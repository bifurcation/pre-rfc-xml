<?xml version="1.0" encoding="US-ASCII"?> 
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [ 

<!ENTITY EAISMTPkeyword "SMTPUTF8"> 

<!ENTITY rfc2045 PUBLIC '' 
'http://xml.resource.org/public/rfc/bibxml/reference.RFC.2045.xml'> 
<!ENTITY rfc2047 PUBLIC '' 
'http://xml.resource.org/public/rfc/bibxml/reference.RFC.2047.xml'> 
<!ENTITY rfc2231 PUBLIC '' 
'http://xml.resource.org/public/rfc/bibxml/reference.RFC.2231.xml'> 
<!ENTITY rfc5321 PUBLIC '' 
'http://xml.resource.org/public/rfc/bibxml/reference.RFC.5321.xml'> 
<!ENTITY rfc5322 PUBLIC '' 
'http://xml.resource.org/public/rfc/bibxml/reference.RFC.5322.xml'> 
<!ENTITY rfc2119 PUBLIC '' 
'http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml'> 
<!ENTITY rfc5321 PUBLIC '' 
'http://xml.resource.org/public/rfc/bibxml/reference.RFC.5321.xml'> 
  <!ENTITY rfc2033 PUBLIC '' 
'http://xml.resource.org/public/rfc/bibxml/reference.RFC.2033.xml'> 
  <!ENTITY rfc3461 PUBLIC '' 
'http://xml.resource.org/public/rfc/bibxml/reference.RFC.3461.xml'> 
  <!ENTITY rfc5336 PUBLIC '' 
'http://xml.resource.org/public/rfc/bibxml/reference.RFC.5336.xml'> 
    <!ENTITY rfc5598 PUBLIC '' 
'http://xml.resource.org/public/rfc/bibxml/reference.RFC.5598.xml'> 
 <!ENTITY rfc6152 PUBLIC '' 
'http://xml.resource.org/public/rfc/bibxml/reference.RFC.6152.xml'> 
 <!ENTITY rfc6409 PUBLIC '' 
'http://xml.resource.org/public/rfc/bibxml/reference.RFC.6409.xml'> 
]> 

<?rfc rfcedstyle='yes'?> 
<?rfc compact='yes'?> 
<?rfc subcompact='no'?> 
<?rfc toc='yes'?> 

<?rfc comments='yes' ?> 
<?rfc inline='yes' ?> 

<!-- RFC references as names, not numbers --> 
<?rfc symrefs="yes" ?> 
<?rfc sortrefs="yes"?> 

<rfc number="6531" ipr="pre5378Trust200902" 
 category="std" obsoletes="5336" submissionType="IETF"> 


<front> 
<title abbrev="SMTP Extension for SMTPUTF8"> 
SMTP Extension for Internationalized Email 
</title> 


<author initials="J." surname="Yao" fullname="Jiankang YAO"> 
  <organization>CNNIC</organization> 
  <address> 
    <postal> 
     <street>No.4 South 4th Street, Zhongguancun</street> 
     <city>Beijing</city> 
     <country>China</country>
    </postal> 
    <phone>+86 10 58813007 </phone> 
    <email>yaojk@cnnic.cn</email> 
  </address> 
</author> 

<author initials="W." surname="Mao" fullname="Wei MAO"> 
  <organization>CNNIC </organization> 
  <address> 
    <postal> 
     <street>No.4 South 4th Street, Zhongguancun</street> 
     <city>Beijing</city> 
     <country>China</country>
    </postal> 
    <phone>+86 10 58812230 </phone> 
    <email>maowei_ietf@cnnic.cn</email> 
  </address> 
</author> 


<date month="February" year="2012" /> 

<keyword>SMTP</keyword>
<keyword>Email I18n</keyword>
<keyword>Internationalization</keyword>
<keyword>SMTPUTF8</keyword>

<abstract> 
<t> 
This document specifies an SMTP extension 
for transport and delivery of email messages with internationalized 
email addresses or header information.
  <!-- [JcK] Removed 2012-02-09: This specification replaces RFC 5336. -->
</t> 
</abstract> 

</front> 

<middle> 

<section title="Introduction" anchor="intro"> 

<t> 
The document defines a Simple Mail Transfer Protocol <xref target="RFC5321"/>
extension so servers can advertise the ability to accept and
process internationalized email addresses (see <xref target="terms"/>) and
internationalized email headers <xref target="RFC6532"/>.
</t><t> 
An extended overview of the extension model for 
internationalized email addresses and the email header appears in 
RFC 6530 <xref target='RFC6530'/>, referred to as "the framework 
document" in this specification. A thorough understanding of the information in that 
document and in the base Internet email specifications 
<xref target="RFC5321"/> <xref target="RFC5322"/> is necessary to 
understand and implement this specification. 
</t> 

<section title="Terminology" anchor="terms"> 

<t>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL 
NOT", "SHOULD", "SHOULD NOT",  "RECOMMENDED", "MAY", and 
"OPTIONAL" in this document are to be interpreted as described in 
RFC 2119 <xref target="RFC2119"/>.</t> 

<t> 
The terms "UTF-8 string" or "UTF-8 character" are used to refer
to Unicode characters, which may or may not be members of the
ASCII subset, in UTF-8 <xref target="RFC3629"/>, a standard Unicode Encoding Form.
All other specialized terms used in this specification are defined in 
the framework document or in the base Internet email specifications. 
In particular, 
the terms "ASCII address", 
"internationalized email address", "non-ASCII address", 
"&EAISMTPkeyword;", "internationalized message", and 
"message" are used in this document according to 
the definitions in the framework document <xref target="RFC6530"/>. 
</t> 
<t> 
Strings referred to in this document, including ASCII strings,
MUST be expressed in UTF-8. 
</t> 

<?rfc needLines="3" ?> 
<t> 
This specification uses Augmented BNF (ABNF) rules <xref target="RFC5234" />. 
Some basic rules in this document are identified in
<xref target="syntax"/> as being defined (under the same names) in RFC 5234
<xref target="RFC5234" />, RFC 5321 <xref target="RFC5321" />, RFC 5890 <xref
target="RFC5890" />, or RFC 6532
<xref target='RFC6532'/>.

</t> 

</section> 

<section title="Changes Made to Other Specifications"> 
<t>
This specification extends some syntax rules defined 
in RFC 5321 and permits internationalized email addresses in the envelope and
in trace fields, but it does not modify
RFC 5321.
It permits data formats defined in RFC 6532 <xref target='RFC6532'/>, but it does not modify RFC 5322. 
It does require that the 8BITMIME extension <xref target="RFC6152"/> be announced by the &EAISMTPkeyword;-aware SMTP server and
used with "BODY=8BITMIME" by the &EAISMTPkeyword;-aware SMTP client, but it 
does not modify the 8BITMIME specification in any way.
</t> 
<t> 
 This specification replaces an earlier, experimental, approach to the
 same problem <xref target='RFC5336'/>. Section 6 of RFC 6530 <xref target='RFC6530'/> describes the changes in
   approach between RFC 5336 <xref target='RFC5336'/> and this specification.
Anyone trying to convert an implementation from the
experimental specification to the specification in this
document will need to review those changes carefully.

 </t> 
</section> 

</section> 

<section title="Overview of Operation" anchor="overview"> 

<t> 
   This document specifies an element of the email internationalization
   work, specifically the definition of an SMTP extension for
   internationalized email.
The extension is identified with the token "&EAISMTPkeyword;". 
</t> 
<t> 
The internationalized email headers
 specification 
<xref target="RFC6532"/> provides the details of email header
features enabled by this extension.</t> 
</section> 

<section title="Mail Transport-Level Protocol"> 
<section title="Framework for the Internationalization Extension" anchor="framework" > 
<t> 
The following service extension is defined: 

<list style="numbers"> 
<t>The name of the SMTP service extension is "Internationalized Email". </t> 
<t>The EHLO keyword value associated with this extension is 
"&EAISMTPkeyword;".</t> 
<t>No parameter values are defined for this EHLO keyword value. In 
order to permit future (although unanticipated) extensions, the 
EHLO response MUST NOT contain any parameters for this keyword. 
The &EAISMTPkeyword;-aware SMTP client MUST ignore any parameters if they appear for this keyword; 
that is, the &EAISMTPkeyword;-aware SMTP client MUST behave as 
if the parameters do not appear. 
If an SMTP server includes &EAISMTPkeyword; in its EHLO response, it MUST be fully 
compliant with this version of this specification. 
</t> 

<t> 
One OPTIONAL parameter, SMTPUTF8, is added to the MAIL command. 
The parameter does not accept a value. If this parameter is set in the MAIL command, 
it indicates that the SMTP client is &EAISMTPkeyword;-aware. Its presence also asserts that 
the envelope includes the non-ASCII 
address, the message being sent is an internationalized message, or the message 
being sent needs the &EAISMTPkeyword; support. 
</t> 

<t> 
The maximum length of a MAIL command line is increased by 
10 characters to accommodate the possible addition of the SMTPUTF8 parameter.

<!--
<cref>RFC Editor: the number '13' will be replaced by the new number (2 spaces + length of the new keyword supposed
to replace "UTF8SMTPbis").</cref>
-->
</t> 

<t>One OPTIONAL parameter, SMTPUTF8, is added to 
the VERIFY (VRFY) and EXPAND (EXPN) commands. The SMTPUTF8 parameter does not
accept a
value. The parameter indicates that the SMTP client can accept Unicode 
characters in UTF-8 encoding in replies from the VRFY and EXPN commands. 
</t> 

<t>No additional SMTP verbs are defined by this extension.</t> 
<t>Servers offering this extension MUST provide support for, and 
announce, the 8BITMIME extension <xref target="RFC6152" />. </t> 
<t> 
The reverse-path and forward-path of the SMTP MAIL and RCPT 
commands are extended to allow Unicode characters encoded in 
UTF-8 in mailbox names (addresses). 
</t> 
<t> 
The mail message body is extended as specified in 
RFC 6532 <xref target="RFC6532" />. 
</t> 

<t>
The &EAISMTPkeyword; extension is valid on the submission
port <xref target="RFC6409" />.  It may also be used with the Local Mail
Transfer Protocol (LMTP)
<xref target="RFC2033" />.  When these protocols are used, their use
should be reflected in the trace field WITH keywords as
appropriate <xref target="RFC3848" />.

</t> 
</list> 
</t> 
</section> 

<section title="The SMTPUTF8 Extension" anchor='extension'> 

<t>An SMTP server that announces the &EAISMTPkeyword; extension MUST be prepared to 
accept a UTF-8 string <xref target="RFC3629" /> 
in any position in which RFC 5321 specifies that a &lt;mailbox> can 
appear. 
Although the characters in the &lt;local-part> are 
permitted to contain non-ASCII characters, the actual parsing of the 
&lt;local-part> and the delimiters used are unchanged 
from the base email specification <xref target="RFC5321" />. 

Any domain name to 
be looked up in the DNS MUST conform to
and be processed as specified for Internationalizing Domain Names in
Applications (IDNA)
<xref target="RFC5890" />. When doing lookups, the &EAISMTPkeyword;-aware SMTP client or server MUST either 
use a Unicode-aware DNS library, or transform the internationalized domain name
to A-label form (i.e., a fully-qualified domain name that contains one or more
A-labels but no U-labels) as specified in RFC 5890
<xref target="RFC5890" />. 
</t> 

<t> 
An SMTP client that receives the &EAISMTPkeyword; extension keyword in 
response to the EHLO command MAY transmit mailbox names within 
SMTP commands as internationalized strings in UTF-8 form. It 
MAY send a UTF-8 header <xref target="RFC6532" /> (which may also include 
mailbox names in UTF-8). 
It MAY transmit the domain parts of mailbox names within SMTP 
commands or the message header as A-labels or U-labels <xref target="RFC5890" />. 

The presence of the &EAISMTPkeyword; extension does not change the
server-relaying behaviors described in RFC 5321. 
</t> 

<t> 
If the &EAISMTPkeyword; SMTP extension is not offered by the SMTP server, the 
&EAISMTPkeyword;-aware SMTP client MUST NOT transmit an internationalized email address 
and MUST NOT transmit a mail message containing 
internationalized mail headers as described in RFC 6532 <xref target="RFC6532" /> 
at any level within its MIME structure <xref target="RFC2045" />. 
(For this paragraph, the internationalized domain name in A-label form
as specified in IDNA definitions <xref target="RFC5890" /> is not considered to be "internationalized".) 
Instead, if an &EAISMTPkeyword;-aware SMTP client (sender) attempts to transfer an 
internationalized message and encounters an SMTP server that 
does not support the extension,
<!-- [JcK]: Beginning of new text added 2012-02-09 after WG
  discussion.  Note that, to reduce citation clutter, I decided that
  anyone who doesn't know what "RFC 5321" refers to has problems this
  spec can't fix. -->
   the best action for it to take depends on other conditions.  In
   particular: </t>
   <t> 
   <list style="symbols"> 
   <t> If it is a Message Submission Agent (MSA)
	  <xref target="RFC6409" /> <xref target="RFC5598" />, it
	  MAY choose its own way to deal with this scenario using the
	  wide discretion for changing addresses 
	  or otherwise fixing up and transforming messages allowed
	  by RFC 6409. As long as the resulting message conforms
	  to the requirements of RFC 5321 (i.e., without the
	  SMTPUTF8 extension), the details of that transformation
	  are outside the scope of this document. </t>
   <t> If it is not an MSA or is an MSA and does not choose to
	  transform the message to one that does not
	  require the SMTPUTF8 extension, it SHOULD reject the
	  message.  As usual, this can be done either by
	  generating an appropriate reply during the SMTP
	  transaction or by accepting the message and then
	  generating and transmitting a non-delivery notification.  If
	  the latter choice is made, the notification process MUST
	  conform to the requirements of RFC 5321,
	  <xref target="RFC3464">RFC 3464</xref>, and
      <xref target="RFC6533">RFC 6533</xref>.</t>
   <t> As specified in Section 2.2.3 of RFC 5321, an SMTP client
	  with additional information and/or knowledge of special
	  circumstances MAY choose to requeue the message and try
	  later and/or try an alternate MX host as specified in
	  that section.</t>
 <!-- [JcK]: End of new text added 2012-02-09 -->
    </list> 
</t> 

<t> 
This document applies when an &EAISMTPkeyword;-aware SMTP client or
server supports the &EAISMTPkeyword; extension.  For all other cases,
and for addresses and messages that do not require an &EAISMTPkeyword;
extension, &EAISMTPkeyword;-aware SMTP clients and servers do not
change the behavior specified in RFC 5321 <xref target="RFC5321" />.
</t> 

<t> 
If an SMTPUTF8-aware SMTP server advertises the Delivery Status
Notification (DSN) <xref target="RFC3461" /> extension, it MUST
implement RFC 6533 <xref target="RFC6533" />.
</t> 

</section> 

<section title="Extended Mailbox Address Syntax" anchor="syntax" > 

<t>RFC 5321, Section 4.1.2, defines the syntax of a &lt;Mailbox>
entirely in terms of ASCII characters. This document extends
&lt;Mailbox> to add support of non-ASCII characters.
</t> 

<t> 
The key changes made by this specification include:

<list style="symbols"> 
<t>The &lt;Mailbox> ABNF rule is
imported from RFC 5321 and updated in order to support the internationalized
email address. Other related rules are imported
from RFC 5321, RFC 5234, RFC 5890, and RFC 6532, or are extended in
this document.</t>

<t>The definition of &lt;sub-domain> is extended to permit both the RFC 5321 
definition and a UTF-8 string in a DNS label that conforms with IDNA definitions 
<xref target="RFC5890" />.</t> 

<t>The definition of &lt;atext> is extended to permit both the RFC 5321
definition and a UTF-8 string. That string MUST NOT contain any of the
ASCII graphics or control characters.
</t> 

</list> </t> 

<t> 
The following ABNF rules imported from RFC 5321, Section 4.1.2, are updated 
directly or indirectly by this document: 
<list style="symbols"> 
<t>&lt;Mailbox></t> 
<t>&lt;Local-part></t> 
<t>&lt;Dot-string></t> 
<t>&lt;Quoted-string></t> 
<t>&lt;QcontentSMTP></t>
<t>&lt;Domain></t> 
<t>&lt;Atom></t>

</list> </t> 
<t> 
The following ABNF rule will be imported from RFC 6532, Section 3.1, directly: 
<list style="symbols"> 
<t>&lt;UTF8-non-ascii></t> 

</list> </t> 

<t> 
The following ABNF rule will be imported from RFC 5234, Appendix B.1, directly: 
<list style="symbols"> 
<t>&lt;DQUOTE></t> 
</list> </t> 

<t> 
The following ABNF rule will be imported from RFC 5890, Section 2.3.2.1, directly: 
<list style="symbols"> 
<t>&lt;U-label></t> 

</list> </t> 

<t>The following rules are extended in ABNF <xref target="RFC5234" /> 
as follows.</t> 
<figure> 
<artwork type="abnf"><![CDATA[ 
 
sub-domain   =/  U-label
 ; extend the definition of sub-domain in RFC 5321, Section 4.1.2
 
atext   =/  UTF8-non-ascii
 ; extend the implicit definition of atext in 
 ; RFC 5321, Section 4.1.2, which ultimately points to
 ; the actual definition in RFC 5322, Section 3.2.3 
 
qtextSMTP  =/ UTF8-non-ascii
 ; extend the definition of qtextSMTP in RFC 5321, Section 4.1.2 

esmtp-value  =/ UTF8-non-ascii
 ; extend the definition of esmtp-value in RFC 5321, Section 4.1.2 
]]> </artwork> 
</figure> 

</section> 

<section title="MAIL Command Parameter Usage" 
  anchor="mailcommand"> 

<t> 
If the envelope or message being sent requires the 
capabilities of the &EAISMTPkeyword; extension, the &EAISMTPkeyword;-aware SMTP client MUST 
supply the SMTPUTF8 parameter with the MAIL command. 
If this parameter is provided, it MUST not accept a value.
If the &EAISMTPkeyword;-aware SMTP client is aware that neither the envelope nor the 
message being sent requires any of the &EAISMTPkeyword; extension 
capabilities, it SHOULD NOT supply the SMTPUTF8
parameter with the MAIL command. </t> 
<t> 
Because there is no guarantee that a next-hop SMTP server will support 
the SMTPUTF8 extension, use of the SMTPUTF8 extension always carries a risk of
 transmission failure. In fact, during the early stages of deployment for 
 the SMTPUTF8 extension, the risk will be quite high.  Hence, there is a distinct 
 near-term advantage for ASCII-only messages to be sent without using 
 this extension. The long-term advantage of casting ASCII <xref target="ASCII"/>
 characters (0x7f and below) as UTF-8 form
 is that it permits pure-Unicode environments.
 </t> 

</section> 

<section title="Non-ASCII Addresses and Reply-Codes" 
    anchor="UsageAndCodes"> 
<t> 
An &EAISMTPkeyword;-aware SMTP client MUST NOT send an
internationalized message to an SMTP server that does not
support &EAISMTPkeyword;.
If the SMTP server does not support this option, then the &EAISMTPkeyword;-aware SMTP 
client has three choices according to <xref target="extension"/> of this specification. 
</t> 
<t>The three-digit reply-codes used in this section are based on 
their meanings as defined in RFC 5321.</t> 
<t> 
When messages are rejected because the RCPT command requires an 
ASCII address, 
the reply-code 553 is returned with the meaning 
"mailbox name not allowed". 

When messages are rejected because the MAIL command requires an 
ASCII address, the reply-code 
550 is returned with the meaning "mailbox unavailable". 

When the &EAISMTPkeyword;-aware SMTP server supports enhanced mail system status 
codes <xref target="RFC3463" />, reply-code "X.6.7" <xref target="RFC5248"/> 
(see <xref target="iana"/>) is used, 
meaning "Non-ASCII addresses not permitted for that sender/recipient". 

</t> 

<t> 
When messages are rejected for other reasons, the server 
follows the model of the base email specification
in RFC 5321; this extension does not change those 
circumstances or reply messages. 
</t> 

<t> 
If a message is rejected after the final "." of the DATA command
because one or more recipients are unable to accept and process a
message with internationalized email headers, the reply-code "554" is
used with the meaning "Transaction failed". If the SMTPUTF8-aware
SMTP server supports enhanced mail system status codes
<xref target="RFC3463" />, reply code "X.6.9" <xref target="RFC5248"/>
(see <xref target="iana"/>) is used to indicate this condition,
meaning "UTF-8 header message cannot be transmitted to one or
more recipients, so the message must be rejected".

</t> 

<t>
 The &EAISMTPkeyword;-aware SMTP servers are encouraged to detect
 that recipients cannot accept internationalized messages and
 generate an error after the RCPT command rather than waiting until
 after the DATA command to issue an error.
</t>

</section> 

<section title="Body Parts and SMTP Extensions" 
anchor="BodyParts"> 
<t>The MAIL command parameter &EAISMTPkeyword; asserts that 
  a message is an internationalized message or the message being sent needs 
the &EAISMTPkeyword; support. 
There is still a chance that a message being sent via the MAIL command
   with the &EAISMTPkeyword; parameter is not an internationalized message.
An &EAISMTPkeyword;-aware SMTP 
  client or server that requires accurate knowledge of whether a message is 
  internationalized needs to parse all message header fields 
  and MIME header fields <xref target="RFC2045" /> in 
the message body. However, this specification 
does not require that the &EAISMTPkeyword;-aware SMTP client or server inspects the message.</t> 
<t>Although this specification requires that &EAISMTPkeyword;-aware SMTP servers support the 
  8BITMIME extension <xref target="RFC6152"/> to ensure that 
  servers have adequate handling capability for 8-bit data, 
  it does not require non-ASCII 
  body parts in the MIME message as specified in RFC 2045. 

  The &EAISMTPkeyword; extension MAY be used as follows (assuming it
  is appropriate given the body content):

<?rfc text-list-symbols="-"?>

<list style="symbols">
<t>
  with the BODY=8BITMIME parameter <xref target="RFC6152"/>, or
</t>
<t>   
  with the BODY=BINARYMIME parameter, if the SMTP server advertises
    BINARYMIME <xref target="RFC3030"/>.
</t>
</list>
</t> 
  </section> 

<?rfc text-list-symbols="o*+-"?>

<section title="Additional ESMTP Changes and Clarifications" > 

<t>The information carried in the mail transport process involves
addresses ("mailboxes") and domain names in various contexts in
addition to the MAIL and RCPT commands and extended alternatives to
them. In general, the rule is that, when RFC 5321 specifies a mailbox,
this SMTP extension requires UTF-8 form to be used for the entire
string. When RFC 5321 specifies a domain name, the internationalized
domain name SHOULD be in U-label form if the &EAISMTPkeyword;
extension is supported; otherwise, it SHOULD be in 
A-label form.
</t> 

<t>The following subsections list and discuss all of the relevant cases. 
</t> 

<section title="The Initial SMTP Exchange" > 

<t> When an SMTP connection is opened, the SMTP server sends a
"greeting" response consisting of the 220 reply-code and some
information. The SMTP client then sends the EHLO command.

 Since the
SMTP client cannot know whether the SMTP server supports
&EAISMTPkeyword; until after it receives the response to the EHLO, the
&EAISMTPkeyword;-aware SMTP client MUST send only ASCII (LDH label or
A-label <xref target="RFC5890" />) domains in the EHLO command.
 If the &EAISMTPkeyword;-aware SMTP server provides domain names
in the EHLO response, they MUST be in the form of LDH labels or
A-labels. </t>

</section> 

<section title="Mail eXchangers" > 
<t> 
  
If multiple DNS MX records are used to specify multiple 
servers for a domain (as described in Section 5 of RFC 5321 <xref target="RFC5321" />), it is 
 strongly advised that all or none of them SHOULD support the 
 &EAISMTPkeyword; extension. Otherwise, unexpected rejections can happen 
during temporary or permanent failures, which users might perceive as serious 
reliability issues. 
</t> 
</section> 


<section title="Trace Information" anchor="TraceFields" > 
<t> 

The trace information &lt;Return-path-line>, &lt;Time-stamp-line>, and
their related rules are defined in Section 4.4 of RFC 5321
<xref target="RFC5321" />.  This document updates &lt;Mailbox> and
&lt;Domain> to support non-ASCII characters.  When the
&EAISMTPkeyword; extension is used, the 'Reverse-path' clause of the
Return-path-line may include an internationalized domain name that
uses the U-label form. Also, the 'Stamp' clause of the Time-stamp-line may
include an internationalized domain name that uses the U-label form.
</t> 

<t> 
 If the messages that include trace fields are sent by an
&EAISMTPkeyword;-aware SMTP client or relay server without the &EAISMTPkeyword;
parameter included in the
MAIL commands, trace field values must conform to RFC 5321 regardless of the SMTP server's
capability.
</t>
<t>
When an &EAISMTPkeyword;-aware SMTP server adds a trace field to a message that was or
will be transmitted with the &EAISMTPkeyword; parameter included in the MAIL commands, that
server SHOULD use the U-label form for internationalized domain
names in the new trace field.
</t> 

<t> 

The protocol value of the 'WITH' clause when this extension is 
used is one of the &EAISMTPkeyword; values specified in the "IANA 
Considerations" section of this document. 
</t> 

</section> 

<section title="UTF-8 Strings in Replies" anchor="SMTPUTF8" > 

<section title="MAIL Command"> 

<t> 
If an SMTP client follows this specification and sends any MAIL
commands containing the SMTPUTF8 parameter, the
&EAISMTPkeyword;-aware SMTP server is permitted to use UTF-8
characters in the email address associated with 251 and 551
reply-codes, and the SMTP client MUST be able to accept and process
them. If a given MAIL command does not include the SMTPUTF8
parameter, the &EAISMTPkeyword;-aware SMTP server MUST NOT return a
251 or 551 response containing a non-ASCII mailbox. Instead, it MUST
transform such responses into 250 or 550 responses that do not contain
non-ASCII addresses.
</t>
 
</section> 

<section title="VRFY and EXPN Commands and the SMTPUTF8 Parameter" anchor="usage2"> 

<t>
   If the SMTPUTF8 parameter is transmitted with the VRFY and EXPN
   commands, it indicates that the SMTP client can accept UTF-8
   strings in replies to those commands.  The parameter with the VRFY
   and EXPN commands SHOULD only be used after the SMTP client sees
   the EHLO response with the &EAISMTPkeyword; keyword.  This allows an
   &EAISMTPkeyword;-aware SMTP server to use UTF-8 strings in mailbox names
   and full names that occur in replies, without concern that the SMTP
   client might be confused by them.  An SMTP client that conforms to
   this specification MUST accept and correctly process replies to the
   VRFY and EXPN commands that contain UTF-8 strings.  However, an
   &EAISMTPkeyword;-aware SMTP server MUST NOT use UTF-8 strings in replies if
   the SMTP client does not specifically allow such replies by
   transmitting this parameter with the VRFY and EXPN commands.
</t>

<t>
Most replies do not require that a
mailbox name be included in the returned text, and therefore a UTF-8
string is not needed in them.  Some replies, notably those resulting
from successful execution of the VRFY and EXPN commands, do include
the mailbox.
</t>

<t>VERIFY (VRFY) and EXPAND (EXPN) command syntaxes are changed to: 

<figure> 
<artwork type="abnf"><![CDATA[ 
vrfy = "VRFY" SP String 
  [ SP "SMTPUTF8" ] CRLF 
 ; String may include Non-ASCII characters

expn = "EXPN" SP String 
  [ SP "SMTPUTF8" ] CRLF 
 ; String may include Non-ASCII characters
 
]]></artwork> 
</figure> 
</t>

<t> 
The SMTPUTF8 parameter does not accept a value.  If the reply
to a VRFY or EXPN command requires a UTF-8 string, but the SMTP client
did not use the SMTPUTF8 parameter, then the
&EAISMTPkeyword;-aware SMTP server MUST use either the reply-code 252
or 550.  Reply-code 252, defined in RFC 5321 <xref target="RFC5321" />, means
"Cannot VRFY user, but will accept the message and attempt the
delivery".  Reply-code 550, also defined in RFC 5321 <xref target="RFC5321" />,
means "Requested action not taken: mailbox unavailable". 

When the
&EAISMTPkeyword;-aware SMTP server supports enhanced mail system
status codes <xref target="RFC3463" />, the enhanced reply-code as
specified below is used.  Using the SMTPUTF8 parameter with a
VRFY or EXPN command enables UTF-8 replies for that
command only.
</t> 
<t>If a normal success response (i.e., 250) is returned, 
the response MAY include the full name of the user and MUST include 
the mailbox of the user. It MUST be in either of the following 
forms:</t> 

<figure> 
<artwork>
User Name &lt;Mailbox>
 ; Mailbox is defined in Section 3.3 of this document. 
 ; User Name can contain non-ASCII characters. 

Mailbox 
 ; Mailbox is defined in Section 3.3 of this document. 
</artwork> 
</figure> 

<t> 
If the SMTP reply requires UTF-8 strings, but a UTF-8 string is not 
allowed in the reply, and the &EAISMTPkeyword;-aware SMTP server supports enhanced mail 
system status codes <xref target='RFC3463'/>, the enhanced reply-code 
is "X.6.8" <xref target="RFC5248" /> (see <xref target="iana"/>), meaning "A reply 
containing a UTF-8 string is required to show the mailbox name, 
but that form of response is not permitted by the SMTP client". 
</t> 

<t> 
If the SMTP client does not support the &EAISMTPkeyword; extension, 
but receives a UTF-8 string in a reply, it may not be able to 
properly report the reply to the user, and some clients might mishandle that reply. 
Internationalized messages in replies are only 
allowed in the commands 
under the situations described above. 
</t> 

<t> 
Although UTF-8 strings are needed to represent email addresses in responses 
under the rules specified in this section, this extension 
does not permit the use of UTF-8 strings for any other purposes. 
&EAISMTPkeyword;-aware SMTP servers MUST NOT include non-ASCII characters in replies except in the 
limited cases specifically permitted in this section. 
</t> 
</section> 
</section> 
</section> 
</section> 

<section title="IANA Considerations" anchor="iana"> 
<section title="SMTP Service Extensions Registry">
<t>IANA has added a new value "&EAISMTPkeyword;" to the "SMTP 
Service Extension" registry of the "Mail Parameters" registry, according 
to the following data: 
</t> 
<texttable> 
<ttcol align="left">Keywords</ttcol> 
<ttcol align="left">Description</ttcol> 
<ttcol align="left">Reference</ttcol> 
<c>&EAISMTPkeyword;</c>  <c>Internationalized email address</c> 
<c>[RFC&rfc.number;]</c> 
</texttable> 
</section> 

<section title="SMTP Enhanced Status Code Registry">
<t>
The code definitions in this document replace those specified in RFC 5336,
following the guidance in Sections <xref target="UsageAndCodes"
format="counter"/> and <xref target="usage2" format="counter"/> of this
document, and based on RFC 5248 <xref target="RFC5248" />. 
IANA has updated the "Simple Mail Transfer Protocol (SMTP) Enhanced Status Code
Registry" with the following data:

<figure> 
<artwork ><![CDATA[ 
 Code:        X.6.7 
 Sample Text: Non-ASCII addresses not permitted for that 
              sender/recipient 
 Associated basic status code: 550, 553 
 Description: This indicates the reception of a MAIL or RCPT command
              that non-ASCII addresses are not permitted. 
 Defined:     RFC 6531 (Standards Track) 
 Submitter:   Jiankang YAO 
 Change controller: ima@ietf.org 
]]> </artwork> 
</figure> 

<figure> 
<artwork ><![CDATA[ 
 Code:        X.6.8 
 Sample Text: UTF-8 string reply is required, but not permitted by 
              the SMTP client 
 Associated basic status code: 252, 550, 553 
 Description: This indicates that a reply containing a UTF-8 string 
              is required to show the mailbox name, but that form of
              response is not permitted by the SMTP client. 
 Defined:     RFC 6531 (Standards Track) 
 Submitter:   Jiankang YAO 
 Change controller: ima@ietf.org 
]]> </artwork> 
</figure> 

<figure> 
<artwork ><![CDATA[ 
 Code:        X.6.9 
 Sample Text: UTF-8 header message cannot be transferred to one or 
              more recipients, so the message must be rejected 
 Associated basic status code: 550 
 Description: This indicates that transaction failed after the 
              final "." of the DATA command. 
 Defined:     RFC 6531 (Standards Track) 
 Submitter:   Jiankang YAO 
 Change controller: ima@ietf.org 
]]> </artwork> 
</figure> 

<figure> 
<artwork ><![CDATA[ 
 Code:        X.6.10 
 Description: This is a duplicate of X.6.8 and is thus deprecated. 
]]> </artwork> 
</figure> 

</t> 
</section> 

<section title="WITH Protocol Types Sub-Registry of the Mail Transmission Types Registry">
<t> 
IANA has modified or added the following entries 
in the "WITH protocol types" sub-registry under the "Mail Transmission Types" registry.</t> 

<texttable> 
<ttcol align="left">WITH protocol types</ttcol> 
<ttcol align="left">Description</ttcol> 
<ttcol align="left">Reference</ttcol> 

<c>UTF8SMTP</c>  <c>ESMTP with &EAISMTPkeyword;</c> 
<c>[RFC&rfc.number;]</c> 
<c>UTF8SMTPA</c> <c> ESMTP with &EAISMTPkeyword; and AUTH</c> 
 <c><xref target="RFC4954"/> [RFC&rfc.number;]</c> 
<c>UTF8SMTPS </c> <c>ESMTP with &EAISMTPkeyword; and STARTTLS</c> 
<c><xref target="RFC3207"/> [RFC&rfc.number;]</c> 
<c>UTF8SMTPSA</c> <c>ESMTP with &EAISMTPkeyword; and both STARTTLS and AUTH</c> 
  <c><xref target="RFC3207"/> <xref target="RFC4954"/> [RFC&rfc.number;]</c> 

<c>UTF8LMTP</c>  <c>LMTP with &EAISMTPkeyword;</c> 
<c>[RFC&rfc.number;]</c> 
<c>UTF8LMTPA</c> <c>LMTP with &EAISMTPkeyword; and AUTH</c> 
 <c><xref target="RFC4954"/> [RFC&rfc.number;]</c> 
<c>UTF8LMTPS </c> <c>LMTP with &EAISMTPkeyword; and STARTTLS</c> 
<c><xref target="RFC3207"/> [RFC&rfc.number;]</c> 
<c>UTF8LMTPSA</c> <c>LMTP with &EAISMTPkeyword; and both STARTTLS and AUTH</c> 
  <c><xref target="RFC3207"/> <xref target="RFC4954"/> [RFC&rfc.number;]</c> 
</texttable>                         
</section> 
</section> 

<section title="Security Considerations" anchor="security"> 
<t> The extended security considerations discussion in the 
framework document <xref target="RFC6530"/> applies here. 
</t> 
<t> 
More security considerations are discussed below: 
</t> 
<t> 
Beyond the use inside the email global system (in SMTP envelopes and message 
headers), internationalized email addresses will also show up inside other 
cases, in particular: 

</t> 
<t><list style="symbols"> 
<t> the logging systems of SMTP transactions and other logs to monitor 
 the email systems;</t> 
<t> the trouble ticket systems used by security teams to manage security 
 incidents, when an email address is involved;</t> 
</list> </t> 


<t> 
In order to avoid problems that could cause loss of data,
   this will likely require extending these systems to support full UTF-8,
   or require providing an adequate mechanism for mapping non-ASCII
   strings to ASCII.
</t> 
<t> 
Another security aspect to be considered is related to the ability by security 
team members to quickly understand, read, and identify email addresses from 
the logs, when they are tracking an incident. Mechanisms to automatically and 
quickly provide the origin or ownership of an internationalized email 
address SHALL be implemented for use by log readers that cannot easily 
read non-ASCII information. 
</t> 

<t> 
The SMTP commands VRFY and EXPN are sometimes used in SMTP transactions 
where there is no message to transfer (by tools used to take automated 
actions in case potential spam messages are identified). Sections 3.5 
and 7.3 of RFC 5321 give detailed descriptions of use and possible behaviors. 
Implementation of internationalized addresses can also affect logs and 
actions by these tools. 
</t> 
</section> 


<section title="Acknowledgements"> 
<t>
This document revises RFC 5336 <xref target="RFC5336"/> based on the result
of the Email Address Internationalization (EAI) working group's discussion.  Many
EAI working group members did tests and implementations to move this
document to the Standards Track.  Significant comments and suggestions
were received from Xiaodong LEE, Nai-Wen HSU, Yangwoo KO, Yoshiro
YONEYA, and other members of JET and were incorporated into the
specification. Additional important comments and suggestions, and
often specific text, were contributed by many members of the working group and
design team. Those contributions include material from John C. Klensin,
Charles Lindsey, Dave Crocker, Harald Tveit Alvestrand, Marcos Sanz,
Chris Newman, Martin Duerst, Edmon Chung, Tony Finch, Kari Hurtta,
Randall Gellens, Frank Ellermann, Alexey Melnikov, Pete Resnick,
S. Moonesamy, Soobok Lee, Shawn Steele, Alfred Hoenes, Miguel Garcia,
Magnus Westerlund, Joseph Yee, and Lars Eggert.  Of course, none of
the individuals are necessarily responsible for the combination of
ideas represented here.
</t> 
<t> 
Thanks a lot to Dave Crocker for his comments and helping with ABNF refinement.
</t> 

</section> 

</middle> 

<back> 

<references title="Normative References"> 

<!-- 4952bis = 6530 -->
<reference anchor="RFC6530"> 
<front> 
<title>Overview and Framework for Internationalized Email</title> 
<author initials="J." surname="Klensin" fullname="J. Klensin"> 
<organization /> 
</author> 
<author initials="Y." surname="Ko" fullname="Y. Ko"> 
<organization /> 
</author> 
<date year="2012" month="February" /> 
<abstract> 
<t>Full use of electronic mail throughout the world requires that 
people be able to use their own names, written correctly in 
their own languages and scripts, as mailbox names in email 
addresses. This document introduces a series of specifications 
that define mechanisms and protocol extensions needed to fully 
support internationalized email addresses. These changes include 
an SMTP extension and extension of email header syntax to 
accommodate UTF-8 data. The document set also includes 
discussion of key assumptions and issues in deploying fully 
internationalized email. This memo provides information for the 
Internet community.</t>     
</abstract> 
</front> 
<seriesInfo name="RFC" value="6530" /> 

</reference> 

<!-- 5335bis = 6532 -->
        <reference anchor="RFC6532">
           <front>
                  <title>Internationalized Email Headers</title>
                  <author initials="A." surname="Yang" fullname="Abel YANG">
                 <organization>TWNIC </organization>
                  </author>
                  <author initials="S." surname="Steele" fullname="Shawn STEELE">
                         <organization> Microsoft </organization>
                  </author>
                  <author initials="N." surname="Freed" fullname="Ned Freed">
                 <organization>Oracle </organization>
                  </author>

                  <date year="2012" month="February"/>
           </front>
           <seriesInfo name="RFC" value="6532"/>
        </reference>


<reference anchor="RFC3463"> 
<front> 
<title>Enhanced Mail System Status Codes</title> 
<author initials="G." surname="Vaudreuil" fullname="G. Vaudreuil"> 
<organization /> 
</author> 
<date year="2003" month="January" /> 
<abstract> 
<t>This document defines a set of extended status codes for use within the mail system for delivery status reports, tracking, and improved diagnostics. In combination with other information provided in the Delivery Status Notification (DSN) delivery report, these codes facilitate media and language independent rendering of message delivery status. [STANDARDS TRACK]</t> 
</abstract> 
</front> 
<seriesInfo name="RFC" value="3463" /> 
<format type="TXT" octets="31832" target="http://www.rfc-editor.org/rfc3463.txt" /> 
</reference> 



<reference anchor="RFC3464"> 
<front> 
<title>An Extensible Message Format for Delivery Status Notifications</title> 
<author initials="K." surname="Moore" fullname="K. Moore"> 
<organization /> 
</author> 
<author initials="G." surname="Vaudreuil" fullname="G. Vaudreuil"> 
<organization /> 
</author> 
<date year="2003" month="January" /> 
<abstract> 
<t>This memo defines a Multipurpose Internet Mail Extensions (MIME) content-type that MAY be used by a message transfer agent (MTA) or electronic mail gateway to report the result of an attempt to deliver a message to one or more recipients. This content-type is intended as a machine-processable replacement for the various types of delivery status notifications currently used in Internet electronic mail. Because many messages are sent between the Internet and other messaging systems (such as X.400 or the so-called "Local Area Network (LAN)-based" systems), the Delivery Status Notification (DSN) protocol is designed to be useful in a multi-protocol messaging environment. To this end, the protocol described in this memo provides for the carriage of "foreign" addresses and error codes, in addition to those normally used in Internet mail. Additional attributes MAY also be defined to support "tunneling" of foreign notifications through Internet mail. [STANDARDS TRACK]</t> 
</abstract> 
</front> 
<seriesInfo name="RFC" value="3464" /> 
<format type="TXT" octets="83060" target="http://www.rfc-editor.org/rfc3464.txt" /> 
</reference> 





<reference anchor='RFC3629'> 
 <front> 
 <title abbrev='UTF-8'>UTF-8, a transformation format of ISO 10646</title> 
 <author initials='F.' surname='Yergeau' fullname='Francois Yergeau'> 
 <organization>Alis Technologies</organization> 
 <address> 
 <postal> 
 <street>100, boul. Alexis-Nihon</street> 
 <street>Suite 600</street> 
 <city>Montreal</city> 
 <region>Quebec</region> 
 <code>H4M 2P2</code> 
 <country>CA</country></postal> 
 <phone>+1 514 747 2547</phone> 
 <facsimile>+1 514 747 2561</facsimile> 
 <email>fyergeau@alis.com</email></address></author> 
 <date month='November' year='2003' /> 
 </front> 
 <seriesInfo name='RFC' value='3629' /> 
 <format type='TXT' octets='33856' 
   target='http://www.rfc-editor.org/rfc3629.txt' /> 
</reference> 

&rfc5321; 
&rfc5322; 

&rfc6152; 


<reference anchor="RFC5890"> 
<front> 
<title>Internationalizing Domain Names in Applications (IDNA definitions)</title> 
<author initials='J.' surname='Klensin' fullname='Klensin, J.'> 
<organization /></author> 
<date month='June' year='2010' /></front> 
<seriesInfo name='RFC' value='5890' /> 
<format type='TXT' octets='51943' 
 target='http://www.rfc-editor.org/rfc5890.txt' /> 
</reference> 


&rfc6409;

<reference anchor="RFC5248"> 
 <front> 
 <title abbrev="SMTP Code Registry"> 
 A Registry for SMTP Enhanced Mail System Status Codes</title> 
<author initials="T." surname="Hansen" fullname="Tony Hansen"> 
  <organization/> 
  <address/> 
  </author> 
 <author initials="J." surname="Klensin" fullname="John C Klensin"> 
  <organization/> 
  <address/> 
  </author> 
  <date month="June" day="10" year="2008" /> 
  </front> 
  <seriesInfo name="RFC" value="5248" /> 
</reference> 

<!-- 5337bis = 6533 -->
<reference anchor="RFC6533"> 
<front> 
 <title> 
    Internationalized Delivery Status and Disposition Notifications</title> 
 
  <author initials="T." surname="Hansen" fullname="T. Hansen" role="editor"> 
  <organization>AT and T Laboratories</organization> 
  <address /> 
  </author> 
 
 <author initials="C." surname="Newman" fullname="Chris Newman"> 
  <organization>Sun Microsystems</organization> 
  <address /> 
  </author> 

  <author initials="A." surname="Melnikov" fullname="Alexey 
  Melnikov" role="editor"> 
  <organization>Isode Ltd</organization> 
  <address /> 
  </author> 
  <date month="February" year="2012" /> 
  </front> 
<seriesInfo name="RFC" value="RFC6533" /> 
</reference> 

  <reference anchor='ASCII'> 
   <front> 
    <title>USA Code for Information Interchange</title> 
    <author> 
     <organization abbrev="ANSI"> 
      American National Standards Institute 
       (formerly United States of America Standards Institute) 
   </organization> 
    </author> 
    <date year="1968"/> 
   </front> 
  <seriesInfo name="ANSI" value="X3.4-1968" /> 
<!-- <annotation>ANSI X3.4-1968 has been replaced by newer 
  versions with slight modifications, but the 1968 version 
  remains definitive for the Internet. </annotation> --> 
  </reference> 

&rfc2119; 
<?rfc include="reference.RFC.3848"?> 
&rfc3461; 

<reference anchor="RFC5234"> 
<front> 
<title>Augmented BNF for Syntax Specifications: ABNF</title> 
<author initials="D." surname="Crocker" fullname="D. Crocker"> 
<organization /> 
</author> 
<author initials="P." surname="Overell" fullname="P. Overell"> 
<organization /> 
</author> 
<date year="2008" month="January" /> 
<abstract> 
<t>Internet technical specifications often need to define a formal syntax. Over the years, a modified version of Backus-Naur Form (BNF), called Augmented BNF (ABNF), has been popular among many Internet specifications. The current specification documents ABNF. It balances compactness and simplicity with reasonable representational power. The differences between standard BNF and ABNF involve naming rules, repetition, alternatives, order-independence, and value ranges. This specification also supplies additional rule definitions and encoding for a core lexical analyzer of the type common to several Internet specifications. [STANDARDS TRACK]</t> 
</abstract> 
</front> 
<seriesInfo name="STD" value="68" /> 
<seriesInfo name="RFC" value="5234" /> 
<format type="TXT" octets="26359" target="http://www.rfc-editor.org/rfc5234.txt" /> 
</reference> 

</references> 

<references title="Informative References"> 

<reference anchor="RFC3030"> 
<front> 
<title>SMTP Service Extensions for Transmission of Large and Binary MIME Messages</title> 
<author initials="G." surname="Vaudreuil" fullname="G. Vaudreuil"> 
<organization /> 
</author> 
<date year="2000" month="December" /> 
<abstract> 
<t>This memo defines two extensions to the SMTP (Simple Mail Transfer Protocol) service. [STANDARDS TRACK] </t> 
</abstract> 
</front> 
<seriesInfo name="RFC" value="3030" /> 
<format type="TXT" octets="23405" target="http://www.rfc-editor.org/rfc3030.txt" /> 
</reference> 

<reference anchor="RFC3207"> 
<front> 
<title>SMTP Service Extension for Secure SMTP over Transport Layer Security</title> 
<author initials="P." surname="Hoffman" fullname="P. Hoffman"> 
<organization /> 
</author> 
<date year="2002" month="February" /> 
<abstract> 
<t>This document describes an extension to the SMTP (Simple Mail Transfer Protocol) service that allows an SMTP server and client to use TLS (Transport Layer Security) to provide private, authenticated communication over the Internet. This gives SMTP agents the ability to protect some or all of their communications from eavesdroppers and attackers. [STANDARDS TRACK]</t> 
</abstract> 
</front> 
<seriesInfo name="RFC" value="3207" /> 
<format type="TXT" octets="18679" target="http://www.rfc-editor.org/rfc3207.txt" /> 
</reference> 



<reference anchor="RFC4954"> 
<front> 
<title>SMTP Service Extension for Authentication</title> 
<author initials="R." surname="Siemborski" fullname="R. Siemborski"> 
<organization /> 
</author> 
<author initials="A." surname="Melnikov" fullname="A. Melnikov"> 
<organization /> 
</author> 
<date year="2007" month="July" /> 
<abstract> 
<t>This document defines a Simple Mail Transport Protocol (SMTP) extension whereby an SMTP client MAY indicate an authentication mechanism to the server, perform an authentication protocol exchange, and OPTIONALly negotiate a security layer for subsequent protocol interactions during this session. This extension includes a profile of the Simple Authentication and Security Layer (SASL) for SMTP.</t><t> This document obsoletes RFC 2554. [STANDARDS TRACK]</t> 
</abstract> 
</front> 
<seriesInfo name="RFC" value="4954" /> 
<format type="TXT" octets="43493" target="http://www.rfc-editor.org/rfc4954.txt" /> 
</reference> 


&rfc2033; 
&rfc2045; 
&rfc5336; 
&rfc5598; 

</references> 

</back> 
</rfc>
