<?xml version='1.0' encoding='US-ASCII'?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!ENTITY RFC0826 PUBLIC '' "reference.RFC.0826.xml">
<!ENTITY RFC0903 PUBLIC '' "reference.RFC.0903.xml">
<!ENTITY RFC2119 PUBLIC '' "reference.RFC.2119.xml">
<!ENTITY RFC2131 PUBLIC '' "reference.RFC.2131.xml">
<!ENTITY RFC3315 PUBLIC '' "reference.RFC.3315.xml">
<!ENTITY RFC4861 PUBLIC '' "reference.RFC.4861.xml">
<!ENTITY RFC4862 PUBLIC '' "reference.RFC.4862.xml">
<!ENTITY RFC6325 PUBLIC '' "reference.RFC.6325.xml">
<!ENTITY RFC7172 PUBLIC '' "reference.RFC.7172.xml">
<!ENTITY RFC7356 PUBLIC '' "reference.RFC.7356.xml">
<!ENTITY RFC7357 PUBLIC '' "reference.RFC.7357.xml">
<!ENTITY RFC7780 PUBLIC '' "reference.RFC.7780.xml">
<!ENTITY RFC7961 PUBLIC '' "reference.RFC.7961.xml">
<!ENTITY RFC8171 PUBLIC '' "reference.RFC.8171.xml">
<!ENTITY RFC3756 PUBLIC '' "reference.RFC.3756.xml">
<!ENTITY RFC3971 PUBLIC '' "reference.RFC.3971.xml">
<!ENTITY RFC5227 PUBLIC '' "reference.RFC.5227.xml">
<!ENTITY RFC6820 PUBLIC '' "reference.RFC.6820.xml">
<!ENTITY RFC6823 PUBLIC '' "reference.RFC.6823.xml">
<!ENTITY RFC7042 PUBLIC '' "reference.RFC.7042.xml">
<!ENTITY RFC7067 PUBLIC '' "reference.RFC.7067.xml">
<!ENTITY RFC8174 PUBLIC '' "reference.RFC.8174.xml">
]>
<rfc submissionType="IETF" number="8203" category="std" consensus="yes">
        <?rfc compact="yes"?>
	<?rfc text-list-symbols="o*+-"?>
	<?rfc subcompact="no"?>
	<?rfc sortrefs="no"?>
	<?rfc symrefs="yes"?>
	<?rfc toc="yes"?>
	<front>
	<title abbrev="TRILL ARP/ND Optimization">Transparent Interconnection of Lots of Links (TRILL): ARP&nbsp;and&nbsp;Neighbor&nbsp;Discovery&nbsp;(ND)&nbsp;Optimization</title>
	<author fullname="Yizhou Li" initials="Y." surname="Li">
	<organization>Huawei Technologies</organization>
	<address><postal><street>101 Software Avenue,</street>
	<region>Nanjing</region>
        <code>210012</code>
	<country>China</country>
	</postal>
	<phone>+86-25-56625375</phone>
	<email>liyizhou@huawei.com</email>
	</address>
	</author>

	<author fullname="Donald Eastlake 3rd" initials="D." surname="Eastlake 3rd">
	<organization abbrev="Huawei Technologies">Huawei R&amp;D USA</organization>
	<address><postal><street>155 Beaver Street</street>
        <city>Milford</city>
        <region>MA</region>
        <code>01757</code>
	<country>United States of America</country>
	</postal>
	<phone>+1-508-333-2270</phone>
	<email>d3e3e3@gmail.com</email>
	</address>
	</author>

	<author fullname="Linda Dunbar" initials="L." surname="Dunbar">
	<organization>Huawei Technologies</organization>
	<address><postal><street>5430 Legacy Drive, Suite #175</street>
        <city>Plano</city>
        <region>TX</region>
        <code>75024</code>
	<country>United States of America</country>
	</postal>
	<phone>+1-469-277-5840</phone>
	<email>ldunbar@huawei.com</email>
	</address>
	</author>

	<author fullname="Radia Perlman" initials="R." surname="Perlman">
	<organization>EMC</organization>
	<address><postal><street>2010 256th Avenue NE, #200</street>
        <city>Bellevue</city>
        <region>WA</region>
        <code>98007</code>
        <country>United States of America</country>
	</postal>
	<email>Radia@alum.mit.edu</email>
	</address>
	</author>

	<author fullname="Mohammed Umair" initials="M." surname="Umair">
	<organization>Cisco</organization>
	<address><postal><street>Cessna Business Park, Kadubeesanahalli Village, Hobli,</street>
	<street>Sarjapur, Varthur Main Road, Marathahalli,</street>
        <region>Bengaluru, Karnataka</region>
        <code>560087</code>
        <country> India</country>
	</postal>
	<email>mohammed.umair2@gmail.com</email>
	</address>
	</author>

	<date month="December" year="2017"/>
	<workgroup>TRILL Working Group</workgroup>

<!-- [rfced] Please insert any keywords (beyond those that appear in 
the title) for use on https://www.rfc-editor.org/search.
-->


	<abstract><t>
   This document describes mechanisms to optimize the Address
   Resolution Protocol (ARP) and Neighbor Discovery (ND) traffic in a 
   Transparent Interconnection of Lots of Links (TRILL)
   campus. TRILL switches maintain a cache of IP / Media Access Control (MAC) address / Data Label
   bindings that are learned from ARP/ND requests and responses that
   pass through them. In many cases, this cache allows an edge Routing Bridge (RBridge)
   to avoid flooding an ARP/ND request by either responding to it
   directly or encapsulating it and unicasting it. Such optimization
   reduces packet flooding over a TRILL campus.</t>

	</abstract>
	</front>

	<middle>
	<section title="Introduction" anchor="section-1"><t>

<!--[rfced] Should we add "requests and responses" to this sentence?

Original:
ARP [RFC826] and ND [RFC4861] are normally sent by broadcast and
multicast respectively. 

Perhaps:
Requests and responses using ARP [RFC0826] and ND [RFC4861] are normally sent by broadcast and
multicast, respectively. 

-->
   ARP <xref target="RFC0826" /> and ND <xref target="RFC4861"/> are normally sent by broadcast and
   multicast, respectively. To reduce the burden on a TRILL campus caused
   by these multi-destination messages, RBridges MAY implement an
   "optimized ARP/ND response", as specified herein, when the target's
   location is known by the ingress RBridge or can be obtained from a
   directory. This avoids ARP/ND query and answer flooding.</t>

	<section title="Terminology" anchor="section-1.1"><t>
  The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL
      NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED",
      "MAY", and "OPTIONAL" in this document are to be interpreted as
      described in BCP 14 <xref target="RFC2119" /> <xref target="RFC8174" /> when, and only when, they
      appear in all capitals, as shown here.</t>

	<t>
   The abbreviations and terminology in <xref target="RFC6325"/> are used herein. Some of
   these are listed below for convenience along with some additions:</t>
<!--[rfced] In Section 1.1, the listed terms each contain a reference,
except for DAD, Data Label, IP, and RBridge. Would you like to add
references to the descriptions for consistency?

Original:

DAD            Duplicate Address Detection

Data Label     VLAN or FGL

IP             Internet Protocol, both IPv4 and IPv6

RBridge        A contraction of "Routing Bridge". A device 
               implementing the TRILL protocol.

-->

	<t><list style="hanging" hangIndent="13"><t hangText="APPsub-TLV">
	Application sub-Type-Length-Value <xref target="RFC6823"/>
	<vspace blankLines="0"/>
	</t>

	<t hangText="ARP">
	Address Resolution Protocol <xref target="RFC0826"/>
	<vspace blankLines="0"/>
	</t>

	<t hangText="Campus">
	A TRILL network consisting of RBridges, links, and
	<vspace blankLines="0"/>
	possibly bridges bounded by end stations and IP routers <xref target="RFC6325"/>
	</t>

	<t hangText="DAD">
	Duplicate Address Detection
	<vspace blankLines="0"/>
	</t>

	<t hangText="Data Label">
	VLAN or Fine-Grained Label (FGL)
	<vspace blankLines="0"/>
	</t>

	<t hangText="DHCP">
	Dynamic Host Configuration Protocol.  In this document, DHCP refers to both DHCP for IPv4
	<xref target="RFC2131"/> and DHCPv6 <xref target="RFC3315"/>
	<vspace blankLines="0"/>
	</t>

	<t hangText="ESADI">
	End Station Address Distribution Information <xref target="RFC7357"/>
	<vspace blankLines="0"/>
	</t>

	<t hangText="FGL">
	Fine-Grained Label <xref target="RFC7172"/>
	<vspace blankLines="0"/>
	</t>

	<t hangText="IA">
	Interface Address; a TRILL APPsub-TLV <xref target="RFC7961"/>
	<vspace blankLines="0"/>
	</t>

	<t hangText="IP">
	Internet Protocol, both IPv4 and IPv6
	<vspace blankLines="0"/>
	</t>

	<t hangText="MAC">
	Media Access Control <xref target="RFC7042"/>
	<vspace blankLines="0"/>
	</t>

	<t hangText="ND">
	Neighbor Discovery <xref target="RFC4861"/>
	<vspace blankLines="0"/>
	</t>

	<t hangText="RBridge">
	A contraction of "Routing Bridge". A device
	<vspace blankLines="0"/>
	implementing the TRILL protocol.
	</t>

	<t hangText="SEND">
	Secure Neighbor Discovery <xref target="RFC3971"/>
	<vspace blankLines="0"/>
	</t>

	<t hangText="TRILL">
	Transparent Interconnection of Lots of Links or
	<vspace blankLines="0"/>
	Tunneled Routing in the Link Layer <xref target="RFC6325"/> <xref target="RFC7780"/>

<!--[rfced] It is unusual to expand an abbreviation/acronym in two different ways in the same RFC.  Might further explanation or a single expansion for TRILL be more helpful to the reader?

Original:
   TRILL        Transparent Interconnection of Lots of Links or
                Tunneled Routing in the Link Layer [RFC6325] [RFC7780]

-->
	</t>

	</list>
	</t>

	</section>

	</section>

	<section title="ARP/ND Optimization Requirement and Solution" anchor="section-2"><t>
   IP address resolution can create significant issues in data centers
   due to flooded packets, as discussed in <xref target="RFC6820"/>. Such flooding can
   be avoided by a proxy ARP/ND function on edge RBridges as described
   in this document. 

<!--[rfced] Would a pointer to Section 8 be helpful here?  

Original:
Such flooding can
be avoided by a proxy ARP/ND function on edge RBridges as described
in this document. 

Perhaps:
Such flooding can
be avoided by a proxy ARP/ND function on edge RBridges as described
in Section 8 of this document.
-->

This section is a general discussion of this
   problem and is not intended to be normative.</t>

<!--[rfced] We have used the term "IP/MAC address mapping" throughout for consistency.  Please review the following and let us know if they should be updated to match.

Original:
   To support such ARP/ND optimization, edge RBridges need to know end-
   station's IP to MAC mapping through manual configuration
   (management), through control plane mechanisms such as directories
   [RFC8171], or through Data plane learning by snooping of messages
   such as ARP/ND (including DHCP or gratuitous ARP messages)

Original:
   The Interface Addresses (IA)
   APPsub-TLV [RFC7961] enhances the TRILL base protocol by allowing IP
   and MAC address mappings to be distributed in the control plane by
   any RBridge.

Original:
...it may save the information and then use
   the IA APPsub-TLV to link the IP and MAC addresses and distribute it
   to other RBridges through ESADI.

Original:
 o   If the sender's IP is not present in the ingress RBridge's ARP/ND
   cache, populate the information of sender's IP/MAC in its ARP/ND
   cache table. 

Original:

   o   Else if the sender's IP has been saved before but with a
   different MAC address mapped or a different ingress nickname
   associated with the same pair of IP/MAC, the RBridge SHOULD verify if
   a duplicate IP address has already been in use or an end station has
   changed its attaching RBridge. 

Original:

   The RBridge MAY use an IA APPsub-TLV [RFC7961] with the Local flag
   set to distribute the sender's MAC and IP mapping information.




-->
	<t>
   To support such ARP/ND optimization, edge RBridges need to know an end station's
   IP-to-MAC mapping through manual configuration
   (management), control-plane mechanisms such as directories
   <xref target="RFC8171"/>, or data-plane learning by snooping of messages
   such as ARP/ND (including DHCP or gratuitous ARP messages).</t>

	<t>
   When all the end station's IP/MAC address mapping is known to edge
   RBridges, provisioned through management, or learned via the control
   plane on the edge RBridges, it should be possible to completely
   suppress flooding of ARP/ND messages in a TRILL campus. When all end station
   MAC addresses are similarly known, it should be possible to
   suppress unknown unicast flooding by dropping any unknown unicast
   received at an edge RBridge.</t>

	<t>
   An ARP/ND optimization mechanism should include provisions for an
   edge RBridge to issue an ARP/ND request to an attached end station to
   confirm or update information and should allow an end station to
   detect duplication of its IP address.</t>

	<t>
   Most of the end station hosts send either DHCP messages requesting an
   IP address or gratuitous ARP or Reverse Address Resolution Protocol (RARP) requests to announce
   themselves to the network right after they come online. Thus, the
   local edge RBridge will immediately have the opportunity to snoop and
   learn their MAC and IP addresses and distribute this information to
   other edge RBridges through the TRILL control-plane End Station Address Distribution Information (ESADI) <xref target="RFC7357"/>
   protocol. Once remote RBridges receive this information via the
   control plane, they should add IP-to-MAC mapping information to their
   ARP/ND cache along with the nickname and Data Label of the address
   information. Therefore, most active IP hosts in the TRILL network can be
   learned by the edge RBridges through either local learning or
   control-plane-based remote learning. As a result, ARP suppression can
   vastly reduce the network flooding caused by host ARP learning
   behavior.</t>

	<t>
   When complete directory information is available, the default data-plane
   learning of end-station MAC addresses is not only
   unnecessary but could be harmful if there is learning based on frames
   with forged source addresses. Such data-plane learning can be
   suppressed because TRILL already provides an option to disable data-plane
   learning from the source MAC address of end-station frames (see
   Section 5.3 of <xref target="RFC6325"/>).</t>

	</section>

	<section title="IP/MAC Address Mappings" anchor="section-3"><t>

<!--[rfced] FYI - we have tried to rewrite this sentence to avoid overhyphenation.  Please let us know if we have obscured your intended meaning.

Original:
   By default, an RBridge [RFC6325] [RFC7172] learns MAC Address and
   Data Label (VLAN or FGL) to egress nickname mapping information from
   TRILL data frames it receives.

Edited:
By default, an RBridge [RFC6325] [RFC7172] learns nickname mapping
information regarding the connection from MAC address and Data Label
(VLAN or FGL) to egress from TRILL data frames it receives.

-->
   By default, an RBridge <xref target="RFC6325"/> <xref target="RFC7172"/> learns nickname mapping information  regarding the connection from MAC address and
   Data Label (VLAN or FGL) to egress  from
   TRILL data frames it receives. No IP address information is learned
   directly from the TRILL data frame. The IA
   APPsub-TLV <xref target="RFC7961"/> enhances the TRILL base protocol by allowing IP
   and MAC address mappings to be distributed in the control plane by
   any RBridge. This APPsub-TLV appears inside the TRILL GENINFO TLV in
   ESADI <xref target="RFC7357"/>, but the value data structure it specifies may also
   occur in other application contexts. Edge RBridge Directory Assist
   Mechanisms <xref target="RFC8171"/> make use of this APPsub-TLV for its push model
   and use the value data structure it specifies in its pull model.</t>

	<t>
   An RBridge can easily know the IP/MAC address mappings of the local
   end stations that it is attached to via its access ports by
   receiving ARP <xref target="RFC0826"/> or ND <xref target="RFC4861"/> messages. If the edge RBridge
   has extracted the sender's IP/MAC address pair from the received data
   frame (either ARP or ND), it may save the information and then use
   the IA APPsub-TLV to link the IP and MAC addresses and distribute it
   to other RBridges through ESADI. Then, the relevant remote RBridges
   (normally those interested in the same Data Label as the original
   ARP/ND messages) also receive and save such mapping information.
   There are other ways that RBridges save IP/MAC address mappings in
   advance, e.g., importing them from the management system and distributing them by
   directory servers <xref target="RFC8171"/>.</t>

	<t>
   The examples given above show that RBridges might have saved an end station's
   triplet of {IP address, MAC address, ingress nickname} for
   a given Data Label (VLAN or FGL) before that end station sends or
   receives any real data packet. Note that such information might or might
   not be a complete list and might or might not exist on all RBridges;
   the information could possibly be from different sources. RBridges
   can then use the Flags field in an IA APPsub-TLV to identify if the
   source is a directory server or local observation by the sender. A
   different confidence level may also be used to indicate the
   reliability of the mapping information.</t>
	</section>

	<section title="Handling ARP/ND/SEND Messages" anchor="section-4"><t>
   A native frame that is an ARP <xref target="RFC0826"/> message is detected by its
   Ethertype of 0x0806. A native frame that is an ND <xref target="RFC4861"/> is
   detected by being one of five different ICMPv6 packet types. ARP/ND
   is commonly used on a link to (1) query for the MAC address
   corresponding to an IPv4 or IPv6 address, (2) test if an IPv4/IPv6
   address is already in use, or (3) announce the new or updated info
   on any of the following: IPv4/IPv6 address, MAC address, and/or point of attachment.</t>

	<t>To simplify the text, we use the following terms in this section.
<list style="numbers">
	<t>IP address -- indicated protocol address that is normally an IPv4
     address in ARP or an IPv6 address in ND.</t>

	<t>sender's IP/MAC address -- sender IP/MAC address in ARP, source
     IP address, and source link-layer address in ND.</t>

	<t>target's IP/MAC address -- target IP/MAC address in ARP, target
     address, and target link-layer address in ND.</t>
	</list>
	</t>

	<t>
   When an ingress RBridge receives an ARP/ND/SEND message, it can
   perform the steps described within the subsections below. In
   particular, <xref target="section-4.4"/> describes the options for such an ingress
   handling an ARP/ND message and, in the cases where it forwards the
   message, <xref target="section-4.5"/> describes how to handle any response that may be
   returned due to the forwarded message.</t>

	<t>
   <xref target="section-4.3"/> describes the extraction of address information by an
   RBridge from ARP/ND messages it handles. Under some circumstances,
   this extraction may prompt verification with an end station. <xref target="section-4.2"/> describes an optional use of ARP/ND messages originated by
   RBridges to verify addresses or liveness.</t>

	<t>
   As described in <xref target="section-4.1"/>, SEND messages are not optimized by the
   mechanisms specified in this document but are snooped on.</t>

	<section title="SEND Considerations" anchor="section-4.1"><t>
   Secure Neighbor Discovery (SEND) <xref target="RFC3971"/> is a method of securing ND
   that addresses the threats discussed in <xref target="RFC3756"/>. Typical TRILL
   campuses are inside data centers, Internet exchange points, or
   carrier facilities. These are generally controlled and protected
   environments where these threats are of less concern. Nevertheless,
   SEND provides an additional layer of protection.</t>

	<t>
   Secure SEND messages require knowledge of cryptographic keys. Methods
   of communicating such keys to RBridges for use in SEND are beyond the
   scope of this document. Thus, using the optimizations in this
   document, RBridges do not attempt to construct SEND messages and are
   generally transparent to them. RBridges only construct ARP, RARP, or
   insecure ND messages, as appropriate. Nevertheless, RBridges
   implementing ARP/ND optimization SHOULD snoop on SEND messages to
   extract the addressing information that would be present if the SEND
   had been sent as an insecure ND message and is still present in the
   SEND message.</t>

	</section>

	<section title="Address Verification" anchor="section-4.2"><t>
   RBridges may use ARP/ND to probe directly attached or remote end
   stations for address or liveness verification. This is typically most
   appropriate in less-managed and/or higher-mobility environments. In
   strongly managed environments, such as a typical data center, where a
   central orchestration/directory system has complete addressing
   knowledge <xref target="RFC7067"/>, optimized ARP/ND responses can use that
   knowledge. In such cases, there is little reason for verification
   except for debugging operational problems or the like.</t>

	</section>

	<section title="Extracting Local Mapping Information for End-Station IP/MAC Addresses" anchor="section-4.3"><t>
   Edge RBridges extract and use information about the correspondence
   between local end-station IP and MAC addresses from the ARP/ND
   messages those end stations send, as described below. An apparent zero
   source IP address means that the end station is probing for duplicate
   IP addresses, and messages with such a zero source IP address are not
   used for the extraction of IP/MAC address mapping information.</t>

	<t><list style="symbols"><t>If the sender's IP is not present in the ingress RBridge's ARP/ND
      cache, populate the information of the sender's IP/MAC address in its ARP/ND
      cache table. The ingress RBridge correlates its nickname and that
      IP/MAC address mapping information. Such a triplet of {IP address, MAC address,
      ingress nickname} information is saved locally and can be distributed
      to other RBridges, as explained later.</t>

	<t>Else, if the sender's IP has been saved before but with a
      different MAC address mapped or a different ingress nickname
      associated with the same pair of IP/MAC, the RBridge SHOULD verify if
      a duplicate IP address has already been in use or an end station has
      changed its attaching RBridge. The RBridge may use different
      strategies to do so. For example, the RBridge might ask an
      authoritative entity like directory servers or it might encapsulate
      and unicast the ARP/ND message to the location where it believes the
      address is in use (<xref target="section-4.2"/>). RBridge SHOULD update the saved
      triplet of {IP address, MAC address, ingress nickname} based on the
      verification results. An RBridge might not verify an IP address if
      the network manager's policy is to have the network behave, for each
      Data Label, as if it were a single link and just believe an ARP/ND it
      receives.</t>

	</list>
	</t>

	<t>
   The ingress RBridge MAY use the IA APPsub-TLV <xref target="RFC7961"/> with the
   Local flag set in ESADI <xref target="RFC7357"/> to distribute any new or updated
   triplet of {IP address, MAC address, ingress nickname} information
   obtained. If a Push Directory server is used, such information can be
   distributed as specified in <xref target="RFC8171"/>.</t>

	</section>

	<section title="Determining How to Reply to ARP/ND" anchor="section-4.4"><t>
   The options for an edge RBridge to handle a native ARP/ND are given
   below. For generic ARP/ND requests seeking the MAC address
   corresponding to an IP address, if the edge RBridge knows the IP
   address and corresponding MAC, behavior is as in item (a), otherwise
   behavior is as in item (b). Behavior for gratuitous ARP and ND
   unsolicited Neighbor Advertisements (NAs) <xref target="RFC4861"/> is given in item (c).
   And item (d) covers the handling of an Address Probe ARP query. Within each
   lettered item, it is an implementation decision as to which numbered
   strategy to use for any particular ARP/ND query falling under that
   item.</t>

	<t><list style="letters">
<t>If the message is a generic ARP/ND request, and the ingress RBridge
	knows the target's IP address and associated MAC address, the ingress
      RBridge MUST take one or a combination of the actions below. In the
      case of SEND <xref target="RFC3971"/>, cryptography
      would prevent a local reply by the ingress RBridge, since the RBridge
      would not be able to sign the response with the target's private key,
      and only action a.2 or a.5 is valid.

<list style="format a.%d." hangIndent="6">
        <t>Send an ARP/ND response directly to the querier, using the
	target's MAC address present in the ingress RBridge's ARP/ND cache
           table. Because the edge RBridge might not have an IPv6 address, the
           source IP address for such an ND response MUST be that of the
           target end station.
	</t>

	<t>Encapsulate the ARP/ND/SEND request to the target's
	Designated RBridge and have the egress RBridge for the target forward the
           query to the target. This behavior has the advantage that a
           response to the request is authoritative. If the request does not
           reach the target, then the querier does not get a response.
	</t>

	<t>Block ARP/ND requests that occur for some time after a request
	to the same target has been launched, and then respond to the
           querier when the response to the recently launched query to that
           target is received.
	</t>

	<t>Reply to the querier based on directory information <xref target="RFC8171"/>
	such as information obtained from a Pull Directory server or
           directory information that the ingress RBridge has requested to be
           pushed to it.</t>

	<t>Flood the ARP/ND/SEND request as per <xref target="RFC6325"/>.
	</t>

	</list>
	</t>

	<t>If the message is a generic ARP/ND/SEND request and the ingress
	RBridge does not know the target's IP address, the ingress RBridge MUST
      take one of the following actions.  In the case of SEND <xref target="RFC3971"/>, cryptography would prevent local reply by
      the ingress RBridge, since the RBridge would not be able to sign the
      response with the target's private key; therefore, only action b.1 is
      valid.

<list style="format b.%d." hangIndent="6">
<t>Flood the ARP/ND/SEND message as per <xref target="RFC6325"/>.</t>

<t>Use a directory server to pull the information <xref target="RFC8171"/> and
reply to the querier.
</t>

<t>Drop the message if there should be no response because the
	directory server gives authoritative information that the address
           being queried is nonexistent.
	</t>
	</list>
	</t>

	<t>If the message is a gratuitous ARP, which can be identified by
	the same sender's and target's "protocol" address fields, or an
      unsolicited Neighbor Advertisement <xref target="RFC4861"/> in ND/SEND then:
	<vspace blankLines="1"/>
	The RBridge MAY use an IA APPsub-TLV <xref target="RFC7961"/> with the Local flag
      set to distribute the sender's MAC and IP mapping information. When
      one or more directory servers are deployed and complete Push
      Directory information is used by all the RBridges in the Data Label,
      a gratuitous ARP or unsolicited NA SHOULD be discarded rather than
      ingressed. Otherwise, they are either ingressed and flooded as per
      <xref target="RFC6325"/> or discarded depending on local policy.
	</t>

	<t>If the message is an Address Probe ARP query <xref target="RFC5227" />, which can
	be identified by the sender's protocol (IPv4) address field being
      zero and the target's protocol address field being the IPv4 address
      to be tested or a Neighbor Solicitation for Duplicate Address
      Detection (DAD) that has the unspecified source address <xref target="RFC4862"/>, it
      SHOULD be handled as the generic ARP message as in (a) or (b) above.
	</t>

	</list>
	</t>

	</section>

	<section title="Determining How to Handle the ARP/ND Response" anchor="section-4.5"><t>

<!--[rfced] This document does not contain Section 3.2.  We updated
the following to reference "Section 4.4, item a.2"; if this is
not correct, please let us know.

Original:
If the ingress RBridge R1 decides to unicast the ARP/ND request to
the target's egress RBridge R2 as discussed in subsection 3.2 item
a.2 or to flood the request as per [RFC6325] and item a.5, then R2
decapsulates the query, and initiates an ARP/ND query on the target's
link. 

Current:
If the ingress RBridge R1 decides to unicast the ARP/ND request to
the target's egress RBridge R2 as discussed in Section 4.4, item
a.2 or to flood the request as per item a.5 and [RFC6325], then R2
decapsulates the query and initiates an ARP/ND query on the target's
link. 
-->

   If the ingress RBridge R1 decides to unicast the ARP/ND request to
   the target's egress RBridge R2 as discussed in <xref target="section-4.4"/>, item
   a.2 or to flood the request as per item a.5 and <xref target="RFC6325"/>, then R2
   decapsulates the query and initiates an ARP/ND query on the target's
   link. If and when the target responds, R2 encapsulates and unicasts
   the response to R1, which decapsulates the response and sends it to
   the querier. R2 SHOULD initiate a link state update to inform all the
   other RBridges of the target's location, Layer 3 address, and Layer 2
   address, in addition to forwarding the reply to the querier.

 <!-- [rfced] The citation tag "[IA-draft]" has no corresponding reference entry
 in the References section.  

Please provide us with the appropriate reference information and let us know 
if the entry should be listed as a normative or an informative reference. 

Original:
The update uses an IA APPsub-TLV [IA-draft] (so the layer 3 and layer 2
addresses can be linked) with the Local flag set in ESADI [RFC7357]
or as per [RFC8171] if push directory server is in use.
-->

   The
   update uses an IA APPsub-TLV [IA-draft] (so the Layer 3 and Layer 2
   addresses can be linked) with the Local flag set in ESADI <xref target="RFC7357"/>
   or as per <xref target="RFC8171"/> if the Push Directory server is in use.</t>

	</section>

	</section>

	<section title="Handling of Reverse Address Resolution Protocol (RARP) Messages" anchor="section-5"><t>

<!--[rfced] This document does not contain Section 3.2.  We updated
the following to reference "Section 4.4, items a. and b."; if
this is not correct, please let us know.

Current:
Its processing is similar to the generic ARP Request/Response 
as described in Section 4.4, items a. and b.
-->
   RARP <xref target="RFC0903"/> uses the same packet format as ARP but different
   Ethertype (0x8035) and opcode values. Its processing is similar to
   the generic ARP request/response as described in <xref target="section-4.4"/>, items a. and b.  The
   difference is that it is intended to query for the target "protocol"
   (IP) address corresponding to the target "hardware" (MAC) address
   provided. It SHOULD be handled by doing a local cache or directory
   server lookup on the target "hardware" address provided to find a
   mapping to the desired "protocol" address.</t>

	</section>

	<section title="Handling of DHCP Messages" anchor="section-6"><t>
   When a newly connected end station exchanges messages with a DHCP
   <xref target="RFC3315"/><xref target="RFC2131"/> server, an edge RBridge should snoop them (mainly
   the DHCPAck message) and store IP/MAC address mapping information in its
   ARP/ND cache and should also send the information out through the
   TRILL control plane using ESADI.</t>

	</section>

	<section title="Handling of Duplicate IP Addresses" anchor="section-7"><t>
   Duplicate IP addresses within a Data Label can occur due to an
   attacker sending fake ARP/ND messages or due to human/configuration
   errors. If complete directory information is available, then, by
   definition, the IP location information in the directory is correct.
   Any appearance of an IP address in a different place (different edge
   RBridge or port) from other sources is not correct.</t>

	<t>
   Without complete directory information, the ARP/ND optimization
   function should support duplicate IP detection. This is critical in a
   data center to stop an attacker from using ARP/ND spoofing to divert
   traffic from its intended destination.</t>

	<t>
   Duplicate IP addresses can be detected when an existing active IP/MAC address
   mapping gets modified. Also, an edge RBridge may send a query called a
   Duplicate Address Detection query (DAD-query) asking about the IP
   address in question to the former owner of that IP address by using
   the MAC address formerly associated with that IP address. A DAD&nbhy;query
   is a unicast ARP/ND message with sender IP 0.0.0.0 in case of ARP (or
   a configurable IP address per RBridge called the DAD-Query source IP)
   and an IPv6 Link Local Address in case of ND with the source MAC set to
   the DAD-querier RBridge's MAC. If the querying RBridge does not
   receive an answer within a given time, it may be a case of mobility;
   in any case, the new IP entry will be confirmed and activated in
   its ARP/ND cache.</t>

	<t>
   In the case where the former owner replies, a duplicate address has
   been detected. In this case, the querying RBridge SHOULD log the
   duplicate so that the network administrator can take appropriate
   action.</t>

	<t>
   It is an implementation choice how to respond to a query for an
   address that is duplicated in the network when authoritative
   information is not available from a directory or configuration.
   Typically, the information most recently snooped is returned.</t>

	</section>

	<section title="RBridge ARP/ND Cache Liveness and MAC Mobility" anchor="section-8"><t>
   A maintenance procedure is needed for RBridge ARP/ND caching to
   ensure IP end stations connected to ingress RBridges are still
   active.</t>

	<t>
   Some links provide a physical-layer indication of link liveness. A
   dynamic proxy ARP/ND entry (one learned from data-plane observation)
   MUST be removed from the table if the link over which it was learned
   fails.</t>

	<t>
   Similarly, a dynamic proxy ARP/ND entry SHOULD be flushed out of the
   table if the IP/MAC address mapping has not been refreshed within a given
   age-time. The entry is refreshed if an ARP or ND message is received
   for the same IP/MAC address mapping entry from any location. The IP/MAC address
   mapping information Ageing Timer is configurable per RBridge and
   defaults to 3/4 of the MAC address learning Ageing Timer <xref target="RFC6325"/>.</t>

	<t>

   For example, end station "A" is connected to edge-RBridge1 (RB1) and
   has been learned as a local entry on RB1. If end station "A" moves to
   some other location (MAC / Virtual Machine (VM) Mobility) and gets connected to edge&nbhy;RBridge
   (RB2), after learning on RB2's access port, RB2 advertises
   this entry through the TRILL control plane, and it is learned on RB1
   as a remote entry. The old entry on RB1 SHOULD get replaced, and all
   other edge-RBridges with end-station service enabled for that Data
   Label should update the entry to show reachability from RB2 instead
   of RB1.</t>

	<t>
   If an ARP/ND entry in the cache is not refreshed, then the RBridge
   connected to that end station MAY send periodic refresh messages
   (ARP/ND "probes") to that end station, so that the entries can be
   refreshed before they age out. The end station would reply to the
   ARP/ND probe, and the reply resets the corresponding entry age-timer.</t>

	</section>

	<section title="Security Considerations" anchor="section-9"><t>
   There are generally two modes of learning the address information
   that is the basis of ARP/ND optimization: data-plane mode and
   directory mode. The data-plane mode is the traditional bridge address
   learning <xref target="IEEE802.1Q"/> that is also implemented in TRILL switches
   <xref target="RFC6325"/> and is discussed in <xref target="section-9.1"/>. The directory mode uses
   data obtained from a directory <xref target="RFC8171"/> and is discussed in <xref target="section-9.2"/>. The TRILL confidence-level feature, which can help arbitrate
   between conflicting address information, is discussed in <xref target="section-9.3"/>.</t>

	<t>
   RBridges should rate limit ARP/ND queries injected into the TRILL
   campus to limit some potential denial-of-service attacks.</t>

	<section title="Data-Plane-Based Considerations" anchor="section-9.1"><t>
   Generally speaking, when ARP/ND optimization is operating in the data-plane
   mode, the information learned by RBridges is the same as that
   which is learned by end stations. Thus, the answers generated by
   RBridges to the query messages being optimized are generally those
   that would be generated by end stations in the absence of
   optimization, and the security considerations are those of the
   underlying ARP/ND protocols.</t>

	<t>
   RBridges that snoop on DHCPack messages respond to ARP/ND messages in
   essentially the same way that the end stations sending those DHCPack
   messages would. Thus, for security considerations of ARP/ND
   optimization for DHCP messages that may be snooped, see the Security
   Considerations sections of <xref target="RFC3315"/> and <xref target="RFC2131"/>.</t>

	<t>
   Unless SEND <xref target="RFC3971"/> is used, ARP and ND messages can be
   easily forged. Therefore, the learning of IP/MAC addresses by RBridges
   from ARP/ND is hackable, but this is what is available for data-plane
   learning without SEND. See "SEND Considerations", <xref target="section-4.1"/>.</t>

	<t>
   Since end stations communicate with edge RBridges using Ethernet,
   some security improvements could be obtained by the use of <xref target="IEEE802.1AE"/>
   between end stations and edge RBridges. Such link security would
   impose requirements on edge stations, while TRILL is generally
   designed to operate with unmodified, TRILL-ignorant end stations, and
   is beyond the scope of this document</t>

	<t>
   ARP/ND address mapping information learned locally at an RBridge can
   be distributed to other RBridges using the TRILL ESADI protocol that
   can be secured as specified in <xref target="RFC7357"/>. (ESADI is also used for
   Push Directories with flags in the data indicating whether data comes
   from a directory or from data-plane learning, as well as from a confidence
   level (see <xref target="section-9.3"/>).)</t>

	</section>

	<section title="Directory-Based Considerations" anchor="section-9.2"><t>
   ARP/ND optimization can be based on directory information <xref target="RFC8171"/>.
   If the directory information is known to be trustworthy and complete,
   then trustworthy responses to ARP/ND queries can be entirely based on
   this information. This bounds the damage that forged ARP/ND messages
   can do to the local link between end stations and edge RBridges. (In
   TRILL, such a "link" can be a bridged LAN.)</t>

	<t>
   Of course, there can also be incomplete and/or unreliable directory
   address mapping data. The network administrator can configure their
   TRILL campus to use such directory data in place of data-plane-learned data. Alternatively, such directory data can be used along
   with data-plane-learned data arbitrated by the confidence level as discussed
   in <xref target="section-9.3"/>.</t>

	</section>

	<section title="Use of the Confidence Level Feature" anchor="section-9.3"><t>
   An RBridge can use the confidence level in IA APPsub-TLV information
   received via ESADI or Pull Directory retrievals to determine the
   configured relative reliability of IP/MAC address mapping information
   from those sources and from locally learned address information.
<!--[rfced] we notice that RFC 7357 does not specifically mention the
'push directory' but RFC 8171 does. Does the following sentence
perhaps need an update?

Original:
ESADI / push directory information can be secured as provided in
[RFC7357] and pull directory information can be secured as provided
in [RFC8171]. 

Perhaps:
ESADI information can be secured as provided in [RFC7357] and
push/pull directory information can be secured as provided
in [RFC8171]. 
-->

   ESADI / Push Directory information can be secured as provided in
   <xref target="RFC7357"/>, and Pull Directory information can be secured as provided
   in <xref target="RFC8171"/>. The implementation decides if an RBridge will
   distribute the IP and MAC address mappings received from local native
   ARP/ND messages to other RBridges in the same Data Label, and with
   what confidence level it does so. Thus, the implementer can, to some
   extent, cause sources that they know are more reliable to dominate
   those they know to be less reliable. How the implementer determines
   this is beyond the scope of this document.</t>

	</section>

	</section>

	<section title="IANA Considerations" anchor="section-10"><t>
This document does not require any IANA actions.</t>

	</section>

	</middle>

	<back>

<!--[rfced] May we sort the references in alphabetical order?-->

	<references title="Normative References">
	&RFC0826;
	&RFC0903;
	&RFC2119;
	&RFC2131;
	&RFC3315;
	&RFC4861;
	&RFC4862;
	&RFC6325;
	&RFC7172;
 <!-- [rfced] The following normative reference is not cited in the text.  Please let
us know where it should be cited or if this reference should be deleted 
from the References section.

Original:
[RFC7356]  Ginsberg, L., Previdi, S., and Y. Yang, "IS-IS Flooding
           Scope Link State PDUs (LSPs)", RFC 7356, September 2014.
 -->
	&RFC7356;
	&RFC7357;
	&RFC7780;
	&RFC7961;
	&RFC8171;
	&RFC8174;
	</references>

	<references title="Informative References">
	<reference anchor="IEEE802.1AE"><front>
	<title>IEEE Standard for Local and metropolitan area networks: Media Access Control (MAC) Security</title>
	<author>
	<organization>IEEE</organization>
	</author>
	<date/>
	</front>
        <seriesInfo name="IEEE Std" value="802.1AE" />
	</reference>

	<reference anchor="IEEE802.1Q"><front>
	<title>IEEE Standard for Local and metropolitan area networks -- Bridges and Bridged Networks</title>
	<author>
	<organization>IEEE</organization>
	</author>
	<date/>
	</front>
        <seriesInfo name="IEEE Std" value="802.1Q" />
	</reference>

	&RFC3756;
	&RFC3971;
	&RFC5227;
	&RFC6820;
	&RFC6823;
	&RFC7042;
	&RFC7067;
	</references>
	<section title="Acknowledgments" numbered="no" anchor="acknowledgments"><t>
   The authors would like to thank Igor Gashinsky and Sue Hares for
   their contributions.</t>


	</section>

	</back>

	</rfc>
	
