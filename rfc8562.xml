<?xml version="1.0" encoding="US-ASCII"?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd">
<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>
<?rfc toc="yes"?>
<?rfc tocdepth="4"?>
<?rfc symrefs="yes"?>
<?rfc sortrefs="yes" ?>
<?rfc compact="yes" ?>
<?rfc subcompact="no" ?>
<rfc category="std" number="8562" ipr="trust200902" updates="5880" submissionType="IETF" consensus="yes">


  <front>
    <title abbrev="BFD for Multipoint Networks">
	Bidirectional Forwarding Detection (BFD) for Multipoint Networks
    </title>

 
    <author fullname="Dave Katz" initials="D." surname="Katz">
      <organization>Juniper Networks</organization>
      <address>
		<postal>
		<street> 1194 N. Mathilda Ave.</street>
		<city>Sunnyvale</city>
		<region>California</region>
		<code> 94089-1206</code>
		<country>United States of America</country>
	    </postal>
        <email>dkatz@juniper.net</email>
      </address>
    </author>

    <author fullname="Dave Ward" initials="D." surname="Ward">
      <organization>Cisco Systems</organization>
      <address>
		<postal>
		<street> 170 West Tasman Dr.</street>
		<city>San Jose</city>
		<region>California</region>
		<code>95134</code>
		<country>United States of America</country>
	    </postal>
        <email>wardd@cisco.com</email>
      </address>
    </author>
	
	 <author fullname="Santosh Pallagatti" initials="S." role="editor" surname="Pallagatti">
      <organization>VMware</organization>
      <address>
        <email>santosh.pallagatti@gmail.com</email>
      </address>
    </author>
    
    	 <author fullname="Greg Mirsky" initials="G." role="editor" surname="Mirsky">
      <organization>ZTE Corp.</organization>
      <address>
        <email>gregimirsky@gmail.com</email>
      </address>
    </author>


    <date month="March" year="2019"/>

    <area>BFD Working Group</area>
    <workgroup>Internet Engineering Task Force</workgroup>

    <keyword>BFD</keyword>
    <keyword>Multipoint BFD</keyword>


    <abstract>
    	<t>This document describes extensions to the Bidirectional Forwarding Detection (BFD) protocol for its use in multipoint and multicast networks.</t>
    	<t>This document updates RFC 5880.</t>

    </abstract>

  </front>

  <middle>
    <section title="Introduction" anchor="Intro">

<t>
The Bidirectional Forwarding Detection (BFD) protocol <xref target="RFC5880"/> specifies a method for verifying unicast connectivity between a pair of systems. 
This document updates <xref target="RFC5880"/> by defining a new method for using BFD. This new method
provides verification of multipoint or multicast connectivity between a multipoint sender (the "head") 
and a set of one or more multipoint receivers (the "tails").
</t>
 
<t>
As multipoint transmissions are inherently unidirectional, this
mechanism purports only to verify this unidirectional connectivity. 
Although this seems in conflict with the "Bidirectional" in BFD,
the protocol is capable of supporting this use case.
Use of BFD in Demand mode allows a tail to monitor the availability
of a multipoint path even without the existence of some kind of a
return path to the head. As an option, if a return path from a tail to the head exists,
the tail may notify the head of the lack of multipoint connectivity. 
Details of tail notification to the head are outside the scope of this document
and are discussed in <xref target="RFC8563"/>.
</t>

<t>
This application of BFD allows for the tails to detect a lack of connectivity from the head.
For some applications, such detection of the failure at the tail is useful, for example, the use of
multipoint BFD to enable fast failure detection and faster failover in multicast VPN as described in
<xref target="MVPN-FAILOVER"/>.
Due to its unidirectional nature, virtually all options and timing parameters are controlled by the head.
</t>

<t>
Throughout this document, the term "multipoint" is defined as a mechanism by which one or more systems 
receive packets sent by a single sender. This specifically includes such
things as IP multicast and point-to-multipoint MPLS.
</t>
<t>
The term "connectivity" in this document is not being used in the context of connectivity verification in a transport network
but as an alternative to "continuity", i.e., the existence of a forwarding path between the sender and the receiver.
</t>

<t>
This document effectively updates and extends the base BFD specification <xref target="RFC5880"/>.
</t>

    </section>
	
	<section title="Keywords">
        <t>
    The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL
    NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED",
    "MAY", and "OPTIONAL" in this document are to be interpreted as
    described in BCP&nbsp;14 <xref target="RFC2119"/> <xref target="RFC8174"/> 
    when, and only when, they appear in all capitals, as shown here.
        </t>
	</section>

<section title="Goals">

<t>
The primary goal of this mechanism is to allow tails to rapidly detect
 the fact that multipoint connectivity from the head has failed.
 </t>

<t>
Another goal is for the mechanism to work on any multicast technology.
</t>

<t>
A further goal is to support multiple, overlapping point-to-multipoint paths, as well as 
multipoint-to-multipoint paths, and to allow point-to-point BFD sessions to operate simultaneously 
among the systems participating in multipoint BFD.
</t>

<t>
It is not a goal for this protocol to verify point-to-point bidirectional connectivity between 
the head and any tail. This can be done independently (and with no penalty in
protocol overhead) by using point-to-point BFD.
</t>

   </section>


    <section title="Overview">
 
<t>
The heart of this protocol is the periodic transmission of BFD Control packets along a multipoint
path, from the head to all tails on the path. The contents of the BFD packets provide the means 
for the tails to calculate the Detection Time for path failure. If no BFD Control packets are 
received by a tail for a Detection Time, the tail declares that the path has failed. For some applications, this is 
the only mechanism necessary;  the head can remain ignorant of the status of connectivity to the tails.
</t>

<t>
The head of a multipoint BFD session may wish to be alerted to the tails' connectivity (or lack thereof). 
Details of how the head keeps track of tails and how tails alert their connectivity to the
head are outside the scope of this document and are discussed in <xref target="RFC8563"/>.
</t>

<t>
Although this document describes a single head and a set of tails spanned by a single multipoint path,
the protocol is capable of supporting (and discriminating between) more than one multipoint path at both heads and tails,
as described in Sections <xref target="disc-demux-sec" format="counter"/> and <xref target="DEMUX" format="counter"/>.
Furthermore, the same head and tail may share multiple multipoint paths, and a multipoint path may have multiple heads.
</t>

   </section>

   
<section title="Protocol Details">

	<t>This section describes the operation of Multipoint BFD in detail.</t>

	<section title="Multipoint BFD Control Packets">

		<t>
		Multipoint BFD Control packets (packets sent by the head over a multipoint path) are 
		explicitly marked as such, via the setting of the Multipoint (M) bit <xref target="RFC5880"/>. This means that multipoint BFD 
		does not depend on the recipient of a packet to know whether the packet was received 
		over a multipoint path.  This can be useful in scenarios where this information may not be available to the recipient.
		</t>
    
	</section>

	<section title="Session Model">
		<t>
		Multipoint BFD is modeled as a set of sessions of different types. 
		The elements of procedure differ slightly for each type.
		</t>
	
		<t>
		The head has a session of type MultipointHead, as defined in <xref target="new-state-sec"/>, that is bound to a multipoint path. 
    Multipoint BFD Control packets are sent by this session over the multipoint path, 
    and no BFD Control packets are received by it.
    </t>
		
		<t>
		Each tail has a session of type MultipointTail, as defined in <xref target="new-state-sec"/>, associated with a multipoint path. 
		These sessions receive BFD Control packets from the head over the multipoint path.
		</t>
	
	</section>

	<section title="Session-Failure Semantics">

		<t>The semantics of session failure is subtle enough to warrant further explanation.</t>
	
		<t>MultipointHead sessions cannot fail (since they are controlled administratively).</t>
	
		<t>
		If a MultipointTail session fails, it means that the tail definitely has lost contact with 
		the head (or the head has been administratively disabled), and the tail may use 
		mechanisms other than BFD, e.g., logging or NETCONF <xref target="RFC6241"/>,
		to send a notification to the user.
		</t>
		
	</section>

	<section title="State Variables">
		
		<t>Multipoint BFD introduces some new state variables and modifies the usage of a few existing ones.</t>
		

				<section anchor="new-state-sec" title="New State Variable Values">
			<t>A number of new values of the state variable bfd.SessionType are added to the base BFD <xref target="RFC5880"/>
			and base Seamless Bidirectional Forwarding Detection (S-BFD) <xref target="RFC7880"/> specifications in support of multipoint BFD.
				<list style="empty">
					<t>bfd.SessionType
						<list style="empty">
							<t>The type of this session as defined in <xref target="RFC7880"/>. Newly added values are:
								<list style="empty">
									<t>PointToPoint:  Classic point-to-point BFD, as described in <xref target="RFC5880"/>.</t>
									<t>MultipointHead:  A session on the head responsible for the periodic transmission of multipoint BFD Control packets along the multipoint path.</t>
									<t>MultipointTail:  A multipoint session on a tail.</t>
								</list>
							</t>
							<t>This variable MUST be initialized to the appropriate type when the session is created.</t>
						</list>
					</t>
				</list>
			</t>

		</section>
		
		<section title="State Variable Initialization and Maintenance">
			<t>Some state variables defined in Section 6.8.1 of <xref target="RFC5880"/> need to be initialized or manipulated differently depending on the session type.
				<list style="empty">
										
					<t>bfd.RequiredMinRxInterval
						<list style="empty">
							<t>This variable MUST be initialized to zero for session type MultipointHead.</t>
						</list>
					</t>
					
					<t>bfd.DemandMode
						<list style="empty">
							<t>This variable MUST be initialized to 1 for session type
							 MultipointHead and MUST be initialized to
							 zero for session type MultipointTail.
							</t>
						</list>
					</t>
				</list>
			</t>
		</section>
	
	</section>
	
	<section title="State Machine">
	
		<t>
		There are slight differences in how the BFD state machine works in the multipoint application.  
		In particular, since there is a many-to-one mapping, three-way handshakes for 
		session establishment and teardown are neither possible nor appropriate. As such, there is no Init state.
		Sessions of type MultipointHead MUST NOT send BFD Control packets with the State field being set to 
		INIT, and those packets MUST be ignored on receipt.
		</t>
		
		<t>
		The following diagram provides an overview of the state machine for session type MultipointTail. 
		The notation on each arc represents the state of the remote system (as received in the State field in the 
		BFD Control packet) or indicates the expiration of the Detection Timer. 
                        
                        <figure align="left"><preamble/><artwork align="left"><![CDATA[                      DOWN, ADMIN DOWN,
                    +------+  TIMER               +------+
               +----|      |<---------------------|      |----+
          DOWN,|    | DOWN |                      |  UP  |    |UP
    ADMIN DOWN,+--->|      |--------------------->|      |<---+
         TIMER      +------+          UP          +------+
                        
                        ]]></artwork></figure>
                
                Sessions of type MultipointHead never receive packets and have no Detection Timer; as such, all state transitions are administratively driven.
                </t>
                
                
        </section>
        
        
        <section title="Session Establishment">
        
                <t>
                Unlike point-to-point BFD, multipoint BFD provides a form of the discovery mechanism that enables tails to discover the head. 
                The minimum amount of a priori information required both on the head and tails is the binding to the multipoint path 
                over which BFD is running.  The head transmits multipoint BFD packets on that path, and the tails listen for BFD 
                packets on that path.  All other information can be determined dynamically.
                </t>
                
                <t>
                A session of type MultipointHead is created for each multipoint path over which the head wishes to run BFD. 
                This session runs in the Active role, per Section 6.1 of <xref target="RFC5880"/>.  
                Except when administratively  terminating BFD service, this session is always in state Up 
                and always operates in Demand mode.  No received packets are ever demultiplexed to the MultipointHead session.
                In this sense, it is a degenerate form of a session.
                </t> 
                
                <t>
                Sessions on the tail MAY be established dynamically, based on the receipt of a multipoint BFD Control 
                packet from the head, and are of type MultipointTail.  Tail sessions always take the Passive role, per Section 6.1 of <xref target="RFC5880"/>.
                </t>
                                
        </section>      
        
        
        <section title="Discriminators and Packet Demultiplexing" anchor="disc-demux-sec">
                <t>
                The use of discriminators is somewhat different in multipoint BFD than in point-to-point BFD.
                </t>
                
                <t>
                The head sends multipoint BFD Control packets over the multipoint path via the MultipointHead session with 
                My Discriminator set to a value bound to the multipoint path and with Your Discriminator set to zero.
                </t>
                
                <t>
                IP and MPLS multipoint tails MUST demultiplex BFD packets based on a combination 
                of the source address, My Discriminator, and the identity of the multipoint path that the multipoint BFD Control 
                packet was received from. Together they uniquely identify the head of the multipoint path. Bootstrapping a BFD 
                session to multipoint MPLS Label Switched Path (LSP) 
                may use the control plane, e.g., as described in <xref target="MVPN-FAILOVER"/>,
                and  is outside the scope of this document.
                </t>
                
                
                <t>
                Note that, unlike point-to-point sessions, the My Discriminator value on the MultipointHead session 
                MUST NOT be changed during the life of a session.  This is a side effect of the more 
                complex demultiplexing scheme.
                </t>
                                
        </section>
        
        <section title="Packet Consumption on Tails">
                <t>
                BFD packets received on tails for an IP multicast group MUST be consumed by tails and MUST NOT be forwarded to receivers. 
                Nodes with the BFD session of type MultipointTail MUST identify packets received on an IP multipoint path
as a BFD Control packet if the destination UDP port value equals 3784.
                   </t>
                   <t>
                   For multipoint LSPs, when IP/UDP encapsulation of BFD Control packets is used,
      MultipointTail MUST expect destination UDP port 3784. The destination IP address of a BFD
      Control packet MUST be in the 127.0.0.0/8 range for IPv4 or
      in the 0:0:0:0:0:FFFF:7F00:0/104 range for IPv6. The use of these destination addresses is consistent
      with the explanations and usage in <xref target="RFC8029"/>. Packets identified as BFD packets MUST
                   be consumed by MultipointTail and demultiplexed as described in <xref target="DEMUX"/>.
                   Use of other types of encapsulation of the BFD control message over multipoint LSP  is outside the scope of this document.
                   </t>
        </section>
        
        <section title="Bringing Up and Shutting Down Multipoint BFD Service">
                <t>
                Because there is no three-way handshake in multipoint BFD, a newly started head (that does not have any 
                previous state information available) SHOULD start with bfd.SessionState set to Down, and bfd.RequiredMinRxInterval 
                MUST be set to zero in the MultipointHead session. The session SHOULD remain in 
                this state for a time equal to (bfd.DesiredMinTxInterval * bfd.DetectMult).
                This will ensure that all MultipointTail sessions are reset (so long as the 
                restarted head is using the same or a larger value of bfd.DesiredMinTxInterval than it did previously).
                </t>
                
                <t>
                Multipoint BFD service is brought up by administratively setting bfd.SessionState to Up in the MultipointHead session. 
                </t>
                
                <t>
                The head of a multipoint BFD session may wish to shut down its 
                BFD service in a controlled fashion. This is desirable because the tails 
                need not wait for a Detection Time prior to declaring the multipoint session 
                to be down (and taking whatever action is necessary in that case). 
                </t>
                
                <t>
                To shut down a multipoint session in a controlled fashion, the head
                MUST administratively set bfd.SessionState in the MultipointHead 
                session to either Down or AdminDown and SHOULD set 
                bfd.RequiredMinRxInterval to zero. The session SHOULD send BFD
                Control packets in this state for a period equal to (bfd.DesiredMinTxInterval * bfd.DetectMult).
                Alternatively, the head MAY stop transmitting BFD Control packets 
                and not send any more BFD Control packets with the new state (Down or AdminDown). Tails
                will declare the multipoint session down only after the Detection Time interval runs out.
                </t>

        </section>
        
        
        
        <section title="Timer Manipulation">
                <t> 
                Because of the one-to-many mapping, a session of type MultipointHead SHOULD NOT initiate a 
                Poll Sequence in conjunction with timer value changes. However, to indicate a change in the packets, a MultipointHead 
                session MUST send packets with the P bit set. A MultipointTail session MUST NOT
                reply if the packet has the M and P bits set and bfd.RequiredMinRxInterval set to zero.
                Because the Poll Sequence is not used, the tail cannot negotiate down MultpointHead's
                transmit interval. If the value of Desired Min TX Interval in the BFD Control packet received by MultipointTail 
                is too high (that determination may change in time based on the current environment),
                it must be handled by the implementation and may be controlled by local policy, e.g., close the MultipointTail session.
                </t>

                <t>
                The MultipointHead, when changing the transmit interval to a higher value,
    MUST send BFD Control packets with the P bit set at the old transmit interval 
                before using the higher value in order to avoid false detection timeouts at the tails. 
                A MultipointHead session MAY also wait some 
                amount of time before making the changes to the transmit interval (through configuration).
                </t>
                
                <t>Change in the value of bfd.RequiredMinRxInterval is outside the scope of this 
                document and is discussed in <xref target="RFC8563"/>.</t>
                
        </section>
        
        
        <section title="Detection Times" anchor="DETECT">
                <t>Multipoint BFD is inherently asymmetric.  As such, each session type has a different approach to Detection Times.</t>
                
                <t>Since MultipointHead sessions never receive packets, they do not calculate a Detection Time.</t>
                                
                <t>
                MultipointTail sessions cannot influence the transmission rate of the MultipointHead session using the 
                Required Min Rx Interval field because of its one-to-many nature.  As such, the Detection Time calculation 
                for a MultipointTail session does not use bfd.RequiredMinRxInterval. The Detection Time is 
                calculated as the product of the last received values of Desired Min TX Interval and Detect Mult.
                </t>
                
                <t>The value of bfd.DetectMult may be changed at any time on any session type.</t>
                
        </section>
        
        <section title="State Maintenance for Down/AdminDown Sessions">
                
                <t>
                The length of time the session state is kept after the session
		goes down determines 
                how long the session will continue to send BFD Control packets (since no packets can be sent after the session is destroyed).
                </t>
                
                <section title="MultipointHead Sessions">
                        <t>
                        When a MultipointHead session transitions to states Down or AdminDown, the state 
                        SHOULD be maintained for a period equal to (bfd.DesiredMinTxInterval * bfd.DetectMult) to 
                        ensure that the tails more quickly detect the session going down (by continuing to transmit BFD Control packets with the new state). 
                        </t>
        
                </section>
                
                <section title="MultipointTail Sessions">
                        <t> MultipointTail sessions MAY be destroyed immediately upon leaving Up state, since the tail will transmit no packets.</t> 
                        
                        <t>
                        Otherwise, MultipointTail sessions SHOULD be maintained as long as 
                        BFD Control packets are being received by it (which by definition will 
                        indicate that the head is not Up).
                        </t>
                </section>
                
        </section>
        
        <section title="Base Specification Text Replacement" anchor="RFC5880_REPLACE">
                <t>The following sections are meant to replace the corresponding sections in the base specification <xref target="RFC5880"/>
                to support BFD for multipoint networks while not changing processing for point-to-point BFD.</t>
                
                <section title="Reception of BFD Control Packets">
                        <t>The following procedure replaces Section 6.8.6 of
			<xref target="RFC5880"/> entirely.</t>
                        
                        <t>
                        When a BFD Control packet is received, the following procedure MUST 
                        be followed, in the order specified.  If the packet is discarded according to these 
                        rules, processing of the packet MUST cease at that point.
                                <list style="empty">
                                        <t>If the version number is not correct (1), the packet MUST be discarded.</t>
                                        <t> If the Length field is less than the minimum correct value (24 if
                                        the A bit is clear, or 26 if the A bit is set), the packet MUST be
                                        discarded.
                                        </t>
                                        <t>If the Length field is greater than the payload of the
                                        encapsulating protocol, the packet MUST be discarded.
                                        </t>
                                        <t>If the Detect Mult field is zero, the packet MUST be discarded.</t>
                                        <t>If the My Discriminator field is zero, the packet MUST be discarded.</t>
                                        <t>Demultiplex the packet to a session according to <xref target="DEMUX"/>.
                                        The result is either a session of the proper type, or the
                                        packet is discarded (and packet processing MUST cease).
                                        </t>
                                        <t>If the A bit is set and no authentication is in use (bfd.AuthType
                                        is zero), the packet MUST be discarded.
                                        </t>
                                        <t>If the A bit is clear and authentication is in use (bfd.AuthType
                                        is nonzero), the packet MUST be discarded.
                                        </t>
                                        <t>If the A bit is set, the packet MUST be authenticated under the
                                        rules of Section 6.7 of <xref target="RFC5880"/>, based on the authentication type in use
                                        (bfd.AuthType).  This may cause the packet to be discarded.
                                        </t>
                                        <t>Set bfd.RemoteDiscr to the value of My Discriminator.</t>
                                        <t>Set bfd.RemoteState to the value of the State (Sta) field.</t>
                                        <t>Set bfd.RemoteDemandMode to the value of the Demand (D) bit.</t>
                                        <t>Set bfd.RemoteMinRxInterval to the value of Required Min RX Interval.</t>
                                                                                
                                        <t>If the Required Min Echo RX Interval field is zero, the
                                        transmission of Echo packets, if any, MUST cease.</t>
                                        
                                        <t>If a Poll Sequence is being transmitted by the local system and the Final (F) bit in the received packet is set, the Poll Sequence MUST be terminated.</t>

                                        <t>If bfd.SessionType is PointToPoint, update the
                                        transmit interval as described in
					Section 6.8.2 of <xref target="RFC5880"/>.
                                        </t>
                                        <t>If bfd.SessionType is PointToPoint, update the Detection Time as
                                        described in Section 6.8.4 of <xref target="RFC5880"/>.
                                        </t>
                                        <t>Else
                                        <list style="empty">
                                        <t>
                                        If bfd.SessionType is MultipointTail,
                                        then update the Detection Time as the product of the last received values of Desired Min 
                                        TX Interval and Detect Mult, as described in <xref target="DETECT"/> of this specification.
                                        </t>
                                        </list>
                                        </t>

                                        <t>If bfd.SessionState is AdminDown
                                                <list style="empty">
                                                        <t>Discard the packet</t>
                                                </list>
                                        </t>
                                        <t>If the received State is AdminDown
                                                <list style="empty">
                                                        <t>If bfd.SessionState is not Down
                                                                <list style="empty">
                                                                        <t>Set bfd.LocalDiag to 3 (Neighbor signaled session down)</t>
                                                                        <t>Set bfd.SessionState to Down</t>
                                                                </list>
                                                        </t>
                                                </list>
                                        </t>
                                        <t>Else
                                                <list style="empty">
                                                        <t>If bfd.SessionState is Down
                                                                <list style="empty">
                                                                        <t>If bfd.SessionType is PointToPoint
                                                                                <list style="empty">
                                                                                        <t>If received State is Down
                                                                                                <list style="empty">
                                                                                                        <t>Set bfd.SessionState to Init</t>
                                                                                                </list>
                                                                                        </t>
                                                                                        <t>Else if received State is Init
                                                                                                <list style="empty">
                                                                                                        <t>Set bfd.SessionState to Up</t>
                                                                                                </list>
                                                                                        </t>
                                                                                </list>
                                                                        </t>
                                                                        <t>Else (bfd.SessionType is not PointToPoint)
                                                                                <list style="empty">
                                                                                        <t>If received State is Up
                                                                                                <list style="empty">
                                                                                                        <t>Set bfd.SessionState to Up</t>
                                                                                                </list>
                                                                                        </t>
                                                                                </list>
                                                                        </t>
                                                                </list>
                                                        </t>
                                                        <t>Else if bfd.SessionState is Init
                                                                <list style="empty">
                                                                        <t>If received State is Init or Up
                                                                                <list style="empty">
                                                                                        <t>Set bfd.SessionState to Up</t>
                                                                                </list>
                                                                        </t>
                                                                </list>
                                                        </t>
                                                        <t>Else (bfd.SessionState is Up)
                                                                <list style="empty">
                                                                        <t>If received State is Down
                                                                                <list style="empty">
                                                                                        <t>Set bfd.LocalDiag to 3 (Neighbor signaled session down)</t>
                                                                                        <t>Set bfd.SessionState to Down</t>
                                                                                </list>
                                                                        </t>
                                                                </list>
                                                        </t>
                                                </list>
                                        </t>
                                        <t>Check to see if Demand mode should become active or not (see <xref target="RFC5880"/>, Section 6.6).</t>
                                        <t>If bfd.RemoteDemandMode is 1, bfd.SessionState is Up, and
                                        bfd.RemoteSessionState is Up, Demand mode is active on the remote
                                        system and the local system MUST cease the periodic transmission
                                        of BFD Control packets (see <xref target="TRANSMIT"/>).
                                        </t>
                                        <t>If bfd.RemoteDemandMode is zero, bfd.SessionState is not Up, or
                                        bfd.RemoteSessionState is not Up, Demand mode is not active on the
                                        remote system and the local system MUST send periodic BFD Control
                                        packets (see <xref target="TRANSMIT"/>).
                                        </t>
                                        <t>
          If the Poll (P) bit is set, and bfd.SessionType is
          PointToPoint, send a BFD Control packet to the
         remote system with the Poll (P) bit clear, and the Final (F) bit set
         (see <xref target="TRANSMIT"/>).
         </t>
                                        <t>If the packet was not discarded, it has been received for purposes
                                        of the Detection Time expiration rules
					in Section 6.8.4 of <xref target="RFC5880"/>.
                                        </t>
                                </list>
                        </t>

                </section>
                
                <section title="Demultiplexing BFD Control Packets" anchor="DEMUX">
                        <t>This section is part of the replacement for Section
			6.8.6 of <xref target="RFC5880"/>; it is separated for clarity.
                                <list style="empty">
                                        <t>If the Multipoint (M) bit is set
                                                <list style="empty">
                                                        <t>If the Your Discriminator field is nonzero, the packet MUST be discarded.</t>
                                                        <t>Select a session based on the source address, My Discriminator, and the identity
                                                                of the multipoint path on which the multipoint BFD Control packet was received.</t>
                                                                <t>If a session is found, and bfd.SessionType is not MultipointTail, the packet MUST be
                                                                discarded.</t>
                                                                <t>Else
                                                                <list style="empty">
                                                                <t>If a session is not found, a new session of type
                                                                MultipointTail MAY be created, or the packet MAY be discarded.
                                                                This choice can be controlled by the local policy, e.g., by
                                                                setting a maximum number of MultipointTail sessions.
              Use of the local policy and the exact mechanism of it are outside the scope of this specification.</t>
                                                                </list>
                                                                </t>
                                                        
                                                        
                                                </list>
                                        </t>
                                        <t>Else (Multipoint (M) bit is clear)
                                                <list style="empty">
                                                        <t>If the Your Discriminator field is nonzero
                                                                <list style="empty">
                                                                        <t>Select a session based on the value of Your Discriminator. If no session is found, the packet MUST be discarded.</t>
                                                                </list>
                                                        </t>
                                                        <t>Else (Your Discriminator is zero)
                                                                <list style="empty">
                                                                        <t>If the State field is not Down or AdminDown, the packet MUST be discarded.</t>

                                                                        <t>Otherwise, the session MUST be selected based on some
                                                                        combination of other fields, possibly including source
                                                                        addressing information, the My Discriminator field, and the
                                                                        interface over which the packet was received.  The exact
                                                                        method of selection is application specific and is thus
                                                                        outside the scope of this specification.
                                                                        </t>

                                                                        <t>If a matching session is found, and bfd.SessionType is not
                                                                        PointToPoint, the packet MUST be discarded.
                                                                        </t>

                                                                        <t>If a matching session is not found, a new session of type
                                                                        PointToPoint MAY be created, or the packet MAY be discarded.
                                                                        This choice MAY be controlled by a local policy and is outside the scope of this specification.
                                                                        </t>
                                                                </list>
                                                        </t>
                                                        <t>If the State field is Init and bfd.SessionType is not PointToPoint, the packet MUST be discarded.</t>
                                                </list>
                                        </t>
                                </list>
                        </t>
                        
                </section>
                
                <section title="Transmitting BFD Control Packets" anchor="TRANSMIT">
                        <t>The following procedure replaces Section 6.8.7 of
			<xref target="RFC5880"/> entirely.</t>
                        <t>
                           With the exceptions listed in the remainder of this section, a system
   MUST NOT transmit BFD Control packets at an interval less than the
   larger of bfd.DesiredMinTxInterval and bfd.RemoteMinRxInterval, less
   applied jitter (see below).  In other words, the system reporting the
   slower rate determines the transmission rate.
                        </t>
                        <t>
                           The periodic transmission of BFD Control packets MUST be jittered on
   a per-packet basis by up to 25%; that is, the interval MUST be
   reduced by a random value of 0 to 25%, in order to avoid self-
   synchronization with other systems on the same subnetwork.  Thus, the
   average interval between packets will be roughly 12.5% less than that
   negotiated.
   </t>
   <t>
   If bfd.DetectMult is equal to 1, the interval between transmitted BFD
   Control packets MUST be no more than 90% of the negotiated
   transmission interval and MUST be no less than 75% of the negotiated
   transmission interval.  This is to ensure that, on the remote system,
   the calculated Detection Time does not pass prior to the receipt of
   the next BFD Control packet.
   </t>

                        <t>A system MUST NOT transmit any BFD Control packets if bfd.RemoteDiscr is zero and the system is taking the Passive role. </t>
                        
                        <t>A system MUST NOT transmit any BFD Control packets if bfd.SessionType is MultipointTail.</t>
                        
                        <t>
                        A system MUST NOT periodically transmit BFD Control packets if Demand mode 
                        is active on the remote system (bfd.RemoteDemandMode is 1, bfd.SessionState is Up, 
                        and bfd.RemoteSessionState is Up), and a Poll Sequence is not being transmitted.
                        </t>
                        
                        <t>A system MUST NOT periodically transmit BFD Control packets if bfd.RemoteMinRxInterval is zero.</t>
                                                
                        <t>
                        If bfd.SessionType is MultipointHead, the transmit interval MUST be set to
                         bfd.DesiredMinTxInterval (this should happen automatically, as bfd.RemoteMinRxInterval will be zero). 
                         </t>
                        
                        <t>
                        If bfd.SessionType is not MultipointHead, the transmit interval MUST be recalculated whenever 
                        bfd.DesiredMinTxInterval changes, or whenever bfd.RemoteMinRxInterval changes, and is equal to 
                        the greater of those two values.  See Sections 6.8.2
			and 6.8.3 of <xref target="RFC5880"/> for details on transmit timers. 
                        </t>
                                                
                        <t>A system MUST NOT set the Demand (D) bit if bfd.SessionType is MultipointTail.</t>
                        
                        <t>
                        A system MUST NOT set the Demand (D) bit if bfd.SessionType is PointToPoint unless bfd.DemandMode is 1, bfd.SessionState is Up, and bfd.RemoteSessionState is Up.
                        </t>
                        
                        <t>
                        If bfd.SessionType is PointToPoint or MultipointHead, a BFD Control packet 
                        SHOULD be transmitted during the interval between periodic Control packet transmissions 
                        when the contents of that packet would differ from that in the previously transmitted packet 
                        (other than the Poll (P) and Final (F) bits) in order to more rapidly communicate a change in state.
                        </t>
                        
                        <t>The contents of transmitted BFD Control packets MUST be set as follows:
                                <list style="empty">
                                        <t>Version
                                                <list style="empty">
                                                        <t>Set to the current version number (1).</t>
                                                </list>
                                        </t>
                                        <t>Diagnostic (Diag)
                                                <list style="empty">
                                                        <t>Set to bfd.LocalDiag.</t>
                                                </list>
                                        </t>
                                        <t>State (Sta)
                                                <list style="empty">
                                                        <t>Set to the value indicated by bfd.SessionState.</t>
                                                </list>
                                        </t>
                                        <t>Poll (P)
                                                <list style="empty">
                                                        <t>Set to 1 if the local system is sending a Poll Sequence or is a
                                                        session of type MultipointHead soliciting the identities of the
                                                        tails, or zero if not.
                                                        </t>
                                                </list>
                                        </t>

                                        <t>Final (F)
                                                <list style="empty">
                                                        <t>Set to 1 if the local system is responding to a BFD Control packet received with the Poll (P) bit set, or zero if not.</t>
                                                </list>
                                        </t>
                                        <t>Control Plane Independent (C)
                                                <list style="empty">
                                                        <t>Set to 1 if the local system's BFD implementation is independent
                                                        of the control plane (it can continue to function through a
                                                        disruption of the control plane).</t>
                                                </list>
                                        </t>
                                        <t>Authentication Present (A)
                                                <list style="empty">
                                                        <t>Set to 1 if authentication is in use in this session (bfd.AuthType is nonzero), or zero if not.</t>
                                                </list>
                                        </t>
                                        <t>Demand (D)
                                                <list style="empty">
                                                        <t>Set to bfd.DemandMode if bfd.SessionState is Up and
                                                        bfd.RemoteSessionState is Up.  Set to 1 if bfd.SessionType is
                                                        MultipointHead.  Otherwise, it is set to zero.
                                                        </t>
                                                </list>
                                        </t>
                                        <t>Multipoint (M)
                                                <list style="empty">
                                                        <t>Set to 1 if bfd.SessionType is MultipointHead.  Otherwise, it is set to zero.</t>
                                                </list>
                                        </t>
                                        
                                        <t>Detect Mult
                                                <list style="empty">
                                                        <t>Set to bfd.DetectMult.</t>
                                                </list>
                                        </t>
                                        <t>Length
                                                <list style="empty">
                                                        <t>Set to the appropriate length, based on the fixed header length
                                                        (24) plus any Authentication Section.
                                                        </t>
                                                </list>
                                        </t>
                                        <t>My Discriminator
                                                <list style="empty">
                                                        <t>Set to bfd.LocalDiscr.</t>
                                                </list>
                                        </t>
                                        <t>Your Discriminator
                                                <list style="empty">
                                                        <t>Set to bfd.RemoteDiscr.</t>
                                                </list>
                                        </t>
                                        <t>Desired Min TX Interval
                                                <list style="empty">
                                                        <t>Set to bfd.DesiredMinTxInterval.</t>
                                                </list>
                                        </t>
                                        <t>Required Min RX Interval
                                                <list style="empty">
                                                        <t>Set to bfd.RequiredMinRxInterval.</t>
                                                </list>
                                        </t>
                                        <t>Required Min Echo RX Interval
                                                <list style="empty">
                                                        <t>
                                                        Set to zero if bfd.SessionType is MultipointHead or MultipointTail.
                                                        Otherwise, set to the minimum required Echo packet receive interval for this
      session. If this field is set to zero, the local system is
      unwilling or unable to loop back BFD Echo packets to the remote
      system, and the remote system will not send Echo packets.
      </t>
                                                </list>
                                        </t>
                                        <t>Authentication Section
                                                <list style="empty">
                                                        <t>Included and set according to the rules
							in Section 6.7 of <xref target="RFC5880"/>
							if authentication is in use (bfd.AuthType is nonzero).  Otherwise,
                                                        this section is not present.
                                                        </t>
                                                </list>
                                        </t>
                                </list>
                
                        </t>
                </section>
        
        </section>
                
</section>


<section title="Congestion Considerations">
        <t>
            As a foreword, although congestion can occur because of a number of
    factors, it should be noted that high transmission rates are by
    themselves subject to creating congestion either along the path or at
    the tail end(s). As such, as stated in <xref target="RFC5883"/>:
    <list>
    <t>
<!--Begin DNE text-->
        it is required that the operator correctly provision the rates at
       which BFD is transmitted to avoid congestion (e.g link, I/O, CPU)
       and false failure detection.
 <!--End DNE text-->
    </t>
    </list>
        </t>
        <t>
        
    Use of BFD in multipoint networks, as specified in this document,
    over multiple hops requires consideration of the mechanisms to react
    to network congestion.  Requirements stated in Section 7 of the BFD
    base specification <xref target="RFC5880"/> equally apply to BFD in multipoint
    networks and are repeated here:
    <list>
    <t>
<!--Begin DNE text-->
       When BFD is used across multiple hops, a congestion control
       mechanism MUST be implemented, and when congestion is detected,
       the BFD implementation MUST reduce the amount of traffic it
       generates.
 <!--End DNE text-->
    </t>
    </list>
    </t>
    <t>
        The mechanism to control the load of BFD traffic MAY use BFD's
    configuration interface to control BFD state variable
    bfd.DesiredMinTxInterval. However, such a control loop does not form part
    of the BFD protocol itself, and its specification is thus outside the
    scope of this document.
    </t>
    <t>
       Additional considerations apply to BFD in multipoint networks, as
    specified in this document.

   Indeed, because a tail does not transmit
   any BFD Control packets to the head of the BFD session, such a head
   node has no BFD-based mechanism and thus is not aware of the state of the
   session at the tail.


    In the absence of any other mechanism, the head
    of the session could thus continue to send packets towards the
    tail(s) even though a link failure has happened.
    In such a scenario, when it is required for the head of the session to be
    aware of the state of the tail of the session, it is RECOMMENDED to
    implement the extension described in <xref target="RFC8563"/>.
    </t>

</section>

<section title="IANA Considerations">
	<t>This document has no IANA actions.</t>
</section>

<section title="Security Considerations">
	<t>
	The same security considerations as those described in <xref target="RFC5880"/> apply to this document. 
	Additionally, implementations that create MultpointTail sessions dynamically upon receipt of 
	multipoint BFD Control packets MUST implement protective measures to prevent 
	an infinite number of MultipointTail sessions from from being created. Below are some points to consider in such implementations.
		<list style="empty">
			<t>
			If a multipoint BFD Control packet did not arrive on a multicast path (e.g., on the expected interface,
			with the expected MPLS label, etc.), a MultipointTail session should not be created.
			</t>
		
			<t>
			If redundant streams are expected for a given multicast stream, the implementations should not create more MultipointTail 
			sessions than the number of streams. Additionally, when the number of MultipointTail sessions exceeds the number of expected 
			streams, the implementation should generate an alarm to users to indicate the anomaly.
			</t>
		<t>
      The implementation should have a reasonable upper bound on the
      number of MultipointHead sessions that can be created, with the
      upper bound potentially being computed based on the load these
      would generate.
      </t>
			<t>
			The implementation should have a reasonable upper bound on the number of MultipointTail sessions 
			that can be created, with the upper bound potentially being computed based on the number of 
			multicast streams that the system is expecting.
			</t>
		</list>
	</t>
		<t>
	If authentication is in use, the head and all tails may be configured to have a common 
	authentication key in order for the tails to validate multipoint BFD Control packets.
	</t>
	
	<t>
   Shared keys in multipoint scenarios allow any tail to spoof 
   the head from the viewpoint of any other tail. For this reason,
   using shared keys to authenticate BFD Control packets in multipoint
   scenarios is a significant security exposure unless all tails can 
   be trusted not to spoof the head. Otherwise, asymmetric
message authentication would be needed, e.g., protocols that use Timed Efficient Stream 
Loss-Tolerant Authentication (TESLA) as described in <xref target="RFC4082"/>. Applicability
of the asymmetric message authentication to BFD for multipoint networks is outside the scope
of this specification and is for further study.
</t>
</section>

    
  </middle>


  <back>


    <references title="Normative References">
	
	  <?rfc include="reference.RFC.5880"?>
	  <?rfc include="reference.RFC.7880"?>
	  <?rfc include="reference.RFC.2119"?>
	  <?rfc include="reference.RFC.8174"?>
	  <?rfc include="reference.RFC.8029"?>

    </references>
    
    <references title="Informative References">

<!--draft-ietf-bfd-multipoint-active-tail; RFC 8563-->
<reference anchor="RFC8563" target="https://www.rfc-editor.org/info/rfc8563">
<front>
<title>Bidirectional Forwarding Detection (BFD) Multipoint Active Tails</title>
<author initials="D" surname="Katz" fullname="Dave Katz">
    <organization/>
</author>
<author initials="D" surname="Ward" fullname="David Ward">
    <organization/>
</author>
<author initials="S" surname="Pallagatti" fullname="Santosh Pallagatti" role="editor">
    <organization/>
</author>
<author initials="G" surname="Mirsky" fullname="Gregory Mirsky" role="editor">
    <organization/>
</author>
<date month="March" year="2019"/>
</front>
<seriesInfo name="RFC" value="8563"/>
<seriesInfo name="DOI" value="10.17487/RFC8563"/>
</reference>


<!--draft-ietf-bess-mvpn-fast-failover-05; Active - I-D Exists-->
<reference anchor="MVPN-FAILOVER">
<front>
<title>Multicast VPN fast upstream failover</title>
<author initials="T" surname="Morin" fullname="Thomas Morin" role="editor">
    <organization/>
</author>
<author initials="R" surname="Kebler" fullname="Robert Kebler" role="editor">
    <organization/>
</author>
<author initials="G" surname="Mirsky" fullname="Gregory Mirsky" role="editor">
    <organization/>
</author>
<date month="February" year="2019"/>
</front>
<seriesInfo name="Work in Progress," value="draft-ietf-bess-mvpn-fast-failover-05"/>
</reference>

    <?rfc include="reference.RFC.4082"?>
    <?rfc include="reference.RFC.5883"?>
    <?rfc include="reference.RFC.6241"?>
     
    </references>

<section title="Acknowledgments" numbered="no">

	<t>
	The authors would like to thank Nobo Akiya, Vengada Prasad Govindan, Jeff Haas, Wim Henderickx, 
	Gregory Mirsky, and Mingui Zhang who have greatly contributed to this document.
	</t>
	
</section>
    <section title="Contributors" numbered="no">

	<t>Rahul Aggarwal of Juniper Networks and George Swallow of Cisco
	Systems provided the initial idea for this specification and
	contributed to its development.</t> 
	
</section>


  </back>
</rfc>
