<?xml version="1.0" encoding="US-ASCII"?>
<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>

<?rfc toc="yes" ?>
<?rfc tocompact="yes" ?>
<?rfc rfcedstyle="yes" ?>
<?rfc subcompact="no" ?>
<?rfc symrefs="yes"?>
<?rfc sortrefs="yes" ?>

<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
  <!ENTITY rfc2119 PUBLIC '' 
  'http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml'>
  <!ENTITY rfc2131 PUBLIC '' 
  'http://xml.resource.org/public/rfc/bibxml/reference.RFC.2131.xml'>
  <!ENTITY rfc2132 PUBLIC '' 
  'http://xml.resource.org/public/rfc/bibxml/reference.RFC.2132.xml'>
  <!ENTITY rfc2473 PUBLIC '' 
  'http://xml.resource.org/public/rfc/bibxml/reference.RFC.2473.xml'>
  <!ENTITY rfc3775 PUBLIC '' 
  'http://xml.resource.org/public/rfc/bibxml/reference.RFC.3775.xml'>
  <!ENTITY rfc3046 PUBLIC '' 
  'http://xml.resource.org/public/rfc/bibxml/reference.RFC.3046.xml'>
  <!ENTITY rfc4213 PUBLIC '' 
  'http://xml.resource.org/public/rfc/bibxml/reference.RFC.4213.xml'>
  <!ENTITY rfc4361 PUBLIC '' 
  'http://xml.resource.org/public/rfc/bibxml/reference.RFC.4361.xml'>
  <!ENTITY rfc5107 PUBLIC '' 
  'http://xml.resource.org/public/rfc/bibxml/reference.RFC.5107.xml'>
  <!ENTITY rfc5213 PUBLIC '' 
  'http://xml.resource.org/public/rfc/bibxml/reference.RFC.5213.xml'>
  <!ENTITY rfc5555 PUBLIC '' 
  'http://xml.resource.org/public/rfc/bibxml/reference.RFC.5555.xml'>
  <!ENTITY rfc0925 PUBLIC '' 
  'http://xml.resource.org/public/rfc/bibxml/reference.RFC.0925.xml'>
  <!ENTITY rfc1332 PUBLIC '' 
  'http://xml.resource.org/public/rfc/bibxml/reference.RFC.1332.xml'>
  <!ENTITY rfc1918 PUBLIC '' 
  'http://xml.resource.org/public/rfc/bibxml/reference.RFC.1918.xml'>
  <!ENTITY rfc3022 PUBLIC '' 
  'http://xml.resource.org/public/rfc/bibxml/reference.RFC.3022.xml'>
  <!ENTITY rfc4306 PUBLIC '' 
  'http://xml.resource.org/public/rfc/bibxml/reference.RFC.4306.xml'>
  <!ENTITY rfc4436 PUBLIC '' 
  'http://xml.resource.org/public/rfc/bibxml/reference.RFC.4436.xml'>
  <!ENTITY rfc4977 PUBLIC '' 
  'http://xml.resource.org/public/rfc/bibxml/reference.RFC.4977.xml'>
]>


<rfc number="5844" category="std"  >

<!------------------------------------------------>
<!--  Front Section				                -->
<!------------------------------------------------>
<front>

<title abbrev="IPv4 Support for Proxy Mobile IPv6">
IPv4 Support for Proxy Mobile IPv6
</title>

<!-- AUTHORS -->
 <author initials="R." surname="Wakikawa" fullname="Ryuji Wakikawa">
     <organization abbrev="Toyota ITC">TOYOTA InfoTechnology Center, U.S.A., Inc.</organization>
        <address>
		<postal>
		    <street>465 Bernardo Avenue</street>
                    <city>Mountain View, CA  94043</city>
                    <country>USA</country>
		</postal>
                <email>ryuji@us.toyota-itc.com</email>
            </address>
        </author>
 <author initials="S." surname="Gundavelli" fullname="Sri Gundavelli">
     <organization>Cisco</organization>
        <address>
		<postal>
		    <street>170 West Tasman Drive</street>
                    <city>San Jose, CA  95134</city>
                    <country>USA</country>
		</postal>
                <email>sgundave@cisco.com</email>
            </address>
        </author>


<date  month="May" year="2010" />
<area>Internet</area>
<workgroup>NETLMM Working Group</workgroup>
<keyword>NAT traversal</keyword>
<keyword>Dual Stack</keyword>
<keyword>Mobility</keyword>
<!----------------------------------------------------------------------------->
<!--  SECTION 0: OVERVIEW                                                    -->
<!----------------------------------------------------------------------------->
<abstract> 
<t>    
This document specifies extensions to the Proxy Mobile IPv6 protocol for
adding IPv4 protocol support. The scope of IPv4 protocol support is 
two-fold: 1) enable IPv4 home address mobility support to the
mobile node, and 2) allow the mobility entities in the Proxy Mobile
IPv6 domain to exchange signaling messages over an IPv4 transport
network.
</t>
</abstract>
</front>


<!------------------------------------------------>
<!--  Middle Section				            -->
<!------------------------------------------------>
<middle>


<!----------------------------------------------------------------------------->
<!--  SECTION 1: OVERVIEW                                                    -->
<!----------------------------------------------------------------------------->
<section anchor="sec:overview" title="Overview">
<t>
The transition from IPv4 to IPv6 is a long process, and during this
period of transition, both the protocols will be enabled over the
same network infrastructure. Thus, it is reasonable to assume that a
mobile node in a Proxy Mobile IPv6 domain may operate in an IPv4-only,
IPv6-only, or dual-stack mode, and the network between
the mobile access gateway and a local mobility anchor may be an
IPv4 or an IPv6 network. It is also reasonable to expect the same
mobility infrastructure in the Proxy Mobile IPv6 domain to provide
mobility to the mobile nodes operating in IPv4, IPv6, or in dual mode
and whether the transport network is IPv4 or IPv6 network. The
motivation and scope of IPv4 support in Mobile IPv6 is summarized in
<xref target="RFC4977"/>, and all those requirements apply to Proxy Mobile IPv6
protocol as well.
</t>

<t>
The Proxy Mobile IPv6 protocol <xref target="RFC5213"/> specifies a mechanism for
providing IPv6 home address mobility support to a mobile node in a
Proxy Mobile IPv6 domain. The protocol requires IPv6 transport network
between the mobility entities. The extensions defined in this document
specify IPv4 support to the Proxy Mobile IPv6 protocol <xref target="RFC5213"/>.
</t>

<t>
The scope of IPv4 support in Proxy Mobile IPv6 includes the support
for the following two features:
</t>
    
<t><list style="symbols">     
<t> 
IPv4 Home Address Mobility Support: A mobile node that is dual-stack or
IPv4-only enabled will be able to obtain an IPv4 address and be able to use
that address from any of the access networks in that Proxy Mobile IPv6
domain. The mobile node is not required to be allocated or assigned an
IPv6 address to enable IPv4 home address support.
</t>
    
<t>
IPv4 Transport Network Support: The mobility entities in the Proxy
Mobile IPv6 domain will be able to exchange Proxy Mobile IPv6 signaling
messages over an IPv4 transport.

</t>    
</list></t>

<t>    
These two features, the IPv4 home address mobility support and the IPv4
transport support features, are independent of each other, and
deployments may choose to enable either one or both of these features as
required. 
</t>

<t>
<xref target="fig:pmip"/> shows a typical Proxy Mobile IPv6 domain with an IPv4
transport network and with IPv4 enabled mobile nodes. The terms used in this
illustration are explained in the Terminology section.
</t>

<figure anchor="fig:pmip"  title="IPv4 Support for Proxy Mobile IPv6">
<artwork>        
    <![CDATA[
            +----+                +----+
            |LMA1|                |LMA2|
            +----+                +----+
IPv4-LMAA  -> |          IPv4-LMAA-> | <-- LMAA
              |                      |
              \\                    //\\  
               \\                  //  \\  
                \\                //    \\     
             +---\\------------- //------\\----+
            (     \\  IPv4/IPv6 //        \\    )
            (      \\  Network //          \\   )
             +------\\--------//------------\\-+
                     \\      //              \\
                      \\    //                \\
                       \\  //                  \\
      IPv4-Proxy-CoA --> |                      | <-- Proxy-CoA
                      +----+                 +----+   
                      |MAG1|-----{MN2}       |MAG2|
                      +----+    |            +----+
     (MN-HoA)           |       |              | <-- (MN-HoA)
     (IPv4-MN-HoA) -->  |   (IPv4-MN-HoA)      | <-- (IPv4-MN-HoA)
                      {MN1}                   {MN3}
       
     ]]>        
</artwork>        
</figure> 




<!------------------------------------------------------>
<!--  SECTION 1.1: Stated Assumptions                 -->
<!------------------------------------------------------>             
<section anchor="sec:StatedAssumtions" title="Stated Assumptions">       
<t>
The following are the system and configuration requirements from the
mobility entities in the Proxy Mobile IPv6 domain for supporting the
extensions defined in this document.
</t>

<t><list style="symbols">     
<t>
Both the mobility entities, the local mobility anchor and the mobile
access gateway are dual-stack (IPv4/IPv6) enabled. Irrespective of the
type of transport network (IPv4 or IPv6) separating these two entities,
the mobility signaling is always based on Proxy Mobile IPv6 protocol 
<xref target="RFC5213"/>. 
</t>    

<t><!-- *JiK* -->
A deployment where a mobile access gateway uses an IPv4 private address 
with NAT <xref target="RFC3022"/> translation devices in the path to a
local mobility anchor is not supported by this specification.
</t>

<t>
The mobile node can be operating in IPv4-only, IPv6-only or in dual
mode. Based on the enabled configuration for a mobile node, the mobile 
node should be able to obtain IPv4-only, IPv6-only, or both IPv4 and IPv6
addresses for its interface and furthermore achieve mobility support for
those addresses.
</t>

<t>
For enabling IPv4 home address mobility support to a mobile node, it is
not required that the IPv6 home address mobility support need be
enabled. However, the respective protocol(s) support, such as IPv4 or
IPv6 packet forwarding, must be enabled on the access link between the
mobile node and the mobile access gateway.
</t>

<t>
The mobile node can obtain an IPv4 address for its attached interface.
Based on the type of link, it may be able to acquire its IPv4 address
configuration using standard IPv4 address configuration mechanisms such
as DHCP <xref target="RFC2131"/>, IP Control Protocol  (IPCP) <xref target="RFC1332"/>, Internet Key Exchange Protocol version 2 (IKEv2) <xref target="RFC4306"/>, or static address
configuration. However, the details on how IPCP or IKEv2 can be used
for address delivery are outside the scope of this document.
</t>

<t>
The mobile node's IPv4 home subnet is typically a shared address space.
It is not for the exclusive use of any one mobile node. There can be
multiple mobile nodes that are assigned IPv4 addresses from the same
subnet.
</t>

<t>
The mobile access gateway is the IPv4 default router for the mobile
node on its access link. It will be in the forwarding path for the
mobile node's data traffic. Additionally, as specified in Section 
6.9.3 of <xref target="RFC5213"/>, all the mobile access gateways in the Proxy
Mobile IPv6 domain MUST use the same link-layer address on any of the
access links wherever the mobile node attaches.
</t>      

</list></t>

</section> <!-- Stated Assumptions -->            




<!------------------------------------------------------------------->
<!--  SECTION 1.2: Relevance and Relation to Dual-Stack Mobile IPv6 -->
<!------------------------------------------------------------------->             
<section anchor="sec:RelevanceDSMIP6" title="Relevance to Dual-Stack Mobile IPv6">       
<t>
IPv4 support for Mobile IPv6 is specified in the Dual-Stack Mobile IPv6
specification <xref target="RFC5555"/>. This document leverages some of the
approaches,  messaging options, and processing logic defined in that
document for extending IPv4 support to Proxy Mobile IPv6, except with
deviation in some aspects for obvious reasons of supporting a 
network-based mobility model. The following are some of the related
considerations.
</t>

<!--t>TODO: this section may need more rewriting</t-->

<t><list style="symbols">     



<t><!-- *JiK* -->
The Binding Update message flag 'F' and the NAT Detection Option defined in 
Sections 3.1.3 and 3.2.2 of <xref target="RFC5555"/> are used by this
specification in Proxy Binding Update and Proxy Binding Acknowledgement
messages. Their sole purpose is to allow forcing of UDP encapsulation between
a mobile access gateway and a local mobility anchor in situations similar 
to those discussed in Sections 4.1 and 4.4.1 of <xref target="RFC5555"/>.
</t>

<t>
The necessary extensions to the conceptual data structures, Binding Cache
entry and Binding Update List entry, for storing the state related to
the IPv4 support defined in <xref target="RFC5555"/>, will all be needed and
relevant for this document.
</t>

<t>In Mobile IPv6 <xref target="RFC3775"/> and in Dual-Stack Mobile IPv6
<xref target="RFC5555"/>, IPsec security associations (SAs) are specific to a single
mobile node; they use the identifier visible to upper-layer protocols
(HoA/IPv4-HoA) as traffic selector; and the IKE/IPsec SAs need to be
updated when the mobile node moves.

<vspace blankLines="1" />
In Proxy Mobile IPv6 (both <xref target="RFC5213"/> and this document), the IPsec
SAs are specific to the mobile access gateway (and used for a potentially large number
of mobile nodes); they use the locators used for routing (Proxy-CoA/IPv4-Proxy-CoA)
as traffic selectors; and they are not updated when the mobile node moves.

<vspace blankLines="1" />This means the IPsec processing for Mobile IPv6 and
Proxy Mobile IPv6 (whether IPv6-only or dual-stack) is very different.
</t>

<t>
The tunneling considerations specified in <xref target="RFC5555"/> for supporting
IPv4 transport are relevant for this document as well.
</t>
</list></t>

</section> <!-- Relevant and Relation to DSMIPv6 -->
</section> <!-- Introduction -->




<!-------------------------------------------------------------------------------->
<!--  SECTION 2: CONVENTIONS & TERMINOLOGY                                      -->
<!-------------------------------------------------------------------------------->
<section anchor="sec:conventions and terminology" title="Conventions and Terminology">

<!--vspace blankLines="1" /-->

<!-------------------------------------------------------------------------------->
<!--  SECTION 2.1: CONVENTIONS                                                 --->
<!-------------------------------------------------------------------------------->
<section anchor="sec:conventions" title="Conventions">
<t>
The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
"SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
document are to be interpreted as described in RFC 2119 <xref target="RFC2119"/>.
</t>
</section> <!-- conventions -->


<!-------------------------------------------------------------------------------->
<!--  SECTION 2.2: TERMINOLOGY			                               --->
<!-------------------------------------------------------------------------------->
<section anchor="sec:terminology" title="Terminology">
<t>
All the mobility related terms used in this document are to be
interpreted as defined in the Mobile IPv6 specification <xref target="RFC3775"/> and
Proxy Mobile IPv6 specification <xref target="RFC5213"/>. In addition, this document
introduces the following terms.      
</t>

<t>
IPv4 Proxy Care-of Address (IPv4-Proxy-CoA)
</t>
<t><list style="hanging">
<t>
The IPv4 address that is configured on the egress-interface of the
mobile access gateway. When using IPv4 transport, this address will be
the registered care-of address in the mobile node's Binding Cache entry
and will also be the transport-endpoint of the tunnel between the local
mobility anchor and a mobile access gateway.
</t>
</list></t>
         
<t> 
IPv4 Local Mobility Anchor Address (IPv4-LMAA)
</t>
<t><list style="hanging">
<t>
The IPv4 address that is configured on the egress-interface of the
local mobility anchor. When using IPv4 transport, the mobile access
gateway sends the Proxy Binding Update messages to this address and
will be the transport-endpoint of the tunnel between the local mobility
anchor and the mobile access gateway.
</t>
</list></t>

<t>
Mobile Node's IPv4 Home Address (IPv4-MN-HoA)
</t>
<t><list style="hanging">
<t>
The IPv4 home address assigned to the mobile node's attached
interface. This address is topologically anchored at the mobile node's
local mobility anchor. The mobile node configures this address on its
attached interface. If the mobile node connects to the Proxy Mobile
IPv6 domain via multiple interfaces each of the interfaces are assigned
a unique IPv4 address. All the IPv6 home network prefixes and the IPv4
home address assigned to a given interface of a mobile node will be
managed under one mobility session.
</t>
</list></t>


<t>
Selective De-registration
</t>
<t><list style="hanging">
<t>
A procedure for partial de-registration of all the addresses that
belong to one address family, i.e., de-registration of either the IPv4
home address or one or more of the assigned IPv6 home network
prefixes.
</t>
</list></t>


<t>
Encapsulation Modes
</t>
<t><list style="hanging">
<t>
This document uses the following terms when referring to the different
encapsulation modes.

<list style="hanging">

 <t hangText="IPv4-or-IPv6-over-IPv6">
  </t><t>IPv4 or IPv6 packet carried as a payload of an IPv6 packet</t>


 <t hangText="IPv4-or-IPv6-over-IPv4">
  </t><t>IPv4 or IPv6 packet carried as a payload of an IPv4 packet</t>
  
 <t hangText="IPv4-or-IPv6-over-IPv4-UDP">
  </t><t>IPv4 or IPv6 packet carried as a payload in an IPv4 packet
         with a UDP header</t>

 <t hangText="IPv4-or-IPv6-over-IPv4-UDP-TLV">
  </t><t>IPv4 or IPv6 packet carried as a payload in an IPv4 packet with
         UDP and TLV headers</t>

 <t hangText="IPv4-or-IPv6-over-IPv4-GRE">
  </t><t>IPv4 or IPv6 packet carried as a payload in an IPv4 packet with a
         Generic Routing Encapsulation (GRE) header (but no UDP or TLV header)</t>


 
</list></t>
</list></t>
</section> <!-- Terminology -->
</section> <!-- Conventions & Terminology -->


<!------------------------------------------------------------------------->
<!--  SECTION: 3.0 IPv4 Home Address Mobility Support                   --->
<!------------------------------------------------------------------------->
<section anchor="sec:po" title="IPv4 Home Address Mobility Support">     
<t>
The IPv4 home address mobility support essentially enables a mobile
node in a Proxy Mobile IPv6 domain to obtain IPv4 home address
configuration for its attached interfaces and be able to retain that
address configuration even after performing a handoff anywhere within
that Proxy Mobile IPv6 domain. This section describes the protocol
operation and the required extensions to Proxy Mobile IPv6 protocol for
extending IPv4 home address mobility support.
</t>

<t>  
When an IPv4-enabled or a dual-stack-enabled mobile node attaches to
the Proxy Mobile IPv6 domain, the mobile access gateway on the access 
link where the mobile node is attached will identify the mobile node
and will initiate the Proxy Mobile IPv6 signaling with the mobile
node's local mobility anchor. The mobile access gateway will follow the
signaling considerations specified in <xref target="sec:IPv4hoa-mag-considerations"/>
for requesting IPv4 home address mobility support. Upon the completion of the
signaling, the local mobility anchor and the mobile access gateway will establish
the required routing states for allowing the mobile node to use its IPv4
home address from its current point of attachment.
</t>

<t>
The mobile node on the access link using any of the standard IPv4
address configuration mechanisms supported on that access link, such as
IPCP <xref target="RFC1332"/>, IKEv2 <xref target="RFC4306"/>, or DHCP <xref target="RFC2131"/>, will be able to
obtain an IPv4 home address (IPv4-MN-HoA) for its attached interface.
Although the address configuration mechanisms for delivering the
address configuration to the mobile node is independent of the Proxy
Mobile IPv6 protocol operation, there needs to be some
interaction between these two protocol flows. <xref target="sec:v4hoa-mag-dhcpint"/> identifies
these interactions for supporting DHCP-based address configuration. 
</t> 
   
<t>
The support for IPv4 home address mobility is not dependent on the IPv6
home address mobility support. It is not required that the IPv6 home
address mobility support needs to be enabled for providing IPv4 home
address mobility support. A mobile node will be able to obtain
IPv4-only, IPv6-only, or dual IPv4/IPv6 address configuration for its
attached interface. The mobile node's policy profile will determine if
the mobile node is entitled to both the protocol versions or a single
protocol version. Based on the policy, only those protocols will be
enabled on the access link. Furthermore, if the mobile node, after
obtaining the address configuration on its interface, performs a
handoff, either by changing its point of attachment over the same
interface or to a different interface, the network will ensure the
mobile node will be able to use the same IPv4 address configuration
after the handoff. 
</t>

<t>
Additionally,  if the mobile node connects to the Proxy Mobile IPv6
domain, through multiple interfaces and simultaneously through
different access networks, each of the connected interfaces will obtain
a unique IPv4 home address. In such a scenario, there
will be multiple Binding Cache entries for the mobile node on the local
mobility anchor. All the addresses (IPv4/IPv6) assigned to a given
interface will be managed as part of one mobility session, as specified
in Section 5.4 of <xref target="RFC5213"/>.
</t>


<!----------------------------------------------------------------------------->
<!--  SECTION: 3.1 Local Mobility Anchor Considerations                      -->
<!----------------------------------------------------------------------------->
<section title="Local Mobility Anchor Considerations" anchor="sec:v4hoa-lma-considerations">   

<!--vspace blankLines="1" /-->

<!----------------------------------------------------------------------------->
<!--  SECTION: 3.1.1 Extensions to Binding Cache Entry                       -->
<!----------------------------------------------------------------------------->
<section title="Extensions to Binding Cache Entry" anchor="sec:IPv4hoa-lma-concept">
<t>
To support this feature, the conceptual Binding Cache entry data
structure maintained by the local mobility anchor needs to include the
following parameters. 
</t>

<t><list style="symbols">
<t>
The IPv4 home address assigned to the mobile node's interface and
registered by the mobile access gateway. The IPv4 home address entry
also includes the corresponding subnet mask. It is to be noted that
this parameter is defined in <xref target="RFC5555"/> and is presented here
for completeness.
</t>

<t>
The IPv4 default router address assigned to the mobile node.
</t>
</list></t>
</section> <!-- Extensions to BCE -->


<!----------------------------------------------------------------------------->
<!--  SECTION: 3.1.2 LMA Signaling Considerations                            -->
<!----------------------------------------------------------------------------->
<section title="Signaling Considerations" anchor="sec:v4hoa-lma"> 

<!--vspace blankLines="1" /-->


<!----------------------------------------------------------------------------->
<!-- SECTION: 3.1.2.1 Processing Proxy Binding Updates                       -->
<!----------------------------------------------------------------------------->
<section title="Processing Proxy Binding Updates" anchor="sec:v4hoa-lma-pbu">
<t>
The processing rules specified in Section 5.3 of <xref target="RFC5213"/> are applied
for processing the received Proxy Binding Update message.  However, if
the received Proxy Binding Update message has an IPv4 Home Address
Request option, the following considerations MUST be applied
additionally.
</t>   


<t><list style="symbols">
<t>
If there is an IPv4 Home Address Request option 
(<xref target="sec:HAreq" />) present in the received Proxy
Binding Update message, but no Home Network Prefix option <xref target="RFC5213"/>
present in the received Proxy Binding Update message, the local mobility anchor MUST
NOT reject the request as specified in Section 5.3.1 of <xref target="RFC5213"/>. At
least one instance of either of these two options, either the IPv4 Home Address Request
option or the Home Network Prefix option, MUST be present. If there is not a single
instance of either of these two options present in the request, the local mobility
anchor MUST reject the request and send a Proxy Binding Acknowledgement message
with the Status field set to MISSING_HOME_NETWORK_PREFIX_OPTION (missing the mobile node's
home network prefix option) <xref target="RFC5213"/>.

</t>  

<t>
If there is at least one instance of the Home Network Prefix option
<xref target="RFC5213"/> present in the received Proxy Binding Update message, but
it is known from the mobile node's policy profile that the
mobile node is not authorized for IPv6 service, or IPv6 routing in not
enabled in the home network, the local mobility anchor MUST reject the
request and send a Proxy Binding Acknowledgement message with the
Status field set to NOT_AUTHORIZED_FOR_IPV6_MOBILITY_SERVICE (mobile
node not authorized for IPv6 mobility service; see
<xref target="sec:statuscodes" />).  
</t>

<t>
If there is an IPv4 Home Address Request option present in the 
received Proxy Binding Update message, but it is known from
the mobile node's policy profile that the mobile node is not authorized
for IPv4 service, or if IPv4 routing is not enabled in the home network,
the local mobility anchor MUST reject the request and send a Proxy
Binding Acknowledgement message with the Status field set to
NOT_AUTHORIZED_FOR_IPV4_MOBILITY_SERVICE (mobile node not authorized
for IPv4 mobility service; see <xref target="sec:statuscodes" />).
</t>


<t>
If there is more than one instance of the IPv4 Home Address Request
option present in the request, then the local mobility anchor MUST reject
the request and send a Proxy Binding Acknowledgement message with the
Status field set to MULTIPLE_IPV4_HOME_ADDRESS_ASSIGNMENT_NOT_SUPPORTED 
(multiple IPv4 home address assignments not supported; see
<xref target="sec:statuscodes" />).
</t>


<t>
For associating the received Proxy Binding Update message to an
existing mobility session, the local mobility anchor MUST perform the
Binding Cache entry existence test by applying the following
considerations.

<list style="symbols">
<t>
If there is at least one instance of the Home Network Prefix option
<xref target="RFC5213"/> with a NON_ZERO prefix value, or, if there is an IPv4 Home
Address Request option with the IPv4 address in the option set to
ALL_ZERO, considerations from Section 5.4.1 of <xref target="RFC5213"/> MUST be
applied.
</t>

<t>
If there is an IPv4 Home Address Request option present in the
request with the IPv4 address value in the option set to a NON_ZERO
value, considerations from <xref target="sec:v4hoa-lma-mh"/> MUST be applied. 
</t>
</list></t>

<t>
If there is no existing Binding Cache entry that can be associated with
the request, the local mobility anchor MUST consider this request as an
initial binding registration request, and considerations from <xref target="sec:v4hoa-lma-initbindreg"/> MUST be applied. Additionally, if there are one or more Home
Network Prefix options <xref target="RFC5213"/> present in the request,
considerations from Section 5.3.2 of <xref target="RFC5213"/> MUST also be applied.
</t>

<t> 
If there exists a Binding Cache entry that can be associated with the
request, the local mobility anchor MUST apply considerations from
Section 5.3.1 of <xref target="RFC5213"/>, (point 13), to determine if the request
is a re-registration or a de-registration request. If the request is a
re-registration request, considerations from <xref target="sec:v4hoa-lma-bindlifeext"/> MUST be
applied, and if it is a de-registration request, considerations from
<xref target="sec:v4hoa-lma-binddereg"/> MUST be applied.
</t>

<t>
If there exists a Binding Cache entry that can be associated with the
request and if it is determined that the request is a re-registration
request for extending an IPv4 home address mobility support to the
existing IPv6-only mobility session, considerations from 
<xref target="sec:v4hoa-lma-initbindreg"/> MUST be applied with respect to IPv4 support.
</t>

</list></t>
</section> <!-- Processing PBU -->


<!----------------------------------------------------------------------------->
<!-- SECTION: 3.1.2.2 Initial Binding Registration (New Mobility Session)    -->
<!----------------------------------------------------------------------------->
<section title="Initial Binding Registration (New Mobility Session)" anchor="sec:v4hoa-lma-initbindreg">
	
<!--vspace blankLines="1" /-->

<t><list style="symbols">
<t>
If there is an IPv4 Home Address Request option present in the
Proxy Binding Update message with the IPv4 address value in the option
set to ALL_ZERO, the local mobility anchor MUST allocate an IPv4 home
address to the mobile node and associate it with the new mobility
session created for that mobile node. 
</t>

<t>
If there is an IPv4 Home Address Request option with the IPv4
address in the option set to a NON_ZERO value, the local mobility
anchor, before accepting the request, MUST ensure that the address is 
topologically anchored on the local mobility anchor and furthermore that the
mobile node is authorized to use that address. If the mobile node is
not authorized for that specific address, the local mobility anchor
MUST reject the request and send a Proxy Binding Acknowledgement
message with the Status field set to
NOT_AUTHORIZED_FOR_IPV4_HOME_ADDRESS (mobile node not authorized for
the requesting IPv4 address; see <xref target="sec:statuscodes" />).
It MUST also include the IPv4 Home Address Reply option
(<xref target="sec:HArep" />).
 
in the reply with the Status field value in the option set to 129 
(Administratively prohibited).
</t>

<t>
If the local mobility anchor is unable to allocate an IPv4 address
due to lack of resources, it MUST reject the request and send a
Proxy Binding Acknowledgement message with Status field set to 130
(Insufficient resources). It MUST also include the IPv4 Home Address
Reply option in the reply with the Status field value in the option set
to 128 (Failure, reason unspecified).
</t>

<t>
Upon accepting the request, the local mobility anchor MUST create a
Binding Cache entry for this mobility session. However, if the request
also contains one or more Home Network Prefix options <xref target="RFC5213"/>,
there should still be only one Binding Cache entry that should be
created for this mobility session. The created Binding Cache entry MUST
be used for managing both IPv4 and IPv6 home address bindings. The
fields in the Binding Cache entry MUST be updated with the accepted
values for that session.
</t>

<t>
The local mobility anchor MUST establish a bidirectional tunnel to the
mobile access gateway with the encapsulation mode set to the
negotiated mode for carrying the IPv4 payload traffic. When using IPv6
transport, the encapsulation mode is IPv4-or-IPv6-over-IPv6 (IPv4 or IPv6
packet carried as a payload of an IPv6 packet). When using IPv4 transport,
the encapsulation mode is as specified in <xref target="sec:v4trans"/>.
</t>

<t>
The local mobility anchor MUST create an IPv4 host route (or a platform-specific equivalent function that sets up the forwarding) for tunneling
the packets received for the mobile node's home address associated with
this mobility session.
</t>

<t>
The local mobility anchor MUST send the Proxy Binding Acknowledgement
message with the Status field set to 0 (Proxy Binding Update accepted).
The message MUST be constructed as specified in <xref target="sec:v4hoa-lma-proxybindack"/>.
</t>

</list></t>
</section> <!-- Initial PBU -->


<!----------------------------------------------------------------------------->
<!-- SECTION: 3.1.2.3 Binding Lifetime Extension (No handoff)                -->
<!----------------------------------------------------------------------------->
<section title="Binding Lifetime Extension (No Handoff)" anchor="sec:v4hoa-lma-bindlifeext">
<t>
All the considerations from Section 5.3.3 of <xref target="RFC5213"/> MUST be
applied.
</t>

<!--vspace blankLines="1" /-->
</section> <!-- Binding Lifetime Extension (No handoff) -->


<!----------------------------------------------------------------------------->
<!-- SECTION: 3.1.2.4 Binding Lifetime Extension (After handoff)             -->
<!----------------------------------------------------------------------------->
<section title="Binding Lifetime Extension (after Handoff)" anchor="sec:v4hoa-lma-bindlifeextaho">
<t><list style="symbols">
<t>
If there is no Home Network Prefix option <xref target="RFC5213"/> present in the
request, but if the Binding Cache entry associated with this request
has IPv6 home network prefix(es), the local mobility anchor MUST
consider this as a request to extend lifetime only for the IPv4 home
address and not for the IPv6 home network prefix(es). Hence, the local
mobility anchor SHOULD release all the IPv6 home network prefix(es)
assigned to that mobile node and for that specific attached interface.
Similar considerations apply for the case where there is no IPv4 Home
Address Request option present in the request, but if the Binding
Cache entry associated with that request has both IPv4 home address and
IPv6 home network prefix(es).
</t>

<t>
The local mobility anchor MUST remove the previously created IPv4 host
route (or the forwarding state) and the dynamically created
bidirectional tunnel for carrying  the IPv4 payload traffic (if there
are no other mobile nodes for which the tunnel is being used). This
will remove the routing state towards the mobile access gateway where
the mobile node was anchored prior to the handoff.
</t>

<t>
The local mobility anchor MUST create a bidirectional tunnel to the
mobile access gateway that sent the request (if there is no existing
bidirectional tunnel) and with the encapsulation mode set to the
negotiated mode for carrying the IPv4 payload traffic. An IPv4 host
route for tunneling the packets received for the mobile node's IPv4
home address MUST also be added.
</t>

<t>
The required forwarding state identified in Section 5.3.6 of
<xref target="RFC5213"/> is for IPv6 payload traffic. Those considerations apply for
IPv4 payload traffic as well. However, if IPv4 transport is in use, 
considerations from <xref target="sec:v4trans"/> MUST be applied.
</t>
</list></t>
</section> <!-- Binding Lifetime Extension (After handoff) -->


<!----------------------------------------------------------------------------->
<!-- SECTION: 3.1.2.5 Binding De-Registration                                -->
<!----------------------------------------------------------------------------->
<section title="Binding De-Registration" anchor="sec:v4hoa-lma-binddereg">
<t>
All the considerations from Section 5.3.5 of <xref target="RFC5213"/> MUST be
applied. Additionally, to remove the IPv4 state as part of the
Binding Cache entry deletion, the IPv4 host route and the dynamically
created bidirectional tunnel for carrying the IPv4 payload traffic
(if there are no other mobile nodes for which the tunnel is being used)
MUST be removed.  However, if the request is for a selective de-registration (IPv4
   home address only, or all the IPv6 home network prefixes), the
   Binding Cache entry MUST NOT be deleted, only the respective states
   related to those addresses MUST be deleted.</t>

</section> <!-- Binding De-Registration -->


<!----------------------------------------------------------------------------->
<!-- SECTION: 3.1.2.6 Constructing the Proxy Binding Acknowledgement Message -->
<!----------------------------------------------------------------------------->
<section title="Constructing the Proxy Binding Acknowledgement Message" anchor="sec:v4hoa-lma-proxybindack">
<t>
When sending the Proxy Binding
Acknowledgement message to the mobile access gateway, the local mobility anchor MUST construct
the message as specified in Section 5.3.6 of <xref target="RFC5213"/>. Additionally,
the following considerations MUST be applied.
</t>


<t><list style="symbols">

<t>
Section 5.3.6 of <xref target="RFC5213"/> requires the local mobility anchor to
include at least one instance of the Home Network Prefix option <xref target="RFC5213"/>
in the Proxy Binding Acknowledgement message that it sends to the
mobile access gateway. However, if the received Proxy Binding Update
message has only the IPv4 Home Address Request option and does not
contain the Home Network Prefix option(s), then the local mobility
anchor MUST NOT include any Home Network Prefix option(s) in the reply.
However, there MUST be at least one instance of either the Home Network
Prefix option <xref target="RFC5213"/> or the IPv4 Home Address Reply option present
in the Proxy Binding Acknowledgement message.
</t>

<t>
The IPv4 Home Address Reply option  MUST be present in the Proxy
Binding Acknowledgement message.

<list style="numbers">
<t>
If the Status field is set to a value greater than or equal to 128,
i.e., if the Proxy Binding Update is rejected, then there MUST be an
IPv4 Home Address Reply option corresponding to the IPv4 Home Address
Request option present in the request and with the IPv4 address value
and the prefix length fields in the option set to the corresponding
values in the request. The Status field value in the option must be set
to the specific error code.
</t>

<t>
For all other cases, there MUST be an IPv4 Home Address Reply option
to carry the IPv4 home address assigned for that mobility session
and with the value in the option set to the allocated IPv4 address. The
prefix length in the option MUST be set to the prefix length of the
mobile node's IPv4 home network. The Status field value in the option must
be set to 0 (Success).
</t>
</list></t>

<t>
The IPv4 Default-Router Address option 
(<xref target="sec:DRadd" />) MUST be present, if the
Status field value in the Proxy Binding Acknowledgement message is
set to 0 (Proxy Binding Update accepted) <xref target="RFC5213"/>.  Otherwise,
the option MUST NOT be present. If the option is present, the default router
address in the option MUST be set to the mobile node's default router address.
</t>

</list></t>
</section> <!-- Constructing PBU -->


<!----------------------------------------------------------------------------->
<!--  SECTION: 3.1.2.7 BCE Lookup Considerations                             -->
<!----------------------------------------------------------------------------->
<section title="Binding Cache Entry Lookup Considerations" anchor="sec:v4hoa-lma-mh"> 
<t>
The Binding Cache entry lookup considerations specified in Section
5.4.1.1 of <xref target="RFC5213"/> uses the Home Network Prefix option <xref target="RFC5213"/> as
the key parameter for identifying the Binding Cache entry.  However,
when there is not a single Home Network Prefix option with a NON_ZERO
value present in the request, but there is an IPv4 Home Address
option with a NON_ZERO value present in the request, then the following
considerations MUST be applied.
</t>

<t><list style="symbols"> 
<t>
The search rules specified in Section 5.4.1.1 of <xref target="RFC5213"/>, which
primarily uses IPv6 home network prefix set as the search key, are
equally valid when using a single IPv4 home address as the key. When
applying those considerations, instead of the IPv6 home network
prefix(es), the IPv4 home address from the IPv4 Home Address option
present in the request MUST be used as the search key.
</t>

<t>
The rules specified in Section 5.4.1.1 of <xref target="RFC5213"/> assume the 
presence of one or more IPv6 home network prefixes in the received
request and also in the Binding Cache entry. But, when using the IPv4
home address as the search key, these considerations MUST always assume
just one single IPv4 home address, both in the request and also in the 
Binding Cache entry.
</t>

<!-- V6 and V4 set match error - throw error -->
</list></t>

</section> <!-- BCE Lookup Considerations -->
</section> <!-- Singnaling Considerations -->


<!----------------------------------------------------------------------------->
<!--  SECTION: 3.1.3 LMA Routing Considerations                              -->
<!----------------------------------------------------------------------------->
<section title="Routing Considerations for the Local Mobility Anchor" anchor="sec:v4hoa-lma-routing">    
<!--vspace blankLines="1" /-->

<t>
Intercepting Packets Sent to the Mobile Node's IPv4 Home Address:
</t>
<t><list style="symbols">  
<t>
When the local mobility anchor is serving a mobile node, it MUST
advertise a connected route into the Routing Infrastructure for the
mobile node's IPv4 home address or for its home subnet, in order to
receive packets that are sent to the mobile node's IPv4 home address.
This essentially enables IPv4 routers in that network to detect the
local mobility anchor as the last-hop router for that subnet.
</t>
</list></t>
<vspace blankLines="1" />


<t>
Forwarding Packets to the Mobile Node:
</t>
<t><list style="symbols">  
<t>
On receiving a packet from a corresponding node with the destination
address matching the mobile node's IPv4 home address, the local mobility
anchor MUST forward the packet through the bidirectional tunnel setup
for that mobile node. 
</t>


<t>
The format of the tunneled packet when payload protection is not enabled:
</t>

<figure anchor="fig:pba-hoa-rtg"  title="Tunneled Packets from the Local Mobility Anchor (LMA) to the Mobile Access Gateway (MAG)">
<artwork>        
<![CDATA[
     IPv6 header (src= LMAA, dst= Proxy-CoA       /* Tunnel Header */
        IPv4 header (src= CN, dst= IPv4-MN-HOA )  /* Packet Header */                           
           Upper-layer protocols                  /* Packet Content*/ 
]]>        
</artwork>        
</figure>

</list></t>
<vspace blankLines="1" />


    
    
<t>
Forwarding Packets Sent by the Mobile Node:
</t>

<t><list style="symbols"> 
<t>
All the reverse tunneled packets that the local mobility anchor
receives from the mobile access gateway, after removing the tunnel
header, MUST be routed to the destination specified in the inner IPv4
packet header. These routed packets will have the Source Address field
set to the mobile node's IPv4 home address.




</t> 
</list></t>
  
  
</section> <!-- Routing Considerations -->


<!----------------------------------------------------------------------------->
<!--	SECTION 3.1.4 ECN Considerations               	                 -->
<!----------------------------------------------------------------------------->
<section title="ECN and Payload Fragmentation Considerations">
<t>
The Explicit Congestion Notification (ECN) considerations specified in Section 5.6.3 of <xref target="RFC5213"/> apply
for the IPv4 payload packets as well. The mobility agents at the
tunnel entry and exit points MUST handle ECN information as specified
in that document.
</t>

<t>
The mobility agents at the tunnel entry and exit points MUST apply the
IP packet fragmentation considerations as specified in Section 7 of 
<xref target="RFC2473"/>; additionally, they MUST apply the considerations related
to tunnel error processing and reporting as specified in Section 8 of
<xref target="RFC2473"/>. 
</t>

</section> <!-- ECN Considerations -->
</section> <!-- LMA Considerations -->


<!--------------------------------------------------------->
<!--  SECTION: 3.2 Mobile Access Gateway Considerations  -->
<!--------------------------------------------------------->
<section title="Mobile Access Gateway Considerations" anchor="sec:IPv4hoa-mag-considerations">

<!--vspace blankLines="1" /-->


<!----------------------------------------------------------------------------->
<!--  SECTION: 3.2.1 Extensions to Binding Update List Entry Data Structure  -->
<!----------------------------------------------------------------------------->
<section title="Extensions to Binding Update List Entry" anchor="sec:IPv4hoa-mag-concept">
<t>
To support the IPv4 home address mobility feature, the conceptual
Binding Update List entry data structure needs to be extended with the
following additional fields.
</t>

<t><list style="symbols">
<t>
The IPv4 home address assigned to the mobile node's attached interface.
This IPv4 home address may have been statically configured in the
mobile node's policy profile, or, may have been dynamically allocated
by the local mobility anchor. The IPv4 home address entry also includes
the corresponding subnet mask.
</t>

<t>
The IPv4 default router address of the mobile node. This is acquired
from the mobile node's local mobility anchor through the received Proxy
Binding Acknowledgement message.
</t>
</list></t>
</section> <!-- Extensions to Binding Update List Entry -->


<!----------------------------------------------------------------------------->
<!--	SECTION 3.2.2: Extensions to Mobile Node's Policy Profile            -->
<!----------------------------------------------------------------------------->
<section title="Extensions to Mobile Node's Policy Profile">
<t>
To support the IPv4 home address mobility support feature, the mobile
node's policy profile, specified in Section 6.2 of <xref target="RFC5213"/>, MUST be
extended with the following additional fields.
</t>

<!--vspace blankLines="1" /-->

<t>
Extensions to the mandatory section of the policy profile:
</t>
<t><list style="symbols">
<t>
This field identifies all the IP versions for which the home
address mobility support needs to be extended to the mobile node. The
supported modes are IPv4-only, IPv6-only, and dual IPv4/IPv6.
</t>
</list></t>

<vspace blankLines="1" />

<t>
Extensions to the optional section of the policy profile:
</t>
<t><list style="symbols">
<t>
The IPv4 home address assigned to the mobile node's attached interface.
The specific details on how the network maintains the association
between the address and the attached interface is outside the scope of
this document. This address field also includes the corresponding
subnet mask.
</t>
</list></t>
</section> <!-- Extensions to Mobile Node's Policy Profile -->



<!----------------------------------------------------------------------------->
<!--  SECTION: 3.2.3 MAG Signaling Considerations                            -->
<!----------------------------------------------------------------------------->
<section title="Signaling Considerations" anchor="sec:v4hoa-mag">

<!--vspace blankLines="1" /-->


<!----------------------------------------------------------------------------->
<!-- SECTION: 3.2.3.1 Mobile Node Attachment and Initial Binding Registration -->
<!----------------------------------------------------------------------------->
<section title="Mobile Node Attachment and Initial Binding Registration" anchor="sec:v4hoa-mag-bindupd">
<t>
After detecting a new mobile node on its access link, the mobile
access gateway on the access link MUST determine if IPv4 home 
address mobility support needs to be enabled for that mobile node.
The mobile node's policy profile identifies the supported modes
(IPv4-only, IPv6-only, or dual IPv4/IPv6) for that mobile node for
which the mobile service needs to be enabled. Based on those policy
considerations and from other triggers such as from the network, if it
is determined that IPv4 home address mobility support needs to be
enabled for the mobile node, considerations from Section 6.9.1.1 of
<xref target="RFC5213"/> MUST be applied with the following exceptions.
</t>


<t><list style="symbols">
<t>
The IPv4 Home Address Request option MUST be present in the Proxy
Binding Update message. 

<list style="symbols">
<t>
If the mobile access gateway learns the mobile node's IPv4 home
address either from its policy profile or from other means, the
mobile access gateway MAY ask the local mobility anchor to allocate
that specific address by including exactly one instance of the IPv4
Home Address Request option with the IPv4 home address and the
prefix length fields in the option set to that specific IPv4 address
and the prefix length of the corresponding home network.
</t>
<!--tFurthermore, the (P) flag in the option MUST be set to 0. </t-->

<t>
The mobile access gateway MAY also ask the local mobility anchor for
dynamic IPv4 home address allocation. It can include exactly one
instance of the IPv4 Home Address option with the IPv4 home address
and the prefix length fields in the option set to the ALL_ZERO value.
Furthermore, the (P) flag in the option MUST be set to 0. This
serves as a request to the local mobility anchor for the
IPv4 home address allocation. 
</t>
</list></t>

<t>
The Proxy Binding Update message MUST be constructed as specified in
Section 6.9.1.5 of <xref target="RFC5213"/>. However, the Home Network Prefix
option(s) <xref target="RFC5213"/> MUST be present in the Proxy Binding Update only
if IPv6 home address mobility support also needs to be enabled for the
mobile node. Otherwise, the Home Network Prefix option(s) MUST NOT be
present.
</t>

<t>
When using IPv4 transport to carry the signaling messages, the
related considerations from <xref target="sec:v4trans"/> MUST be applied additionally.
</t>

</list></t>
</section> <!-- Mobile Node Attachment and Initial Binding Registration -->


<!----------------------------------------------------------------------------->
<!-- SECTION: 3.2.3.2 Receiving Proxy Binding Acknowledgement                -->
<!----------------------------------------------------------------------------->
<section title="Receiving Proxy Binding Acknowledgement" anchor="sec:v4hoa-mag-bindreply">
<t>
All the considerations from Section 6.9.1.2 of <xref target="RFC5213"/> MUST be
applied with the following exceptions.
</t>

<t><list style="symbols">
<t>
If the received Proxy Binding Acknowledgement message has the Status
field value set to NOT_AUTHORIZED_FOR_IPV4_MOBILITY_SERVICE (The
mobile node is not authorized for IPv4 mobility service), the
mobile access gateway SHOULD NOT send a Proxy Binding Update message
including a IPv4 Home Address Request option until an administrative
action is taken.
</t>

<t>
If the received Proxy Binding Acknowledgement message has the Status
field value set to NOT_AUTHORIZED_FOR_IPV4_HOME_ADDRESS (The mobile
node is not authorized for the requesting IPv4 home address), the
mobile access gateway SHOULD NOT request the same IPv4 address
again, but MAY request the local mobility anchor to perform the
address assignment by including exactly one instance of the IPv4 Home
Address Request option with the IPv4 home address and the prefix
length fields in the option set to the ALL_ZERO value.
</t>

<t>
If the received Proxy Binding Acknowledgement message has the Status
field value set to NOT_AUTHORIZED_FOR_IPV6_MOBILITY_SERVICE (The
mobile node is not authorized for IPv6 mobility service), the
mobile access gateway SHOULD NOT send a Proxy Binding Update message
including any Home Network Prefix option(s) until an administrative
action is taken.
</t>

<t>
If there is no IPv4 Home Address Reply option present in the received
Proxy Binding Acknowledgement message, the mobile access gateway MUST
NOT enable IPv4 support for the mobile node and the  rest of the
considerations from this section can be skipped.
</t>

<t>
If the received Proxy Binding Acknowledgement message has the Status
field value in the IPv4 Home Address Reply option set to a value that
indicates that the request was rejected by the local mobility anchor,
the mobile access gateway MUST NOT enable IPv4 mobility support.
</t>

<t>
If the received Proxy Binding Acknowledgement message has the Status
field value set to 0 (Proxy Binding Update accepted), the mobile
access gateway MUST update a Binding Update List entry for that mobile
node. The entry MUST be updated with the assigned IPv4 home address
and other accepted registration values.
</t>

<t>
If the received Proxy Binding Acknowledgement message has the Status
field value set to 0 (Proxy Binding Update accepted) and has the IPv4
Home Address Reply option set to a value that indicates that the
request was accepted by the local mobility anchor, the mobile access
gateway MUST establish a bidirectional tunnel to the local mobility
anchor (if there is no existing bidirectional tunnel to that local
mobility anchor) and with the encapsulation mode set to
IPv4-or-IPv6-over-IPv6 (an IPv4 or IPv6 packet carried as a payload of an
IPv6 packet). Considerations from Section 5.6.1 of <xref target="RFC5213"/> MUST be
applied for managing the dynamically created bidirectional tunnel.
However, when using IPv4 transport, the encapsulation mode MUST be set
to the negotiated encapsulation mode, as specified in 
<xref target="sec:v4trans"/> of this
document.
</t>

<t>
The mobile access gateway MUST set up the route for forwarding the
IPv4 packets received from the mobile node (using its IPv4 home
address) through the bidirectional tunnel set up for that mobile node.
</t>

<t>
The default router address MUST be obtained from the IPv4
Default-Router Address option present in the received Proxy Binding
Acknowledgement message. The mobile access gateway SHOULD configure
this address on its interface and respond to any Address Resolution Protocol (ARP) requests sent by
the mobile node to resolve the hardware address of the default
router. However, since the link between the mobile access gateway and
the mobile node is a point-to-point link, implementations will be able
receive any packets sent to the default router address without having
to explicitly configure the default router address on its interface.
The mobile access gateway MAY also use the default router address as
the source address for any datagrams sent to the mobile node and
originated by the mobile access gateway itself. It MUST also use this
address in the DHCP Router option <xref target="RFC2132"/> in the DHCP messages.
</t>

<t>
If there is an IPv4 DHCP Support Mode option 
(<xref target="sec:DHCPsupp" />)
present in the received
Proxy Binding Acknowledgement message and if the (S) flag in the option
is set to a value of (1), then the mobile access gateway MUST function
as a DHCP server for the mobile node. If either the (S) flag in the
option is set to a value of (0), or if the option is not present in the
request, then the mobile access gateway MUST function as a DHCP Relay
for the mobile node.
</t>



</list></t>
</section> <!-- Receiving Proxy Binding Acknowledgement -->


<!----------------------------------------------------------------------------->
<!-- SECTION: 3.2.3.3 Binding Re-Registration and De-Registration            -->
<!----------------------------------------------------------------------------->
<section title="Binding Re-Registration and De-Registrations" anchor="sec:v4hoa-mag-extendlife">
<t>
When sending a Proxy Binding Update either to extend the lifetime
of a mobility session or to de-register the mobility session, the
respective considerations from <xref target="RFC5213"/> MUST be applied. Furthermore,
the following additional considerations MUST also be applied.
</t>

<t><list style="symbols">
<t>
If there is an IPv4 home address assigned to the mobility session, then
there MUST be exactly one instance of the IPv4 Home Address Request
option present in the Proxy Binding Update message. The IPv4 home
address and the prefix length fields in the option MUST be set to that
specific address and its corresponding subnet-mask length. 
</t>
<!--t> The (P) flag in the option MUST be set to 0. </t-->

<t>
If there was no IPv4 home address requested in the initial Proxy
Binding Update message, but it is determined that the IPv4 home 
address MUST be requested subsequently, then there MUST be exactly one
instance of the IPv4 Home Address Request option present in the
Proxy Binding Update message. The IPv4 home address in the option MUST
be set to either ALL_ZERO or to a specific address that is being
requested.
</t>

<t>
For performing selective de-registration of IPv4 home address but still
retaining the mobility session with all the IPv6 home network prefixes,
the Proxy Binding Update message with the lifetime value of (0) MUST NOT
include any IPv6 Home Network Prefix options <xref target="RFC5213"/>. It MUST
include exactly one instance of the IPv4 Home Address Request option
with the IPv4 home address and the prefix length fields in the option
set to the IPv4 home address that is being de-registered. Similarly, for
selective de-registration of all the IPv6 home network prefixes, the
Proxy Binding Update message MUST NOT include the IPv4 Home address
option, it MUST include a Home Network Prefix option for each of the
assigned home network prefixes assigned for that mobility session and
with the prefix value in the option set to that respective prefix value. 
</t>

<t>
The Home Network Prefix option(s) <xref target="RFC5213"/> MUST NOT be present if the
same option(s) was not present in the initial Proxy Binding Update
message. Otherwise, considerations from <xref target="RFC5213"/> with respect to this
option MUST be applied.
</t>

<t>
If at any point the mobile access gateway fails to extend the binding
lifetime with the local mobility anchor for the mobile node's IPv4 
address, it MUST remove any forwarding state set up for the mobile
node's IPv4 home address.
</t>

</list></t>


</section> <!-- Binding Re-Reg and De-Reg -->
</section> <!-- MAG Signaling Considerations -->


<!----------------------------------------------------------------------------->
<!--  SECTION: 3.2.4 MAG Routing Considerations                              -->
<!----------------------------------------------------------------------------->
<section title="Routing Considerations for the Mobile Access Gateway" anchor="sec:v4hoa-mag-routing">    
<!--vspace blankLines="1" /-->
<t><list style="symbols">
<t>
On receiving a packet from the bidirectional tunnel established with
the mobile node's local mobility anchor, the mobile access gateway
MUST remove the outer header before forwarding the packet to the mobile
node.
</t>

<t>
On receiving a packet from a mobile node connected to its access link,
the packet MUST be forwarded to the local mobility anchor through the
bidirectional tunnel established with the local mobility anchor.
However, when the EnableMAGLocalRouting flag is set, considerations from
Section 6.10.3 of <xref target="RFC5213"/> MUST be applied with respect to local
routing.
</t>

<t>
When forwarding the packet through the bidirectional tunnel, the
encapsulation considerations as specified in 
<xref target="sec:v4hoa-lma-routing"/> MUST be applied (except that the
source and destination addresses fields in the outer encapsulation header are
reversed). However, before forwarding the packet, the mobile access gateway MUST
ensure the source address in the received packet is the address allocated for that
mobile node and that there is an active binding on the local mobility anchor for
that mobile node.
</t>

<t>
The mobile access gateway SHOULD use the Proxy ARP <xref target="RFC0925"/> to reply to
ARP Requests that it receives from the mobile node seeking address
resolutions for the destinations on the mobile node's home subnet.
When receiving an ARP Request, the mobile access gateway SHOULD
examine the target IP address of the Request, and if this IP
address matches the mobile node's IPv4 home subnet, it SHOULD
transmit a Proxy ARP Reply. However, on certain types of links, the
mobile node does not use ARP for address resolutions, instead it
forwards all the packets to the mobile access gateway. On such types
of links, the mobile access gateway is not required to support the Proxy
ARP function. At the same time, implementations not supporting the
Proxy ARP function on links where the mobile node uses ARP for seeking
address resolutions for the destinations on the mobile node's home
subnet will result in communication failure.
</t>


</list></t>
</section> <!-- Routing Considerations -->
</section> <!-- MAG Considerations -->


<!-------------------------------------------------------------------------->
<!--  SECTION 3.3: Mobility Options                                     -->
<!-------------------------------------------------------------------------->
<section title="Mobility Options and Status Codes" anchor="sec:IPv4hoa-options">
<t>
To support the IPv4 home address mobility feature, this specification
defines the following new options and status codes.
</t>

<!--vspace blankLines="1" /-->



<!-------------------------------------------------------------------------->
<!--  SECTION 3.3.1: IPv4 Home Address Request Option                     -->
<!-------------------------------------------------------------------------->
<section title="IPv4 Home Address Request Option" anchor="sec:HAreq">
<t>
A new option, the IPv4 Home Address Request option, is defined for use with
the Proxy Binding Update message sent by the mobile access gateway to
the local mobility anchor. This option is used to request IPv4 home
address assignment for the mobile node.
</t>

<t>
The IPv4 Home Address Request option has an alignment requirement of
4n. Its format is as follows:
</t>

<figure anchor='fig34' title="IPv4 Home Address Request Option" >
<artwork>
<![CDATA[
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     Type      |   Length      |Prefix-len |      Reserved     |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                     IPv4 home address                         |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  
]]>
</artwork>
</figure> 

<t><list style="hanging">
   <t><list style="hanging">
      <t hangText="Type"></t>
         <t>36</t> 
          
      <t hangText="Length"></t>
         <t>An 8-bit unsigned integer indicating the length of the option in
            octets, excluding the Type and Length fields. This field MUST
            be set to (6).</t>
        
    <t hangText="Prefix-len"></t>
         <t>This 6-bit unsigned integer indicating the prefix length of the
           mobile node's IPv4 home network corresponding to the IPv4 home address
		   contained in the option.</t>         
        
      <t hangText="Reserved"></t>
         <t>This 10-bit field is unused for now. The value MUST be
            initialized to (0) by the sender and MUST be ignored by the
            receiver.</t>
  
      <t hangText="IPv4 home address"></t>
         <t>This 4-byte field containing the IPv4 home address that is
            being requested. The value of 0.0.0.0 is used to request that the
            local mobility anchor perform the address allocation.</t>  
   </list></t>
</list></t>
</section>


<!-------------------------------------------------------------------------->
<!--  SECTION 3.3.2: IPv4 Home Address Reply Option                       -->
<!-------------------------------------------------------------------------->
<section title="IPv4 Home Address Reply Option" anchor="sec:HArep">
<t>
A new option, the IPv4 Home Address Reply option, is defined for use
in the Proxy Binding Acknowledgement message sent by the local
mobility anchor to the mobile access gateway. This option can be used
to send the assigned mobile node's IPv4 home address.
</t>

<t>
The IPv4 Home Address Reply option has an alignment requirement of
4n. Its format is as follows:
</t>

<figure anchor='fig40' title="IPv4 Home Address Reply Option" >
<artwork>
<![CDATA[
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     Type      |    Length     |   Status      |Pref-len   |Res|
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                      IPv4 home address                        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]>

</artwork>
</figure> 

<t><list style="hanging">
   <t><list style="hanging">
   
      <t hangText="Type"></t>
         <t>37</t> 
          
      <t hangText="Length"></t>
         <t>An 8-bit unsigned integer indicating the length of the option in
            octets, excluding the Type and Length fields. This field MUST
            be set to (6).</t>     
             
      <t hangText="Status"></t>
         <t>Indicates success or failure for the IPv4 home address
            assignment. Values from 0 to 127 indicate success.  Higher
            values (128 to 255) indicate failure. The following Status
            values are currently allocated by this document:</t>                
                  
            <t><list style="hanging">
              <t>0 Success</t>
            
              <t>128 Failure, reason unspecified</t>

              <t>129 Administratively prohibited</t>

              <t>130 Incorrect IPv4 home address</t>

              <t>131 Invalid IPv4 address</t>

              <t>132 Dynamic IPv4 home address assignment not available</t>
            </list></t>
                  
      <t hangText="Prefix-len"></t>
         <t>This 6-bit unsigned integer is used to carry the prefix
            length of the mobile node's IPv4 home network corresponding
            to the IPv4 home address contained in the option.</t>         
        
      <t hangText="Reserved (Res)"></t>
         <t>This 2-bit field is unused for now. The value MUST be
            initialized to (0) by the sender and MUST be ignored by the
            receiver.</t>
  
      <t hangText="IPv4 home address"></t>
         <t>This 4-byte field is used to carry the IPv4 home
            address assigned to the mobile node.  
         </t>                        
   </list></t>
</list></t>
</section>


<!-------------------------------------------------------------------------->
<!--  SECTION 3.3.3: IPv4 Default-Router Address Option                 -->
<!-------------------------------------------------------------------------->
<section title="IPv4 Default-Router Address Option" anchor="sec:DRadd">
<t>
A new option, the IPv4 Default-Router Address option, is defined for use
in the Proxy Binding Acknowledgement message sent by the
local mobility anchor to the mobile access gateway. This option can be
used to send the mobile node's IPv4 default router address.
</t>

<t>
The IPv4 Default-Router Address option has an alignment requirement of
4n. Its format is as follows:
</t>

<figure anchor='fig4' title="IPv4 Default-Router Address Option" >
<artwork>
<![CDATA[
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |      Type     |   Length      |         Reserved (R)          |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                  IPv4 Default-Router Address                  |  
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]>
</artwork>
</figure> 

<t><list style="hanging">
   <t><list style="hanging">
      <t hangText="Type"></t>
         <t>38</t> 
          
      <t hangText="Length"></t>
         <t>An 8-bit unsigned integer indicating the length of the option in
            octets, excluding the Type and Length fields. This field MUST
            be set to (6).</t>
        
      <t hangText="Reserved (R)"></t>
         <t>This 16-bit field is unused for now. The value MUST be
            initialized to (0) by the sender and MUST be ignored by the
            receiver.</t>
  
      <t hangText="IPv4 Default-Router Address"></t>
         <t>A 4-byte field containing the mobile node's default router
            address.</t>  
   </list></t>
</list></t>
</section>


<!-------------------------------------------------------------------------->
<!--  SECTION 3.3.4: IPv4 DHCP Support Mode                               -->
<!-------------------------------------------------------------------------->
<section title="IPv4 DHCP Support Mode Option" anchor="sec:DHCPsupp">

<t>
A new option, the IPv4 DHCP Support Mode option, is defined for use in
the Proxy Binding Acknowledgement message  sent by the local
mobility anchor to the mobile access gateway. This option can be used
to notify the mobile access gateway as to whether it should function as a
DHCP Server or a DHCP Relay for the attached mobile node.
</t>

<t>
The IPv4 DHCP Support Mode option has no alignment requirement. Its
format is as follows:
</t>

<figure anchor='fig5' title="IPv4 DHCP Support Mode Option" >
<artwork>
<![CDATA[
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |      Type     |   Length      |    Reserved (R)             |S|
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]>
</artwork>
</figure> 


<t><list style="hanging">
   <t><list style="hanging">
      <t hangText="Type"></t>
         <t>39</t> 
         
      <t hangText="Length"></t>
         <t>
         An 8-bit unsigned integer indicating the length of the option in
         octets, excluding the Type and Length fields. This field MUST
         be set to 2.
         </t>
        
      <t hangText="Reserved (R)"></t>
         <t>
         This 15-bit field is unused for now. The value MUST be
         initialized to (0) by the sender and MUST be ignored by the
         receiver.
         </t>
  
      <t hangText="DHCP Support Mode (S)"></t>
         <t>
         A 1-bit field that specifies the DHCP support mode. This flag
         indicates whether the mobile access gateway should function as a DHCP
         Server or a DHCP Relay for the attached mobile node. The flag
         value of (0) indicates the mobile access gateway should act as a
         DHCP Relay, and the flag value of (1) indicates it should act as
         a DHCP Server.  
         </t>
</list></t>
</list></t>
</section>



<!-------------------------------------------------------------------------->
<!--  SECTION 3.3.5: Status Codes                                         -->
<!-------------------------------------------------------------------------->
<section title="Status Codes" anchor="sec:statuscodes">

<t>
This document defines the following new Status values for use in the
Proxy Binding Acknowledgement message. These values are to
be allocated from the same numbering space, as defined in Section 6.1.8
of <xref target="RFC3775"/>.
</t>

<t>
NOT_AUTHORIZED_FOR_IPV4_MOBILITY_SERVICE: 170  
</t>
<t><list style="hanging">
<t>
Mobile node not authorized for IPv4 mobility service.
</t>
</list></t>

<t>
NOT_AUTHORIZED_FOR_IPV4_HOME_ADDRESS: 171  
</t>
<t><list style="hanging">
<t>
Mobile node not authorized for the requesting IPv4 home address.
</t>
</list></t>

<t>
NOT_AUTHORIZED_FOR_IPV6_MOBILITY_SERVICE: 172  
</t>
<t><list style="hanging">
<t>
Mobile node not authorized for IPv6 mobility service.
</t>
</list></t>

<t>
MULTIPLE_IPV4_HOME_ADDRESS_ASSIGNMENT_NOT_SUPPORTED: 173
</t>
<t><list style="hanging">
<t>
Multiple IPv4 home address assignments not supported.
</t>
</list></t>



</section> <!-- Status Code -->
</section> <!-- Mobility Options -->


<!----------------------------------------------------------------------------->
<!--  SECTION: 3.4 Supporting DHCP Based Address Configuration               -->
<!----------------------------------------------------------------------------->
<section title="Supporting DHCP-Based Address Configuration" anchor="sec:v4hoa-mag-dhcpint">
<!--vspace blankLines="1" /-->
<t>
This section explains how DHCP-based address configuration support can
be enabled for a mobile node in a Proxy Mobile IPv6 domain. It explains
the protocol operation, supported DHCP server deployment configurations,
and the protocol interactions between DHCP agents and mobility entities
in each of the supported configurations.
</t>

<!--vspace blankLines="1" /-->

<t>
This specification supports the following two DHCP deployment
configurations.
</t>

<t><list style="symbols">
<t>
DHCP relay agent co-located with the mobile access gateway.
</t>
<t>
DHCP server co-located in the mobile access gateway.
</t>
</list></t>

<!--vspace blankLines="1" /-->

<t>
The following are the configuration requirements:
</t>
<t><list style="symbols">
<t>
The DHCP server or the DHCP relay agent configured on the mobile access
gateway is required to have an IPv4 address for exchanging the DHCP
messages with the mobile node. This address is the mobile node's
default router address provided by the local mobility anchor.
Optionally, all the DHCP servers co-located with the mobile access
gateways in the Proxy Mobile IPv6 domain can be configured with a fixed
IPv4 address. This fixed address can be an IPv4 private
address <xref target="RFC1918"/> that can be used for the DHCP protocol communication
on any of the access links. This address will be used as the server
identifier in the DHCP messages.
</t>

<t>
A DHCP server identifies a DHCP interface from the contents of
the DHCP "Client-identifier" option <xref target="RFC2132"/>, if present, or
from the client hardware address (chaddr), as specified in
<xref target="RFC2131"/>.  Note that the name "Client-identifier" is a
misnomer as it actually identifies an interface and not the
client.  The DHCP server uses this identity to identify the
interface for which the address is assigned.  A mobile node in a
Proxy Mobile IPv6 domain, can attach to the network through
multiple interfaces and can obtain address configuration for
each of its interfaces.  Additionally, it may perform handoffs
between its interfaces.  The following are the related
considerations with respect to the identification presented to
the DHCP server.

<list style="symbols">
<t>
If the mobile node attaches to the Proxy Mobile IPv6 domain
through multiple physical interfaces, the DHCP server will
uniquely identify each of those interfaces and will perform
address assignment.  The DHCP server will identify the
interface as specified in RFC 2131.  The mobile node SHOULD
generate and use the "Client-identifier" for each physical
interface according to <xref target="RFC4361"/>.  Any time the mobile node
performs a handoff of a physical interface to a different
mobile access gateway, using the same interface, the DHCP
server will always be able to identify the binding using the
presented identifier.  The presented identifier (either the
"Client-identifier" or the hardware address) will remain as
the primary key for each binding, just as how they are unique
in a Binding Cache entry.
</t>
 
<t>
If the mobile node is capable of performing a handoff between
interfaces, as per <xref target="RFC5213"/>, a "Client-identifier" value
MUST be used for the attachment point that is not tied to any
of the physical interfaces.  The identifier MUST be generated
according to <xref target="RFC4361"/>, which guarantees that the identifier
is stable and unique across all "Client-identifier" values in
use in the Proxy Mobile IPv6 domain.
</t>
</list></t>



<t>
All the DHCP servers co-located with the mobile access gateways in a 
Proxy Mobile IPv6 domain can be configured with the same set of 
DHCP option values (e.g., DNS Server, SIP Server, etc.) to ensure the
mobile node receives the same configuration values on any of the access
links in that Proxy Mobile IPv6 domain.
</t>  
</list></t>



<!----------------------------------------------------------------------------->
<!--	SECTION 3.4.1: DHCP Server co-located with MAG         	             -->
<!----------------------------------------------------------------------------->    
<section title="DHCP Server Co-Located with the Mobile Access Gateway" anchor="sec:v4hoa-mag-dhcpserver">

<t>
This section explains the operational sequence of home address
assignment operation when the DHCP server is co-located with the mobile
access gateway.
</t>



<figure anchor="fig:overview1"  title="Overview of DHCP Server Located at Mobile Access Gateway">
<artwork>
 <![CDATA[
  MN   MAG(DHCP-S)  LMA
   |------>|        |    1. DHCPDISCOVER
   |       |------->|    2. Proxy Binding Update
   |       |<-------|    3. Proxy Binding Acknowledgement (IPv4 HoA)
   |       |========|    4. Tunnel/Route Setup
   |<------|        |    5. DHCPOFFER  (IPv4 HoA) 
   |------>|        |    6. DHCPREQUEST (IPv4 HoA)
   |<------|        |    7. DHCPACK
   |       |        | 
   ]]> 
</artwork>
</figure>

<t><list style="symbols">
<t>It is possible that the mobile access gateway may have already completed the
     Proxy Mobile IPv6 signaling with the local mobility anchor to request both IPv6
	 home network
     prefix(es) and IPv4 home address assignment prior to Step 1. In
     such an event, the Proxy Mobile IPv6 signaling steps (Steps 2 to
     4) above are not relevant.  </t>   
<t>It is possible the mobile access gateway may have initially completed the Proxy
     Mobile IPv6 signaling prior to Step 1, but only for requesting
     IPv6 home network prefix(es), and it may later request IPv4 home
     address assignment after detecting the DHCP triggers from the
     mobile node as shown above.  </t> 
<t>The mobile access gateway may choose to ignore the DHCPDISCOVER messages until the
     Proxy Mobile IPv6 signaling is successfully completed, or it may
     choose to send a delayed response for reducing the additional
     delay waiting for a new DHCPDISCOVER message from the mobile node.</t>
</list></t>       

<t>
Initial IPv4 Home Address Assignment:
</t>

<t><list style="symbols">
<t>
To acquire the mobile node's IPv4 home address from the local
mobility anchor, the mobile access gateway will initiate Proxy Mobile
IPv6 signaling with the local mobility anchor. 
</t>

<t>
After the successful completion of the Proxy Mobile IPv6 signaling and
upon acquiring the mobile node's IPv4 home address from the local
mobility anchor, the DHCP server on the mobile access gateway will
send a DHCPOFFER message <xref target="RFC2131"/> to the mobile node.  The offered
address will be the mobile node's IPv4 home address, assigned by the
local mobility anchor. The DHCPOFFER message will also have the Subnet
Mask option <xref target="RFC2132"/> and Router option <xref target="RFC2132"/>, with the values in
those options set to the mobile node's IPv4 home subnet mask and
default router address, respectively. Additionally, the Server Identifier
option will be included and with the value in the option set to the
default router address.
</t>

<t>
If the mobile node sends the DHCPREQUEST message, the DHCP server will
send DHCPACK message, as per <xref target="RFC2131"/>.
</t>
</list></t>


<vspace blankLines="1" />

<t>
IPv4 Home Address Renewal with the DHCP Server (No Handoff):
</t>

<t><list style="symbols">     
<t>
Any time the mobile node goes into the DHCP RENEWING state <xref target="RFC2131"/>,
it simply unicasts the DHCPREQUEST message including the assigned IPv4
home address in the 'Requested IP Address' option.  The DHCPREQUEST is
sent to the address specified in the Server Identifier option of the
previously received DHCPOFFER and DHCPACK messages.
</t>

<t>
The DHCP server will send a DHCPACK to the mobile node to acknowledge
the assignment of the committed IPv4 address.
</t>
</list></t>





<vspace blankLines="1" />

<t>
IPv4 Home Address Renewal with the DHCP Server (after Handoff):
</t>

<t>
When the mobile node goes into the DHCP RENEWING state <xref target="RFC2131"/>, it
directly unicasts the DHCPREQUEST message to the DHCP server that
currently provided the DHCP lease. However, if the mobile node changed
its point of attachment and is attached to a new mobile access gateway,
it is required that the mobile node update the DHCP server address and
use the address of the DHCP server that is co-located with the new
mobile access gateway. The following approach can be adopted to ensure
the mobile node uses the DHCP server on the attached link.
</t>


<figure anchor="fig:dhcprenew"  title="Address Renewal with the DHCP Server">
   <artwork>        
      <![CDATA[ 
  MN   oMAG(DHCP-S) nMAG(DHCP-S)
   |       :        | 
 RENEW------------->|    1. DHCPREQUEST (IPv4 HoA)
 BOUND<-------------|    2. DHCPACK (IPv4 HoA) or DHCPNACK
   |       :        | 
 *  The use of a fixed DHCP server address on all DHCP servers  
   ]]>           
   </artwork>        
</figure>


<t><list style="symbols">
<t>
The use of a stable address, either the IPv4 default router address of
the mobile node or a fixed IPv4 address common in that Proxy Mobile
IPv6 domain, as the DHCP Server Identifier will ensure the DHCPREQUEST message
sent by the mobile node to renew the address will be received by
the new mobile access gateway on the attached link. 
</t>

<t>
The mobile access gateway after completing the Proxy Mobile IPv6
signaling and upon acquiring the IPv4 home address of the mobile node
will return the address in the DHCPACK message. However, if the mobile
access gateway is unable to complete the Proxy Mobile IPv6 signaling or
is unable to acquire the same IPv4 address as requested by the mobile
node, it will send a DHCPNACK message <xref target="RFC2131"/> to the
mobile node, as shown in <xref target="fig:dhcprenew"/>.
</t>

</list></t>

</section>
    
    
<!----------------------------------------------------------------------------->
<!--	SECTION 3.4.2: DHCP Relay Agent co-located with MAG    	             -->
<!----------------------------------------------------------------------------->       
<section title="DHCP Relay Agent Co-Located with the Mobile Access Gateway" anchor="sec:v4hoa-mag-dhcprelay">

<t>
A DHCP relay agent is co-located with each mobile access gateway. A DHCP
server is located somewhere in the Proxy Mobile IPv6 domain (e.g., is
co-located with the local mobility anchor). <xref target="fig:overview2"/>
shows the sequence of IPv4 home address assignment using DHCP Relay.
</t>

<figure anchor="fig:overview2"  title="Overview of the DHCP Relay Located at Mobile Access Gateway">
<artwork>
    <![CDATA[
MN   MAG(DHCP-R) LMA   DHCP-S
 |       |------->|      | 1. Proxy Binding Update *
 |       |<-------|      | 2. Proxy Binding Acknowledgement (IPv4 HoA)
 |       |========|      | 3. Tunnel/Route Setup*
 |------>|-------------->| 4. DHCPDISCOVER (IPv4 HoA) via DHCP-R 
 |<------|<--------------| 5. DHCPOFFER (IPv4 HoA) via DHCP-R
 |------>|-------------->| 6. DHCPREQUEST (IPv4 HoA) via DHCP-R
 |<------|<--------------| 7. DHCPACK (IPv4 HoA) via DHCP-R
 |       |               | 

   ]]>        
   </artwork>        
</figure>
<t> <list style="symbols">
 <t> The Proxy Mobile IPv6 signaling (starting at Step 1) and the
   DHCP address configuration (starting at Step 4) may start in any
   order. However, the DHCPOFFER (Step 5) and the immediate steps
   following it will occur in the specified order and only after the
   Tunnel/Route Setup (Step 3).</t>
 <t> It is possible the mobile access gateway may have initially completed the Proxy
   Mobile IPv6 signaling with the local mobility anchor only to request IPv6 home
   network prefix(es) and may later request IPv4 home address
   assignment after detecting the DHCP triggers from the mobile node
   (after Step 4).  </t>
 <t> The mobile access gateway may choose to ignore the DHCPDISCOVER messages until the
   Proxy Mobile IPv6 signaling is successfully completed, or it may
   choose to send a delayed response for reducing the additional
   delay waiting for a new DHCPDISCOVER message from the mobile node.</t>

</list>
</t>


<!--vspace blankLines="1" /-->

<t>Initial IPv4 Home Address Assignment:</t>

<t><list style="symbols">
<t>
To acquire the mobile node's IPv4 home address from the local
mobility anchor, the mobile access gateway will initiate Proxy Mobile
IPv6 signaling with the local mobility anchor.
</t>

<t>
After the successful completion of the Proxy Mobile IPv6 signaling and
upon acquiring the mobile node's IPv4 home address from the local
mobility anchor, the mobile access gateway will enable forwarding
for all the DHCP messages between the mobile node and the DHCP server.
</t>

<t>
The DHCP relay agent on the mobile access gateway will add the DHCP
Relay Agent Information option <xref target="RFC3046"/> to the DHCPDISCOVER message.
The assigned IPv4 home address will be included in the Agent Remote ID
Sub-option of the DHCP Relay Agent Information option. This sub-option
is used as a hint for requesting the DHCP server to allocate that
specific IPv4 address.
</t>

<t>
On receiving a DHCPOFFER message from the DHCP server, the mobile
access gateway will ensure the assigned address is currently assigned
by the local mobility anchor to that mobile node. If this address is
different from what is assigned to the mobile node, then the mobile
access gateway will drop the DHCPOFFER message and an administrative
error message will be logged. 
</t>

<t>
When the DHCP messages are sent over administrative boundaries, the
operators need to ensure these messages are secured. All the DHCP
messages relayed by the mobile access gateway can be tunneled to the
local mobility anchor if needed. Alternatively, if the network in the
Proxy Mobile IPv6 domain is secure enough, the mobile access gateway
can just relay the DHCP messages to the server. To achieve this, all
the mobile access gateways need to have a route towards the DHCP
server.  
</t>

</list></t>


<vspace blankLines="1" />

<t>
IPv4 Home Address Renewal to the same DHCP Server: (No Handoff)
</t>

<t><list style="symbols">      
<t>
When the DHCP client goes into the DHCP RENEW STATE <xref target="RFC2131"/>, it
directly unicasts DHCPREQUEST messages to the DHCP server. The DHCP
relay agent may not detect any changes in the DHCP state. For example,
if the mobile node releases the IPv4 address, the relay agent would
not be aware of it. The following describes additional mechanisms for
the mobile access gateway to detect any changes in the DHCP state.


<list style="symbols">
<t>
The DHCP relay agent can intercept all IPv4 DHCP packets destined to
the set of addresses used within the Proxy Mobile IPv6 domain as DHCP
addresses. Since the link between a mobile node and a mobile access
gateway is the point-to-point link, the mobile access gateway will be
in path for all the messages.
</t>

<t>
The DHCP relay agent can use the DHCP Server Identifier Override
Sub-option <xref target="RFC5107"/> to be in path for all the DHCP message flows.
The DHCP client uses the DHCP server address that is overridden by
the DHCP relay agent address as a destination address of DHCPREQUEST.
The DHCP Server Identifier Override Sub-option is recommended only
when the fixed DHCP relay address is configured on all the mobile
access gateways. Otherwise, the DHCP relay agent address is changed
when the mobile node changes the attached mobile access gateway.
</t>
</list></t>

<t>
However, if the DHCP server is co-located with the local mobility
anchor, then the DHCP relay agent is not required to intercept the
unicast DHCP messages between the mobile node and the DHCP server.
This is because the local mobility anchor will ensure that the DHCP
state is consistent with the Proxy Mobile IPv6 binding that exists for the IPv4
address.
</t>

<t>
Once the mobile access gateway intercepts the DHCP message from the
mobile node to the DHCP server, it can verify if the mobile node is
negotiating the same IPv4 address that the local mobility anchor 
allocated for that mobile node. If the address in the DHCPREQUEST
message does not match with the IPv4 address allocated for the mobile
node, then the mobile access gateway SHOULD drop the DHCP message and
an administrative error message can be logged.
</t>

<t>
Any time the mobile access gateway detects that the mobile node has
released its IPv4 address, it can send a Proxy Binding Update to the
local mobility anchor and de-register the IPv4 mobility session.
</t>
</list></t>

</section>



   
<!----------------------------------------------------------------------------->
<!--	SECTION 3.4.3: Common DHCP Considerations           	             -->
<!----------------------------------------------------------------------------->       
<section title="Common DHCP Considerations" anchor="sec:v4hoa-mag-dhcp-common">
<t>
The following DHCP-related considerations are common to both the
supported configuration modes, specified in Sections
<xref target="sec:v4hoa-mag-dhcpserver" format="counter"/> and <xref target="sec:v4hoa-mag-dhcprelay" format="counter"/>.
</t>

<t><list style="symbols">
<t>
When a mobile node sends a DHCPDISCOVER message <xref target="RFC2131"/>, the DHCP
server or the relay agent co-located with the mobile access gateway
will trigger the mobile access gateway to complete the Proxy Mobile
IPv6 signaling. This is the required interaction between these two
protocols. The mobile access gateway, on receiving this trigger, will 
check if there is already an assigned IPv4 home address for the mobile
node, from the local mobility anchor. If there is no assigned IPv4 home
address assigned for that mobile node, the mobile access gateway will
complete the Proxy Mobile IPv6 signaling with the local mobility anchor
by sending a Proxy Binding Update message. 
</t>

<t>
The mobile node needs to be identified by the MN-Identifier, as
specified in Section 6.6 of <xref target="RFC5213"/>. This identity should be
associated to the DHCP messages sent by the mobile node.
</t>

<t>
The mobile access gateway will drop all the DHCPDISCOVER messages until
it completes the Proxy Mobile IPv6 signaling. If the mobile access
gateway is unable to complete the Proxy Mobile IPv6 signaling, or, if
the local mobility anchor does not assign an IPv4 address for the
mobile node, the mobile access gateway MUST NOT enable IPv4 home
address mobility support for the mobile node on that access link.
</t>

<t>
The trigger for initiating Proxy Mobile IPv6 signaling can also be
delivered to the mobile access gateway as part of a context transfer
from the previous mobile access gateway, or delivered from the other
network elements in the radio network, the details of which are outside
the scope of this document.
</t>

<t>
The DHCPOFFER message <xref target="RFC2131"/> sent to the mobile node MUST include
the Subnet Mask option <xref target="RFC2132"/> and the Router option <xref target="RFC2132"/>. The
values in the Subnet Mask option and Router option MUST be set to the
mobile node's IPv4 home subnet mask and its default router address,
respectively.
</t>

<t>
The DHCPOFFER message <xref target="RFC2131"/> sent to the mobile node MUST include
the Interface MTU option <xref target="RFC2132"/>. The DHCP servers in the Proxy 
Mobile IPv6 domain MUST be configured to include the Interface MTU
option. The MTU value SHOULD reflect the tunnel MTU for the
bidirectional tunnel between the mobile access gateway and the local
mobility anchor. 
</t>

<t>
The DHCP lease length allocated to the mobile node's IPv4 home address
may be different from the binding lifetime at the local mobility
anchor for that mobile node's session. It is not possible to keep these
lifetimes synchronized, and so its not required that the configured 
lifetimes should be kept same in both DHCP and Proxy Mobile IPv6.
</t>


<t>
When the mobile node performs a handoff from one mobile access gateway
to another, the mobile access gateway on the new link will initiate
the Proxy Mobile IPv6 signaling with the local mobility anchor. On
completing the Proxy Mobile IPv6 signaling, the mobile access gateway
has the proper IPv4 address state that the local mobility anchor has
allocated for the mobile node and that can be used for supporting DHCP
based address configuration on that link.
</t>

<t>
Any time the mobile node detects a link change event due to handoff, or
due to other reasons such as re-establishment of the link-layer, the
following are the mobile node's considerations with respect to the DHCP
protocol.

<list style="symbols">
<t>
If the mobile node is DNAv4-capable (Detecting Network Attachment version 4) <xref target="RFC4436"/> and if it performs DNAv4
procedures after receiving a link change event, it would always detect
the same default router on any of the access links in that Proxy Mobile
IPv6 domain, as the mobile access gateway configures a fixed link-layer
address on all the access links, as per the base Proxy Mobile IPv6
specification <xref target="RFC5213"/>. The mobile node will not perform any DHCP
operation specifically due to this event. 
</t>

<t>
If the mobile node is not DNAv4-capable <xref target="RFC4436"/>, after receiving the
link change event it will enter INIT-REBOOT state <xref target="RFC2131"/> and will
send a DHCPREQUEST message as specified in Section 3.7 of <xref target="RFC2131"/>.
The mobile node will obtain the same address configuration as before,
as the link change does not result in any change at the network layer.
</t>
</list></t>

<t>
The mobile node may release its IPv4 home address at any time by
sending the DHCPRELEASE message <xref target="RFC2131"/>. When the mobile access 
gateway detects the DHCPRELEASE message sent by the mobile node, it
should consider this as a trigger for de-registering the mobile node's
IPv4 home address. It will apply the considerations specified in
<xref target="sec:v4hoa-mag-extendlife"/> for performing the de-registration procedure. However,
this operation MUST NOT release any IPv6 home network prefix(es)
assigned to the mobile node.
</t>

</list></t>


</section> <!-- DHCP Considerations -->

</section> <!-- DHCP Interactions -->
</section> <!-- IPv4 Home Address Mobility Support -->


<!----------------------------------------------------------------------------->
<!--	SECTION 4: IPv4 Transport Support   	        	                 -->
<!----------------------------------------------------------------------------->
<section title="IPv4 Transport Support" anchor="sec:v4trans">  

<t>The Proxy Mobile IPv6 specification <xref target="RFC5213"/> requires the
signaling messages exchanged between the local mobility anchor and the
mobile access gateway to be over an IPv6 transport. However, in some
cases, the local mobility anchor and the mobile access gateway are
separated by an IPv4 network.</t>

<t>The normal Proxy Mobile IPv6 specification <xref target="RFC5213"/> can be run
over an IPv4 transport without any modifications by using a transition
technology that allows IPv6 hosts to communicate over IPv4
networks. For example, the mobile access gateway and the local mobility anchor
could have a simple configured IPv6-over-IPv4 tunnel. Instead of configured tunnels,
various mechanisms for automatic tunneling could be used, too. To
these tunnels, Proxy Mobile IPv6 would look just like any other
application traffic running over IPv6.</t>

<t>However, treating Proxy Mobile IPv6 just like any other IPv6
traffic would mean an extra layer of encapsulation for the mobile
node's tunneled data traffic, adding 40 octets of overhead for each
packet. The extensions defined in this section allow the mobile access gateway and
the local mobility anchor to communicate over an IPv4 network without this overhead.</t>

<figure anchor='fig:pba-coa-network' title="IPv4 Transport Network">
<artwork>
<![CDATA[                    
         IPv4-Proxy-CoA                      IPv4-LMAA
                |         + - - - - - - +        |
+--+          +---+      /               \     +---+          +--+
|MN|----------|MAG|=====   IPv4  Network  =====|LMA|----------|CN|
+--+          +---+      \               /     +---+          +--+
                          + - - - - - - +                           
]]>                      
</artwork>
</figure>
   
<t>
When the local mobility anchor and the mobile access gateway are
configured and reachable using only IPv4 addresses, the mobile access
gateway serving a mobile node can potentially send the signaling
messages over IPv4 transport and register its IPv4 address as the
care-of address in the mobile node's Binding Cache entry. An IPv4
tunnel (with any of the supported encapsulation modes) can be used for
tunneling the mobile node's data traffic. The following are the key
aspects of this feature.
</t>
     
<t><list style="symbols">
<t>
The local mobility anchor and the mobile access gateway are both
<!-- *JiK* configured and reachable using an IPv4 address.-->
configured and reachable using an IPv4 address of the same scope.
</t>

<t>
The IPv4 addresses used can be private IPv4 addresses, but it is
assumed that there is no NAT between the local mobility anchor and the mobile
access gateway. However, it is possible to use UDP encapsulation if other
types of middleboxes are present.
</t>

<t>
The Mobility Header <xref target="RFC3775"/> is carried inside an IPv4
packet with UDP header (IPv4-UDP-MH), using a UDP port number for Proxy Mobile IPv6
signaling over IPv4.
</t>

<t>
The mobile node can be an IPv6, IPv4, or a dual IPv4/IPv6 node and the
IPv4 transport support specified in this section is agnostic to the
type of address mobility enabled for that mobile node.
</t>

<t>
The mobile node's data traffic will be tunneled between the local
mobility anchor and the mobile access gateway. There are several
encapsulation modes available:

<list style="symbols">
<t>
IPv4 (IPv4 or IPv6 payload packet carried in an IPv4 packet).
If payload protection using IPsec is enabled for the tunneled traffic,
the Encapsulating Security Payload (ESP) header follows the outer tunnel header.
</t>

<t>
IPv4-UDP (payload packet carried in an IPv4 packet with UDP header,
using a UDP port number for Proxy Mobile IPv6 data; this is different
port than is used for signaling).  If payload protection using IPsec
is enabled, the ESP header follows the outer IPv4 header, as explained
in <xref target="sec:IPv4coa-sec-considerations"/>.
</t>

<t>
IPv4-UDP-TLV (payload packet carried in an IPv4 packet with UDP and
TLV header) and IPv4-GRE (Payload packet carried in an IPv4 packet
with GRE header). Refer to <xref target="RFC5845"/>.
If payload protection using IPsec is enabled, the ESP header follows the
outer IPv4 header, as explained in <xref target="sec:IPv4coa-sec-considerations"/>.
</t>
</list></t>
</list></t>


<!----------------------------------------------------------------------------->
<!-- SECTION 4.1: Local Mobility Anchor Considerations -->
<!----------------------------------------------------------------------------->
<section title="Local Mobility Anchor Considerations" anchor="sec:IPv4coa-lma-considerations">


<!----------------------------------------------------------------------------->
<!--	SECTION 4.1.1: Extensions to Binding Cache Entry      	             -->
<!----------------------------------------------------------------------------->
<section title="Extensions to Binding Cache Entry" anchor="sec:IPv4coa-lma-concept">
<t>
To support this feature, the conceptual Binding Cache entry data
structure maintained by the local mobility anchor <xref target="RFC5213"/> MUST be
extended with the following additional parameters. It is to be noted
that all of these parameters are specified in <xref target="RFC5555"/> and also
required here in the present usage context, and are presented here only
for completeness.
</t>

<t><list style="symbols">
<t>
The IPv4 Proxy Care-of Address configured on the mobile access gateway
that sent the Proxy Binding Update message. The address MUST be the same as
the source address of the received IPv4 packet that
contains the Proxy Binding Update message. However, if the received
Proxy Binding Update message is not sent as an IPv4 packet, i.e., when
using IPv6 transport, this field in the Binding Cache entry MUST be set
to the ALL_ZERO value.
</t>

</list></t>
</section> <!-- Extensions to Binding Cache Entry -->


<!----------------------------------------------------------------------------->
<!--	SECTION 4.1.2: Extensions to Mobile Node's Policy Profile            -->
<!----------------------------------------------------------------------------->
<section title="Extensions to Mobile Node's Policy Profile">
<t>
To support the IPv4 Transport Support feature, the mobile node's policy
profile, specified in Section 6.2 of <xref target="RFC5213"/>, MUST be extended with
the following additional fields. These are mandatory fields of the
policy profile required for supporting this feature.
</t>

<t><list style="symbols">
<t>
The IPv4 address of the local mobility anchor (IPv4-LMAA). 
</t>
</list></t>
</section>


<!----------------------------------------------------------------------------->
<!--	SECTION 4.1.3: LMA Signaling Considerations          	             -->
<!----------------------------------------------------------------------------->
<section title="Signaling Considerations" anchor="sec:v4trans-lma">
<t>
This section provides the rules for processing the Proxy Mobile IPv6
signaling messages received over IPv4 transport.
</t>

<!----------------------------------------------------------------------------->
<!--	SECTION 4.1.3.1: Processing Proxy Binding Updates      	             -->
<!----------------------------------------------------------------------------->
<section title="Processing Proxy Binding Updates" anchor="sec:v4trans-lmapbu">

<t><list style="symbols">

<t>If the Proxy Binding Update message is protected with IPsec ESP,
IPsec processing happens before the packet is passed to Proxy 
Mobile IPv6.</t>

<t>
All the considerations from Section 5.3.1 of <xref target="RFC5213"/> except Step 1
(about IPsec) MUST be applied on the encapsulated Proxy Binding
Update message. Note that the Checksum field in Mobility Header MUST be
ignored.
<!-- *JiK* no pseudoheader available/required.. -->
</t>

<t>
Upon accepting the request, the local mobility anchor MUST set up an
IPv4 bidirectional tunnel to the mobile access gateway. The tunnel
endpoint addresses are IPv4-LMAA and the IPv4-Proxy-CoA. The
encapsulation mode MUST be determined by applying the following
considerations:

<list style="symbols">
<t>
If the (F) flag in the received Proxy Binding Update message is set to
the value of (1), but if the configuration flag,
AcceptForcedIPv4UDPEncapsulationRequest, is set to a value of (0),
then the local mobility anchor MUST reject the request with the Status
field value set to 129 (Administratively prohibited).
</t>

<t>If the (T) flag is set to (1), or GRE Key option is included, see
<xref target="RFC5845"/>.

</t>

<t>
If the (F) flag in the received Proxy Binding Update message is set to
the value of (1), then the encapsulation mode MUST be set to
IPv4-UDP. Otherwise, the encapsulation mode MUST be set to IPv4.
</t>

</list></t>

<t>
The local mobility anchor MUST send the Proxy Binding Acknowledgement
message with the Status field value set to (0) (Proxy Binding Update
accepted). The message MUST be constructed as specified in <xref target="sec:v4trans-lma-pbucons"/>.
</t>
</list></t>
</section> <!-- Processing Proxy Binding Updates -->


<!----------------------------------------------------------------------------->
<!-- SECTION: 4.1.3.2 Constructing the Proxy Binding Acknowledgement Message -->
<!----------------------------------------------------------------------------->
<section title="Constructing the Proxy Binding Acknowledgement Message" anchor="sec:v4trans-lma-pbucons">

<t>
The local mobility anchor when sending the Proxy Binding
Acknowledgement message to the mobile access gateway MUST construct
the message as specified in Section 5.3.6 of <xref target="RFC5213"/>. However,
if the Proxy Binding Update message was received over IPv4, the following
additional considerations MUST be applied.
</t>

<t><list style="symbols">

<t>
The IPv6 Header is removed, and the Mobility Header containing the Proxy
Binding Acknowledgement is encapsulated in UDP (with source port set to 5436
and destination port set to the source port of the received Proxy Binding Update
message). The Mobility Header Checksum field MUST be set to zero (and the UDP checksum MUST be
used instead).

</t>

<t>
The source address in the IPv4 header of the message MUST be set to
the destination IPv4 address of the received request.
</t>

<t>
If IPsec ESP is used to protect signaling, the packet is processed
using transport mode ESP as described in <xref target="sec:IPv4coa-sec-considerations"/>.</t>

<t>
<xref target="fig:pba1" /> shows the format of the Proxy Binding
Acknowledgement message sent over IPv4 and protected using ESP.
</t>

<figure anchor="fig:pba1"  title="Proxy Binding Acknowledgement (PBA) Message Sent over IPv4">
<artwork>        
<![CDATA[
  IPv4 header (src=IPv4-LMAA, dst=pbu_src_address) 
    ESP header (in transport mode)
      UDP header (sport=5436, dport=5436)
        Mobility Header (PBA)
     ]]>        
</artwork>
</figure>

</list></t>
</section> <!-- Constructing the Proxy Binding Acknowledgement Message -->

</section> <!-- Signaling Considerations -->


<!----------------------------------------------------------------------------->
<!--	SECTION 4.1.4: LMA Routing Considerations            	                 -->
<!----------------------------------------------------------------------------->
<section title="Routing Considerations" anchor="sec:v4trans-lmaroutingcons">


<!----------------------------------------------------------------------------->
<!--	SECTION 4.1.4.1: Forwarding Considerations          	                 -->
<!----------------------------------------------------------------------------->
<section title="Forwarding Considerations" anchor="sec:v4trans-lmaforwardingcons">

<!--vspace blankLines="1" /-->

<t>
Forwarding Packets to the Mobile Node:
</t>
<t><list style="symbols">
<t>
On receiving an IPv4 or an IPv6 packet from a correspondent node with
the destination address matching any of the mobile node's IPv4 or IPv6
home addresses, the local mobility anchor MUST forward the packet
through the bidirectional tunnel set up for that mobile node.
</t>

<t>
The format of the tunneled packet is shown below. 
The IPv4-UDP-TLV and IPv4-GRE encapsulation modes are described
in <xref target="RFC5845"/>.</t>

<figure anchor="fig100"  title="Tunneled IPv4 Packet from LMA to MAG (IPv4 or IPv4-UDP Encapsulation Mode) ">
<artwork>        
<![CDATA[
 IPv4 Header (src=IPv4-LMAA, dst=IPv4-Proxy-CoA)] /* Tunnel Header */
   [UDP Header (src port=5437, dst port=5437]   /* If UDP encap nego */
     /* IPv6 or IPv4 Payload Packet */                     
     IPv6 header (src=CN, dst=MN-HOA)
       OR 
     IPv4 header (src=CN, dst=IPv4-MN-HoA)                
]]>        
</artwork>        
</figure>


<!--vspace blankLines="1" /-->

<t>
Forwarding Packets Sent by the Mobile Node:

<list style="symbols">
<t>
All the reverse tunneled packets (IPv4 and IPv6) that the local
mobility anchor receives from the mobile access gateway, after removing
the tunnel header (i.e., the outer IPv4 header along with the UDP and
TLV header, if negotiated) MUST be routed to the destination specified
in the inner packet header. These routed packets will have the source
address field set to the mobile node's home address.
</t>
</list></t>
</list></t>
</section> <!-- Forwarding Considerations --> 


<!----------------------------------------------------------------------------->
<!--	SECTION 4.1.4.2: ECN Considerations               	                 -->
<!----------------------------------------------------------------------------->
<section title="ECN and Payload Fragmentation Considerations">
<t>
The ECN considerations specified in Section 5.6.3 of <xref target="RFC5213"/> apply
for the IPv4 transport tunnels as well. The mobility agents at the
tunnel entry and exit points MUST handle ECN information as specified
in that document.
</t>

<t>
The mobility agents at the tunnel entry and exit points MUST apply the
IP packet fragmentation considerations as specified in <xref target="RFC4213"/>.
Additionally, they MUST also apply the considerations related to tunnel
error processing and reporting as specified in the same specification.
</t>
</section> <!-- ECN Considerations -->


<!----------------------------------------------------------------------------->
<!--	SECTION 4.1.4.3: Bi-Directional Tunnel Management           	     -->
<!----------------------------------------------------------------------------->
<section title="Bidirectional Tunnel Management" anchor="sec:v4trans-tunnelmgmt">
<t>
The Tunnel Management considerations specified in Section 5.6.1 of
<xref target="RFC5213"/> apply for the IPv4 transport tunnels as well, with just one
difference that the encapsulation mode is different.
</t>
</section> <!-- Bi-Directional Tunnel Management -->
</section> <!-- Routing Considerations -->
</section> <!-- LMA Considerations -->





<!----------------------------------------------------------------------------->
<!--	SECTION 4.2: Mobile Access Gateway Considerations    	             -->
<!----------------------------------------------------------------------------->
<section title="Mobile Access Gateway Considerations" anchor="sec:IPv4coa-mags-considerations">


<!----------------------------------------------------------------------------->
<!--	SECTION 4.2.1: Mobile Access Gateway Considerations    	             -->
<!----------------------------------------------------------------------------->
<section title="Extensions to Binding Update List Entry" anchor="sec:IPv4coa-mag-concept">
<t>
To support the IPv4 Transport Support feature, the conceptual Binding
Update List entry data structure maintained by the mobile access
gateway <xref target="RFC5213"/> MUST be extended with the following additional
parameters.
</t>


<t><list style="symbols">
<t>
The IPv4 address of the local mobility anchor. This address can be
obtained from the mobile node's policy profile.
</t>

</list></t>
</section> <!-- Extensions to BUL Entry -->


<!----------------------------------------------------------------------------->
<!--	SECTION 4.2.2: MAG Signaling Considerations          	             -->
<!----------------------------------------------------------------------------->
<section title="Signaling Considerations" anchor="sec:v4trans-mag">
<t>
The mobile access gateway, when sending a Proxy Binding Update message
to the local mobility anchor, MUST construct the message as specified in
Section 6.9.1.5 of <xref target="RFC5213"/>. However, if the mobile access gateway is
in an IPv4-only access network, the following additional considerations
MUST be applied.
</t>


<t><list style="symbols"> 
<t>
The Proxy Binding Update message MUST be sent over IPv4 as described
in <xref target="sec:v4trans-mag-pbucons"/>.
</t>


<t>

Just as specified in <xref target="RFC5213"/>, when sending a Proxy Binding Update message
for extending the lifetime of a currently existing mobility session or
to de-register the mobility session, the Proxy Binding Update
message MUST be constructed just as the initial request.
</t>
</list></t>



<vspace blankLines="1" />
<t>
Receiving Proxy Binding Acknowledgement: 
</t>
<t><list style="symbols"> 
<t>If the received Proxy Binding Acknowledgement message is protected
with IPsec ESP, IPsec processing happens before the packet is passed
to Proxy Mobile IPv6. Considerations from Section
4 of <xref target="RFC5213"/> MUST be applied to authenticate and authorize the
message.
</t>

<t>
All the considerations from Section 6.9.1.2 of <xref target="RFC5213"/> MUST be
applied on the encapsulated Proxy Binding Acknowledgement message.
Note that the Checksum field in Mobility Header MUST be ignored.
</t>

<t>
If the Status field indicates Success, the mobile access gateway MUST
set up a bidirectional tunnel to the local mobility anchor.
</t>

<t>
Upon accepting the request, the mobile access gateway MUST set up an
IPv4 bidirectional tunnel to the local mobility anchor. The tunnel
endpoint addresses are the IPv4-Proxy-CoA and the IPv4-LMAA. The
encapsulation mode MUST be determined from the below considerations:

<list style="symbols">

<t>If the (T) flag is set to (1), or the GRE Key option is included, see
<xref target="RFC5845"/>.</t>

<t>If there is a NAT Detection option <xref target="RFC5555"/> in the received Proxy
Binding Acknowledgement message, and the (F) flag is set to value of
(1), the encapsulation mode for the tunnel MUST be set to IPv4-UDP.
Otherwise, the encapsulation mode MUST be set to IPv4.
</t>

</list></t>
</list></t>


<!----------------------------------------------------------------------------->
<!-- SECTION: 4.2.2.1 Constructing the Proxy Binding Update Message          -->
<!----------------------------------------------------------------------------->
<section title="Constructing the Proxy Binding Update Message" anchor="sec:v4trans-mag-pbucons">

<t><list style="symbols"> 

<t>
The IPv6 Header is removed, and the Mobility Header containing the Proxy
Binding Update message is encapsulated in UDP (with the destination
port set to 5436). The Mobility Header Checksum field MUST be set to zero (and UDP
checksum MUST be used instead).
</t>


<t>
The source address in the IPv4 header MUST be set to IPv4-Proxy-CoA of
the mobile access gateway and the destination address MUST be set to
the local mobility anchor's IPv4-LMAA. 
</t>

<t>
If the configuration variable ForceIPv4UDPEncapsulationSupport is set
to value of (1), then the (F) flag in the Proxy Binding Update message
MUST be set to value of (1).
</t>

<t>If IPsec ESP is used to protect signaling, the packet is processed
using transport mode ESP as described in <xref target="sec:IPv4coa-sec-considerations"/>.</t>

<t><xref target="fig:pbu1"/> shows the format of the Proxy Binding
Update message sent over IPv4 and protected using ESP.
</t>

<figure anchor="fig:pbu1"  title="Proxy Binding Update (PBU) Message Sent over IPv4">
<artwork>        
<![CDATA[
  IPv4 header (src=IPv4-Proxy-CoA, dst=IPv4-LMAA)
    ESP header (in transport mode)
      UDP header (sport=5436, dport=5436) 
        Mobility Header (PBU)
]]>        
</artwork>        
</figure>

</list></t>
</section> <!-- Constructing the Proxy Binding Update Message -->


<!----------------------------------------------------------------------------->
<!--	SECTION 4.2.2.2: Forwarding Considerations                           -->
<!----------------------------------------------------------------------------->
<section title="Forwarding Considerations" anchor="sec:v4trans-magforwardingcons">
<!--vspace blankLines="1" /-->

<t>
Forwarding Packets Sent by the Mobile Node:
</t>

<t><list style="symbols">
<t>
On receiving an IPv4 or an IPv6 packet from the mobile node to any
destination, the mobile access gateway MUST tunnel the packet to the
local mobility anchor. The format of the tunneled packet is shown
below. The IPv4-UDP-TLV and IPv4-GRE encapsulation modes are described
in <xref target="RFC5845"/>.
However, considerations from Section 6.10.3 of <xref target="RFC5213"/> MUST
be applied with respect the local routing and on the use of
EnableMAGLocalRouting flag. 
</t>


<figure anchor="fig101"  title="Tunneled IPv4 Packet from MAG to LMA (IPv4 or IPv4-UDP Encapsulation Mode)">
   <artwork>        
<![CDATA[
IPv4 Header (src=IPv4-Proxy-CoA, dst=IPv4-LMAA)] /* Tunnel Header */
   [UDP Header (src port=5437, dst port=5437]   /* If UDP encap nego */
     /* IPv6 or IPv4 Payload Packet */                     
     IPv6 header (src=MN-HOA, dst=CN)
       OR 
     IPv4 header (src=IPv4-MN-HOA, dst=CN)                
]]> 
</artwork>        
</figure>


</list></t>

<t>
Forwarding Packets Received from the Bidirectional Tunnel:
</t>


<t><list style="symbols">

<t>
On receiving a packet from the bidirectional tunnel established
with the mobile node's local mobility anchor, the mobile access
gateway MUST remove the outer header before forwarding the packet
to the mobile node.
</t>
</list></t>
</section> <!-- Routing Considerations -->    
</section> <!-- MAG Signaling Considerations -->
</section> <!-- MAG Considerations -->

<!----------------------------------------------------------------------------->
<!--	SECTION 4.3: IPsec Considerations    	                             -->
<!----------------------------------------------------------------------------->
<section title="IPsec Considerations" anchor="sec:IPv4coa-sec-considerations">

<section title="PBU and PBA" anchor="sec:IPv4coa-sec-considerations-t">

 
<t>
The following section describes how IPsec is used to protect the
signaling messages and data packets between the local mobility anchor
and mobile access gateway when using IPv4 transport.
</t>

<t>
The following are the Security Policy Database (SPD) example entries to protect PBU and PBA on
the local mobility anchor and mobile access gateway.
</t>

<artwork>        
    <![CDATA[
        MAG SPD-S:
          - IF local_address = IPv4-Proxy-CoA_1 &
               remote_address = IPv4-LMAA_1 & proto = UDP &
               remote_port = 5436
            Then use SA ESP transport mode

        LMA SPD-S:
          - IF local_address = IPv4-LMAA_1 &
               remote_address = IPv4-Proxy-CoA_1 & proto = UDP &
               local_port = 5436
            Then use SA ESP transport mode
     ]]>        
</artwork>        

</section>

<section title="Payload Packet" anchor="sec:IPv4coa-sec-considerations-data">

<!--t>TODO: This section probably needs some rewriting</t-->

<t>
The following are the SPD example entries to protect payload packets on
the local mobility anchor and mobile access gateway. Note that the
example SPDs protect all payload packets sent to and from mobile
nodes. If an operator needs to apply a different security mechanism
per mobile node, they need to create a SPD and a SA entry per mobile
node.
</t>
<!-- *JiK* Changed the SPD a bit -->
<artwork>        
    <![CDATA[
        MAG SPD-S:
          - IF interface = tunnel to LMAA_1 &
               local_address != Proxy-CoA_1 &
               remote_address != LMAA_1 & proto=any
            Then use SA ESP tunnel mode
      
        LMA SPD-S:
          - IF interface = tunnel to Proxy-CoA_1 &
               local_address != LMAA_1 &
               remote_address != Proxy-CoA_1 & proto=any
            Then use SA ESP tunnel mode
     ]]>        
</artwork>        


<t>When payload packets are protected by IPsec, payload packets matching the
SPDs are passed to the IPsec module and encapsulated using the tunnel mode
ESP. The tunnel mode ESP encapsulated payload packets are then directly sent to
the peer mobile access gateway or local mobility anchor. If IPsec is not applied
to payload packets, then they are encapsulated as shown in Figures
<xref target="fig100" format="counter"/> and <xref target="fig101" format="counter"/>.
</t>

</section>

</section> <!-- IPsec Considerations --> 
</section> <!-- End of Section 4.0 IPv4 Transport Support -->



<!-------------------------------------------------------------------------->
<!--  SECTION 5: Protocol Configuration Variables                       -->
<!-------------------------------------------------------------------------->
<section title="Protocol Configuration Variables">
<!--vspace blankLines="1" /-->


<!-------------------------------------------------------------------------->
<!--  SECTION 5.1: Local Mobility Anchor - Configuration Variables        -->
<!-------------------------------------------------------------------------->
<section title="Local Mobility Anchor - Configuration Variables">
<t>
The local mobility anchor MUST allow the following variables to be
configured by the system management. The configured values for these
protocol variables MUST survive server reboots and service restarts.
</t>

<!--vspace blankLines="1" /-->

<t>
AcceptForcedIPv4UDPEncapsulationRequest
</t>
<t><list style="hanging">
<t>
This flag indicates whether or not the local mobility anchor should
accept IPv4 UDP encapsulation request for the mobile node's data 
traffic. The default value for this flag is set to (0), indicating that
plain IPv4 encapsulation (without UDP) is used for data traffic.
</t>

</list></t>
<vspace blankLines="1" />
</section> <!-- LMA - Configuration Variables -->


<!-------------------------------------------------------------------------->
<!--  SECTION 5.2: Mobile Access Gatewway - Configuration Variables       -->
<!-------------------------------------------------------------------------->
<section title="Mobile Access Gateway - Configuration Variables">
<!--vspace blankLines="1" /-->
<t>
The mobile access gateway MUST allow the following variables to be configured
by the system management. The configured values for these protocol variables
MUST survive server reboots and service restarts.
</t>
<!--vspace blankLines="1" /-->

<t>
ForceIPv4UDPEncapsulationSupport
</t>
<t><list style="hanging">
<t>
This flag indicates whether or not the mobile access gateway should
request the mobile node's local mobility anchor to use IPv4-UDP encapsulation
mode for the mobile node's data traffic. The default value for this flag is set
to (0), indicating that plain IPv4 encapsulation (without UDP) is used
for data traffic.
</t>

</list></t>
</section> <!-- MAG Configuration Variables -->
</section> <!-- Protocol Configuration Variables -->


<!-------------------------------------------------------->
<!--	SECTION 6: IANA CONSIDERATIONS         			-->
<!-------------------------------------------------------->
<section anchor="sec:iana" title="IANA Considerations">
<t>
This document defines four new Mobility Header options: the IPv4 Home
Address Request option, IPv4 Home Address Reply option, IPv4 Default
Router Address option, and IPv4 DHCP Support Mode option. These
options are described in Sections <xref target="sec:HAreq"
format="counter"/>, <xref target="sec:HArep" format="counter"/>,
<xref target="sec:DRadd" format="counter"/>, and
<xref target="sec:DHCPsupp" format="counter"/>, respectively.  The
Type value for these options has been assigned from the same number
space as allocated for the other mobility options, as defined in
<xref target="RFC3775"/>.
</t>

<t>
The IPv4 Home Address Reply option, described in <xref target="sec:HArep"/> of
this document, introduces a new number space, IPv4 Home Address Reply
status codes. This document currently reserves the following values.
Approval of any new status code values are to be made through IANA Expert
Review.
</t>
<t><list style="symbols">
  <t>0 Success</t>
            
  <t>128 Failure, Reason Unspecified</t>

  <t>129 Administratively prohibited</t>

  <t>130 Incorrect IPv4 home address</t>

  <t>131 Invalid IPv4 address</t>

  <t>132 Dynamic IPv4 home address assignment not available</t>
</list></t>

<t>
The IPv4 DHCP Support Mode option, described in <xref target="sec:DHCPsupp"/> of this
document, introduces a new number space, IPv4 DHCP Support Mode Flags.
This document reserves the value 0x1 for the (S) flag. Approval of 
flag values are to be made through IANA Expert Review. At this point in
time, there are no thoughts on what the new flag allocations can be, and hence this document leaves this to the discretion of the Expert Review.
</t>

<t>
This document also defines new Status values, used in Proxy Binding
Acknowledgement message, as described in <xref target="sec:statuscodes"/>. These values
have been assigned from the same number space as allocated for other
status codes <xref target="RFC3775"/>. Each of these allocated values is
greater than 128.
</t>

<t><list style="hanging">

<t>
NOT_AUTHORIZED_FOR_IPV4_MOBILITY_SERVICE: 170 
<list style="hanging">
<t>
Mobile node not authorized for IPv4 mobility service.
</t>
</list></t>


<t>
NOT_AUTHORIZED_FOR_IPV4_HOME_ADDRESS: 171 
<list style="hanging">
<t>
Mobile node not authorized for the requesting IPv4 home address.
</t>
</list></t>

<t>
NOT_AUTHORIZED_FOR_IPV6_MOBILITY_SERVICE: 172  
<list style="hanging">
<t>
Mobile node not authorized for IPv6 mobility service.
</t>
</list></t>

<t>
MULTIPLE_IPV4_HOME_ADDRESS_ASSIGNMENT_NOT_SUPPORTED: 173
<list style="hanging">
<t>
Multiple IPv4 home address assignment not supported.
</t>
</list></t>

</list></t>

<t>IANA has assigned two UDP port numbers, 5436 and 5437,
for "pmip6-cntl" and "pmip6-data", respectively.
</t>

</section> <!-- IANA Considerations -->


<!-------------------------------------------------------->
<!--	SECTION 7: SECURITY CONSIDERATIONS    			-->
<!-------------------------------------------------------->
<section anchor="sec:ipsec" title="Security Considerations">
<t>
All the security considerations from the base Proxy Mobile IPv6
<xref target="RFC5213"/>, Mobile IPv6 <xref target="RFC3775"/>, and Dual-Stack Mobile IPv6
<xref target="RFC5555"/> specifications apply when using the extensions defined in this document.
Additionally, the following security considerations need to be
applied.
</t>

<t>
This document defines new mobility options for supporting the IPv4
Home Address assignment and IPv4 Transport Support features. These
options are to be carried in Proxy Binding Update and Proxy Binding
Acknowledgement messages. The required security mechanisms specified in
the base Proxy Mobile IPv6 protocol for protecting these signaling
messages are sufficient when carrying these mobility options.
</t>

<t>
This specification describes the use of IPv4 transport for exchanging
signaling messages between the local mobility anchor and the mobile
access gateway. These can be protected using IPsec as described
in <xref target="sec:IPv4coa-sec-considerations"/>.
</t>

</section>


<!-------------------------------------------------------->
<!--	SECTION 8: CONTRIBUTORS             			-->
<!-------------------------------------------------------->

<section title="Contributors">

<t> 
This document reflects discussions and contributions from several
people (in alphabetical order):
</t>

<t>
<t><list style="hanging">

  <t hangText="Kuntal Chowdhury">
  </t><t>kchowdhury@starentnetworks.com</t>
     
  <t hangText="Vijay Devarapalli">
  </t><t>vijay.devarapalli@azairenet.com</t>

  <t hangText="Pasi Eronen">
  </t><t>Pasi.Eronen@nokia.com</t>
  
  <t hangText="Sangjin Jeong">
  </t><t>sjjeong@etri.re.kr</t>  

  <t hangText="Basavaraj Patil">
  </t><t>basavaraj.patil@nokia.com</t>
  
  <t hangText="Myungki Shin">
  </t><t>myungki.shin@gmail.com</t>
  
</list></t>
</t>
</section> <!-- Contributors --> 

<?rfc compact="yes" ?>


<!-------------------------------------------------------->
<!--	SECTION 9: ACKNOWLEDGEMENTS			-->
<!-------------------------------------------------------->
<section title="Acknowledgements">   
<t>
The IPv4 support for Proxy Mobile IPv6 was initially covered in    
"Proxy Mobile IPv6" (March 2007). We would like
to thank all the authors of the document and acknowledge that initial
work.
</t>  
  
<t>
Thanks to Alper Yegin, Behcet Sarikaya, Bernard Aboba, Charles Perkins,
Damic Damjan, Jari Arkko, Joel Hortelius, Jonne Soinnen,
Julien Laganier, Mohana Jeyatharan, Niklas Nuemann, Pasi Eronen,
Premec Domagoj, Ralph Droms, Sammy Touati, Vidya Narayanan, Yingzhe Wu,
and Zu Qiang for their helpful review of this document.
</t>  

<t>
Also, we would like to thank Spencer Dawkins, Tim Polk, Menachem
Dodge, Adrian Farrel, and Pekka Savola for their reviews of this
document as part of the IESG review process. Finally, special thanks to 
Jouni Korohonen for his support in addressing the IPsec issues.
</t>

</section> <!-- Acknowledgements -->


</middle>

<!-------------------------------------------------------->
<!--  Back Section	                    				-->
<!-------------------------------------------------------->



<!-------------------------------------------------------->
<!--	SECTION 10: REFERENCES                			-->
<!-------------------------------------------------------->

<!-------------------------------------------------------------------------->
<!--  SECTION 11.1: Normative References                                   -->
<!-------------------------------------------------------------------------->

<!-------------------------------------------------------------------------->
<!--  SECTION 11.2: Informative References                                -->
<!-------------------------------------------------------------------------->


<back>
  <references title="Normative References">
		&rfc2131;
		&rfc2132;
		&rfc2473;
		&rfc3775;
		&rfc3046;
		&rfc4213;
		&rfc4361;
		&rfc5107;
		&rfc5213;
		&rfc5555;
		&rfc2119;
  </references>
  <references title="Informative References">
		&rfc0925;
		&rfc1332;
		&rfc1918;
		&rfc3022;
		&rfc4306;
		&rfc4436;
		&rfc4977;

	<!-- ietf-netlmm-grekey-option = RFC-to-be 5845 -->

<reference anchor='RFC5845'>
<front>
<title>Generic Routing Encapsulation (GRE) Key Option for Proxy Mobile IPv6</title>

<author initials='A' surname='Muhanna' fullname='Ahmad Muhanna'>
    <organization />
</author>

<author initials='M' surname='Khalil' fullname='Mohamed Khalil'>
    <organization />
</author>

<author initials='S' surname='Gundavelli' fullname='Sri Gundavelli'>
    <organization />
</author>

<author initials='K' surname='Leung' fullname='Kent Leung'>
    <organization />
</author>

<date month='May' year='2010' />

<abstract><t>This specification defines a new Mobility Option for allowing the mobile access gateway and the local mobility anchor to negotiate GRE (Generic Routing Encapsulation) encapsulation mode and exchange the downlink and uplink GRE keys which are used for marking the downlink and uplink traffic that belong to a specific mobility session.  In addition, the same mobility option can be used to negotiate the GRE encapsulation mode without exchanging the GRE keys.</t></abstract>

</front>

<seriesInfo name='RFC' value='5845' />

</reference>




  </references>
</back>

<!-------------------------------------------------------------------------->
<!--  Appendix A: DHCP Scenarios                                          -->
<!-------------------------------------------------------------------------->

</rfc>
