<?xml version="1.0" encoding="US-ASCII"?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!ENTITY RFC2119 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml">
<!ENTITY RFC2434 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2434.xml">
<!ENTITY RFC4005 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4005.xml">
<!ENTITY RFC4675 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4675.xml">
<!ENTITY RFC5226 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5226.xml">
<!ENTITY RFC5777 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5777.xml">
<!ENTITY RFC5624 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5624.xml">
<!ENTITY RFC5866 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5866.xml">
<!ENTITY RFC6144 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6144.xml">
<!ENTITY RFC6145 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6145.xml">
<!ENTITY RFC6146 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6146.xml">
<!ENTITY RFC6147 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6147.xml">
<!ENTITY RFC1661 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.1661.xml">
<!ENTITY RFC3022 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3022.xml">
<!ENTITY RFC4097 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4097.xml">
<!ENTITY RFC2663 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2663.xml">
<!ENTITY RFC2776 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2776.xml">
<!ENTITY RFC3550 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3550.xml">
<!ENTITY RFC3303 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3303.xml">
<!ENTITY RFC3304 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3304.xml">
<!ENTITY RFC5189 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5189.xml">
<!ENTITY RFC3411 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3411.xml">
<!ENTITY RFC6241 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6241.xml">
]>
<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>
<?rfc strict="no" ?>
<?rfc toc="yes"?>
<?rfc tocdepth="4"?>
<?rfc symrefs="yes"?>
<?rfc sortrefs="yes" ?>
<?rfc compact="yes" ?>
<?rfc subcompact="no" ?>
<?rfc rfcedstyle="yes" ?>
<rfc submissionType="IETF" consensus="yes" category="std" number="6736"  ipr="trust200902">

  <!-- ***** FRONT MATTER ***** -->

  <front>


    <title abbrev="Diameter NAT Control Application">Diameter Network Address
    and Port Translation Control Application</title>


    <author fullname="Frank Brockners" initials="F." surname="Brockners">
      <organization>Cisco</organization>

      <address>
        <postal>
          <street>Hansaallee 249, 3rd Floor</street>

          <city>Duesseldorf</city>

          <region>Nordrhein-Westfalen</region>

          <code>40549</code>

          <country>Germany</country>
        </postal>

        <email>fbrockne@cisco.com</email>

      </address>
    </author>

    <author fullname="Shwetha Bhandari" initials="S." surname="Bhandari">
      <organization>Cisco</organization>

      <address>
        <postal>
          <street>Cessna Business Park, Sarjapura Marathalli Outer Ring
          Road</street>

          <city>Bangalore, Karnataka 560 087</city>

          <country>India</country>
        </postal>

        <email>shwethab@cisco.com</email>
      </address>
    </author>

    <author fullname="Vaneeta Singh" initials="V." surname="Singh">
      <organization></organization>

      <address>
        <postal>
          <street>18, Cambridge Road</street>

          <city>Bangalore 560008</city>

          <country>India</country>
        </postal>

        <email>vaneeta.singh@gmail.com</email>
      </address>
    </author>

    <author fullname="Victor Fajardo" initials="V." surname="Fajardo">
      <organization>Telcordia Technologies</organization>

      <address>
        <postal>
          <street>1 Telcordia Drive #1S-222</street>

          <city>Piscataway, NJ 08854</city>

          <country>USA</country>
        </postal>

        <email>vf0213@gmail.com</email>
      </address>
    </author>

    <date month="October" year="2012" />


    <!-- Meta-data Declarations -->

    <area>General</area>

    <workgroup>Internet Engineering Task Force</workgroup>




    <keyword>NAT control, NAT44, NAT66, CGN, BNG, diameter</keyword>



    <abstract>
      <t>This document describes the framework, messages, and procedures for
      the Diameter Network address and port translation Control Application.
      This Diameter application allows per-endpoint control of Network Address
      Translators and Network Address and Port Translators, which are added to
      networks to cope with IPv4 address space depletion. This Diameter
      application allows external devices to configure and manage a Network
      Address Translator device -- expanding the existing Diameter-based Authentication, Authorization, and Accounting (AAA)
      and policy control capabilities with a Network Address Translator and
      Network Address and Port Translator control component. These external
      devices can be network elements in the data plane such as a Network
      Access Server, or can be more centralized control plane devices such as
      AAA-servers. This Diameter application establishes a context to commonly
      identify and manage endpoints on a gateway or server and a Network
      Address Translator and Network Address and Port Translator device. This
      includes, for example, the control of the total number of Network
      Address Translator bindings allowed or the allocation of a specific
      Network Address Translator binding for a particular endpoint. In
      addition, it allows Network Address Translator devices to provide
      information relevant to accounting purposes.</t>
    </abstract>
  </front>

  <middle>
    <section title="Introduction" toc="default">
      <t>Internet service providers deploy Network Address Translators (NATs)
      and Network Address and Port Translators (NAPTs) <xref
      target="RFC3022"></xref> in their networks. A key motivation for doing
      so is the depletion of available public IPv4 addresses. This document
      defines a Diameter application allowing providers to control the
      behavior of NAT and NAPT devices that implement IPv4-to-IPv4 network
      address and port translation <xref target="RFC2663"></xref> as well as
      stateful IPv6-to-IPv4 address family translation as defined in <xref
      target="RFC2663"></xref>, <xref target="RFC6145"></xref>, and <xref
      target="RFC6146"></xref>. The use of a Diameter application allows for
      simple integration into the existing Authentication, Authorization, and
      Accounting (AAA) environment of a provider.</t>

      <t>The Diameter Network address and port translation Control Application
      (DNCA) offers the following capabilities:</t>

      <t><list style="numbers">
          <t>Limits or defines the number of NAPT/NAT-bindings made available
          to an individual endpoint. The main motivation for restricting the
          number of bindings on a per-endpoint basis is to protect the service
          of the service provider against denial-of-service (DoS) attacks. If
          multiple endpoints share a single public IP address, these endpoints
          can share fate. If one endpoint would (either intentionally, or due
          to misbehavior, misconfiguration, malware, etc.) be able to
          consume all available bindings for a given single public IP address,
          service would be hampered (or might even become unavailable) for
          those other endpoints sharing the same public IP address. The
          efficiency of a NAPT deployment depends on the maximum number of
          bindings an endpoint could use. Given that the typical number of
          bindings an endpoint uses depends on the type of endpoint (e.g., a
          personal computer of a broadband user is expected to use a higher
          number of bindings than a simple mobile phone) and a NAPT device is
          often shared by different types of endpoints, it is desirable to
          actively manage the maximum number of bindings. This requirement is
          specified in REQ-3 of <xref target="CGN-REQS"></xref>.</t>

          <t>Supports the allocation of specific NAPT/NAT-bindings. Two types
          of specific bindings can be distinguished:<list style="symbols">
              <t>Allocation of a predefined NAT-binding: The internal
              and external IP addresses as well as the port pair are specified within the
              request. Some deployment cases, such as access to a web-server
              within a user&rsquo;s home network with IP address and port,
              benefit from statically configured bindings.</t>

              <t>Allocation of an external IP address for a given internal IP
              address: The allocated external IP address is reported back to
              the requester. In some deployment scenarios, the application
              requires immediate knowledge of the allocated binding for a
              given internal IP address but does not control the allocation of
              the external IP address; for example, SIP-proxy server
              deployments.</t>
            </list></t>

          <t>Defines the external address pool(s) to be used for allocating an
          external IP address: External address pools can be either 
          pre-assigned at the NAPT/NAT device or specified within a request.
          If pre-assigned address pools are used, a request needs to include a
          reference to identify the pool. Otherwise, the request contains a
          description of the IP address pool(s) to be used, for example, a
          list of IP-subnets. Such external address pools can be used to
          select the external IP address in NAPT/NAT-bindings for multiple
          subscribers.</t>

          <t>Generates reports and accounting records: Reports established
          bindings for a particular endpoint. The collected information is
          used by accounting systems for statistical purposes.</t>

          <t>Queries and retrieves details about bindings on demand: This
          feature complements the previously mentioned accounting
          functionality (see item 4). This feature can be used by an entity to
          find NAT-bindings belonging to one or multiple endpoints on the
          NAT device. The entity is not required to create a DNCA control
          session to perform the query but would, obviously, still need to
          create a Diameter session complying to the security
          requirements.</t>

          <t>Identifies a subscriber or endpoint on multiple network devices
          (NAT/NAPT device, the AAA-server, or the Network Access Server
          (NAS)): Endpoint identification is facilitated through a Global
          Endpoint ID. Endpoints are identified through a single classifier or a set of
          classifiers, such as IP address, Virtual Local Area Network (VLAN)
          identifier, or interface identifier that uniquely identify the
          traffic associated with a particular global endpoint.</t>
        </list></t>

      <t>With the above capabilities, DNCA qualifies as a Middlebox Communications (MIDCOM) protocol
      <xref target="RFC3303"></xref>, <xref target="RFC3304"></xref>, <xref
      target="RFC5189"></xref> for middleboxes that perform NAT. The MIDCOM
      protocol evaluation <xref target="RFC4097"></xref> evaluated Diameter as
      a candidate protocol for MIDCOM. DNCA provides the extensions to the
      Diameter base protocol <xref target="RFC6733"></xref> following the
      MIDCOM protocol requirements, such as the support of NAT-specific rule
      transport, support for oddity of mapped ports, as well as support for
      consecutive range port numbers. DNCA adds to the MIDCOM protocol
      capabilities in that it allows the maintenance of the reference to an endpoint
      representing a user or subscriber in the control operation, enabling the
      control of the behavior of a NAT device on a per-endpoint basis.
      Following the requirements of different operators and deployments,
      different management protocols are employed. Examples include, for example, Simple Network Management Protocol (SNMP)
      <xref target="RFC3411"></xref> and Network Configuration (NETCONF) <xref
      target="RFC6241"></xref>, which can both be used for device
      configuration. Similarly, DNCA complements existing MIDCOM
      implementations, offering a MIDCOM protocol option for operators with an
      operational environment that is Diameter focused that desire the use of
      Diameter to perform per-endpoint NAT control. Note that in case an
      operator uses multiple methods and protocols to configure a NAT device,
      such as, for example, command line interface (CLI), SNMP, NETCONF, or Port Control Protocol (PCP), along
      with DNCA specified in this document, the operator MUST ensure that the
      configurations performed using the different methods and protocols do
      not conflict in order to ensure a proper operation of the NAT
      service.</t>

      <t>This document is structured as follows: <xref target="Conventions" /> lists terminology,
      while <xref target="framework" /> provides an introduction to DNCA and its overall
      deployment framework. Sections <xref target="management" format="counter" /> to <xref target="sec-dnca-avps" format="counter" /> cover DNCA specifics, with <xref target="management" /> describing session management, <xref target="sec-diameter-base-use" /> the use of the Diameter base
      protocol, <xref target="sec-dnca-commands" /> new commands, <xref target="sec-dnca-avps" /> Attribute Value Pairs (AVPs)
      used, and <xref target="sec-accounting" /> accounting aspects. <xref target="sec-avp-occurence-table" /> presents AVP
      occurrence tables. IANA and security considerations are addressed in
      Sections <xref target="IANA" format="counter"/> and <xref target="Security" format="counter" />, respectively.</t>
    </section>

    <section anchor="Conventions" title="Conventions">
      <t>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
      "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
      document are to be interpreted as described in <xref
      target="RFC2119"></xref>.</t>

      <t>Abbreviations and terminology used in this document:</t>

      <t><list style="empty">
          <t>AAA: Authentication, Authorization, Accounting</t>

          <t>DNCA: Diameter Network address and port translation Control
          Application</t>

          <t>Endpoint: Managed entity of the DNCA. An endpoint represents a
          network element or device, associated with a subscriber, a user, or a
          group of users. An endpoint is represented by a single
          access-session on a NAS. DNCA assumes a 1:1 relationship between an
          endpoint, the access-session it represents, and the associated DNCA
          session.</t>

          <t>NAPT: Network Address and Port Translation, see also <xref
          target="RFC3022"></xref>.</t>

          <t>NAT: Network Address Translation (NAT and NAPT are used in this
          document interchangeably)</t>

          <t>NAT-binding or binding: Association of two IP address/port pairs
          (with one IP address typically being private and the other one
          public) to facilitate NAT</t>

          <t>NAT-binding predefined template: A policy template or
          configuration that is predefined at the NAT device. It may contain
          NAT-bindings, IP address pools for allocating the external
          IP address of a NAT-binding, the maximum number of allowed
          NAT-bindings for endpoints, etc.</t>

          <t>NAT device: Network Address Translator or Network Address and
          Port Translator: An entity performing NAT or NAPT.</t>

          <t>NAT controller: Entity controlling the behavior of a
          NAT device.</t>

          <t>NAS: Network Access Server</t>

          <t>NCR: NAT-Control-Request</t>

          <t>NCA: NAT-Control-Answer</t>

          <t>NAT44: IPv4-to-IPv4 NAPT, see
          <xref target="RFC2663"></xref></t>

          <t>NAT64: IPv6-to-IPv4 address family translation, see <xref
          target="RFC6145"></xref> and <xref target="RFC6146"></xref></t>

          <t>PPP: Point-to-Point Protocol <xref target="RFC1661"></xref></t>
        </list></t>
    </section>

    <section anchor="framework" title="Deployment Framework">
      <section title="Deployment Scenario">
        <t><xref target="fig-network-deployment"></xref> shows a typical
        network deployment for IPv4 Internet access. A user&rsquo;s IPv4 host
        (i.e., endpoint) gains access to the Internet though a NAS, which
        facilitates the authentication of the endpoint and configures the
        endpoint's connection according to the authorization and
        configuration data received from the AAA-server upon successful
        authentication. Public IPv4 addresses are used throughout the network.
        DNCA manages an endpoint that represents a network element or device
        or an IPv4 host, associated with a subscriber, a user or a group of
        users. An endpoint is represented by a single access-session on a NAS.
        DNCA assumes a 1:1:1 relationship between an endpoint, the
        access-session it represents, and the associated DNCA session.</t>

        <figure anchor="fig-network-deployment"
                title="Typical Network Deployment for Internet Access">
          <artwork><![CDATA[
                      +---------+
                      |         |
                      |   AAA   |
                      |         |
                      +---------+
                           |
                           |
                           |
                           |
 +---------+          +---------+             +----------+
 |  IPv4   |          |         |             |  IPv4    |
 |  Host   |----------|   NAS   |-------------| Internet |
 |         |          |         |             |          |
 +---------+          +---------+             +----------+

 <-------------------- Public IPv4 ---------------------->
]]></artwork>
        </figure>

        <t><xref target="fig-NAT-deployment"></xref> depicts the deployment
        scenario where a service provider places a NAT between the host and
        the public Internet. The objective is to provide the customer with
        connectivity to the public IPv4 Internet. The NAT device performs
        network address and port (and optionally address family) translation,
        depending on whether the access network uses private IPv4 addresses or
        public IPv6 addresses to public IPv4 addresses. Note that there may
        be more than one NAS, NAT device, or AAA-entity in a deployment,
        although the figures only depict one entity each for clarity.</t>

        <t>If the NAT device would be put in place without any endpoint
        awareness, the service offerings of the service provider could be
        impacted as detailed in <xref
        target="CGN-REQS"></xref>. This includes cases
        like the following:</t>

        <t><list style="symbols">
            <t>Provisioning static NAT-bindings for particular endpoints</t>

            <t>Using different public IP address pools for a different set of
            endpoints (for example, residential or business customers)</t>

            <t>Reporting allocated bindings on a per-endpoint basis</t>

            <t>Integrate control of the NAT device into the already existing
            per-endpoint management infrastructure of the service provider</t>
          </list></t>

        <figure anchor="fig-NAT-deployment"
                title="Access Network Deployment with NAT">
          <artwork><![CDATA[
                +---------+
                |         |
                |   AAA   |
                |         |
                +---------+
                     |
                     |
                     |
                     |
  +--------+    +---------+    +--------+    +----------+
  |  IPv4  |----|         |----|  NAT-  |----| IPv4     |
  |  Host  |    |   NAS   |    | device |    | Internet |
  |        |    |         |    |        |    |          |
  +--------+    +---------+    +--------+    +----------+

For NAT44 deployments (IPv4 host):
     <----- Private IPv4 ----------><--- Public IPv4 --->

For NAT64 deployments (IPv6 host):
     <----- Public  IPv6 ----------><--- Public IPv4 --->
]]></artwork>
        </figure>

        <t><xref target="fig-NAT-deployment"></xref> shows a typical
        deployment for IPv4 Internet access involving a NAT device within the
        service provider network. The figure describes two scenarios: one
        where an IPv4 host (with a private IPv4 address) accesses the
        IPv4 Internet, as well as one where an IPv6-host accesses the
        IPv4 Internet.</t>
      </section>

      <section anchor="management" title="Diameter NAPT Control Application Overview">
        <t>DNCA runs between two DNCA Diameter peers. One DNCA Diameter peer
        resides within the NAT device, the other DNCA Diameter peer resides
        within a NAT controller (discussed in <xref target="deployDNCA" />). DNCA allows per-endpoint control and management of NAT within the NAT device. Based on
        Diameter, DNCA integrates well with the suite of Diameter applications
        deployed for per-endpoint authentication, authorization, accounting,
        and policy control in service provider networks.</t>

        <t>DNCA offers:<list style="symbols">
            <t>Request and answer commands to control the allowed number of
            NAT-bindings per endpoint, to request the allocation of specific
            bindings for an endpoint, to define the address pool to be used
            for an endpoint.</t>

            <t>Per-endpoint reporting of the allocated NAT-bindings.</t>

            <t>Unique identification of an endpoint on a NAT device,
            AAA-server, and NAS to simplify correlation of accounting data
            streams.</t>
          </list></t>

        <t>DNCA allows controlling the behavior of a NAT device on a per-endpoint basis during initial session establishment and at later
        stages by providing an update procedure for already established
        sessions. Using DNCA, per-endpoint NAT-binding information can be
        retrieved using either accounting mechanisms or an explicit
        session query to the NAT.</t>
      </section>

      <section anchor="deployDNCA" title="Deployment Scenarios for DNCA">
        <t>DNCA can be deployed in different ways. DNCA supports deployments
        with "n" NAT controllers and "m" NAT devices, with n and m equal to or
        greater than 1. From a DNCA perspective, an operator should ensure that
        the session representing a particular endpoint is atomic. Any
        deployment MUST ensure that, for any given endpoint, only a single DNCA
        NAT controller and is active at any point in time. This is to ensure
        that NAT devices controlled by multiple NAT controllers do not receive
        conflicting control requests for a particular endpoint or that they would not be
        unclear about to which NAT controller to send accounting information.
        Operational considerations MAY require an operator to use alternate
        control mechanisms or protocols such as SNMP or manual configuration
        via a CLI to apply per-endpoint NAT-specific
        configuration, for example, static NAT-bindings. For these cases,
        the NAT device MUST allow the operator to configure a policy on how
        configuration conflicts are resolved. Such a policy could specify, for example,
        that manually configured NAT-bindings using the
        CLI always take precedence over those configured
        using DNCA.</t>

        <t>Two common deployment scenarios are outlined in <xref
        target="fig-NAT-integrated-deployment"></xref> (&ldquo;Integrated
        Deployment&rdquo;) and <xref
        target="fig-NAT-autonomous-deployment"></xref> (&ldquo;Autonomous
        Deployment&rdquo;). Per the note above, multiple instances of
        NAT controllers and NAT devices could be deployed. The figures only
        show single instances for reasons of clarity. The two shown scenarios
        differ in which entity fulfills the role of the NAT controller. Within
        the figures, (C) denotes the network element performing the role of the
        NAT controller.</t>

        <t>The integrated deployment approach hides the existence of the
        NAT device from external servers, such as the AAA-server. It is suited
        for environments where minimal changes to the existing AAA deployment
        are desired. The NAS and the NAT device are Diameter peers supporting
        the DNCA. The Diameter peer within the NAS, performing the role of the
        NAT controller, initiates and manages sessions with the NAT device,
        exchanges NAT-specific configuration information, and handles reporting
        and accounting information. The NAS receives reporting and accounting
        information from the NAT device. With this information, the NAS can
        provide a single accounting record for the endpoint. A system
        correlating the accounting information received from the NAS and
        NAT device would not be needed.</t>

        <t>An example network attachment for an integrated NAT deployment can
        be described as follows: an endpoint connects to the network, with the
        NAS being the point of attachment. After successful authentication,
        the NAS receives endpoint-related authorization data from the
        AAA-server. A portion of the authorization data applies to per-endpoint configuration on the NAS itself, another portion describes
        authorization and configuration information for NAT control aimed at
        the NAT device. The NAS initiates a DNCA session to the NAT device and
        sends relevant authorization and configuration information for the
        particular endpoint to the NAT device. This can comprise NAT-bindings,
        which have to be pre-established for the endpoint, or management-related configuration, such as the maximum number of NAT-bindings
        allowed for the endpoint. The NAT device sends its per-endpoint
        accounting information to the NAS, which aggregates the accounting
        information received from the NAT device with its local accounting
        information for the endpoint into a single accounting stream towards
        the AAA-server.</t>

        <figure anchor="fig-NAT-integrated-deployment"
                title="NAT Control Deployment: Integrated Deployment">
          <artwork><![CDATA[
                +---------+
                |         |
                |   AAA   |
                |         |
                +---------+
                     |
                     |
                     |
  +--------+    +---------+    +--------+    +----------+
  |        |    |   (C)   |    |        |    |          |
  |  Host  |----|   NAS   |----|  NAT-  |----| IPv4     |
  |        |    |         |    | device |    | Internet |
  +--------+    +---------+    +--------+    +----------+

For NAT44 deployments (IPv4 host):
     <----- Private IPv4 ----------><--- Public IPv4 --->

For NAT64 deployments (IPv6 host):
     <----- Public  IPv6 ----------><--- Public IPv4 --->
]]></artwork>
        </figure>

        <t><xref target="fig-NAT-integrated-deployment"></xref> shows examples
        of integrated deployments. It illustrates two scenarios: one
        where an IPv4 host (with a private IPv4 address) accesses the
        IPv4 Internet and another where an IPv6 host accesses the
        IPv4 Internet.</t>

        <t>The autonomous deployment approach decouples endpoint management on
        the NAS and NAT device. In the autonomous deployment approach, the
        AAA-system and the NAT device are the Diameter peers running the DNCA.
        The AAA-system also serves as NAT controller. It manages the
        connection to the NAT device, controls the per-endpoint configuration,
        and receives accounting and reporting information from the
        NAT device. Different from the integrated deployment scenario, the
        autonomous deployment scenario does not &ldquo;hide&rdquo; the
        existence of the NAT device from the AAA infrastructure. Here, two
        accounting streams are received by the AAA-server for one particular
        endpoint: one from the NAS and one from the NAT device.</t>

        <figure anchor="fig-NAT-autonomous-deployment"
                title="NAT Control Deployment: Autonomous Deployment">
          <artwork><![CDATA[
                +---------+
                |   (C)   |
                |   AAA   |---------
                |         |         |
                +---------+         |
                     |              |
                     |              |
                     |              |
  +--------+    +---------+    +---------+    +----------+
  |  IPv4/ |    |         |    |         |    |  IPv4    |
  |  IPv6  |----|   NAS   |----|  NAT-   |----| Internet |
  |  Host  |    |         |    | device  |    |          |
  +--------+    +---------+    +---------+    +----------+

For NAT44 deployments (IPv4 host):
     <----- Private IPv4 ----------><--- Public IPv4 --->

For NAT64 deployments (IPv6 host):
     <----- Public  IPv6 ----------><--- Public IPv4 --->]]></artwork>
        </figure>

        <t><xref target="fig-NAT-autonomous-deployment"></xref> shows examples
        of autonomous deployments. It illustrates two scenarios: one
        where an IPv4 host (with a private IPv4 address) accesses the
        IPv4 Internet and another where an IPv6 host accesses the
        IPv4 Internet.</t>
      </section>
    </section>

    <section anchor="sec-dnca"
             title="DNCA Session Establishment and Management">
      <t>Note that from this section on, there are references to some of the commands and
      AVPs defined for DNCA. Please refer to Sections <xref
      target="sec-dnca-commands" format="counter"></xref> and <xref
      target="sec-dnca-avps" format="counter"></xref> for details. DNCA runs between a Diameter
      peer residing in a NAT controller and a Diameter peer residing in a
      NAT device. Note that, per what was already mentioned above, each DNCA
      session between Diameter peers in a NAT controller and a NAT device
      represents a single endpoint, with an endpoint being either a network
      element, a device, or an IPv4 host associated with a subscriber, a user,
      or a group of users. The Diameter peer within the NAT controller is
      always the control-requesting entity: it initiates, updates, or
      terminates the sessions. Sessions are initiated when the NAT controller
      learns about a new endpoint (i.e., host) that requires a NAT service.
      This could be due to, for example, the entity hosting the NAT controller
      receiving authentication, authorization, or accounting requests for or
      from the endpoint. Alternate methods that could trigger session setup
      include local configuration, receipt of a packet from a formerly unknown
      IP address, etc.</t>

      <section title="Session Establishment">
        <t>The DNCA Diameter peer within the NAT controller establishes a
        session with the DNCA Diameter peer within the NAT device to control
        the behavior of the NAT function within the NAT device. During session
        establishment, the DNCA Diameter peer within the NAT controller passes
        along configuration information to the DNCA Diameter peer within the
        NAT device. The session configuration information comprises the
        maximum number of bindings allowed for the endpoint associated with
        this session, a set of predefined NAT-bindings to be established for
        this endpoint, or a description of the address pool, from which external
        addresses are to be allocated.</t>

        <t>The DNCA Diameter peer within the NAT controller generates a
        NAT-Control-Request (NCR) message to the DNCA Diameter peer within the
        NAT device with the NC-Request-Type AVP set to INITIAL_REQUEST to initiate
        a Diameter NAT control session. On receipt of an NCR, the DNCA Diameter
        peer within the NAT device sets up a new session for the endpoint
        associated with the endpoint classifier(s) contained in the NCR. The
        DNCA Diameter peer within the NAT device notifies its DNCA Diameter
        peer within the NAT controller about successful session setup using a
        NAT-Control-Answer (NCA) message with the Result-Code set to
        DIAMETER_SUCCESS. <xref target="fig-session-establishment"></xref>
        shows the initial protocol interaction between the two DNCA Diameter
        peers.</t>

        <t>The initial NAT-Control-Request MAY contain configuration
        information for the session, which specifies the behavior of the
        NAT device for the session. The configuration information that MAY be
        included, comprises: <list style="symbols">
            <t>A list of NAT-bindings, which should be pre-allocated for the
            session; for example, in case an endpoint requires a fixed
            external IP address/port pair for an application. </t>

            <t>The maximum number of NAT-bindings allowed for an endpoint.</t>

            <t>A description of the external IP address pool(s) to be used for
            the session.</t>

            <t>A reference to a NAT-binding Predefined template on the
            NAT device, which is applied to the session. Such a NAT-binding
            Predefined template on the NAT device may contain, for example,
            the name of the IP address pool from which external IP addresses should
            be allocated, the maximum number of bindings permitted for
            the endpoint, etc.</t>
          </list>In certain cases, the NAT device may not be able to perform
        the tasks requested within the NCR. These include the following: <list
            style="symbols">
            <t>If a DNCA Diameter peer within the NAT device receives an NCR
            from a DNCA Diameter peer within a NAT controller with the 
            NC-Request-Type AVP set to INITIAL_REQUEST that identifies an
            already existing session, that is, the endpoint identifier matches an
            already existing session, the DNCA Diameter peer within the
            NAT device MUST return an NCA with the Result-Code set to
            SESSION_EXISTS and provide the Session-Id of the existing session
            in the Duplicate-Session-Id AVP.</t>

            <t>If a DNCA Diameter peer within the NAT device receives an NCR
            from a DNCA Diameter peer within a NAT controller with the 
            NC-Request-Type AVP set to INITIAL_REQUEST that matches more than
            one of the already existing sessions, that is, the DNCA Diameter peer
            and endpoint identifier match already existing sessions, the DNCA
            Diameter peer within the NAT device MUST return an NCA with
            the Result-Code set to INSUFFICIENT-CLASSIFIERS. In case a DNCA
            Diameter peer receives an NCA that reports
            Insufficient-Classifiers, it MAY choose to retry establishing a
            new session using additional or more specific classifiers.</t>

            <t>If the NCR contains a NAT-binding Predefined template not
            defined on the NAT device, the DNCA Diameter peer within the
            NAT device MUST return an NCA with the Result-Code AVP set to
            UNKNOWN_BINDING_TEMPLATE_NAME.</t>

            <t>In case the NAT device is unable to establish all of the
            bindings requested in the NCR, the DNCA Diameter peer MUST return
            an NCA with the Result-Code set to BINDING_FAILURE. A DNCA Diameter
            peer within a NAT device MUST treat an NCR as an atomic operation;
            hence, none of the requested bindings will be established by the
            NAT device. Either all requested actions within an NCR MUST be
            completed successfully or the entire request fails.</t>

            <t>If a NAT device cannot conform to a request to set the maximum
            number of NAT-bindings allowed for a session, the DNCA Diameter
            peer in the NAT device MUST return an NCA with the Result-Code AVP set
            to MAX_BINDINGS_SET_FAILURE. Such a condition can, for example,
            occur if the operator specified the maximum number of NAT-bindings
            through another mechanism, which, per the operator's policy, takes
            precedence over DNCA.</t>

            <t>If a NAT device does not have sufficient resources to process a
            request, the DNCA Diameter peer MUST return an NCA with
            the Result-Code set to RESOURCE_FAILURE.</t>

            <t>In the case where Max-NAT-Bindings, NAT-Control-Definition, and
            NAT-Control-Binding-Template are included in the NCR, and the
            values in Max-NAT-Bindings and NAT-Control-Definition contradict
            those specified in the pre-provisioned template on the NAT device
            that NAT-Control-Binding-Template references, Max-NAT-Bindings
            and NAT-Control-Definition MUST override the values specified in
            the template to which NAT-Control-Binding-Template refers.</t>
          </list></t>

        <figure anchor="fig-session-establishment"
                title="Initial NAT-Control-Request and Session Establishment  ">
          <artwork><![CDATA[
NAT controller (DNCA Diameter peer)   NAT device (DNCA Diameter peer)
            |                                           |
            |                                           |
            |                                           |
         Trigger                                        |
            |                                           |
            |                   NCR                     |
            |------------------------------------------>|
            |                                           |
            |                                           |
            |                                           |
            |                                           |
            |                                 If able to comply
            |                                 with request, then
            |                                 create session state
            |                                           |
            |                                           |
            |                     NCA                   |
            |<------------------------------------------|
            |                                           |
            |                                           |]]></artwork>
        </figure>

        <t>Note: The DNCA Diameter peer within the NAT device creates session
        state only if it is able to comply with the NCR. On success, it will
        reply with an NCA with the Result-Code set to DIAMETER_SUCCESS.</t>
      </section>

      <section title="Session Update">
        <t>A session update is performed if the NAT controller desires to change
        the behavior of the NAT device for an existing session. A session update
        could be used, for example, to change the number of allowed bindings
        for a particular session or establish or remove a predefined
        binding.</t>

        <t>The DNCA Diameter peer within the NAT controller generates an NCR
        message to the DNCA Diameter peer within the NAT device with
        the NC-Request-Type AVP set to UPDATE_REQUEST upon receiving a trigger
        signal. If the session is updated successfully, the DNCA Diameter peer
        within the NAT device notifies the DNCA Diameter peer within the
        NAT controller about the successful session update using a NAT-Control-Answer (NCA) message with the Result-Code set to DIAMETER_SUCCESS.  <xref
        target="fig-session-update"> </xref> shows the protocol interaction
        between the two DNCA Diameter peers.</t>

        <t>In certain cases, the NAT device may not be able to perform the
        tasks requested within the NCR. These include the following: <list
            style="symbols">
            <t>If a DNCA Diameter peer within a NAT device receives an NCR
            update or query request for a non-existent session, it MUST set
            the Result-Code in the answer to DIAMETER_UNKNOWN_SESSION_ID.</t>

            <t>If the NCR contains a NAT-binding Predefined template not
            defined on the NAT device, an NCA with the Result-Code AVP set to
            UNKNOWN_BINDING_TEMPLATE_NAME MUST be returned.</t>

            <t>If the NAT device cannot establish the requested binding
            because the maximum number of allowed bindings has been reached
            for the endpoint classifier, an NCA with the Result-Code AVP set to
            MAXIMUM_BINDINGS_REACHED_FOR_ENDPOINT MUST be returned to the DNCA
            Diameter peer.</t>

            <t>If the NAT device cannot establish some or all of the bindings
            requested in an NCR, but has not yet reached the maximum number of
            allowed bindings for the endpoint, an NCA with the Result-Code set to
            BINDING_FAILURE MUST be returned. As already noted, the DNCA
            Diameter peer in a NAT device MUST treat an NCR as an atomic
            operation. Hence, none of the requested bindings will be
            established by the NAT device in case of failure. Actions
            requested within an NCR are either all successful or all fail.</t>

            <t>If the NAT device cannot conform to a request to set the
            maximum number of bindings allowed for a session as specified by
            the Max-NAT-Bindings, the DNCA Diameter peer in the NAT device
            MUST return an NCA with the Result-Code AVP set to
            MAX_BINDINGS_SET_FAILURE.</t>

            <t>If the NAT device does not have sufficient resources to process
            a request, an NCA with the Result-Code set to RESOURCE_FAILURE MUST be
            returned.</t>

            <t>If an NCR changes the maximum number of NAT-bindings allowed
            for the endpoint defined through an earlier NCR, the new value
            MUST override any previously defined limit on the maximum number
            of NAT-bindings set through the DNCA. Note that, prior to overwriting
            an existing value, the NAT device MUST check whether the overwrite
            action conforms to the locally configured policy. Deployment
            dependent, an existing value could have been set by a protocol or
            mechanism different from DNCA and with higher priority. In which
            case, the NAT device will refuse the change and the DNCA Diameter
            peer in the NAT device MUST return an NCA with the Result-Code AVP set
            to MAX_BINDINGS_SET_FAILURE. It depends on the implementation of
            the NAT device on how the NAT device copes with a case where the
            new value is lower than the actual number of allocated bindings.
            The NAT device SHOULD refrain from enforcing the new limit
            immediately (that is, actively remove bindings), but rather
            disallows the establishment of new bindings until the current
            number of bindings is lower than the newly established maximum
            number of allowed bindings.</t>

            <t>If an NCR specifies a new NAT-binding Predefined template on
            the NAT device, the NAT-binding Predefined template overrides any
            previously defined rule for the session. Existing NAT-bindings
            SHOULD NOT be impacted by the change of templates.</t>

            <t>In case Max-NAT-Bindings, NAT-Control-Definition, and
            NAT-Control-Binding-Template are included in the NCR, and the
            values in Max-NAT-Bindings and NAT-Control-Definition contradict
            those specified in the pre-provisioned template on the NAT device
            that NAT-Control-Binding-Template references, Max-NAT-Bindings
            and NAT-Control-Definition MUST override the values specified in
            the template to which the NAT-Control-Binding-Template refers.</t>
          </list>Note: Already established bindings for the session SHOULD NOT
        be affected in case the tasks requested within the NCR cannot be
        completed.</t>

        <figure anchor="fig-session-update"
                title="NAT-Control-Request for Session Update ">
          <artwork><![CDATA[
NAT controller (DNCA Diameter peer)   NAT device (DNCA Diameter peer)
            |                                           |
            |                                           |
            |                                           |
     Change of session                                  |
        attributes                                      |
            |                                           |
            |                   NCR                     |
            |------------------------------------------>|
            |                                           |
            |                                           |
            |                                   If able to comply 
            |                                   with the request:
            |                                  update session state
            |                                           |
            |                                           |
            |                     NCA                   |
            |<------------------------------------------|
            |                                           |]]></artwork>
        </figure>
      </section>

      <section title="Session and Binding Query">
        <t>A session and NAT-binding query MAY be used by the DNCA Diameter
        peer within the NAT controller either to retrieve information on the
        current bindings for a particular session at the NAT device or
        to discover the session identifier for a particular external IP
        address/port pair.</t>

        <t>A DNCA Diameter peer within the NAT controller starts a session
        query by sending an NCR message with NC-Request-Type AVP set to
        QUERY_REQUEST. <xref target="fig-session-query"></xref> shows the
        protocol interaction between the DNCA Diameter peers.</t>

        <t>Two types of query requests exist. The first type of query request
        uses the Session-Id as input parameter to the query. It is to allow
        the DNCA Diameter peer within the NAT controller to retrieve the
        current set of bindings for a specific session. The second type of
        query request is used to retrieve the session identifiers, along with
        the associated bindings, matching a criteria. This enables the DNCA
        Diameter peer within the NAT controller to find those sessions, which
        utilize a specific external or internal IP address.</t>

        <t><list style="numbers">
            <t>Request a list of currently allocated NAT-bindings for a
            particular session: On receiving an NCR, the NAT device SHOULD look
            up the session information for the Session-Id contained in the
            NCR and report all currently active NAT-bindings for the session
            using an NCA message with the Result-Code set to DIAMETER_SUCCESS. In
            this case, the NCR MUST NOT contain a NAT-Control-Definition AVP.
            Each NAT-binding is reported in a NAT-Control-Definition AVP. In
            case the Session-Id is unknown, the DNCA Diameter peer within the
            NAT device MUST return an NCA message with the Result-Code set to
            DIAMETER_UNKNOWN_SESSION_ID.</t>

            <t>Retrieve Session-Ids and bindings for internal IP address or
            one or multiple external IP address/port pairs: If the DNCA
            Diameter peer within the NAT controller wishes to retrieve the
            Session-Id(s) for an internal IP address or one or multiple external
            IP address/port pairs, it MUST include the internal IP address as
            part of the Framed-IP-Address AVP or external IP address/port pair(s) as
            part of the NAT-External-Address AVP of the NCR. The external
            IP address/port pair(s) are known in advance by the controller via
            configuration, AAA interactions, or other means. The Session-Id is
            not included in the NCR or the NCA for this type of a query. The
            DNCA Diameter peer within the NAT device SHOULD report the
            NAT-bindings and associated Session-Ids corresponding to the
            internal IP address or external IP address/port pairs in an NCA
            message using one or multiple instances of the
            NAT-Control-Definition AVP. The Result-Code is set to
            DIAMETER_SUCCESS. In case an external IP address/port pair has no
            associated existing NAT-binding, the NAT-Control-Definition AVP
            contained in the reply just contains the NAT-External-Address
            AVP.</t>
          </list></t>

        <figure anchor="fig-session-query" title="Session Query">
          <artwork><![CDATA[
NAT controller (DNCA Diameter peer)   NAT device (DNCA Diameter peer)
            |                                           |
            |                                           |
            |                                           |
  DNCA Session Established                              |
            |                                           |
            |                   NCR                     |
            |------------------------------------------>|
            |                                           |
            |                                           |
            |                                           |
            |                                           |
            |                          Look up corresponding session
            |                            and associated NAT-bindings
            |                                           |
            |                   NCA                     |
            |<------------------------------------------|
            |                                           |
            |                                           |
            |                                           |]]></artwork>
        </figure>
      </section>

      <section anchor="sec-dnca-sess-term" title="Session Termination">
        <t>Similar to session initiation, session tear down MUST be initiated
        by the DNCA Diameter peer within the NAT controller. The DNCA Diameter
        peer sends a Session-Termination-Request (STR) message to its peer
        within the NAT device upon receiving a trigger signal. The source of
        the trigger signal is outside the scope of this document. As part of
        STR-message processing, the DNCA Diameter peer within the NAT device
        MAY send an accounting stop record reporting all bindings. All the
        NAT-bindings belonging to the session MUST be removed, and the session
        state MUST be cleaned up. The DNCA Diameter peer within the NAT device
        MUST notify its DNCA Diameter peer in the NAT controller about
        successful session termination using a Session-Termination-Answer (STA)
        message with Result-Code set to DIAMETER_SUCCESS. <xref
        target="fig-session-terminate"></xref> shows the protocol interaction
        between the two DNCA Diameter peers.</t>

        <t>If a DNCA Diameter peer within a NAT device receives an STR and
        fails to find a matching session, the DNCA Diameter peer MUST return an
        STA with the Result-Code set to DIAMETER_UNKNOWN_SESSION_ID.</t>

        <figure anchor="fig-session-terminate"
                title="Terminate NAT Control Session">
          <artwork><![CDATA[
NAT controller (DNCA Diameter peer)   NAT device (DNCA Diameter peer)
            |                                            |
            |                                            |
         Trigger                                         |
            |                                            |
            |                   STR                      |
            |------------------------------------------->|
            |                                            |
            |                                            |
            |                                            |
            |                                            |
            |                                            |
            |           Send accounting stop             |
            |<-------------------------------------------|
            |       reporting all session bindings       |
            |                                            |
            |                                            |
            |                                  Remove NAT-bindings
            |                                       of session   
            |                                            |
            |                                  Terminate session /
            |                                 Remove session state
            |                                            |
            |                                            |
            |                                            |
            |                  STA                       |
            |<-------------------------------------------|
            |                                            |
            |                                            |]]></artwork>
        </figure>
      </section>

      <section title="Session Abort">
        <t>An Abort-Session-Request (ASR) message is sent from the DNCA
        Diameter peer within the NAT device to the DNCA Diameter peer within
        the NAT controller when it is unable to maintain a session due to
        resource limitations. The DNCA Diameter peer within the NAT controller
        MUST acknowledge a successful session abort using an Abort-Session-Answer
        (ASA) message with the Result-Code set to DIAMETER_SUCCESS. <xref
        target="fig-session-abort"></xref> shows the protocol interaction
        between the DNCA Diameter peers. The DNCA Diameter peers will start a
        session termination procedure as described in <xref
        target="sec-dnca-sess-term"></xref> following an ASA with the Result-Code
        set to DIAMETER_SUCCESS.</t>

        <t>If the DNCA Diameter peer within a NAT controller receives an ASR
        but fails to find a matching session, it MUST return an ASA with
        the Result-Code set to DIAMETER_UNKNOWN_SESSION_ID. If the DNCA Diameter
        peer within the NAT controller is unable to comply with the ASR for
        any other reason, an ASA with the Result-Code set to
        DIAMETER_UNABLE_TO_COMPLY MUST be returned.</t>

        <figure anchor="fig-session-abort" title="Abort NAT Control Session">
          <artwork><![CDATA[
NAT controller (DNCA Diameter peer)   NAT device (DNCA Diameter peer)
            |                                            |
            |                                            |
            |                                         Trigger
            |                                            |
            |                   ASR                      |
            |<-------------------------------------------|
            |                                            |
            |                                            |
            |                                            |
            |                  ASA                       |
            |------------------------------------------->|
            |                                            |
            |                                            |
            |                                            |
            |           On successful ASA                |
            |<------Session Termination Procedure------->|]]></artwork>
        </figure>
      </section>

      <section title="Failure Cases of the DNCA Diameter Peers">
        <t>This document does not specify the behavior in case the NAT device
        and NAT controller, or their respective DNCA Diameter peers, are out of
        sync or lose state. This could happen, for example, if one of the
        entities restarts, in case of a (temporary) loss of network
        connectivity, etc. Example failure cases include the following:</t>

        <t><list style="symbols">
            <t>NAT controller and the DNCA Diameter peer within the
            NAT controller lose state (e.g., due to a restart). In this case:
            <list style="symbols">
                <t>the DNCA Diameter peer within the NAT device MAY receive an
                NCR with the NC-Request-Type AVP set to INITIAL_REQUEST that
                matches an existing session of the DNCA Diameter peer within
                the NAT device. The DNCA Diameter peer within the NAT device
                MUST return a Result-Code that contains a Duplicate-Session-Id AVP
                to report the Session-Id of the existing session. The DNCA
                Diameter peer within the NAT controller MAY send an explicit
                Session-Termination-Request (STR) for the older session, which
                was lost.</t>

                <t>a DNCA Diameter peer MAY receive accounting records for a
                session that does not exist. The DNCA Diameter peer sends an
                accounting answer with the Result-Code set to
                DIAMETER_UNKNOWN_SESSION_ID in response. On receiving the
                response, the DNCA Diameter peer SHOULD clear the session and
                remove associated session state.</t>
              </list></t>

            <t>The NAT device and the DNCA Diameter peer within NAT device lose
            state. In such a case, the DNCA Diameter peer MAY receive an NCR
            with the NC-Request-Type AVP set to UPDATE_REQUEST for a non-existent
            session. The DNCA Diameter peer MUST return an NCA with
            the Result-Code set to DIAMETER_UNKNOWN_SESSION_ID. When a DNCA
            application within a NAT controller receives this NCA with the
            Result-Code set to DIAMETER_UNKNOWN_SESSION_ID, it MAY try to
            re-establish DNCA session or disconnect corresponding access
            session.</t>

            <t>The DNCA Diameter peer within the NAT controller is
            unreachable, for example, it is detected by Diameter device watchdog
            messages (as defined in Section 5.5 of <xref
            target="RFC6733"></xref>) or accounting requests from the DNCA
            Diameter peer fail to get a response, NAT-bindings and NAT device
            state pertaining to that session MUST be cleaned up after a grace
            period that is configurable on the NAT device. The grace period
            can be configured as zero or higher, depending on operator
            preference. </t>

            <t>The DNCA Diameter peer within the NAT device is unreachable or
            down and the NCR fails to get a response. Handling of this case
            depends on the actual service offering of the service provider.
            The service provider could, for example, choose to stop offering
            connectivity service.</t>

            <t>A discussion of the mechanisms used for a NAT device to clean up state
            in case the DNCA Diameter peer within the NAT device crashes is
            outside the scope of this document. Implementers of NAT devices
            could choose from a variety of options such as coupling the state
            (e.g., NAT-bindings) to timers that require periodic refresh, or
            time out otherwise, operating system watchdogs for applications,
            etc.</t>
          </list></t>
      </section>
    </section>

    <section anchor="sec-diameter-base-use"
             title="Use of the Diameter Base Protocol">
      <t>The Diameter base protocol <xref target="RFC6733"></xref>
      applies with the clarifications listed in the present specification.</t>

      <section anchor="sec-diameter-messages"
               title="Securing Diameter Messages ">
        <t>For secure transport of Diameter messages, the recommendations in
        <xref target="RFC6733"></xref> apply.</t>

        <t>DNCA Diameter peers SHOULD verify their identity during the
        Capabilities Exchange Request procedure.</t>

        <t>A DNCA Diameter peer within the NAT device SHOULD verify that a
        DNCA Diameter peer that issues an NCR command is allowed to do so based
        on: <list style="symbols">
            <t>The identity of the DNCA Diameter peer</t>

            <t>The type of NCR Command</t>

            <t>The content of the NCR Command</t>

            <t>Any combination of the above</t>
          </list></t>
      </section>

      <section title="Accounting Functionality">
        <t>Accounting functionality (the accounting session state machine, related
        Command Codes and AVPs) is defined in <xref
        target="sec-accounting"></xref>.</t>
      </section>

      <section title="Use of Sessions">
        <t>Each DNCA session MUST have a globally unique Session-Id, as defined
        in <xref target="RFC6733"></xref>, which MUST NOT be changed during
        the lifetime of the DNCA session. The Diameter Session-Id serves as the
        global endpoint identifier. The DNCA Diameter peers maintain state
        associated with the Session-Id. This globally unique Session-Id is
        used for updating, accounting, and terminating the session. A DNCA
        session MUST NOT have more than one outstanding request at any given
        time. A DNCA Diameter peer sends an Abort-Session-Request as
        defined in <xref target="RFC6733"></xref> if it is unable to maintain
        sessions due to resource limitation.</t>
      </section>

      <section title="Routing Considerations">
        <t>It is assumed that the DNCA Diameter peer within a NAT controller
        knows the DiameterIdentity of the Diameter peer within a NAT device
        for a given endpoint. Both the Destination-Realm and Destination-Host
        AVPs are present in the request from a DNCA Diameter peer within a
        NAT controller to a DNCA Diameter peer within a NAT device.</t>
      </section>

      <section title="Advertising Application Support">
        <t>Diameter nodes conforming to this specification MUST advertise
        support for DNCA by including the value of 12 in the
        Auth-Application-Id of the Capabilities-Exchange-Request and
        Capabilities-Exchange-Answer commands <xref target="RFC6733">
        </xref>.</t>
      </section>
    </section>

    <section anchor="sec-dnca-commands" title="DNCA Commands">
      <t>The following commands are used to establish, maintain, and query
      NAT-bindings.</t>

      <section anchor="sec-dnca-ncr" title="NAT-Control-Request (NCR) Command">
        <t>The NAT-Control-Request (NCR) command, indicated by the command
        field set to 330 and the 'R' bit set in the Command Flags
        field, is sent from the DNCA Diameter peer within the NAT controller
        to the DNCA Diameter peer within the NAT device in order to install
        NAT-bindings.</t>

        <t>User-Name, Logical-Access-Id, Physical-Access-ID,
        Framed-IP-Address, Framed-IPv6-Prefix, Framed-Interface-Id,
        EGRESS-VLANID, NAS-Port-ID, Address-Realm, and Calling-Station-ID AVPs
        serve as identifiers for the endpoint.</t>

        <t>Message format:</t>

        <figure>
          <artwork><![CDATA[   < NC-Request > ::= < Diameter Header: 330, REQ, PXY>
                    { Auth-Application-Id }
                    { Origin-Host }
                    { Origin-Realm }
                    { Destination-Realm }
                    { Destination-Host }
                    { NC-Request-Type }
                    [ Session-Id ]
                    [ Origin-State-Id ]
                 *1 [ NAT-Control-Remove ]
                 *1 [ NAT-Control-Install ]
                    [ NAT-External-Address ]
                    [ User-Name ]
                    [ Logical-Access-Id ]
                    [ Physical-Access-ID ]
                    [ Framed-IP-Address ]
                    [ Framed-IPv6-Prefix ]
                    [ Framed-Interface-Id ]
                    [ EGRESS-VLANID]
                    [ NAS-Port-ID]
                    [ Address-Realm ]
                    [ Calling-Station-ID ]
                  * [ Proxy-Info ]
                  * [ Route-Record ]
                  * [ AVP ]
]]></artwork>
        </figure>
      </section>

      <section anchor="sec-dnca-nca" title="NAT-Control-Answer (NCA) Command">
        <t>The NAT-Control-Answer (NCA) command, indicated by the Command Code
        field set to 330 and the 'R' bit cleared in the Command Flags
        field, is sent by the DNCA Diameter peer within the NAT device in
        response to the NAT-Control-Request command.</t>

        <t>Message format:</t>

        <figure>
          <artwork><![CDATA[   <NC-Answer> ::= < Diameter Header: 330, PXY >
                   { Origin-Host }
                   { Origin-Realm }
                   { Result-Code }
                   [ Session-Id ]
                   [ NC-Request-Type ]
                 * [ NAT-Control-Definition ]
                   [ Current-NAT-Bindings ]
                   [ Origin-State-Id ]
                   [ Error-Message ]
                   [ Error-Reporting-Host ]
                 * [ Failed-AVP ]
                 * [ Proxy-Info ]
                   [ Duplicate-Session-Id ]
                 * [ Redirect-Host]
                   [ Redirect-Host-Usage ]
                   [ Redirect-Max-Cache-Time ]
                 * [ Proxy-Info ]
                 * [ Route-Record ]
                 * [ Failed-AVP ]
                 * [ AVP ]

]]></artwork>
        </figure>
      </section>
    </section>

    <section title="NAT Control Application Session State Machine">
      <t>This section contains a set of finite state machines, representing
      the life cycle of a DNCA session, which MUST be observed by all
      implementations of the DNCA Diameter application. The DNCA Diameter
      peers are stateful and the state machine maintained is similar to the
      stateful client and server authorization state machine described in
      <xref target="RFC6733"></xref>. When a session is moved to the Idle
      state, any resources that were allocated for the particular session must
      be released. Any event not listed in the state machines MUST be
      considered an error condition, and an answer, if applicable, MUST be
      returned to the originator of the message.</t>

      <t>In the state table, the event "Failure to send NCR" means that the
      DNCA Diameter peer within the NAT controller is unable to send the NCR
      command to the desired destination. This could be due to the peer being
      down or due to the peer sending back the transient failure or temporary
      protocol error notification DIAMETER_TOO_BUSY or DIAMETER_LOOP_DETECTED
      in the Result-Code AVP of an NCA.</t>

      <t>In the state table, "FAILED NCA" means that the DNCA Diameter peer
      within the NAT device was not able to honor the corresponding NCR. This
      can happen due to any transient or permanent error at the NAT device or
      its associated DNCA Diameter peer within indicated by the following
      error Result-Code values: RESOURCE_FAILURE,
      UNKNOWN_BINDING_TEMPLATE_NAME, MAX_BINDINGS_SET_FAILURE,
      BINDING_FAILURE, MAXIMUM_BINDINGS_REACHED_FOR_ENDPOINT, SESSION_EXISTS,
      INSUFFICIENT_CLASSIFIERS.</t>

      <t>The following state machine is observed by a DNCA Diameter peer
      within a NAT controller. The state machine description uses the term
      "access session" to describe the connectivity service offered to the
      endpoint or host. "Access session" should not be confused with the
      Diameter session.</t>

      <t><figure>
          <artwork><![CDATA[          DNCA Diameter peer within a NAT controller
   State     Event                          Action     New State
   -------------------------------------------------------------
   Idle      New endpoint detected that     Send        Pending
             requires NAT control           NCR
                                            Initial 
                                            Request

   Idle      ASR received                   Send ASA    Idle
             for unknown session            with
                                            Result-Code
                                            = UNKNOWN_
                                            SESSION_ID

   Pending   Successful NCA                 Setup       Open
             received                       complete

   Pending   Successful NCA                 Send STR    Discon
             received,
             but peer unable to provide
             service

   Pending   Error processing successful    Send STR    Discon
             NCA

   Pending   Failed                         Clean up    Idle
             NCA received

   Open      NAT control                    Send        Open
             update required                NCR update
                                            request
   Open      Successful                                 Open
             NCA received  

   Open      Failed                         Clean up    Idle
             NCA received                  
             

   Open      Access session end detected    Send STR    Discon
             

   Open      ASR received,                  Send ASA    Discon
             access session will be         with
             terminated                     Result-Code
                                            = SUCCESS,
                                            Send STR

   Open      ASR received,                  Send ASA    Open
             access session will not        with
             be terminated                  Result-Code
                                            != SUCCESS
   
   Discon    ASR Received                   Send ASA    Idle

   Discon    STA Received                   Discon.     Idle
                                            endpoint]]></artwork>
        </figure></t>

      <t>The following state machine is observed by a DNCA Diameter peer
      within a NAT device.</t>

      <figure>
        <artwork><![CDATA[
          DNCA Diameter peer within a NAT device
   State     Event                          Action     New State
   -------------------------------------------------------------
   Idle      NCR query request              Send       Idle
             received, and                  successful
             able to provide requested      NCA 
             NAT-binding report             

   Idle      NCR received                   Send       Open
             and able to                    successful
             provide requested              NCA
             NAT control service

   Idle      NCR request                    Send       Idle
             received, and                  failed 
             unable to provide requested    NCA
             NAT control service
     
   Open      NCR request                    Send       Open
             received, and                  successful
             able to provide requested      NCA
             NAT control service       

   Open      NCR request                    Send       Idle
             received, and                  failed 
             unable to provide requested    NCA,
             NAT control service            Clean up
  
   Open      Unable to continue             Send ASR   Discon
             providing requested
             NAT control service

   Open      Unplanned loss of session/     Clean up   Idle
             connection to DNCA Diameter    
             peer in NAT controller
             detected (e.g., due to Diameter
             watchdog notification)

   Discon    Failure to send ASR            Wait,      Discon
                                            resend ASR

   Discon    ASR successfully sent and      Clean up   Idle
             ASA received with Result-Code

   Not       ASA received                   None       No change
   Discon

   Any       STR received                   Send STA,  Idle
                                            Clean up]]></artwork>
      </figure>
    </section>

    <section anchor="sec-dnca-avps" title="DNCA AVPs">
      <t></t>

      <section title="Reused Base Protocol AVPs">
        <t>The following table describes the AVPs reused from the Diameter base
        protocol <xref target="RFC6733"></xref>; their AVP Code values, types,
        and possible flag values and whether the AVP MAY be encrypted. 
        <xref target="RFC6733"></xref> specifies the AVP Flag rules for AVPs
        in Section 4.5. The Diameter AVP rules are defined in <xref
        target="RFC6733"></xref>, Section 4.</t>

        <figure anchor="tab-avps-from-diameter-base" suppress-title="true">
          <artwork><![CDATA[                                                +---------+
                                                |  AVP    |
                                                |  Flag   | 
                                                |  rules  |
+-----------------------------------------------|-----+---+---------+
|                           AVP                 |     |   |         |
| Attribute Name            Code     Data Type  |MUST |MAY|   Encr  |
+-----------------------------------------------+-----+---+---------+
|Acct-Interim-Interval      85       Unsigned32 | M   | P |    Y    |
|Auth-Application-Id        258      Unsigned32 | M   | P |    N    |
|Destination-Host           293      DiamIdent  | M   | P |    N    |
|Destination-Realm          283      DiamIdent  | M   | P |    N    |
|Error-Message              281      UTF8String | M   | P |    N    |
|Error-Reporting-Host       294      DiamIdent  | M   | P |    N    |
|Failed-AVP                 279      Grouped    | M   | P |    N    |
|Origin-Host                264      DiamIdent  | M   | P |    N    |
|Origin-Realm               296      DiamIdent  | M   | P |    N    |
|Origin-State-Id            278      Unsigned32 | M   | P |    N    |
|Proxy-Info                 284      Grouped    | M   | P |    N    |
|Result-Code                268      Unsigned32 | M   | P |    N    |
|Route-Record               282      DiamIdent  | M   |   |    N    |
|Session-Id                 263      UTF8String | M   | P |    Y    |
|User-Name                  1        UTF8String | M   | P |    Y    |
+-----------------------------------------------+-----+---+---------+]]></artwork>

          <postamble>Table 1: DIAMETER AVPs from the Diameter Base Protocol</postamble>
        </figure>

        <t>The Auth-Application-Id AVP (AVP Code 258) is assigned by IANA to
        Diameter applications. The value of the Auth-Application-Id for the
        Diameter NAT Control Application is 12. Please refer to <xref
        target="RFC6733"></xref> for the definition of the Diameter AVP flag
        rules and the associated abbreviations used in the table.</t>
      </section>

      <section anchor="sec_result-codes"
               title="Additional Result-Code AVP Values">
        <t>This section defines new values for the Result-Code AVP that SHALL
        be supported by all Diameter implementations that conform to the
        present document.</t>

        <section title="Success">
          <t>No new Result-Code AVP value is defined within this category.</t>
        </section>

        <section anchor="sec_result-code-transient" title="Transient Failures">
          <t>Result-Code AVP values that fall within the transient failures
          category are those used to inform a peer that the request could not
          be satisfied at the time that it was received. The request may be
          able to be satisfied in the future.</t>

          <t>The following new values of the Result-Code AVP are defined:</t>

          <t><list style="empty">
              <t>RESOURCE_FAILURE (4014)<list style="empty">
                  <t>The DNCA Diameter peer within the NAT device indicates
                  that the binding could not be installed or a new session
                  could not be created due to resource shortage.</t>
                </list></t>
            </list></t>
        </section>

        <section anchor="sec_result-code-permanent"
                 title="Permanent Failures ">
          <t>The Result-Code AVP values, which fall within the permanent
          failures category are used to inform the peer that the request
          failed and should not be attempted again. The request may be able
          to be satisfied in the future.</t>

          <t>The following new values of the Result-Code AVP are defined:</t>

          <t><list style="empty">
              <t>UNKNOWN_BINDING_TEMPLATE_NAME (5042)<list style="empty">
                  <t>The DNCA Diameter peer within the NAT device indicates
                  that the binding could not be installed or a new session
                  could not be created because the specified
                  NAT-Control-Binding-Template AVP, which refers to a
                  predefined policy template in the NAT device, is
                  unknown.</t>
                </list></t>

              <t>BINDING_FAILURE (5043)<list style="empty">
                  <t>The DNCA Diameter peer within the NAT device indicates
                  that the requested binding(s) could not be installed. For
                  example, Requested ports are already in use.</t>
                </list>MAX_BINDINGS_SET_FAILURE (5044)<list style="empty">
                  <t>The DNCA Diameter peer within the NAT device indicates
                  that it failed to conform to a request to configure the
                  maximum number of bindings for a session. For example, an
                  operator defined the maximum number of bindings on the
                  NAT device using a method or protocol that takes
                  precedence over DNCA.</t>
                </list></t>

              <t>MAXIMUM_BINDINGS_REACHED_FOR_ENDPOINT (5045)<list
                  style="empty">
                  <t>The DNCA Diameter peer within the NAT device denies the
                  request because the maximum number of allowed bindings has
                  been reached for the specified endpoint classifier.</t>
                </list></t>

              <t>SESSION_EXISTS (5046)<list style="empty">
                  <t>The DNCA Diameter peer within the NAT device denies
                  a request to initialize a new session, if it already has a
                  DNCA session that uses the same set of classifiers as
                  indicated by the DNCA Diameter peer within the
                  NAT controller in the new session initialization
                  request.</t>
                </list></t>

              <t>INSUFFICIENT_CLASSIFIERS (5047)<list style="empty">
                  <t>The DNCA Diameter peer within the NAT device requests to
                  initialize a new session, if the classifiers in the request
                  match more than one of the existing sessions on the DNCA
                  Diameter peer within the NAT device.</t>
                </list></t>
            </list></t>
        </section>
      </section>

      <section title="Reused NASREQ Diameter Application AVPs">
        <t>The following table describes the AVPs reused from the Diameter
        Network Access Server Application <xref target="RFC4005"></xref>;
        their AVP Code values, types, and possible flag values; and whether
        the AVP MAY be encrypted. The <xref target="RFC6733"></xref> specifies
        the AVP Flag rules for AVPs in Section 4.5. The Diameter AVP rules are
        defined in the <xref target="RFC6733"></xref>, Section 4.</t>

        <figure anchor="tab-avps-from-nasreq" suppress-title="true">
          <artwork><![CDATA[                                       +---------------------+
                                       |    AVP Flag Rules   |
+------------------+------+------------|----+-----+----+-----|----+
|                  | AVP  |            |    |     |SHLD| MUST|    |
| Attribute Name   | Code |  Value Type|MUST| MAY | NOT|  NOT|Encr|
|------------------|------|------------|----+-----+----+-----|----|
| NAS-Port         |   5  | Unsigned32 | M  |  P  |    |  V  | Y  |
| NAS-Port-Id      |  87  | UTF8String | M  |  P  |    |  V  | Y  |
| Calling-Station- |  31  | UTF8String | M  |  P  |    |  V  | Y  |
|   Id             |      |            |    |     |    |     |    |
| Framed-IP-Address|   8  | OctetString| M  |  P  |    |  V  | Y  |
| Framed-Interface-|  96  | Unsigned64 | M  |  P  |    |  V  | Y  |
|   Id             |      |            |    |     |    |     |    |
| Framed-IPv6-     |  97  | OctetString| M  |  P  |    |  V  | Y  |
|  Prefix          |      |            |    |     |    |     |    |
+------------------+------+------------|----+-----+----+-----|----+]]></artwork>

          <postamble>Table 2: Reused NASREQ Diameter application AVPs. Please
          refer to <xref target="RFC6733"></xref> for the definition of the
          Diameter AVP Flag rules and the associated abbreviations used in the
          table.</postamble>
        </figure>
      </section>

      <section title="Reused AVPs from RFC 4675 ">
        <t>The following table describes the AVPs reused from "RADIUS
        Attributes for Virtual LAN and Priority Support" <xref
        target="RFC4675"></xref>; their AVP Code values, types, and possible
        flag values; and whether the AVP MAY be encrypted.  <xref
        target="RFC6733"></xref> specifies the AVP Flag rules for AVPs in
        Section 4.5. The Diameter AVP rules are defined in <xref
        target="RFC6733"></xref>, Section 4.</t>

        <figure anchor="tab-avps-from-rfc4675" suppress-title="true">
          <artwork><![CDATA[                                       +---------------------+
                                       |    AVP Flag Rules   |
+------------------+------+------------|----+-----+----+-----|----+
|                  | AVP  |            |    |     |SHLD| MUST|    |
| Attribute Name   | Code |  Value Type|MUST| MAY | NOT|  NOT|Encr|
|------------------|------|------------|----+-----+----+-----|----|
| Egress-VLANID    |  56  | OctetString| M  |  P  |    |  V  | Y  |
+------------------+------+------------|----+-----+----+-----|----+]]></artwork>

          <postamble>Table 3: Reused attributes from <xref target="RFC4675" />. Please refer to
          <xref target="RFC6733"></xref> for the definition of the Diameter
          AVP Flag rules and the associated abbreviations used in the
          table.</postamble>
        </figure>
      </section>

      <section title="Reused AVPs from Diameter QoS Application">
        <t>The following table describes the AVPs reused from the "Traffic
        Classification and Quality of Service (QoS) Attributes for Diameter"
        <xref target="RFC5777"></xref>; their AVP Code values, types, and
        possible flag values; and whether the AVP MAY be encrypted. <xref
        target="RFC6733"></xref> specifies the AVP Flag rules for AVPs in
        Section 4.5. The Diameter AVP rules are defined in <xref
        target="RFC6733"></xref>, Section 4.</t>

        <figure anchor="tab-avps-from-diameter-qos" suppress-title="true">
          <artwork><![CDATA[                                                +---------+
                                                |  AVP    |
                                                |  Flag   | 
                                                |  Rules  |
+-----------------------------------------------|-----+---+---------+
|                           AVP                 |     |   |         |
| Attribute Name            Code     Data Type  |MUST |MAY|   Encr  |
+-----------------------------------------------+-----+---+---------+
|Port                       530     Integer32   |  M  | P |    Y    |
|Protocol                   513     Enumerated  |  M  | P |    Y    |
|Direction                  514     Enumerated  |  M  | P |    Y    |
+-----------------------------------------------+-----+---+---------+
]]></artwork>

          <postamble>Table 4: Reused QoS-attributes. Please refer to <xref
          target="RFC6733"></xref> for the definition of the Diameter AVP Flag
          rules and the associated abbreviations used in the
          table.</postamble>
        </figure>
      </section>

      <section title="Reused AVPs from ETSI ES 283 034, e4 Diameter Application">
        <t>The following table describes the AVPs reused from the Diameter e4
        Application <xref target="ETSIES283034"></xref>; their AVP Code
        values, types, and possible flag values; and whether the AVP MAY be
        encrypted. <xref target="RFC6733"></xref> specifies the AVP Flag
        rules for AVPs in Section 4.5. The Diameter AVP rules are defined in
        <xref target="RFC6733"></xref>, Section 4. The Vendor-ID field in
        these AVP header will be set to ETSI (13019).</t>

        <figure anchor="tab-avps-from-diameter-e4" suppress-title="true">
          <artwork><![CDATA[
                                                +---------+
                                                |  AVP    |
                                                |  Flag   | 
                                                |  Rules  |
+-----------------------------------------------|-----+---+---------+
|                           AVP                 |     |   |         |
| Attribute Name            Code     Data Type  |MUST |MAY|   Encr  |
+-----------------------------------------------+-----+---+---------+
|Address-Realm              301     OctetString | M,V |   |    Y    |
|Logical-Access-Id          302     OctetString |   V | M |    Y    |
|Physical-Access-ID         313     UTF8String  |   V | M |    Y    |
+-----------------------------------------------+-----+---+---------+
]]></artwork>

          <postamble>Table 5: Reused AVPs from the Diameter e4 application. Please
          refer to <xref target="RFC6733"></xref> for the definition of the
          Diameter AVP Flag rules and the associated abbreviations used in the
          table.</postamble>
        </figure>
      </section>

      <section anchor="tab-new-avps" title="DNCA-Defined AVPs">
        <t>The following table describes the new Diameter AVPs defined in this
        document; their AVP Code values, types, and possible flag values; and
        whether the AVP MAY be encrypted. <xref target="RFC6733"></xref>
        specifies the AVP Flag rules for AVPs in Section 4.5. The Diameter AVP
        rules are defined in <xref target="RFC6733"></xref>, Section 4.
        The AVPs defined here MUST NOT have the 'V' bit in the AVP Flags field set.</t>

        <figure suppress-title="true">
          <artwork><![CDATA[
                                                   +---------+
                                                   |  AVP    |
                                                   |  Flag   | 
                                                   |  Rules  |
+--------------------------------------------------|-----+---+------+
|                       AVP                        |     |   |      |
| Attribute Name        Code    Sect.   Data Type  |MUST |MAY| Encr |
+--------------------------------------------------+-----+---+------+
|NC-Request-Type        595     8.7.1   Enumerated | M   | P |  Y   |
|NAT-Control-Install    596     8.7.2   Grouped    | M   | P |  Y   |
|NAT-Control-Remove     597     8.7.3   Grouped    | M   | P |  Y   |
|NAT-Control-Definition 598     8.7.4   Grouped    | M   | P |  Y   |
|NAT-Internal-Address   599     8.7.5   Grouped    | M   | P |  Y   |
|NAT-External-Address   600     8.7.6   Grouped    | M   | P |  Y   |
|Max-NAT-Bindings       601     8.7.7   Unsigned32 | M   | P |  Y   |
|NAT-Control-           602     8.7.8   OctetString| M   | P |  Y   |
| Binding-Template                                 |     |   |      |
|Duplicate-             603     8.7.9   UTF8String | M   | P |  Y   |
| Session-Id                                       |     |   |      |
|NAT-External-Port-     604     8.7.10  Enumerated | M   | P |  Y   |
| Style                                            |     |   |      |
|NAT-Control-Record     605     9.2.1   Grouped    | M   | P |  Y   |
|NAT-Control-           606     9.2.2   Enumerated | M   | P |  Y   |
| Binding-Status                                   |     |   |      |
|Current-NAT-Bindings   607     9.2.3   Unsigned32 | M   | P |  Y   |
+--------------------------------------------------+-----+---+------+
]]></artwork>

          <postamble>Table 6: New Diameter AVPs. Please refer to <xref
          target="RFC6733"></xref> for the definition of the Diameter AVP Flag
          rules and the associated abbreviations used in the
          table.</postamble>
        </figure>

        <section anchor="avp_NC-Request-Type" title="NC-Request-Type AVP">
          <t>The NC-Request-Type AVP (AVP Code 595) is of type Enumerated
          and contains the reason for sending the NAT-Control-Request command.
          It shall be present in all NAT-Control-Request messages.</t>

          <t>The following values are defined: <list style="empty">
              <t>INITIAL_REQUEST (1)<list style="empty">
                  <t>An Initial Request is to initiate a Diameter NAT control
                  session between the DNCA Diameter peers.</t>
                </list></t>

              <t>UPDATE_REQUEST (2)<list style="empty">
                  <t>An Update Request is used to update bindings previously
                  installed on a given access session, to add new binding on a
                  given access session, or to remove one or several binding(s)
                  activated on a given access session.</t>
                </list></t>

              <t>QUERY_REQUEST (3)<list style="empty">
                  <t>Query Request is used to query a NAT device about the
                  currently installed bindings for an endpoint classifier.</t>
                </list></t>
            </list></t>
        </section>

        <section anchor="avp_NAT-Control-Install"
                 title="NAT-Control-Install AVP">
          <t>The NAT-Control-Install AVP (AVP code 596) is of type Grouped, and it
          is used to activate or install NAT-bindings. It also contains
          Max-NAT-Bindings that defines the maximum number of NAT-bindings
          allowed for an endpoint and the NAT-Control-Binding-Template that
          references a predefined template on the NAT device that may contain
          static binding, a maximum number of bindings allowed, an IP address
          pool from which external binding addresses should be allocated, etc.
          If the NAT-External-Port-Style AVP is present, then the NAT device
          MUST select the external ports for the NAT-bindings, per the style
          specified. The NAT-External-Port-Style is applicable for
          NAT-bindings defined by the NAT-Control-Definition AVPs whose
          NAT-External-Address or Port AVPs within the NAT-External-Address
          are unspecified.</t>

          <t>AVP format:</t>

          <figure>
            <artwork><![CDATA[  NAT-Control-Install ::= < AVP Header: 596 >
                           * [ NAT-Control-Definition ]
                             [ NAT-Control-Binding-Template ]
                             [ Max-NAT-Bindings ]
                             [ NAT-External-Port-Style ]
                           * [ AVP ]]]></artwork>
          </figure>
        </section>

        <section anchor="avp_NAT-Control-Remove"
                 title="NAT-Control-Remove AVP">
          <t>The NAT-Control-Remove AVP (AVP code 597) is of type Grouped,
          and it is used to deactivate or remove NAT-bindings. At least one of
          the two AVPs (NAT-Control-Definition AVP or
          NAT-Control-Binding-Template AVP) SHOULD be present in the
          NAT-Control-Remove AVP.</t>

          <t>AVP format:</t>

          <figure>
            <artwork><![CDATA[  NAT-Control-Remove ::= < AVP Header: 597 >
                          * [ NAT-Control-Definition ]
                            [ NAT-Control-Binding-Template ]
                          * [ AVP ]]]></artwork>
          </figure>
        </section>

        <section anchor="avp_NAT-Control-Definition"
                 title="NAT-Control-Definition AVP">
          <t>The NAT-Control-Definition AVP (AVP code 598) is of type
          Grouped, and it describes a binding.</t>

          <t>The NAT-Control-Definition AVP uniquely identifies the binding
          between the DNCA Diameter peers.</t>

          <t>If both the NAT-Internal-Address and NAT-External-Address AVP(s)
          are supplied, it is a predefined binding.</t>

          <t>If the NAT-External-Address AVP is not specified, then the
          NAT device MUST select the external port as per the
          NAT-External-Port-Style AVP, if present in the
          NAT-Control-Definition AVP.</t>

          <t>The Protocol AVP describes the transport protocol for the
          binding. The NAT-Control-Definition AVP can contain either zero or
          one Protocol AVP. If the Protocol AVP is omitted and if both
          internal and external IP addresses are specified, then the binding
          reserves the IP addresses for all transport protocols.</t>

          <t>The Direction AVP is of type Enumerated. It specifies the
          direction for the binding. The values of the enumeration applicable
          in this context are: "IN","OUT". If Direction AVP is OUT or absent,
          the NAT-Internal-Address refers to the IP address of the endpoint
          that needs to be translated. If Direction AVP is "IN",
          NAT-Internal-Address is the destination IP address that has to be
          translated.</t>

          <t>AVP format:</t>

          <figure>
            <artwork><![CDATA[  NAT-Control-Definition ::= < AVP Header: 598 >
                              { NAT-Internal-Address }
                              [ Protocol ]
                              [ Direction ]
                              [ NAT-External-Address ]
                              [ Session-Id ]
                            * [ AVP ]]]></artwork>
          </figure>
        </section>

        <section anchor="avp_NAT-Internal-Address"
                 title="NAT-Internal-Address AVP">
          <t>The NAT-Internal-Address AVP (AVP code 599) is of type
          Grouped. It describes the internal IP address and port for a
          binding. Framed-IPV6-Prefix and Framed-IP-Address AVPs are mutually
          exclusive. The endpoint identifier Framed-IP-Address,
          Framed-IPv6-Prefix, and the internal address in this
          NAT-Internal-Address AVP to install NAT-bindings for the session
          MUST match.</t>

          <t>AVP format:</t>

          <figure>
            <artwork><![CDATA[  NAT-Internal-Address ::= < AVP Header: 599 >
                            [ Framed-IP-Address ]
                            [ Framed-IPv6-Prefix ]
                            [ Port]
                          * [ AVP ]]]></artwork>
          </figure>
        </section>

        <section anchor="avp_NAT-External-Address"
                 title="NAT-External-Address AVP">
          <t>The NAT-External-Address AVP (AVP code 600) is of type
          Grouped, and it describes the external IP address and port for a
          binding. The external IP address specified in this attribute can be
          reused for multiple endpoints by specifying the same address in the
          respective NAT-External-Address AVPs. If the external IP address is
          not specified and the NAT-External-Port-Style AVP is specified in
          the NAT-Control-Definition AVP, then the NAT device MUST select
          an external port as per the NAT-External-Port-Style AVP.</t>

          <t>AVP format:</t>

          <figure>
            <artwork><![CDATA[  NAT-External-Address ::= < AVP Header: 600 >
                            [ Framed-IP-Address ]
                            [ Port ]
                          * [ AVP ]]]></artwork>
          </figure>
        </section>

        <section anchor="avp_Max-NAT-Bindings" title="Max-NAT-Bindings">
          <t>The Max-NAT-Bindings AVP (AVP code 601) is of type Unsigned32.
          It indicates the maximum number of NAT-bindings allowed for a
          particular endpoint.</t>
        </section>

        <section anchor="avp_NAT-Control-Binding-Rule"
                 title="NAT-Control-Binding-Template AVP">
          <t>The NAT-Control-Binding-Template AVP (AVP code 602) is of type
          OctetString. It defines a name for a policy template that is
          predefined at the NAT device. Details on the contents and structure
          of the template and configuration are outside the scope of this
          document. The policy to which this AVP refers may contain
          NAT-bindings, an IP address pool for allocating the external IP address
          of a NAT-binding, and a maximum number of allowed NAT-bindings. Such a
          policy template can be reused by specifying the same
          NAT-Control-Binding-Template AVP in the corresponding
          NAT-Control-Install AVPs of multiple endpoints.</t>
        </section>

        <section anchor="avp_Duplicate-Session-Id"
                 title="Duplicate-Session-Id AVP">
          <t>The Duplicate-Session-Id AVP (AVP Code 603) is of type
          UTF8String. It is used to report errors and contains the Session-Id
          of an existing session.</t>
        </section>

        <section anchor="avp_NAT-External-Port-Style"
                 title="NAT-External-Port-Style AVP">
          <t>The NAT-External-Port-Style AVP (AVP Code 604) is of type
          Enumerated and contains the style to be followed while selecting the
          external port for a NAT-binding relative to the internal port.</t>

          <t>The following values are defined: <list style="empty">
              <t>FOLLOW_INTERNAL_PORT_STYLE (1)<list style="empty">
                  <t>External port numbers selected MUST follow the same
                  sequence and oddity as the internal ports of the
                  NAT-bindings. The port oddity is required to support
                  protocols like RTP and RTCP as defined in <xref
                  target="RFC3550"></xref>. If for example the internal port
                  in a requested NAT-binding is odd numbered, then the external
                  port allocated MUST also be odd numbered, and vice versa for
                  an even numbered port. In addition, the sequence of port
                  numbering is maintained: if internal ports are consecutive,
                  then the NAT device MUST choose consecutive external ports
                  for the NAT-bindings.</t>
                </list></t>
            </list></t>
        </section>
      </section>
    </section>

    <section anchor="sec-accounting" title="Accounting Commands">
      <t>The DNCA reuses session-based accounting as defined in the Diameter
      base protocol <xref target="RFC6733"></xref> to report the bindings per
      endpoint. This reporting is achieved by sending Diameter Accounting-Request (ACR) commands [Start, Interim, and Stop] from the DNCA Diameter peer
      within the NAT device to its associated DNCA Diameter peer within the
      NAT controller.</t>

      <t>The DNCA Diameter peer within the NAT device sends an ACR Start on
      receiving an NCR with NC-Request-Type AVP set to INITIAL_REQUEST for a
      session or on creation of the first binding for a session requested in
      an earlier NCR. DNCA may send ACR Interim updates, if required, either
      due to a change in bindings resulting from an NCR with NC-Request-Type
      AVP set to UPDATE_REQUEST, periodically as specified in
      Acct-Interim-Interval by the DNCA Diameter peer within the
      NAT controller, or when it creates or tears down bindings. An ACR Stop
      is sent by the DNCA Diameter peer within the NAT device on receiving
      an STR message.</t>

      <t>The function of correlating the multiple bindings used by an endpoint
      at any given time is relegated to the post processor.</t>

      <t>The DNCA Diameter peer within the NAT device may trigger an Interim
      accounting record when the maximum number of bindings, if received in an
      NCR, is reached.</t>

      <section title="NAT Control Accounting Messages">
        <t>The ACR and ACA messages are reused as defined in the Diameter base
        protocol <xref target="RFC6733"></xref> for exchanging endpoint NAT-binding details between the DNCA Diameter peers. The DNCA Application
        ID is used in the accounting commands. The ACR contains one or more
        optional NAT-Control-Record AVPs to report the bindings. The
        NAT device indicates the number of allocated NAT-bindings to the
        NAT controller using the Current-NAT-Bindings AVP. This number needs
        to match the number of bindings identified as active within the
        NAT-Control-Record AVP.</t>
      </section>

      <section title="NAT Control Accounting AVPs">
        <t>In addition to AVPs for ACR specified in <xref
        target="RFC6733"></xref>, the DNCA Diameter peer within the NAT device
        must add the NAT-Control-Record AVP.</t>

        <section anchor="avp_NAT-Control-Record" title="NAT-Control-Record">
          <t>The NAT-Control-Record AVP (AVP code 605) is of type Grouped.
          It describes a binding and its status. If NAT-Control-Binding-Status
          is set to Created, Event-Timestamp indicates the binding creation
          time. If NAT-Control-Binding-Status is set to Removed,
          Event-Timestamp indicates the binding removal time. If
          NAT-Control-Binding-Status is active, Event-Timestamp need not be
          present; if a value is present, it indicates that binding is active
          at the given time.</t>

          <figure>
            <artwork><![CDATA[  NAT-Control-Record ::= < AVP Header: 605 >
                         { NAT-Control-Definition }
                         { NAT-Control-Binding-Status } 
                         [ Event-Timestamp ]]]></artwork>
          </figure>
        </section>

        <section anchor="avp_NAT-Control-Binding-Status"
                 title="NAT-Control-Binding-Status">
          <t>The NAT-Control-Binding-Status AVP (AVP code 606) is of type
          enumerated. It indicates the status of the binding: created,
          removed, or active.</t>

          <t>The following values are defined: <list style="empty">
              <t>Created (1)<list style="empty">
                  <t>NAT-binding is created.</t>
                </list></t>

              <t>Active (2)<list style="empty">
                  <t>NAT-binding is active.</t>
                </list></t>

              <t>Removed (3)<list style="empty">
                  <t>NAT-binding was removed.</t>
                </list></t>
            </list></t>
        </section>

        <section anchor="avp_Current-NAT-Bindings"
                 title="Current-NAT-Bindings">
          <t>The Current-NAT-Bindings AVP (AVP code 607) is of type
          Unsigned32. It indicates the number of NAT-bindings active on the
          NAT device.</t>
        </section>
      </section>
    </section>

    <section anchor="sec-avp-occurence-table" title="AVP Occurrence Tables">
      <t>The following sections present the AVPs defined in this document and
      specify the Diameter messages in which they can be present. Note: AVPs
      that can only be present within a Grouped AVP are not represented in
      this table.</t>

      <t>The table uses the following symbols:</t>

      <t><list style="empty">
          <t><list hangIndent="10" style="hanging">
              <t hangText="0">The AVP MUST NOT be present in the message.</t>

              <t hangText="0+">Zero or more instances of the AVP can be
              present in the message.</t>

              <t hangText="0-1">Zero or one instance of the AVP can be present
              in the message. It is considered an error if there is more than
              one instance of the AVP.</t>

              <t hangText="1">One instance of the AVP MUST be present in the
              message.</t>

              <t hangText="1+">At least one instance of the AVP MUST be
              present in the message.</t>
            </list></t>
        </list></t>

      <section title="DNCA AVP Table for NAT Control Initial and Update Requests">
        <t>The following table lists DNCA-specific AVPs that have to be
        present in NCRs and NCAs with the NC-Request-Type set to INITIAL_REQUEST
        or UPDATE_REQUEST.</t>

        <figure>
          <artwork><![CDATA[                                    +-------------------+
                                    |  Command Code     |
+-----------------------------------+-------------------+
| Attribute Name                        NCR    NCA      |
+-------------------------------------------------------+
|NC-Request-Type                         1      1       |
|NAT-Control-Install                    0-1     0       |
|NAT-Control-Remove                     0-1     0       |
|NAT-Control-Definition                  0      0       |
|Current-NAT-Bindings                    0      0       |
|Duplicate-Session-Id                    0     0-1      |
+-------------------------------------------------------+]]></artwork>
        </figure>

        <t>Note that any combination of NAT-Control-Install and
        NAT-Control-Remove AVPs could be present in an update or initial
        requests. Consider the following examples:</t>

        <t><list style="empty">
            <t>Neither the NAT-Control-Install AVP nor the NAT-Control-Remove AVP
            is present: This could, for example, be the case if the
            NAT controller would only want to receive accounting information
            but not control NAT-bindings.</t>

            <t>Only NAT-Control-Install AVP is present: This could, for
            example, be the case if a new NAT-binding is installed for an
            existing session.</t>

            <t>Only NAT-Control-Remove AVP is present: This could, for
            example, be the case if a new NAT-binding is removed from an
            existing session.</t>

            <t>Both, NAT-Control-Install AVP and NAT-Control-Remove AVP
            are present: This could, for example. be the case if a formerly
            created NAT-binding is removed and a new NAT-binding is
            established within the same request.</t>
          </list></t>
      </section>

      <section title="DNCA AVP Table for Session Query Requests">
        <t>The following table lists DNCA-specific AVPs that have to be
        present in NCRs and NCAs with the NC-Request-Type set to
        QUERY_REQUEST.</t>

        <figure>
          <artwork><![CDATA[                                    +-------------------+
                                    |  Command Code     |
+-----------------------------------+-------------------+
| Attribute Name                        NCR    NCA      |
+-------------------------------------------------------+
|NC-Request-Type                         1      1       |
|NAT-Control-Install                     0      0       |
|NAT-Control-Remove                      0      0       |
|NAT-Control-Definition                  0      0+      |
|NAT-External-Address                    0+     0       |
|Current-NAT-Bindings                    0      1       |
|Duplicate-Session-Id                    0      0       |
+-------------------------------------------------------+]]></artwork>
        </figure>
      </section>

      <section title="DNCA AVP Table for Accounting Messages">
        <t>The following table lists DNCA-specific AVPs, which may or may not
        be present in ACR and ACA messages.</t>

        <figure>
          <artwork><![CDATA[                                    +-------------------+
                                    |  Command Code     |
+-----------------------------------+-------------------+
| Attribute Name                        ACR    ACA      |
+-------------------------------------------------------+
|NAT-Control-Record                      0+     0       |
|Current-NAT-Bindings                    1      0       |
+-------------------------------------------------------+
]]></artwork>
        </figure>
      </section>
    </section>


    <section anchor="IANA" title="IANA Considerations">
      <t>This section contains either the namespaces that have been created in
      this specification or the values assigned to existing namespaces
      managed by IANA.</t>

      <t>In the subsections below, when we speak about review by a Designated
      Expert <xref target="RFC5226" />, please note that the Designated Expert will be assigned by the
      IESG. Initially, such Expert discussions take place on the AAA WG
      mailing list.</t>

      <section title="Application Identifier">
        <t>This specification assigns the value 12, 'Diameter
        NAT Control Application', to the Application Identifier namespace
        defined in <xref target="RFC6733"></xref>. See <xref
        target="sec-dnca"></xref> for more information.</t>
      </section>

      <section title="Command Codes">
        <t>This specification uses the value 330 from the
        Command code namespace defined in <xref target="RFC6733"></xref> for
        the NAT-Control-Request (NCR) and NAT-Control-Answer (NCA) commands. See
        <xref target="sec-dnca-ncr"></xref> and <xref
        target="sec-dnca-nca"></xref> for more information on these
        commands.</t>
      </section>

      <section title="AVP Codes">
        <t>This specification assigns the values 595-607 from the AVP
        Code namespace defined in <xref target="RFC6733"></xref>. See <xref
        target="tab-new-avps"></xref> for the assignment of the namespace in
        this specification.</t>
      </section>

      <section title="Result-Code AVP Values ">
        <t>This specification assigns the values 4014 and 5042-5047 from the Result-Code AVP value namespace
        defined in <xref target="RFC6733"></xref>. See <xref
        target="sec_result-codes"></xref> for the assignment of the namespace
        in this specification.</t>
      </section>

      <section title="NC-Request-Type AVP">
        <t>As defined in <xref target="avp_NC-Request-Type"></xref>, the
        NC-Request-Type AVP includes Enumerated type values 1-3. IANA has
        created and is maintaining a namespace for this AVP. All remaining
        values are available for assignment by a Designated Expert <xref
        target="RFC5226"></xref>.</t>
      </section>

      <section title="NAT-External-Port-Style AVP">
        <t>As defined in <xref target="avp_NAT-External-Port-Style"></xref>,
        the NAT-External-Port-Style AVP includes Enumerated type value 1. IANA
        has created and is maintaining a namespace for this AVP. All remaining
        values are available for assignment by a Designated Expert <xref
        target="RFC5226"></xref>.</t>
      </section>

      <section title="NAT-Control-Binding-Status AVP">
        <t>As defined in <xref target="avp_NC-Request-Type"></xref>, the
        NAT-Control-Binding-Status AVP includes Enumerated type values 1-3.
        IANA has created and is maintaining a namespace for this AVP. All
        remaining values are available for assignment by a Designated Expert
        <xref target="RFC5226"></xref>.</t>
      </section>
    </section>

    <section anchor="Security" title="Security Considerations">
      <t>This document describes procedures for controlling NAT-related
      attributes and parameters by an entity, which is non-local to the device
      performing NAT. This section discusses security considerations for DNCA.
      This includes the interactions between the Diameter peers within a
      NAT controller and a NAT device as well as general considerations for
      a NAT-control in a service provider network.</t>

      <t>Security between a NAT controller and a NAT device has a number of
      components: authentication, authorization, integrity, and
      confidentiality.</t>

      <t>"Authentication" refers to confirming the identity of an originator for
      all datagrams received from the originator. Lack of authentication of
      Diameter messages between the Diameter peers can jeopardize the
      fundamental service of the peering network elements. A consequence of
      not authenticating the message sender by the recipient would be that an
      attacker could spoof the identity of a "legitimate" authorizing entity
      in order to change the behavior of the receiver. An attacker could, for
      example, launch a DoS attack by setting the maximum number
      of bindings for a session on the NAT device to zero; provisioning bindings
      on a NAT device that includes IP addresses already in use in other parts
      of the network; or requesting session termination of the Diameter session
      and hampering an endpoint's (i.e., a user's) connectivity. Lack of
      authentication of a NAT device to a NAT controller could lead to
      situations where the NAT device could provide a wrong view of the
      resources (i.e., NAT-bindings).  In addition, a NAT-binding Predefined
      template on the NAT device could be configured differently than expected
      by the NAT controller. If either of the two DNCA Diameter peers fail to
      provide the required credentials, the failure should be subject to logging. The
      corresponding logging infrastructure of the operator SHOULD be built in
      a way that it can mitigate potential DoS attacks resulting
      from large amounts of logging events. This could include proper
      dimensioning of the logging infrastructure combined with policing the
      maximum amount of logging events accepted by the logging system to a
      threshold which the system is known to be able to handle.</t>

      <t>"Authorization" refers to whether a particular authorizing entity is
      authorized to signal a network element request for one or more
      applications, adhering to a certain policy profile. Failing the
      authorization process might indicate a resource theft attempt or failure
      due to administrative and/or credential deficiencies. In either case,
      the network element should take the proper measures to log such
      attempts.</t>

      <t>Integrity is required to ensure that a Diameter message exchanged
      between the Diameter peers has not been maliciously altered by
      intermediate devices. The result of a lack of data integrity enforcement
      in an untrusted environment could be that an impostor will alter the
      messages exchanged between the peers. This could cause a change of
      behavior of the peers, including the potential of a DoS.</t>

      <t>Confidentiality protection of Diameter messages ensures that the
      signaling data is accessible only to the authorized entities. When
      signaling messages between the DNCA Diameter peers traverse untrusted
      networks, lack of confidentiality will allow eavesdropping and traffic
      analysis.</t>

      <t>Diameter offers security mechanisms to deal with the functionality
      demanded above. DNCA makes use of the capabilities offered by Diameter
      and the underlying transport protocols to deliver these requirements
      (see <xref target="sec-diameter-messages"></xref>). If the DNCA
      communication traverses untrusted networks, messages between DNCA
      Diameter peers SHOULD be secured using either IPsec or TLS. Please refer
      to <xref target="RFC6733"></xref>, Section 13 for details. DNCA Diameter
      peers SHOULD perform bilateral authentication, authorization, as well as
      procedures to ensure integrity and confidentiality of the information
      exchange. In addition, the Session-Id chosen for a particular Diameter
      session SHOULD be chosen in a way that it is hard to guess in order to
      mitigate issues through potential message replay.</t>

      <t>DNCA Diameter peers SHOULD have a mutual trust setup. This document
      does not specify a mechanism for authorization between the DNCA
      Diameter peers. The DNCA Diameter peers SHOULD be provided with
      sufficient information to make an authorization decision. The
      information can come from various sources, for example, the peering
      devices could store local authentication policy, listing the identities
      of authorized peers.</t>

      <t>Any mechanism or protocol providing control of a NAT device, and DNCA
      is an example of such a control mechanism, could allow for misuse of the
      NAT device given that it enables the definition of per-destination or
      per-source rules. Misuse could include anti-competitive practices among
      providers, censorship, crime, etc. NAT-control could be used as a tool
      for preventing or redirecting access to particular sites. For instance,
      by controlling the NAT-bindings, one could ensure that endpoints aren't
      able to receive particular flows, or that those flows are redirected to
      a relay that snoops or tampers with traffic instead of directly
      forwarding the traffic to the intended endpoint. In addition, one could
      set up a binding in a way that the source IP address used is one of a
      relay so that traffic coming back can be snooped on or interfered with.
      The operator also needs to consider security threats resulting from
      unplanned termination of the DNCA session. Unplanned session
      termination, which could happen due to, e.g., an attacker taking down the
      NAT controller, leads to the NAT device cleaning up the state associated
      with this session after a grace period. If the grace period is set to
      zero, the endpoint will experience an immediate loss of connectivity to
      services reachable through the NAT device following the termination of
      the DNCA session.The protections on DNCA and its Diameter protocol
      exchanges don't prevent such abuses of NAT-control. Prevention of
      misuse or misconfiguration of a NAT device by an authorized
      NAT controller is beyond the scope of this protocol specification. A
      service provider deploying DNCA needs to make sure that higher-layer
      processes and procedures are put in place that allow them to detect and
      mitigate misuses.</t>
    </section>

    <section title="Examples">
      <t>This section shows example DNCA message content and exchange.</t>

      <section title="DNCA Session Establishment Example">
        <t><xref target="fig-session-establishment-example"></xref> depicts a
        typical call flow for DNCA session establishment.</t>

        <t>In this example, the NAT controller does the following:</t>

        <t><list style="letters">
            <t>requests a maximum of 100 NAT-bindings for the endpoint.</t>

            <t>defines a static binding for a TCP connection that associates
            the internal IP Address:Port 192.0.2.1:80 with the external
            IP Address:Port 198.51.100.1:80 for the endpoint.</t>

            <t>requests the use of a preconfigured template called
            "local-policy" while creating NAT-bindings for the endpoint.</t>
          </list></t>

        <figure anchor="fig-session-establishment-example"
                title="Initial NAT-Control-Request and Session Establishment Example">
          <artwork><![CDATA[endpoint             NAT controller (within NAS)           NAT device 
   |                            |                               |
   |                            |                               |
   |      1. Trigger            |                               |
   |--------------------------->|                               |
   |       +-------------------------------------+              |
   |       |  2. Determine that NAT control      |              |
   |       |     is required for the endpoint    |              |  
   |       +-------------------------------------+              |
   |                            |                               |
   |                            |                               |
   |                           ...................................
   |                           .|   3. Diameter Base CER/CEA    |.
   |                           .|<----------------------------->|.
   |                           ...................................
   |                            |                               |
   |                            |                               |
   |                            |         4.  NCR               |
   |                            |------------------------------>|
   |                            |                               |
   |                            |                     5. DNCA session  
   |                            |                        established      
   |                            |                               | 
   |                            |         6.  NCA               |
   |                            |<------------------------------|  
   |                            |                               |
   |                            |                               |
   |                  7. Data traffic                           |
   |----------------------------------------------------------->| 
   |                            |                               |
   |                            |                               |
   |                            |                    8. NAT-bindings
   |                            |                     created as per
   |                            |                   directives in the
   |                            |                       DNCA session   
   |                            |                               |

]]></artwork>
        </figure>

        <t>Detailed description of the steps shown in <xref
        target="fig-session-establishment-example"></xref>:</t>

        <t><list style="numbers">
            <t>The NAT controller (co-located with the NAS here) creates state
            for an endpoint based on a trigger. This could, for example, be the
            successful establishment of a Point-to-Point Protocol (PPP) <xref
            target="RFC1661"></xref> access session.</t>

            <t>Based on the configuration of the DNCA Diameter peer within the
            NAT controller, the NAT controller determines that NAT-control is
            required and is to be enforced at a NAT device.</t>

            <t>If there is no Diameter session already established with the
            DNCA Diameter peer within NAT device, a Diameter connection is
            established and Diameter Base CER/CEA are exchanged.</t>

            <t>The NAT-Controller creates an NCR message (see below) and sends
            it to the NAT device. This example shows IPv4 to IPv4 address and
            port translation. For IPv6 to IPv4 translation, the
            Framed-IP-Address AVP would be replaced by the Framed-IPv6-Address
            AVP with the value set to the IPv6 address of the endpoint.
            <figure anchor="fig-NAT-session-establish-example"
                suppress-title="true">
                <artwork><![CDATA[
  < NC-Request > ::= < Diameter Header: 330, REQ, PXY>
                   Session-Id =  "natC.example.com:33041;23432;"
                   Auth-Application-Id = <DNCA Application ID>
                   Origin-Host = "natC.example.com"  
                   Origin-Realm = "example.com"
                   Destination-Realm = "example.com"
                   Destination-Host = "nat-device.example.com"
                   NC-Request-Type = INITIAL_REQUEST
                   User-Name = "subscriber_example1"
                   Framed-IP-Address = "192.0.2.1"
                   NAT-Control-Install = {
                        NAT-Control-Definition = {
                           Protocol = TCP
                           Direction = OUT
                           NAT-Internal-Address = {
                                Framed-IP-Address = "192.0.2.1"
                                Port = 80
                           }
                           NAT-External-Address = {
                                Framed-IP-Address = "198.51.100.1"
                                Port = 80
                           }
                        }
                        Max-NAT-Bindings = 100
                        NAT-Control-Binding-Template = "local-policy"
                   }]]></artwork>
              </figure></t>

            <t>The NAT device establishes a DNCA session as it is able to
            comply with the request.</t>

            <t>The NAT device sends an NCA to indicate the successful
            completion of the request. <figure suppress-title="true">
                <artwork><![CDATA[   <NC-Answer> ::= < Diameter Header: 330, PXY >
                    Session-Id =  "natC.example.com:33041;23432;"
                    Origin-Host = "nat-device.example.com"  
                    Origin-Realm = "example.com"
                    NC-Request-Type = INITIAL_REQUEST
                    Result-Code = DIAMETER_SUCCESS

]]></artwork>
              </figure></t>

            <t>The endpoint sends packets that reach the NAT device.</t>

            <t>The NAT device performs NAT for traffic received from the
            endpoint with source address 192.0.2.1. Traffic with source
            IP address 192.0.2.1 and port 80 are translated to the external
            IP address 198.51.100.1 and port 80. Traffic with source
            IP address 192.0.2.1 and a source port different from 80 will be
            translated to IP address 198.51.100.1 and a port chosen by the
            NAT device. Note that this example assumes that the NAT device
            follows typical binding allocation rules for endpoints, in that
            only a single external IP address is used for all traffic received
            from a single IP address of an endpoint. The NAT device will allow
            a maximum of 100 NAT-bindings be created for the endpoint.</t>
          </list></t>
      </section>

      <section title="DNCA Session Update with Port Style Example">
        <t>This section gives an example for a DNCA session update: A new set
        of NAT-bindings is requested for an existing session. The request
        contains a directive ( the "NAT-External-Port-Style" AVP set to
        FOLLOW_INTERNAL_PORT_STYLE) that directs the NAT device to maintain
        port-sequence and port-oddity for the newly created NAT-bindings. In
        the example shown, the internal ports are UDP port 1036 and 1037. The
        NAT device follows the directive selects the external ports
        accordingly. The NAT device would, for example, create a mapping of
        192.0.2.1:1036 to 198.51.100.1:5056 and 192.0.2.1:1037 to
        198.51.100.1:5057, thereby maintaining port oddity (1036-&gt;5056,
        1037-&gt;5057) and sequence ( the consecutive internal ports 1036 and
        1037 map to the consecutive external ports 5056 and 5057).</t>

        <figure anchor="fig-NAT-session-update-example" suppress-title="true">
          <artwork><![CDATA[   < NC-Request > ::= < Diameter Header: 330, REQ, PXY>
                    Session-Id =  "natC.example.com:33041;23432;"
                    Auth-Application-Id = <DNCA Application ID>
                    Origin-Host = "natC.example.com"  
                    Origin-Realm = "example.com"
                    Destination-Realm = "example.com"
                    Destination-Host = "nat-device.example.com"
                    NC-Request-Type = UPDATE_REQUEST
                    NAT-Control-Install = {
                        NAT-Control-Definition = {
                            Protocol = UDP
                            Direction = OUT
                            NAT-Internal-Address = {
                                 Framed-IP-Address = "192.0.2.1"
                                 Port = 1035
                            }
                        }
                        NAT-Control-Definition = {
                            Protocol = UDP
                            Direction = OUT
                            NAT-Internal-Address = {
                                 Framed-IP-Address = "192.0.2.1"
                                 Port = 1036
                            }
                        }
                        NAT-External-Port-
                               Style = FOLLOW_INTERNAL_PORT_STYLE
                    }]]></artwork>
        </figure>
      </section>

      <section title="DNCA Session Query Example">
        <t>This section shows an example for DNCA session query for a
        subscriber whose internal IP Address is 192.0.2.1.</t>

        <figure anchor="fig-NAT-session-query-example" suppress-title="true">
          <artwork><![CDATA[   < NC-Request > ::= < Diameter Header: 330, REQ, PXY>
                    Auth-Application-Id = <DNCA Application ID>
                    Origin-Host = "natC.example.com"  
                    Origin-Realm = "example.com"
                    Destination-Realm = "example.com"
                    Destination-Host = "nat-device.example.com"
                    NC-Request-Type = QUERY_REQUEST
                    Framed-IP-Address = "192.0.2.1"]]></artwork>
        </figure>

        <t>The NAT device constructs an NCA to report all currently active
        NAT-bindings whose internal address is 192.0.2.1.</t>

        <figure anchor="fig-NAT-session-query-answer-example"
                suppress-title="true">
          <artwork><![CDATA[
   <NC-Answer> ::= < Diameter Header: 330, PXY >
                 Origin-Host = "nat-device.example.com"  
                 Origin-Realm = "example.com"
                 NC-Request-Type = QUERY_REQUEST
                 NAT-Control-Definition = {
                         Protocol = TCP
                         Direction = OUT
                         NAT-Internal-Address = {
                             Framed-IP-Address = "192.0.2.1"
                             Port = 80
                            }
                         NAT-External-Address = {
                              Framed-IP-Address = "198.51.100.1"
                              Port = 80
                            }
                         Session-Id = "natC.example.com:33041;23432;"
                 }
                 NAT-Control-Definition = {
                         Protocol = TCP
                         Direction = OUT
                         NAT-Internal-Address = {
                             Framed-IP-Address = "192.0.2.1"
                             Port = 1036
                            }
                         NAT-External-Address = {
                              Framed-IP-Address = "198.51.100.1"
                              Port = 5056
                            }
                         Session-Id = "natC.example.com:33041;23432;"
                 }
                 NAT-Control-Definition = {
                         Protocol = TCP
                         Direction = OUT
                         NAT-Internal-Address = {
                             Framed-IP-Address = "192.0.2.1"
                             Port = 1037
                            }
                         NAT-External-Address = {
                              Framed-IP-Address = "198.51.100.1"
                              Port = 5057
                            }
                         Session-Id = "natC.example.com:33041;23432;"
                    }   ]]></artwork>
        </figure>
      </section>

      <section title="DNCA Session Termination Example">
        <t>In this example the NAT controller decides to terminate the
        previously established DNCA session. This could, for example, be the
        case as a result of an access session (e.g., a PPP session) associated
        with an endpoint having been torn down.</t>

        <figure anchor="fig-session-teardown-example"
                title=" NAT Control Session Termination Example">
          <artwork><![CDATA[
    NAT controller                            NAT device 
          |                                       |
          |                                       |
 +--------------+                                 |
 |  1. Trigger  |                                 |
 +--------------+                                 |
          |                                       |
          |                                       | 
          |             2.  STR                   |
          |-------------------------------------->|
          |                                       |
          |                             3. DNCA session 
          |                                   lookup 
          |             4.  ACR                   |
          |<--------------------------------------|
          |                                       |
          |             5.  ACA                   |
          |-------------------------------------->|  
          |                                       |
          |                                       |  
          |                             6. DNCA bindings
          |                            and session cleanup 
          |                                       |
          |             7.  STA                   |
          |<--------------------------------------|  
          |                                       |]]></artwork>
        </figure>

        <t>The following steps describe the sequence of events for tearing
        down the DNCA session in the example above:</t>

        <t><list style="numbers">
            <t>The NAT controller receives a trigger that a DNCA session
            associated with a specific endpoint should be terminated. An
            example event could be the termination of the PPP <xref
            target="RFC1661"></xref> access session to an endpoint in a NAS.
            The NAS correspondingly triggers the NAT controller request
            to tear down the associated DNCA session.</t>

            <t>The NAT controller creates the required NCR message and sends
            it to the NAT device: <figure
                anchor="fig-NAT-session-termination-example"
                suppress-title="true">
                <artwork><![CDATA[   < STR >     ::= < Diameter Header: 275, REQ, PXY>
                    Session-Id =  "natC.example.com:33041;23432;"
                    Auth-Application-Id = <DNCA Application ID>
                    Origin-Host = "natC.example.com"  
                    Origin-Realm = "example.com"
                    Destination-Realm = "example.com"
                    Destination-Host = "nat-device.example.com"
                    Termination-Cause = DIAMETER_LOGOUT
]]></artwork>
              </figure></t>

            <t>The NAT device looks up the DNCA session based on the
            Session-Id AVP and finds a previously established active
            session.</t>

            <t>The NAT device reports all NAT-bindings established for that
            subscriber using an ACR: <figure
                anchor="fig-NAT-session-accounting-request-example"
                suppress-title="true">
                <artwork><![CDATA[   < ACR >     ::= < Diameter Header: 271, REQ, PXY>
                    Session-Id =  "natC.example.com:33041;23432;"
                    Auth-Application-Id = <DNCA Application ID>
                    Origin-Host = "nat-device.example.com"  
                    Origin-Realm = "example.com"
                    Destination-Realm = "example.com"
                    Destination-Host = "natC.example.com"
                    Accounting-Record-Type = STOP_RECORD
                    Accounting-Record-Number = 1
                    NAT-Control-Record = {
                        NAT-Control-Definition = {
                            Protocol = TCP
                            Direction = OUT
                            NAT-Internal-Address = {
                                Framed-IP-Address = "192.0.2.1"
                                Port = 5001
                               }
                            NAT-External-Address = {
                                 Framed-IP-Address = "198.51.100.1"
                                 Port = 7777
                               }
                           }
                          NAT-Control-Binding-Status = Removed
                       }

]]></artwork>
              </figure></t>

            <t>The NAT controller receives and processes the ACR as per its
            configuration. It responds with an ACA to the NAT device. <figure
                suppress-title="true">
                <artwork><![CDATA[   <ACA>      ::= < Diameter Header: 271, PXY >
                    Session-Id =  "natC.example.com:33041;23432;"
                    Origin-Host = "natC.example.com"  
                    Origin-Realm = "example.com"
                    Result-Code = DIAMETER_SUCCESS
                    Accounting-Record-Type = STOP_RECORD
                    Accounting-Record-Number = 1

]]></artwork>
              </figure></t>

            <t>On receipt of the ACA the NAT device cleans up all NAT-bindings
            and associated session state for the endpoint.</t>

            <t>NAT device sends an STA. On receipt of the STA the
            NAT controller will clean up the corresponding session state.
            <figure suppress-title="true">
                <artwork><![CDATA[   <STA>      ::= < Diameter Header: 275, PXY >
                    Session-Id =  "natC.example.com:33041;23432;"
                    Origin-Host = "nat-device.example.com"  
                    Origin-Realm = "example.com"
                    Result-Code = DIAMETER_SUCCESS
]]></artwork>
              </figure></t>
          </list></t>
      </section>
    </section>

    <section title="Acknowledgements">
      <t>The authors would like to thank Jari Arkko, Wesley Eddy, Stephen
      Farrell, Miguel A. Garcia, David Harrington, Jouni Korhonen, Matt
      Lepinski, Avi Lior, Chris Metz, Pallavi Mishra, Lionel Morand, Robert
      Sparks, Martin Stiemerling, Dave Thaler, Hannes Tschofenig, Sean Turner,
      Shashank Vikram, Greg Weber, and Glen Zorn for their input on this
      document.</t>
    </section>

   
  </middle>

  <!--  *****BACK MATTER ***** -->

  <back>
  
    <references title="Normative References">

      &RFC2119;

   <reference anchor='RFC6733'>
<front>
<title>Diameter Base Protocol</title>

<author initials='V' surname='Fajardo' fullname='Victor Fajardo'>
    <organization />
</author>

<author initials='J' surname='Arkko' fullname='Jari Arkko'>
    <organization />
</author>

<author initials='J' surname='Loughney' fullname='John Loughney'>
    <organization />
</author>

<author initials='G' surname='Zorn' fullname='Glen Zorn'>
    <organization />
</author>

<date month='October'  year='2012' />

<abstract><t>The Diameter base protocol is intended to provide an Authentication, Authorization and Accounting (AAA) framework for applications such as network access or IP mobility in both local and roaming situations. This document specifies the message format, transport, error reporting, accounting and security services used by all Diameter applications.  The Diameter base protocol as defined in this document obsoletes RFC 3588 and RFC 5719 and must be supported by all new Diameter implementations.</t></abstract>

</front>

<seriesInfo name='RFC' value='6733' />

</reference>

      &RFC4675;

      &RFC5777;

      &RFC5226;

      <reference anchor="ETSIES283034">
        <front>
          <title>Telecommunications and Internet Converged Services and
          Protocols for Advanced Networks (TISPAN), Network Attachment
          Sub-System (NASS), e4 interface based on the Diameter
          protocol.</title>

          <author fullname="ETSI" surname="ETSI">
            <organization></organization>
          </author>

          <date month="September" year="2008" />
        </front>
      </reference>

      &RFC4005;
    </references>

    <references title="Informative References">
      &RFC6241;

      &RFC6146;

      &RFC6145;

      &RFC3411;

      &RFC3022;

  <!--    &I-D.draft-ietf-behave-lsn-requirements; -->
<reference anchor='CGN-REQS'>
<front>
<title>Common requirements for Carrier Grade NATs (CGNs)</title>

<author initials='S' surname='Perreault' fullname='Simon Perreault'>
    <organization />
</author>

<author initials='I' surname='Yamagata' fullname='Ikuhei Yamagata'>
    <organization />
</author>

<author initials='S' surname='Miyakawa' fullname='Shin Miyakawa'>
    <organization />
</author>

<author initials='A' surname='Nakagawa' fullname='Akira Nakagawa'>
    <organization />
</author>

<author initials='H' surname='Ashida' fullname='Hiroyuki Ashida'>
    <organization />
</author>

<date month='September' year='2012' />

<abstract><t>This document defines common requirements for Carrier-Grade NAT (CGN).  It updates RFC 4787.</t></abstract>

</front>

<seriesInfo name='Work in' value='Progress' />
</reference>



      &RFC5189;

      &RFC3550;

      &RFC2663;

      &RFC3303;

      &RFC3304;

      &RFC4097;

      &RFC1661;
    </references>
  </back>
</rfc>
