<?xml version="1.0" encoding="US-ASCII"?>
<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!ENTITY rfc2119 SYSTEM "reference.RFC.2119.xml">
<!ENTITY rfc3633 SYSTEM "reference.RFC.3633.xml">
<!ENTITY rfc3056 SYSTEM "reference.RFC.3056.xml">
<!ENTITY rfc1933 SYSTEM "reference.RFC.1933.xml">
<!ENTITY rfc4213 SYSTEM "reference.RFC.4213.xml">
<!ENTITY rfc5969 SYSTEM "reference.RFC.5969.xml">
<!ENTITY rfc2529 SYSTEM "reference.RFC.2529.xml">
<!ENTITY rfc5214 SYSTEM "reference.RFC.5214.xml">
<!ENTITY rfc4380 SYSTEM "reference.RFC.4380.xml">
<!ENTITY rfc2766 SYSTEM "reference.RFC.2766.xml">
<!ENTITY rfc6145 SYSTEM "reference.RFC.6145.xml">
<!ENTITY rfc6146 SYSTEM "reference.RFC.6146.xml">
<!ENTITY rfc6333 SYSTEM "reference.RFC.6333.xml">
<!ENTITY rfc6346 SYSTEM "reference.RFC.6346.xml">
<!ENTITY rfc6269 SYSTEM "reference.RFC.6269.xml">
<!ENTITY rfc6250 SYSTEM "reference.RFC.6250.xml">
<!ENTITY rfc2663 SYSTEM "reference.RFC.2663.xml">
<!ENTITY rfc0792 SYSTEM "reference.RFC.0792.xml">
<!ENTITY rfc4443 SYSTEM "reference.RFC.4443.xml">
<!ENTITY rfc6324 SYSTEM "reference.RFC.6324.xml">
<!ENTITY rfc2827 SYSTEM "reference.RFC.2827.xml">
<!ENTITY rfc4953 SYSTEM "reference.RFC.4953.xml">
<!ENTITY rfc5961 SYSTEM "reference.RFC.5961.xml">
<!ENTITY rfc6056 SYSTEM "reference.RFC.6056.xml">
<!ENTITY rfc4787 SYSTEM "reference.RFC.4787.xml">
<!ENTITY rfc5508 SYSTEM "reference.RFC.5508.xml">
<!ENTITY rfc5382 SYSTEM "reference.RFC.5382.xml">
<!ENTITY rfc2473 SYSTEM "reference.RFC.2473.xml">
<!ENTITY rfc4862 SYSTEM "reference.RFC.4862.xml">
<!ENTITY rfc4632 SYSTEM "reference.RFC.4632.xml">
<!ENTITY rfc4459 SYSTEM "reference.RFC.4459.xml">
<!ENTITY rfc1858 SYSTEM "reference.RFC.1858.xml">
<!ENTITY rfc3128 SYSTEM "reference.RFC.3128.xml">
<!ENTITY rfc4963 SYSTEM "reference.RFC.4963.xml">
<!ENTITY rfc5625 SYSTEM "reference.RFC.5625.xml">
<!ENTITY rfc6864 SYSTEM "reference.RFC.6864.xml">
<!ENTITY rfc6335 SYSTEM "reference.RFC.6335.xml">
]>

<?rfc toc="yes" ?>
<?rfc tocompact="yes" ?>
<?rfc compact="yes" ?>
<?rfc subcompact="no" ?>
<?rfc symrefs="yes"?>
<?rfc sortrefs="yes" ?>
<?rfc comments="yes" ?>
<?rfc inline="yes" ?>

<rfc category="std" number="7597" ipr="trust200902" submissionType="IETF" consensus="yes">
  <front>
    <title abbrev="MAP-E">Mapping of Address and Port with Encapsulation
    (MAP-E)</title>

    <author fullname="Ole Troan" initials="O" surname="Troan" role="editor">
      <organization>Cisco Systems</organization>
      <address>
        <postal>
          <street>Philip Pedersens vei 1</street>
          <city>Lysaker</city>
          <code>1366</code>
          <country>Norway</country>
        </postal>
        <email>ot@cisco.com</email>
      </address>
    </author>

    <author fullname="Wojciech Dec" initials="W" surname="Dec">
      <organization>Cisco Systems</organization>
      <address>
        <postal>
          <street>Haarlerbergpark Haarlerbergweg 13-19</street>
          <city>Amsterdam, NOORD-HOLLAND</city>
          <code>1101 CH</code>
          <country>The Netherlands</country>
        </postal>
        <phone></phone>
        <email>wdec@cisco.com</email>
      </address>
    </author>

    <author fullname="Xing Li" initials="X" surname="Li">
      <organization abbrev="Tsinghua University">CERNET Center/Tsinghua University</organization>
      <address>
        <postal>
          <street>Room 225, Main Building, Tsinghua University</street>
          <city>Beijing  100084</city>
          <country>China</country>
        </postal>
        <email>xing@cernet.edu.cn</email>
      </address>
    </author>

    <author fullname="Congxiao Bao" initials="C" surname="Bao">
      <organization abbrev="Tsinghua University">CERNET Center/Tsinghua University</organization>
      <address>
        <postal>
          <street>Room 225, Main Building, Tsinghua University</street>
          <city>Beijing  100084</city>
          <country>China</country>
        </postal>
        <email>congxiao@cernet.edu.cn</email>
      </address>
    </author>

    <author fullname="Satoru Matsushima" initials="S" surname="Matsushima">
      <organization>SoftBank Telecom</organization>
      <address>
        <postal>
          <street>1-9-1 Higashi-Shinbashi, Munato-ku</street>
          <city>Tokyo</city>
          <country>Japan</country>
        </postal>
        <email>satoru.matsushima@g.softbank.co.jp</email>
      </address>
    </author>

    <author fullname="Tetsuya Murakami" initials="T" surname="Murakami">
      <organization>IP Infusion</organization>
      <address>
        <postal>
          <street>1188 East Arques Avenue</street>
          <city>Sunnyvale</city>
          <region>CA</region>
          <code>94085</code>
          <country>United States</country>
        </postal>
        <email>tetsuya@ipinfusion.com</email>
      </address>
    </author>

    <author fullname="Tom Taylor" initials="T" surname="Taylor" role="editor">
      <organization>Huawei Technologies</organization>
      <address>
        <postal>
          <street></street>
          <city>Ottawa</city>
          <country>Canada</country>
        </postal>
        <email>tom.taylor.stds@gmail.com</email>
      </address>
    </author>
   
    <date month="July" year="2015" />

    <abstract>
      <t>This document describes a mechanism for transporting IPv4 packets
      across an IPv6 network using IP encapsulation.  It also describes a
      generic mechanism for mapping between IPv6 addresses and
      IPv4 addresses as well as transport-layer ports.</t>
    </abstract>
  </front>

  <middle>

    <section title="Introduction">
      <t>Mapping of IPv4 addresses in IPv6 addresses has been
      described in numerous mechanisms dating back to the mid-1990s
      <xref target="RFC1933"></xref> <xref target="RFC4213"></xref>.
      The "automatic tunneling" mechanism as first described
      in <xref target="RFC1933"></xref> assigned a globally unique
      IPv6 address to a host by combining the host's IPv4 address
      with a well-known IPv6 prefix. Given an IPv6 packet with a
      destination address with an embedded IPv4 address, a node could
      automatically tunnel this packet by extracting the IPv4 tunnel
      endpoint address from the IPv6 destination address.</t>

      <t>There are numerous variations of this idea, as described in
      6over4 <xref target="RFC2529"></xref>,
      6to4 <xref target="RFC3056"></xref>, the Intra-Site Automatic Tunnel
      Addressing Protocol (ISATAP) <xref target="RFC5214"></xref>,
      and IPv6 Rapid Deployment on IPv4 Infrastructures
      (6rd) <xref target="RFC5969"></xref>.</t>

      <t>The commonalities of all of these IPv6-over-IPv4 mechanisms
      are as follows: <list
          style="symbols">
          <t>Automatic provisioning of an IPv6 address for a host or an IPv6
          prefix for a site.</t>

          <t>Algorithmic or implicit address resolution of tunnel endpoint
          addresses. Given an IPv6 destination address, an IPv4 tunnel
          endpoint address can be calculated.</t>

          <t>Embedding of an IPv4 address or part thereof into an IPv6
          address.</t>
        </list></t>

      <t>In later phases of IPv4-to-IPv6 migration, it is expected
      that IPv6-only networks will be common, while there will still
      be a need for residual IPv4 deployment. This document describes
      a generic mapping of IPv4 to IPv6 and a mechanism for
      encapsulating IPv4 over IPv6.</t>

      <t>Just as for the IPv6-over-IPv4 mechanisms referred to above, the
      residual IPv4-over-IPv6 mechanism must be capable of:</t>

      <t><list style="symbols">
          <t>Provisioning an IPv4 prefix, an IPv4 address, or a shared IPv4
          address.</t>

          <t>Algorithmically mapping between an IPv4 prefix, an IPv4 address,
          or a shared IPv4 address and an IPv6 address.</t>
        </list></t>

      <t>The mapping scheme described here supports encapsulation of
      IPv4 packets in IPv6 in both mesh and hub-and-spoke topologies,
      including address mappings with full independence between IPv6
      and IPv4 addresses.</t>

      <t>This document describes the delivery of IPv4 unicast service across
      an IPv6 infrastructure. IPv4 multicast is not considered in this
      document.</t>

      <t>The Address plus Port (A+P) architecture of sharing an IPv4
      address by distributing the port space is described in <xref
      target="RFC6346"></xref>. Specifically, Section 4 of <xref
      target="RFC6346"></xref> covers stateless mapping. The
      corresponding stateful solution, Dual-Stack Lite (DS-Lite), is
      described in <xref target="RFC6333"></xref>. The motivations for
      this work are described in <xref target="Solutions-4v6"></xref>.</t>

      <t><xref target="RFC7598"></xref> defines DHCPv6 options for the
      provisioning of MAP. Other means of provisioning are possible.
      Deployment considerations are described in <xref target="MAP-Deploy"/>.</t>

      <t>MAP relies on IPv6 and is designed to deliver dual-stack
      service while allowing IPv4 to be phased out within the service
      provider's (SP's) network. The phasing out of IPv4 within the SP
      network is independent of whether the end user disables IPv4
      service or not. Further, "greenfield" IPv6-only networks may
      use MAP in order to deliver IPv4 to sites via the IPv6 network.</t>
    </section>

    <section anchor="conventions" title="Conventions">
      <t>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
      "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
      document are to be interpreted as described in RFC 2119 <xref
      target="RFC2119"></xref>.</t>
    </section>

    <section title="Terminology">
      <t><list hangIndent="24" style="hanging">
          <t hangText="MAP domain:">One or more MAP Customer Edge (CE)
          devices and Border Relays (BRs) connected to the same
          virtual link. A service provider may deploy a single
          MAP domain or may utilize multiple MAP domains.</t>

          <t hangText="MAP Rule:">A set of parameters describing the mapping
          between an IPv4 prefix, IPv4 address, or shared IPv4 address and an
          IPv6 prefix or address. Each domain uses a different mapping rule
          set.</t>

          <t hangText="MAP node:">A device that implements MAP.</t>

          <t hangText="MAP Border Relay (BR):">A MAP-enabled router managed by
          the service provider at the edge of a MAP domain. A BR has
          at least an IPv6-enabled interface and an IPv4 interface
          connected to the native IPv4 network. A MAP BR may also be referred
          to as simply a "BR" within the context of MAP.</t>

          <t hangText="MAP Customer Edge (CE):">A device functioning as a
          Customer Edge router in a MAP deployment. A typical MAP CE adopting
          MAP Rules will serve a residential site with one WAN-side interface
          and one or more LAN-side interfaces. A MAP CE may also be referred
          to as simply a "CE" within the context of MAP.</t>

          <t hangText="Port set:">Each node has a separate part of the
          transport-layer port space; this is denoted as a port set.</t>

          <t hangText="Port Set ID (PSID):">Algorithmically identifies a set
          of ports exclusively assigned to a CE.</t>

          <t hangText="Shared IPv4 address:">An IPv4 address that is shared
          among multiple CEs. Only ports that belong to the assigned port set
          can be used for communication. Also known as a port-restricted IPv4
          address.</t>

          <t hangText="End-user IPv6 prefix:">The IPv6 prefix assigned
          to an End-user CE by means other than MAP itself, e.g.,
          provisioned using DHCPv6 Prefix Delegation (PD) <xref
          target="RFC3633"></xref>, assigned via Stateless
          Address Autoconfiguration (SLAAC) <xref target="RFC4862"/>, or
          configured manually. It is unique for each CE.</t>

          <t hangText="MAP IPv6 address:">The IPv6 address used to reach the
          MAP function of a CE from other CEs and from BRs.</t>

          <t hangText="Rule IPv6 prefix:">An IPv6 prefix assigned by a service
          provider for a mapping rule.</t>

          <t hangText="Rule IPv4 prefix:">An IPv4 prefix assigned by a service
          provider for a mapping rule.</t>

          <t hangText="Embedded Address (EA) bits:"><vspace/>
          The IPv4 EA-bits in the IPv6 address identify an IPv4
          prefix/address (or part thereof) or a shared IPv4 address
          (or part thereof) and a Port Set Identifier.</t>
        </list></t>
    </section>

    <section title="Architecture">
      <t>In accordance with the requirements stated above, the MAP
      mechanism can operate with shared IPv4 addresses, full IPv4
      addresses, or IPv4 prefixes. Operation with shared IPv4 addresses
      is described here, and the differences for full IPv4 addresses
      and prefixes are described below.</t>

      <t>The MAP mechanism uses existing standard building blocks.
      The existing Network Address and Port Translator (NAPT)
      <xref target="RFC2663"/> on the CE is used
      with additional support for restricting transport-protocol
      ports, ICMP identifiers, and fragment identifiers to the
      configured port set.  For packets outbound from the private IPv4
      network, the CE NAPT MUST translate transport identifiers (e.g.,
      TCP and UDP port numbers) so that they fall within the CE's
      assigned port range.</t>

      <t>The NAPT MUST in turn be connected to a MAP-aware forwarding
      function that does encapsulation/decapsulation of IPv4 packets
      in IPv6.  MAP supports the encapsulation mode specified in <xref
      target="RFC2473"/>.  In addition, MAP specifies an algorithm to
      do "address resolution" from an IPv4 address and port to an IPv6
      address.  This algorithmic mapping is specified in <xref
      target="mapping_algorithm"/>.</t>

      <t>The MAP architecture described here restricts the use of the
      shared IPv4 address to only be used as the global address
      (outside) of the NAPT running on the
      CE. A shared IPv4 address MUST NOT be used to identify an
      interface. While it is theoretically possible to make host
      stacks and applications port-aware, it would be a drastic change
      to the IP model <xref target="RFC6250"/>.</t>

      <t>For full IPv4 addresses and IPv4 prefixes, the architecture
      just described applies, with two differences: first, a full IPv4
      address or IPv4 prefix can be used as it is today, e.g., for
      identifying an interface or as a DHCP pool, respectively. Second,
      the NAPT is not required to restrict the ports used on outgoing
      packets.</t>

      <t>This architecture is illustrated in <xref target="topology"/>.</t>

      <figure align="center" anchor="topology" title="Network Topology">
        <artwork align="center"><![CDATA[
      User N
    Private IPv4
   |  Network
   |
O--+---------------O
|  |  MAP CE       |
| +-----+--------+ |
| NAPT44|  MAP   | |
| +-----+        | |\     ,-------.                      .------.
|       +--------+ | \ ,-'         `-.                 ,-'       `-.
O------------------O  /              \   O---------O  /   Public   \
                     /    IPv6-only  \  |  MAP    | /     IPv4      \
                    (    Network      --+  Border +-     Network    )
                     \  (MAP Domain) /  |  Relay  | \               /
O------------------O  \              /   O---------O  \            /
|    MAP   CE      |  /".         ,-'                 `-.       ,-'
| +-----+--------+ | /   `----+--'                       ------'
| NAPT44|  MAP   | |/   
| +-----+        | |      
|   |   +--------+ |      
O---+--------------O      
    |
     User M
   Private IPv4
     Network
        ]]></artwork>
      </figure>

      <t>The MAP BR connects one or more MAP domains to external IPv4
      networks.</t>
    </section>

    <section anchor="mapping_algorithm" title="Mapping Algorithm">
      <t>A MAP node is provisioned with one or more mapping rules.</t>

      <t>Mapping rules are used differently, depending on their
      function. Every MAP node must be provisioned with a Basic
      Mapping Rule. This is used by the node to configure its IPv4
      address, IPv4 prefix, or shared IPv4 address. This same basic
      rule can also be used for forwarding, where an IPv4 destination
      address and, optionally, a destination port are mapped into an
      IPv6 address. Additional mapping rules are specified to allow
      for multiple different IPv4 subnets to exist within the domain
      and optimize forwarding between them.</t>

      <t>Traffic outside of the domain (i.e., when the destination IPv4 address
      does not match (using longest matching prefix) any Rule IPv4 prefix in
      the Rules database) is forwarded to the BR.</t>

      <t>There are two types of mapping rules: <list style="numbers">

      <t>Basic Mapping Rule (BMR) - mandatory. A CE can be provisioned
      with multiple End-user IPv6 prefixes. There can only be one
      Basic Mapping Rule per End-user IPv6 prefix. However, all CEs
      having End-user IPv6 prefixes within (aggregated by) the same
      Rule IPv6 prefix may share the same Basic Mapping Rule. In
      combination with the End-user IPv6 prefix, the Basic Mapping
      Rule is used to derive the IPv4 prefix, address, or shared
      address and the PSID assigned to the CE.</t>

      <t>Forwarding Mapping Rule (FMR) - optional; used for forwarding.
      The Basic Mapping Rule may also be a Forwarding Mapping Rule.
      Each Forwarding Mapping Rule will result in an entry in
      the rule table for the Rule IPv4 prefix. Given a destination
      IPv4 address and port within the MAP domain, a MAP node
      can use the matching FMR to derive the End-user IPv6 address
      of the interface through which that IPv4 destination
      address and port combination can be reached. In hub-and-spoke
      mode, there are no FMRs.</t>

      </list></t>

      <t>Both mapping rules share the same parameters:<list style="symbols">
      <t>Rule IPv6 prefix (including prefix length)</t>
      <t>Rule IPv4 prefix (including prefix length)</t>
      <t>Rule EA-bit length (in bits)</t>
      </list></t>

      <t>A MAP node finds its BMR by doing a longest match between the
      End-user IPv6 prefix and the Rule IPv6 prefix in the Mapping
      Rules table. The rule is then used for IPv4 prefix, address, or
      shared address assignment.</t>

      <t>A MAP IPv6 address is formed from the BMR Rule IPv6 prefix. This
      address MUST be assigned to an interface of the MAP node and is used to
      terminate all MAP traffic being sent or received to the node.</t>

      <t>Port-restricted IPv4 routes are installed in the rule table
      for all the Forwarding Mapping Rules, and a default route is
      installed to the MAP BR (see <xref target="outside-domain"/>).</t>

      <t>Forwarding Mapping Rules are used to allow direct communication
      between MAP CEs; this is known as "Mesh mode". In hub-and-spoke mode,
      there are no Forwarding Mapping Rules; all traffic MUST be forwarded
      directly to the BR.</t>

      <t>While an FMR is optional in the sense that a MAP CE MAY be
      configured with zero or more FMRs -- depending on the deployment --
      all MAP CEs MUST implement support for both rule types.</t>

      <section title="Port-Mapping Algorithm" anchor="portmap">
        <t>The port-mapping algorithm is used in domains whose rules allow
        IPv4 address sharing.</t>

        <t>The simplest way to represent a port range is using a
        notation similar to Classless Inter-Domain Routing (CIDR)
        <xref target="RFC4632"/>. For example, the first 256 ports
        are represented as port prefix 0.0/8 and the last 256 ports as
        255.0/8. In hexadecimal, these would be 0x0000/8 (PSID = 0) and
        0xFF00/8 (PSID = 0xFF), respectively. Using this technique but
        wishing to avoid allocating the system ports <xref target="RFC6335"/>
        to the user, one would have to exclude the use of one or more
        PSIDs (e.g., PSIDs 0 to 3 in the example just given).
        </t>
         
         <t>When the PSID is embedded in the End-user IPv6 prefix, it is
         desirable to minimize the restrictions of possible PSID values
         in order to minimize dependencies between the End-user IPv6 prefix
         and the assigned port set. This is achieved by using an infix
         representation of the port value. Using such a representation,
         the well-known ports are excluded by restrictions on the value of
         the high-order bit field (A) rather than the PSID.</t>

         <t>The infix algorithm allocates ports to a given CE as a series of
         contiguous ranges spaced at regular intervals throughout the
         complete range of possible port-set values.</t>

        <figure align="left" anchor="psid-fig"
                   title="Structure of a Port-Restricted Port Field">
          <artwork align="left"><![CDATA[
                           0                   1
                           0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 
                          +-----------+-----------+-------+ 
            Ports in      |     A     |    PSID   |   j   |
         the CE port set  |    > 0    |           |       | 
                          +-----------+-----------+-------+ 
                          |  a bits   |  k bits   |m bits |
                     ]]></artwork>
        </figure>

        <t><list hangIndent="9" style="hanging">
          <t hangText="a bits:">The number of offset bits -- 6 by
          default, as this excludes the system ports (0-1023).
          To guarantee non-overlapping port sets, the offset 'a' 
          MUST be the same for every MAP CE sharing the same
          address.</t>

          <t hangText="     A:">Selects the range of the port number. For 'a'
          &gt; 0, A MUST be larger than 0. This ensures that the
          algorithm excludes the system ports. For the default value
          of 'a' (6), the system ports are excluded by requiring that A
          be greater than 0.  Smaller values of 'a' exclude a larger
          initial range, e.g., 'a' = 4 will exclude ports 0-4095.  The
          interval between initial port numbers of successive contiguous
          ranges assigned to the same user is 2^(16 - a).</t>

          <t hangText="k bits:">The length in bits of the PSID
          field. To guarantee non-overlapping port sets, the length 'k' 
          MUST be the same for every MAP CE sharing the same
          address. The sharing ratio is 2^k.&nbsp; The number of ports
          assigned to the user is 2^(16 - k) - 2^m (excluded ports).</t>
          
          <t hangText="  PSID:">The Port Set Identifier
          (PSID). Different PSID values guarantee non-overlapping
          port sets, thanks to the restrictions on 'a' and 'k' stated
          above, because the PSID always occupies the same bit
          positions in the port number.
          </t>

          <t hangText="m bits:">The number of contiguous ports is
          given by 2^m.</t>

          <t hangText="     j:">Selects the specific port within a
          particular range specified by the concatenation of A and the
          PSID.</t>
              </list></t>

      </section>

      <section title="Basic Mapping Rule (BMR)">
        <t>The Basic Mapping Rule is mandatory and is used by the CE to
        provision itself with an IPv4 prefix, IPv4 address, or shared
        IPv4 address. Recall from <xref target="mapping_algorithm"/>
        that the BMR consists of the following parameters:
        <list style="symbols">
          <t>Rule IPv6 prefix (including prefix length)</t>
          <t>Rule IPv4 prefix (including prefix length)</t>
          <t>Rule EA-bit length (in bits)</t>
        </list>
        </t>
        
        <t><xref target="addressallocation-fig"/> shows the structure 
        of the complete MAP IPv6 address as specified in this document.
        </t>

        <figure align="center" anchor="addressallocation-fig"
            title="MAP IPv6 Address Format">

            <artwork align="center"><![CDATA[
|     n bits         |  o bits   | s bits  |   128-n-o-s bits      |
+--------------------+-----------+---------+-----------------------+
|  Rule IPv6 prefix  |  EA bits  |subnet ID|     interface ID      |
+--------------------+-----------+---------+-----------------------+
|<---  End-user IPv6 prefix  --->|
]]></artwork>
          </figure>
        <t>The Rule IPv6 prefix is common among all CEs using the same
        Basic Mapping Rule within the MAP domain. The EA bit field encodes
        the CE-specific IPv4 address and port information. The EA bit field,
        which is unique for a given Rule IPv6 prefix, can contain a full or
        partial IPv4 address and, in the shared IPv4 address case,
        a PSID. An EA bit field length of 0 signifies that all relevant
        MAP IPv4 addressing information is passed directly in the BMR and
        is not derived from the EA bit field in the End-user IPv6 prefix.</t>

        <t>The MAP IPv6 address is created by concatenating the
        End-user IPv6 prefix with the MAP subnet identifier (if the End-user
        IPv6 prefix is shorter than 64 bits) and the interface identifier as
        specified in <xref target="interface-id"></xref>.</t>

        <t>The MAP subnet identifier is defined to be the first subnet
        (s bits set to zero).</t>
        
        <t>Define:
        <list style="empty">
          <t>r = length of the IPv4 prefix given by the BMR;</t>
          <t>o = length of the EA bit field as given by the BMR;</t>
          <t>p = length of the IPv4 suffix contained in the EA bit field.</t>
        </list></t>
        
        <t>The length r MAY be zero, in which case the complete IPv4
        address or prefix is encoded in the EA bits. If only a part of the
        IPv4 address&nbsp;/ prefix is encoded in the EA bits, the
        Rule IPv4 prefix is provisioned to the CE by other means (e.g.,
        a DHCPv6 option). To create a complete IPv4 address (or prefix),
        the IPv4 address suffix (p) from the EA bits is concatenated
        with the Rule IPv4 prefix (r&nbsp;bits).</t>

        <t>The offset of the EA bit field in the IPv6 address is
        equal to the BMR Rule IPv6 prefix length. The length of the EA
        bit field (o) is given by the BMR Rule EA-bit length and
        can be between 0 and 48. A length of 48 means that the
        complete IPv4 address and port are embedded in the End-user
        IPv6 prefix (a single port is assigned). A length of 0 means
        that no part of the IPv4 address or port is embedded in the
        address. The sum of the Rule IPv6 Prefix length and the Rule
        EA-bit length MUST be less than or equal to the End-user IPv6
        prefix length.</t>

        <t>If o + r &lt; 32 (length of the IPv4 address in bits), then an IPv4
        prefix is assigned. This case is shown
        in <xref target="addressallocation4-fig"/>.</t>

        <figure align="center" anchor="addressallocation4-fig"
            title="IPv4 Prefix">

            <artwork align="center"><![CDATA[
|   r bits    |  o bits =  p bits   |
+-------------+---------------------+
|  Rule IPv4  | IPv4 address suffix |
+-------------+---------------------+
|           < 32 bits               |
]]></artwork>
          </figure>

        <t>If o + r is equal to 32, then a full IPv4 address is to be
        assigned. The address is created by concatenating the Rule IPv4 prefix
        and the EA-bits. This case is shown in <xref target="addressallocation3-fig"/>.</t>

        <figure align="center" anchor="addressallocation3-fig"
            title="Complete IPv4 Address">

            <artwork align="center"><![CDATA[
|   r bits    |  o bits = p bits    |
+-------------+---------------------+
|  Rule IPv4  | IPv4 address suffix |
+-------------+---------------------+
|            32 bits                |
]]></artwork>
          </figure>

        <t>If o + r is &gt; 32, then a shared IPv4 address is to be assigned.
        The number of IPv4 address suffix bits (p) in the EA bits is given by
        32 - r bits. The PSID bits are used to create a port set. The length
        of the PSID bit field within the EA bits is q = o - p.</t>

         <figure align="center" anchor="addressallocation2-fig"
            title="Shared IPv4 Address">

            <artwork align="center"><![CDATA[
|   r bits    |        p bits       |         |   q bits   |
+-------------+---------------------+         +------------+
|  Rule IPv4  | IPv4 address suffix |         |Port Set ID |
+-------------+---------------------+         +------------+
|            32 bits                |
]]></artwork>
          </figure>

        <t>The length of r MAY be 32, with no part of the IPv4 address
        embedded in the EA bits. This results in a mapping with no
        dependence between the IPv4 address and the IPv6 address. In
        addition, the length of o MAY be zero (no EA bits embedded in
        the End-user IPv6 prefix), meaning that the PSID is also
        provisioned using, for example, DHCP.</t>

        <t>See <xref target="appendixA"/> for an example of the Basic
        Mapping Rule.</t>
      </section>

      <section title="Forwarding Mapping Rule (FMR)">
        <t>The Forwarding Mapping Rule is optional and is used in
        Mesh mode to enable direct CE-to-CE connectivity.</t>

        <t>On adding an FMR rule, an IPv4 route is installed in the
        rule table for the Rule IPv4 prefix
        (Figures <xref target="addressallocation4-fig" format="counter"/>,
        <xref target="addressallocation3-fig" format="counter"/>, and
        <xref target="addressallocation2-fig" format="counter"/>).</t>

        <figure align="left" anchor="aplusptoipv6-fig"
            title="Derivation of MAP IPv6 Address">

            <artwork align="left"><![CDATA[
|        32 bits           |         |    16 bits        |
+--------------------------+         +-------------------+
| IPv4 destination address |         |  IPv4 dest port   |
+--------------------------+         +-------------------+
               :           :           ___/       :
               |  p bits   |          /  q bits   :
               +-----------+         +------------+ 
               |IPv4 suffix|         |Port Set ID |
               +-----------+         +------------+
                \          /    ____/    ________/
                  \       :  __/   _____/                 
                    \     : /     /
|     n bits         |  o bits   | s bits  |   128-n-o-s bits      |
+--------------------+-----------+---------+------------+----------+
|  Rule IPv6 prefix  |  EA bits  |subnet ID|     interface ID      |
+--------------------+-----------+---------+-----------------------+
|<---  End-user IPv6 prefix  --->|
]]></artwork>
          </figure>

          <t>See <xref target="appendixA"/> for an example of the
          Forwarding Mapping Rule.</t>

      </section>

      <section anchor="outside-domain" title="Destinations outside the MAP Domain">
        <t>IPv4 traffic between MAP nodes that are all within one MAP
        domain is encapsulated in IPv6, with the sender's MAP IPv6
        address as the IPv6 source address and the receiving MAP
        node's MAP IPv6 address as the IPv6 destination address. To
        reach IPv4 destinations outside of the MAP domain, traffic is
        also encapsulated in IPv6, but the destination IPv6 address is
        set to the configured IPv6 address of the MAP BR.</t>

        <t>On the CE, the path to the BR can be represented as a
        point-to-point IPv4-over-IPv6 tunnel <xref target="RFC2473"/> with
        the source address of the tunnel being the CE's MAP IPv6
        address and the BR IPv6 address as the remote tunnel
        address. When MAP is enabled, a typical CE router will install
        a default IPv4 route to the BR.</t>

        <t>The BR forwards traffic received from the outside to CEs
        using the normal MAP forwarding rules.</t>

      </section>
    </section>

    <section anchor="interface-id" title="The IPv6 Interface Identifier">
      <t>The interface identifier format of a MAP node is described
      below.</t>

      <figure align="left" anchor="interfaceid2-fig" title="IPv6 Interface Identifier"> <artwork align="left"><![CDATA[
                |          128-n-o-s bits          |
                | 16 bits|    32 bits     | 16 bits|
                +--------+----------------+--------+
                |   0    |  IPv4 address  |  PSID  |
                +--------+----------------+--------+
]]></artwork>
        </figure>

      <t>In the case of an IPv4 prefix, the IPv4 address field is right-padded
      with zeros up to 32 bits. The PSID field is left-padded with zeros to
      create a 16-bit field. For an IPv4 prefix or a complete IPv4 address,
      the PSID field is zero.</t>

      <t>If the End-user IPv6 prefix length is larger than 64, the most
      significant parts of the interface identifier are overwritten by
      the prefix.</t>
    </section>

    <section title="MAP Configuration">
      <t>For a given MAP domain, the BR and CE MUST be configured with the
      following MAP elements. The configured values for these elements are
      identical for all CEs and BRs within a given MAP domain.</t>

      <t><list style="symbols">
          <t>The Basic Mapping Rule and, optionally, the Forwarding Mapping
          Rules, including the Rule IPv6 prefix, Rule IPv4 prefix, and Length
          of EA bits.</t>

          <t>Hub-and-spoke mode or Mesh mode (if all traffic should be sent
          to the BR, or if direct CE-to-CE traffic should be supported).</t>
        </list></t>

        <t>In addition, the MAP CE MUST be configured with the IPv6
        address(es) of the MAP BR (<xref target="outside-domain"/>).</t>


      <section title="MAP CE">
        <t>The MAP elements are set to values that are the same across
        all CEs within a MAP domain. The values may be configured in a
        variety of ways, including provisioning methods such as the
        Broadband Forum's "TR-69" Residential Gateway management
        interface <xref target="TR069"/>, an XML&nbhy;based object retrieved
        after IPv6 connectivity is established, or manual configuration by
        an administrator. IPv6 DHCP options for MAP configuration are
        defined in <xref target="RFC7598"/>. Other configuration and
        management methods may use the formats described by these options
        for consistency and convenience of implementation on CEs that
        support multiple configuration methods.</t>

        <t>The only remaining provisioning information the CE requires
        in order to calculate the MAP IPv4 address and enable IPv4
        connectivity is the IPv6 prefix for the CE. The End-user IPv6
        prefix is configured as part of obtaining IPv6 Internet
        access.</t>

        <t>The MAP provisioning parameters, and hence the IPv4 service
        itself, are tied to the associated End-user IPv6 prefix
        lifetime; thus, the MAP service is also tied to this in terms
        of authorization, accounting, etc.</t>

        <t>A single MAP CE MAY be connected to more than one MAP domain, just
        as any router may have more than one IPv4-enabled
        service-provider-facing interface and more than one set of
        associated addresses assigned by DHCP. Each domain within which a
        given CE operates would require its own set of MAP configuration
        elements and would generate its own IPv4 address. Each MAP domain
        requires a distinct End-user IPv6 prefix.</t>

        <t>MAP DHCP options are specified in <xref target="RFC7598"></xref>.</t>
      </section>

      <section title="MAP BR">
        <t>The MAP BR MUST be configured with corresponding mapping rules
        for each MAP domain for which it is acting as a BR.</t>

        <t>For increased reliability and load balancing, the BR IPv6 address
        MAY be an anycast address shared across a given MAP domain. As MAP is
        stateless, any BR may be used at any time. If the BR IPv6 address is
        anycast, the relay MUST use this anycast IPv6 address as the source
        address in packets relayed to CEs.</t>

        <t>Since MAP uses provider address space, no specific routes need to
        be advertised externally for MAP to operate in IPv6 or IPv4 BGP.
        However, if anycast is used for the MAP IPv6 relays, the anycast
        addresses must be advertised in the service provider's IGP.</t>
      </section>

    </section>

    <section title="Forwarding Considerations">
      <t><xref target="topology"/> depicts the overall MAP architecture
      with IPv4 users connected to a routed IPv6 network.</t>

      <t>MAP uses encapsulation mode as specified in <xref target="RFC2473"></xref>.</t>

      <t>For a shared IPv4 address, a MAP CE forwarding IPv4 packets
      from the LAN performs NAT44 functions first and creates
      appropriate NAT44 bindings. The resulting IPv4 packets MUST
      contain the source IPv4 address and source transport identifiers
      specified by the MAP provisioning parameters. The IPv4 packet is
      forwarded using the CE's MAP forwarding function. The IPv6
      source and destination addresses MUST then be derived as per
      <xref target="mapping_algorithm"></xref> of this document.</t>

      <section title="Receiving Rules">

      <t>A MAP CE receiving an IPv6 packet to its MAP IPv6 address
      sends this packet to the CE's MAP function, where it is
      decapsulated. The resulting IPv4 packet is then forwarded to
      the CE's NAT44 function, where it is handled according to the
      NAT's translation table.</t>

      <t>A MAP BR receiving IPv6 packets selects a best matching MAP
      domain rule (Rule IPv6 prefix) based on a longest address match
      of the packet's IPv6 source address, as well as a match of the
      packet destination address against the configured BR IPv6
      address(es). The selected MAP Rule allows the BR to determine
      the EA-bits from the source IPv6 address.</t>

      <t>To prevent spoofing of IPv4 addresses, any MAP node (CE and
      BR) MUST perform the following validation upon reception of a
      packet. First, the embedded IPv4 address or prefix, as well as the
      PSID (if any), are extracted from the source IPv6 address using
      the matching MAP Rule. These represent the range of what is
      acceptable as source IPv4 address and port. Second, the node
      extracts the source IPv4 address and port from the IPv4 packet
      encapsulated inside the IPv6 packet. If they are found to be outside
      the acceptable range, the packet MUST be silently discarded and a
      counter incremented to indicate that a potential spoofing attack
      may be underway. The source validation checks just described are
      not done for packets whose source IPv6 address is that of the
      BR (BR IPv6 address).</t>


      <t>By default, the CE router MUST drop packets received on the
      MAP virtual interface (i.e., after decapsulation of IPv6) for
      IPv4 destinations not for its own IPv4 shared address, full IPv4
      address, or IPv4 prefix.</t>

    </section>

    <section title="ICMP">
      <t>ICMP messages should be supported in MAP domains. Hence, the NAT44 in
      the MAP CE MUST implement the behavior for ICMP messages conforming to
      the best current practice documented
      in <xref target="RFC5508"></xref>.</t>

      <t>If a MAP CE receives an ICMP message having the ICMP Identifier field
      in the ICMP header, the NAT44 in the MAP CE MUST rewrite this field
      to a specific value assigned from the port set. BRs and other CEs
      must handle this field in a way similar to the handling of a port number
      in the TCP/UDP header upon receiving the ICMP message with the
      ICMP Identifier field.</t>

      <t>If a MAP node receives an ICMP error message without the ICMP
      Identifier field for errors that are detected inside an IPv6 tunnel, a
      node should relay the ICMP error message to the original source. This
      behavior SHOULD be implemented in accordance with
      Section 8 of <xref target="RFC2473"></xref>.</t>
    </section>

    <section title="Fragmentation and Path MTU Discovery">
      <t>Due to the different sizes of the IPv4 and IPv6 headers, handling
      the maximum packet size is relevant for the operation of any system
      connecting the two address families. There are three mechanisms to
      handle this issue: Path MTU Discovery (PMTUD), fragmentation, and
      transport-layer negotiation such as the TCP Maximum Segment Size (MSS)
      option <xref target="RFC879"></xref>. MAP uses all three mechanisms to
      deal with different cases.</t>

      <section title="Fragmentation in the MAP Domain">
        <t>Encapsulating an IPv4 packet to carry it across the MAP
        domain will increase its size (typically by 40 bytes). It is
        strongly recommended that the MTU in the MAP domain be well
        managed and that the IPv6 MTU on the CE WAN-side interface be
        set so that no fragmentation occurs within the boundary of the
        MAP domain.</t>

        <t>For an IPv4 packet entering a MAP domain, fragmentation is
        performed as described in Section 7.2 of <xref target="RFC2473"></xref>.</t>

        <t>The use of an anycast source address could lead to an ICMP
        error message generated on the path being sent to a different
        BR. Therefore, using a dynamically set tunnel MTU
        (Section 6.7 of <xref target="RFC2473"></xref>) is subject to
        IPv6 Path MTU black holes. A MAP BR using an anycast
        source address SHOULD NOT by default use Path MTU Discovery
        across the MAP domain.</t>

        <t>Multiple BRs using the same anycast source address could
        send fragmented packets to the same CE at the same time. If
        the fragmented packets from different BRs happen to use the
        same fragment ID, incorrect reassembly might occur. See <xref
        target="RFC4459"/> for an analysis of the problem;
        Section 3.4 of <xref target="RFC4459"/> suggests solving the
        problem by fragmenting the inner packet.</t>
      </section>

      <section title="Receiving IPv4 Fragments on the MAP Domain Borders">
        <t>The forwarding of an IPv4 packet received from outside of
        the MAP domain requires the IPv4 destination address and the
        transport-protocol destination port. The transport-protocol
        information is only available in the first fragment received.
        As described in Section 5.3.3 of <xref target="RFC6346"></xref>,
        a MAP node receiving an IPv4 fragmented packet from outside has to
        reassemble the packet before sending the packet onto the MAP link.
        If the first packet received contains the transport-protocol
        information, it is possible to optimize this behavior by using a
        cache and forwarding the fragments unchanged. Implementers of MAP
        should be aware that there are a number of well-known attacks against
        IP fragmentation; see <xref target="RFC1858"/> and <xref
        target="RFC3128"/>. Implementers should also be aware of
        additional issues with reassembling packets at high rates,
        as described in <xref target="RFC4963"/>.</t>
      </section>

      <section title="Sending IPv4 Fragments to the Outside">
        <t>If two IPv4 hosts behind two different MAP CEs with the
        same IPv4 address send fragments to an IPv4 destination host
        outside the domain, those hosts may use the same IPv4
        fragmentation identifier, resulting in incorrect reassembly of
        the fragments at the destination host. Given that the IPv4
        fragmentation identifier is a 16-bit field, it could be used
        similarly to port ranges. A MAP CE could rewrite the IPv4
        fragmentation identifier to be within its allocated port set,
        if the resulting fragment identifier space was large enough
        related to the rate at which fragments were sent. However,
        splitting the identifier space in this fashion would increase the
        probability of reassembly collisions for all connections
        through the Customer Premises Equipment (CPE).
        See also <xref target="RFC6864"/>.</t>
      </section>
    </section>
  </section>
    <section title="NAT44 Considerations">
      <t>The NAT44 implemented in the MAP CE SHOULD conform to the
      behavior and best current practices documented in <xref
      target="RFC4787"></xref>, <xref target="RFC5508"></xref>, and
      <xref target="RFC5382"></xref>. In MAP address-sharing mode
      (determined by the MAP domain&nbsp;/&nbsp;rule configuration
      parameters), the operation of the NAT44 MUST be restricted to
      the available port numbers derived via the Basic Mapping Rule.</t>
    </section>

    <section title="Security Considerations">
      <t><list style="hanging">
          <t hangText="Spoofing attacks:">With consistency checks between IPv4
          and IPv6 sources that are performed on IPv4/IPv6 packets received by
          MAP nodes, MAP does not introduce any new opportunity for spoofing
          attacks that would not already exist in IPv6.</t>

          <t hangText="Denial-of-service attacks:">In MAP domains
          where IPv4 addresses are shared, the fact that IPv4 datagram
          reassembly may be necessary introduces an opportunity for
          DoS attacks. This is inherent in address sharing and is
          common with other address-sharing approaches such as DS-Lite
          and NAT64/DNS64. The best protection against such attacks is
          to accelerate IPv6 deployment so that address sharing is used
          less and less where MAP is supported.</t>

          <t hangText="Routing loop attacks:">Routing loop attacks may
          exist in some "automatic tunneling" scenarios and are
          documented in <xref target="RFC6324"></xref>. They cannot
          exist with MAP because each BR checks that the IPv6
          source address of a received IPv6 packet is a CE address
          based on the Forwarding Mapping Rule.</t>

          <t hangText="Attacks facilitated by restricted port set:">From
          hosts that are not subject to ingress filtering
          <xref target="RFC2827"></xref>, an attacker can inject
          spoofed packets during ongoing transport connections
          <xref target="RFC4953"></xref> <xref target="RFC5961"></xref>
          <xref target="RFC6056"></xref>. The attacks depend on guessing
          which ports are currently used by target hosts. Using an
          unrestricted port set is preferable, i.e., using native IPv6
          connections that are not subject to MAP port-range
          restrictions. To minimize these types of attacks when using a
          restricted port set, the MAP CE's NAT44 filtering behavior
          SHOULD be "Address-Dependent Filtering" as described in
          Section 5 of <xref target="RFC4787"/>. Furthermore, the MAP CEs
          SHOULD use a DNS transport proxy <xref target="RFC5625"/>
          function to handle DNS traffic and source such traffic from
          IPv6 interfaces not assigned to MAP.</t>
        </list></t>

      <t><xref target="RFC6269"></xref> outlines general issues with IPv4
      address sharing.</t>
    </section>

  </middle>

  <back>

    <references title="Normative References">
      &rfc2119;
      &rfc2473;
      &rfc5625;
    </references>

    <references title="Informative References">

<!-- draft-ietf-softwire-map-dhcp (RFC 7598; "n+2" per RFC Ed. Note) -->
<reference anchor='RFC7598' target="http://www.rfc-editor.org/info/rfc7598">
<front>
<title>DHCPv6 Options for Configuration of Softwire Address and Port-Mapped Clients</title>
<author initials='T' surname='Mrugalski' fullname='Tomek Mrugalski'>
    <organization />
</author>
<author initials='O' surname='Troan' fullname='Ole Troan'>
    <organization />
</author>
<author initials='I' surname='Farrer' fullname='Ian Farrer'>
    <organization />
</author>
<author initials='S' surname='Perreault' fullname='Simon Perreault'>
    <organization />
</author>
<author initials='W' surname='Dec' fullname='Wojciech Dec'>
    <organization />
</author>
<author initials='C' surname='Bao' fullname='Congxiao Bao'>
    <organization />
</author>
<author initials='L' surname='Yeh' fullname='Leaf Yeh'>
    <organization />
</author>
<author initials='X' surname='Deng' fullname='Xiaohong Deng'>
    <organization />
</author>
<date month='July' year='2015' />
</front>
<seriesInfo name='RFC' value='7598' />
<seriesInfo name='DOI' value='10.17487/RFC7598'/>
</reference>

      &rfc6346;

<!-- draft-ietf-softwire-stateless-4v6-motivation (Expired (IESG: Dead)) -->
<reference anchor='Solutions-4v6'>
<front>
<title>Motivations for Carrier-side Stateless IPv4 over IPv6 Migration Solutions</title>
<author initials='M' surname='Boucadair' fullname='Mohamed Boucadair'
	role="editor">
    <organization />
</author>
<author initials='S' surname='Matsushima' fullname='Satoru Matsushima'>
    <organization />
</author>
<author initials='Y' surname='Lee' fullname='Yiu Lee'>
    <organization />
</author>
<author initials='O' surname='Bonness' fullname='Olaf Bonness'>
    <organization />
</author>
<author initials='I' surname='Borges' fullname='Isabel Borges'>
    <organization />
</author>
<author initials='G' surname='Chen' fullname='Gang Chen'>
    <organization />
</author>
<date month='November' year='2012' />
</front>
<seriesInfo name='Work in Progress,' value='draft-ietf-softwire-stateless-4v6-motivation-05' />
</reference>

      &rfc6335;
      &rfc6333;
      &rfc1933;
      &rfc4213;
      &rfc5969;
      &rfc3056;
      &rfc2529;
      &rfc5214;
      &rfc3633;
      &rfc6269;
      &rfc6250;
      &rfc2663;

<reference  anchor='RFC879' target='http://www.rfc-editor.org/info/rfc879'>
<front>
<title>The TCP Maximum Segment Size and Related Topics</title>
<author initials='J.' surname='Postel' fullname='J. Postel'><organization /></author>
<date year='1983' month='November' />
</front>
<seriesInfo name='RFC' value='879'/>
<seriesInfo name='DOI' value='10.17487/RFC0879'/>
</reference>

      &rfc6324;
      &rfc2827;
      &rfc4953;
      &rfc5961;
      &rfc6056;
      &rfc4787;
      &rfc5508;
      &rfc5382;
      &rfc4862;
      &rfc4632;
      &rfc4459;

<!-- draft-ietf-softwire-map-deployment (I-D Exists) -->
<reference anchor='MAP-Deploy'>
<front>
<title>Mapping of Address and Port (MAP) - Deployment Considerations</title>
<author initials='Q' surname='Sun' fullname='Qiong Sun'>
    <organization />
</author>
<author initials='M' surname='Chen' fullname='Maoke Chen'>
    <organization />
</author>
<author initials='G' surname='Chen' fullname='Gang Chen'>
    <organization />
</author>
<author initials='T' surname='Tsou' fullname='Tina Tsou'>
    <organization />
</author>
<author initials='S' surname='Perreault' fullname='Simon Perreault'>
    <organization />
</author>
<date month='June' year='2015' />
</front>
<seriesInfo name='Work in Progress,' value='draft-ietf-softwire-map-deployment-06' />
</reference>

      &rfc1858;
      &rfc3128;
      &rfc4963;
      &rfc6864;

  <reference anchor="TR069" target="https://www.broadband-forum.org">
    <front>
      <title>CPE WAN Management Protocol</title>
      <author><organization>Broadband Forum TR-069</organization></author>
      <date month="November" year="2013"/>
    </front>
    <seriesInfo name="Amendment 5," value="CWMP Version: 1.4"/>
  </reference>

 </references>

    <section title="Examples" anchor="appendixA">
      <figure>
          <preamble>Example 1 - Basic Mapping Rule:</preamble>

          <artwork align="left"><![CDATA[
Given the MAP domain information and an IPv6 address of
an endpoint:

End-user IPv6 prefix: 2001:db8:0012:3400::/56
Basic Mapping Rule:   {2001:db8:0000::/40 (Rule IPv6 prefix),
                       192.0.2.0/24 (Rule IPv4 prefix),
                       16 (Rule EA-bit length)}
PSID length:          (16 - (32 - 24) = 8 (sharing ratio of 256)
PSID offset:          6 (default)

A MAP node (CE or BR) can, via the BMR or equivalent FMR,
determine the IPv4 address and port set as shown below:

EA bits offset:       40
IPv4 suffix bits (p)  Length of IPv4 address (32) -
                      IPv4 prefix length (24) = 8
IPv4 address:         192.0.2.18 (0xc0000212)
PSID start:           40 + p = 40 + 8 = 48
PSID length:          o - p = (56 - 40) - 8 = 8
PSID:                 0x34

Available ports (63 ranges): 1232-1235, 2256-2259, ...... , 
                             63696-63699, 64720-64723

The BMR information allows a MAP CE to determine (complete)
its IPv6 address within the indicated IPv6 prefix.

IPv6 address of MAP CE:  2001:db8:0012:3400:0000:c000:0212:0034

  ]]></artwork>
        </figure>

      <figure>
          <preamble>Example 2 - BR:</preamble>

          <artwork align="left"><![CDATA[
Another example is a MAP BR, configured with the following FMR
when receiving a packet with the following characteristics:

IPv4 source address:       1.2.3.4 (0x01020304)
IPv4 source port:          80
IPv4 destination address:  192.0.2.18 (0xc0000212)
IPv4 destination port:     1232

Forwarding Mapping Rule: {2001:db8::/40 (Rule IPv6 prefix),
                          192.0.2.0/24 (Rule IPv4 prefix),
                          16 (Rule EA-bit length)}

IPv6 address of MAP BR:              2001:db8:ffff::1

The above information allows the BR to derive the mapped
destination IPv6 address for the corresponding MAP CE, and also
the mapped source IPv6 address for the IPv4 source address,
as follows:

IPv4 suffix bits (p):  32 - 24 = 8 (18 (0x12))
PSID length:           8
PSID:                  0x34 (1232)

The resulting IPv6 packet will have the following key fields:

IPv6 source address:       2001:db8:ffff::1
IPv6 destination address:  2001:db8:0012:3400:0000:c000:0212:0034

  ]]></artwork>
        </figure>

      <figure>
          <preamble>Example 3 - Forwarding Mapping Rule:</preamble>

          <artwork align="left"><![CDATA[
An IPv4 host behind the MAP CE (addressed as per the previous
examples) corresponding with IPv4 host 1.2.3.4 will have its
packets encapsulated by IPv6 using the IPv6 address of the BR
configured on the MAP CE as follows:

IPv6 address of BR:         2001:db8:ffff::1
IPv4 source address:        192.0.2.18
IPv4 destination address:   1.2.3.4
IPv4 source port:           1232
IPv4 destination port:      80
MAP CE IPv6 source address: 2001:db8:0012:3400:0000:c000:0212:0034
IPv6 destination address:   2001:db8:ffff::1
   
  ]]></artwork>
        </figure><figure>
          <preamble>Example 4 - Rule with no embedded address bits and no address sharing:</preamble>

          <artwork><![CDATA[
End-user IPv6 prefix: 2001:db8:0012:3400::/56
Basic Mapping Rule:   {2001:db8:0012:3400::/56 (Rule IPv6 prefix),
                       192.0.2.18/32 (Rule IPv4 prefix),
                       0 (Rule EA-bit length)}
PSID length:          0 (sharing ratio is 1)
PSID offset:          n/a

A MAP node (CE or BR) can, via the BMR or equivalent FMR, determine
the IPv4 address and port set as shown below:

EA bits offset:       0
IPv4 suffix bits (p): Length of IPv4 address (32) -
                      IPv4 prefix length (32) = 0
IPv4 address:         192.0.2.18 (0xc0000212)
PSID start:           0
PSID length:          0
PSID:                 null

The BMR information allows a MAP CE to also determine (complete)
its full IPv6 address by combining the IPv6 prefix with the MAP
interface identifier (that embeds the IPv4 address).

IPv6 address of MAP CE:  2001:db8:0012:3400:0000:c000:0212:0000

]]></artwork>
        </figure><figure>
        <preamble>Example 5 - Rule with no embedded address bits and address
sharing (sharing ratio of 256):</preamble>

          <artwork><![CDATA[
End-user IPv6 prefix: 2001:db8:0012:3400::/56
Basic Mapping Rule:   {2001:db8:0012:3400::/56 (Rule IPv6 prefix),
                       192.0.2.18/32 (Rule IPv4 prefix),
                       0 (Rule EA-bit length)}
PSID length:          8 (from DHCP; sharing ratio of 256)
PSID offset:          6 (default)
PSID:                 0x34 (from DHCP)

A MAP node can, via the Basic Mapping Rule, determine the IPv4
address and port set as shown below:

EA bits offset:        0
IPv4 suffix bits (p):  Length of IPv4 address (32) -
                       IPv4 prefix length (32) = 0
IPv4 address:          192.0.2.18 (0xc0000212)
PSID offset:           6
PSID length:           8
PSID:                  0x34

Available ports (63 ranges): 1232-1235, 2256-2259, ...... ,
                             63696-63699, 64720-64723

The Basic Mapping Rule information allows a MAP CE to also
determine (complete) its full IPv6 address by combining the IPv6
prefix with the MAP interface identifier (that embeds the IPv4
address and PSID).

IPv6 address of MAP CE: 2001:db8:0012:3400:0000:c000:0212:0034

Note that the IPv4 address and PSID are not derived from the IPv6
prefix assigned to the CE but are provisioned separately using,
for example, DHCP.
]]></artwork>
        </figure>
    </section>

      <section title="A More Detailed Description of the Derivation of the Port-Mapping Algorithm">
        <t>This appendix describes how the port-mapping algorithm described in 
        <xref target="portmap"/> was derived. The algorithm is used in domains
        whose rules allow IPv4 address sharing. </t>
        
        <t>The basic requirement for a port-mapping algorithm is
        that the port sets it assigns to different MAP CEs MUST be
        non-overlapping. A number of other requirements guided the
        choice of the algorithm:
        <list style="symbols">
          <t>In keeping with the general MAP algorithm, the port set MUST be
          derivable from a Port Set identifier (PSID) that can be embedded in
          the End-user IPv6 prefix.</t>
          
          <t>The mapping MUST be reversible such that, given the port number,
          the PSID of the port set to which it belongs can be quickly derived.
          </t>
          
          <t>The algorithm MUST allow a broad range of address-sharing
          ratios.</t>
          
          <t>It SHOULD be possible to exclude subsets of the complete
          port numbering space from assignment. Most operators would
          exclude the system ports (0-1023). A conservative operator
          might exclude all but the transient ports (49152-65535).
          </t>
          
          <t>The effect of port exclusion on the possible values of the
          End-user IPv6 prefix (i.e., due to restrictions on the PSID value)
          SHOULD be minimized.</t>
          
          <t>For administrative simplicity, the algorithm SHOULD allocate the
          same or almost the same number of ports to each CE sharing a given
          IPv4 address.
          </t>
        </list>         
        </t>
        
        <t>The two extreme cases that an algorithm satisfying those conditions
        might support are when (1) the port numbers are not contiguous for
        each PSID but uniformly distributed across the allowed port range
        and (2) the port numbers are contiguous in a single range for each
        PSID. The port-mapping algorithm proposed here is called the
        Generalized Modulus Algorithm (GMA) and supports both of
        these cases.</t>

        <t>For a given IPv4 address-sharing ratio (R) and the maximum number
        of contiguous ports (M) in a port set, the GMA is defined as follows:

        <list style="letters">
            <t>The port numbers (P) corresponding to a given PSID are
            generated&nbsp;by: <figure>
                <artwork><![CDATA[
    (1) ... P = (R * M) * i + M * PSID + j
          ]]></artwork>
             </figure> where i and j are indices and the ranges
             of i, j, and the PSID are discussed below.</t>
              
             <t>For any given port number P, the PSID is calculated as: <figure>
                     <artwork><![CDATA[
    (2) ... PSID = trunc((P modulo (R * M)) / M)
                     ]]></artwork>
             </figure> where trunc() is the operation of rounding down to the
             nearest integer.</t>
              
            </list>
          </t>
              
          <t>Formula (1) can be interpreted as follows. First, the available
          port space is divided into blocks of size R * M. &nbsp;Each block is 
          divided into R individual ranges of length M. &nbsp;The index i in
          formula (1) selects a block, PSID selects a range within that
          block, and the index j selects a specific port value within the
          range. On the basis of this interpretation: <list style="symbols">
          
          <t>i ranges from ceil(N / (R * M)) to trunc(65536/(R * M)) - 1, 
          where ceil is the operation of rounding up to the nearest integer
          and N is the number of ports (e.g., 1024) excluded from the lower
          end of the range. That is, any block containing excluded values is
          discarded at the lower end, and if the
          final block has fewer than R * M values it is discarded. This
          ensures that the same number of ports is assigned to every PSID. 
          </t>
            
          <t>PSID ranges from 0 to R - 1.</t>
            
          <t>j ranges from 0 to M - 1.</t>
         </list>
         </t>


        <section title="Bit Representation of the Algorithm">
          <t> If R and M are powers of 2 (R = 2^k, M = 2^m), formula (1)
          translates to a computationally convenient structure for any
          port number represented as a 16-bit binary number. This structure
          is shown in <xref target="bitrepresentation2-fig"/>.</t>

          <figure align="left" anchor="bitrepresentation2-fig"
              title="Bit Representation of a Port Number">

              <artwork align="left"><![CDATA[
       0                          8                         15
       +---------------+----------+------+-------------------+
       |                     P                               |
       ----------------+-----------------+-------------------+
       |        i      |       PSID      |        j          |
       +---------------+----------+------+-------------------+
       |<----a bits--->|<-----k bits---->|<------m bits----->|
                ]]></artwork>
            </figure>

          <t>As shown in the figure, the index value i of formula (1)
          is given by the first a = 16 - k - m bits of the port number.
          The PSID value is given by the next k bits, and the
          index value j is given by the last m bits.</t>

          <t>Because the PSID is always in the same position in the port
          number and always the same length, different PSID values are 
          guaranteed to generate different sets of port numbers. In the
          reverse direction, the generating PSID can be extracted from
          any port number by a bitmask operation.</t>

          <t>Note that when M and R are powers of 2, 65536 divides evenly
          by R * M. &nbsp;Hence, the final block is complete, and
          the upper bound on i is exactly 65536/(R * M) - 1. The
          lower bound on i is still the minimum required to ensure that
          the required set of ports is excluded. No port numbers are
          wasted through the discarding of blocks at the lower end if
          block size R * M is a factor of N, the number of ports to be
          excluded.</t>
          
          <t>As a final note, the number of blocks into which the range 0-65535
          is being divided in the above representation is given by 2^a.
          Hence, the case where a = 0 can be interpreted as one where the 
          complete range has been divided into a single block, and individual
          port sets are contained in contiguous ranges in that block. We cannot
          throw away the whole block in that case, so port exclusion has to be
          achieved by putting a lower bound equal to ceil(N / M) on the 
          allowed set of PSID values instead.
          </t>
        </section>

        <section title="GMA Examples">
          <figure align="left" title="Example 1: with offset = 6 (a = 6)">
              <preamble>For example, for R = 256, PSID = 0, offset: a = 6 and PSID
              length: k = 8 bits:</preamble>

              <artwork align="left"><![CDATA[
Available ports (63 ranges): 1024-1027, 2048-2051, ...... ,
                             63488-63491, 64512-64515
          ]]></artwork>
            </figure>

          <figure align="left" title="Example 2: with offset = 0 (a = 0) and N = 0">
              <preamble>For example, for R = 64, PSID = 0, a = 0 (PSID offset = 0 and
              PSID length = 6 bits), no port exclusion:</preamble>
              <artwork align="left"><![CDATA[
Available ports (1 range): 0-1023
          ]]></artwork>
            </figure>
        </section>

      </section>

    <section title="Acknowledgements" numbered="no">
      <t>This document is based on the ideas of many, including
      Masakazu Asama, Mohamed Boucadair, Gang Chen, Maoke Chen,
      Wojciech Dec, Xiaohong Deng, Jouni Korhonen, Tomek Mrugalski,
      Jacni Qin, Chunfa Sun, Qiong Sun, and Leaf Yeh. &nbsp;The authors want
      in particular to recognize Remi Despres, who has tirelessly
      worked on generalized mechanisms for stateless address
      mapping.</t>

      <t>The authors would like to thank Lichun Bao, Guillaume
      Gottard, Dan Wing, Jan Zorz, Necj Scoberne, Tina Tsou, Kristian
      Poscic, and especially Tom Taylor and Simon Perreault for the
      thorough review and comments of this document. Useful IETF Last
      Call comments were received from Brian Weis and Lei Yan.
      </t>
    </section>

    <section title="Contributors" numbered="no">
      <t>This document is the result of the IETF Softwire MAP design team
      effort and numerous previous individual contributions in this area:</t>

      <figure><artwork><![CDATA[
Chongfeng Xie
China Telecom
Room 708, No. 118, Xizhimennei Street
Beijing  100035
China
Phone: +86-10-58552116
Email: xiechf@ctbri.com.cn

Qiong Sun
China Telecom
Room 708, No. 118, Xizhimennei Street
Beijing  100035
China
Phone: +86-10-58552936
Email: sunqiong@ctbri.com.cn

Gang Chen
China Mobile
29, Jinrong Avenue
Xicheng District, Beijing  100033
China
Email: phdgang@gmail.com, chengang@chinamobile.com

Yu Zhai
CERNET Center/Tsinghua University
Room 225, Main Building, Tsinghua University
Beijing  100084
China
Email: jacky.zhai@gmail.com

Wentao Shang
CERNET Center/Tsinghua University
Room 225, Main Building, Tsinghua University
Beijing  100084
China
Email: wentaoshang@gmail.com

Guoliang Han
CERNET Center/Tsinghua University
Room 225, Main Building, Tsinghua University
Beijing  100084
China
Email: bupthgl@gmail.com

Rajiv Asati
Cisco Systems
7025-6 Kit Creek Road
Research Triangle Park, NC  27709
United States
Email: rajiva@cisco.com
      ]]></artwork></figure>
    </section>

  </back>
</rfc>
