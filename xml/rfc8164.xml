<?xml version="1.0" encoding="US-ASCII"?>

<?xml-stylesheet type="text/xsl" href="rfc2629.xslt" ?>
<!-- generated by https://github.com/cabo/kramdown-rfc2629 version 1.0.43 -->

<?rfc toc="yes"?>
<?rfc sortrefs="yes"?>
<?rfc symrefs="yes"?>
<?rfc compact="yes"?>
<?rfc subcompact="no" ?>

<!DOCTYPE rfc
  PUBLIC "" "rfc2629.dtd">

<rfc number="8164" ipr="trust200902" 
     category="exp" consensus="yes"
     submissionType="IETF">

<front>
<title abbrev="Opportunistic HTTP/2 Security">Opportunistic Security for HTTP/2
</title>
<author initials="M." surname="Nottingham" fullname="Mark Nottingham">
<organization/>
<address><email>mnot@mnot.net</email><uri>https://www.mnot.net/</uri></address></author>

<author initials="M." surname="Thomson" fullname="Martin Thomson">
<organization>Mozilla</organization>
<address><email>martin.thomson@gmail.com</email></address>
</author>

<date month="May" year="2017"/>

<area>Applications and Real-Time</area>

<workgroup>HTTP Working Group</workgroup>

<abstract>

<t>This document describes how <spanx style="verb"
xml:space="preserve">http</spanx> URIs can be accessed using Transport Layer
Security (TLS) and HTTP/2 to mitigate pervasive monitoring attacks. This
mechanism not a replacement for <spanx style="verb"
xml:space="preserve">https</spanx> URIs; it is vulnerable to active
attacks.
</t>
</abstract>
</front>

<middle>

<section anchor="introduction" toc="default" title="Introduction">




<t>This document describes a use of HTTP Alternative Services <xref
target="RFC7838" format="default"/> to decouple the URI scheme
from the use and configuration of underlying encryption.  It allows an <spanx
style="verb" xml:space="preserve">http</spanx> URI <xref target="RFC7230"
format="default"/> to be accessed
using HTTP/2 and Transport Layer
Security (TLS) <xref target="RFC5246" format="default"/> with Opportunistic
Security <xref target="RFC7435" format="default"/>.</t>

<t>This document
describes a usage model whereby sites can serve <spanx style="verb"
xml:space="preserve">http</spanx> URIs over TLS, thereby
avoiding the problem of serving Mixed Content (described in <xref
target="W3C.CR-mixed-content-20160802" format="default"/>)
while still providing protection against passive attacks.</t>


<t>Opportunistic
Security does not provide the same guarantees as using TLS with <spanx
style="verb" xml:space="preserve">https</spanx> URIs,
because it is vulnerable to active attacks, and does not change the security
context of the
connection. Normally, users will not be able to tell that it is in use (i.e.,
there will be no "lock icon").</t>


<section anchor="goals-and-non-goals" toc="default"
title="Goals and Non-goals">

<t>The immediate goal is to make the use of HTTP
more robust in the face of pervasive passive
monitoring <xref target="RFC7258" format="default"/>.</t>

<t>A secondary (but significant) goal is to provide for ease of
implementation, deployment, and
operation. This mechanism is expected to have a minimal impact upon
performance and require 
trivial administrative effort to configure.</t>

<t>Preventing active attacks
(such as man-in-the-middle attacks) is a non-goal for this specification.
Furthermore, this specification is not intended to replace or offer an alternative to <spanx style="verb" xml:space="preserve">https</spanx>, since
<spanx style="verb" xml:space="preserve">https</spanx> both prevents active
attacks and invokes a more stringent security model in most
clients.</t>

</section>

<section anchor="notational-conventions" toc="default"
title="Notational Conventions">

   <t>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in <xref target="RFC2119"/>.
</t>
</section>
</section>


<section anchor="using-http-uris-over-tls" toc="default" 
title="Using HTTP URIs over TLS">

<t>An origin server that supports the resolution of <spanx style="verb" xml:space="preserve">http</spanx> URIs can indicate support for this
specification by providing an alternative service advertisement <xref target="RFC7838" format="default"/> for a protocol
identifier that uses TLS, such as <spanx style="verb" xml:space="preserve">h2</spanx> <xref target="RFC7540" format="default"/>.  Such a protocol MUST include an explicit
indication of the scheme of the resource.  This excludes HTTP/1.1; HTTP/1.1 clients are forbidden
from including the absolute form of a URI in requests to origin servers (see Section 5.3.1 of
<xref target="RFC7230" format="default"/>).</t>

<t>A client that receives such an advertisement MAY make future requests intended for the associated
origin <xref target="RFC6454" format="default"/> to the identified service (as specified by <xref target="RFC7838" format="default"/>), provided that the
alternative service opts in as described in <xref target="opt-in"
format="default"/>.</t>

<t>A client that places the importance of protection against passive attacks over performance might
choose to withhold requests until an encrypted connection is available. However, if such a
connection cannot be successfully established, the client can resume its use of the cleartext
connection.</t>

<t>A client can also explicitly probe for an alternative service advertisement by sending a request
that bears little or no sensitive information, such as one with the OPTIONS method. Likewise,
clients with existing alternative services information could make such a request before they
expire, in order minimize the delays that might be incurred.</t>

<t>Client certificates are not meaningful for URLs with the <spanx
style="verb" xml:space="preserve">http</spanx> scheme; therefore, clients
creating new TLS connections to alternative services for the purposes of this specification MUST
NOT present them. A server that also provides <spanx style="verb" xml:space="preserve">https</spanx> resources on the same port can request a
certificate during the TLS handshake, but it MUST NOT abort the handshake if the client does not
provide one.</t>

<section anchor="opt-in" toc="default" 
title="Alternative Server Opt-In">

<t>For various reasons, it is possible that the server might become confused about whether
requests' URLs have an <spanx style="verb" xml:space="preserve">http</spanx>
or <spanx style="verb" xml:space="preserve">https</spanx> scheme (see <xref
target="confuse" format="default"/>). To ensure that the
alternative service has opted into serving <spanx style="verb"
xml:space="preserve">http</spanx> URLs over TLS, clients are required to
perform additional checks before
directing <spanx style="verb" xml:space="preserve">http</spanx> requests to
it.</t>

<t>Clients MUST NOT send <spanx style="verb" xml:space="preserve">http</spanx> requests over a secured connection, unless the chosen alternative
service presents a certificate that is valid for the origin as defined in <xref target="RFC2818" format="default"/>.  Using an
authenticated alternative service establishes "reasonable assurances" for the purposes of
<xref target="RFC7838" format="default"/>.  In addition to authenticating the
server, the client MUST have obtained a valid
"http-opportunistic" response for an origin (as per <xref target="well-known"/>)
using the authenticated
connection.  An exception to the latter restriction is made for requests for the
"http-opportunistic" well-known URI.</t>

<t>For example, assuming the following request is made over a TLS connection that is successfully
authenticated for those origins, the following request/response pair would allow requests for the
origins "http://www.example.com" or "http://example.com" to be sent using a
secured connection:</t>

<figure suppress-title="false" align="left" alt=""
width="" height=""><artwork type="example" xml:space="preserve" name=""
align="left" alt="" width="" height=""><![CDATA[
HEADERS
  + END_STREAM
  + END_HEADERS
    :method = GET
    :scheme = http
    :authority = example.com
    :path = /.well-known/http-opportunistic

HEADERS
    :status = 200
    content-type = application/json
DATA
  + END_STREAM
[ "http://www.example.com", "http://example.com" ]
]]></artwork></figure>

<t>This document describes multiple origins, but only for
operational convenience.  


Only
a request made to an origin (over an authenticated connection) can be used to
acquire the "http-opportunistic"
resource for that origin.  
  Thus, in the example, the request to "http://example.com" cannot be
  assumed to also provide a representation of the "http-opportunistic"
  resource for "http://www.example.com".
</t></section>


<section anchor="interaction-with-https-uris" toc="default" 
title="Interaction with &quot;https&quot; URIs">

<t>Clients MUST NOT send <spanx style="verb" xml:space="preserve">http</spanx>
and <spanx style="verb" xml:space="preserve">https</spanx> requests
on the same connection.  Similarly,
clients MUST NOT send <spanx style="verb" xml:space="preserve">http</spanx>
requests for multiple origins on the same connection.</t></section>

<section anchor="well-known" toc="default" 
title="The &quot;http-opportunistic&quot; Well-Known URI">

<t>This specification defines the "http-opportunistic" well-known URI <xref target="RFC5785" format="default"/>. A client is said to
have a valid "http-opportunistic" response for a given origin when:</t>

<t><list style="symbols">

<t>The client has requested the well-known URI from the origin over an authenticated connection
and a 200 (OK) response was provided, </t>



<t>That response is fresh <xref target="RFC7234" format="default"/>
(potentially through revalidation
 <xref target="RFC7232" format="default"/>),
</t>

<t>That response has the media type "application/json",</t>

<t>That response's payload, when parsed as JSON <xref target="RFC7159"
format="default"/>, contains an array as the root, and</t>

<t>The array contains a string that is a case-insensitive,
character-for-character match
for the origin in question, serialized into Unicode as per Section 6.1 of
<xref target="RFC6454" format="default"/>.</t></list></t>

<t>A client MAY treat an "http-opportunistic" resource as invalid if values it contains are not
strings.</t>

<t>This document does not define semantics for
"http-opportunistic" resources on an <spanx style="verb"
xml:space="preserve">https</spanx> origin,
nor does it define semantics if the resource includes <spanx style="verb"
xml:space="preserve">https</spanx> origins.</t>

<t>Allowing clients to cache
the "http-opportunistic" resource means that all alternative services
need to be able to respond to requests for <spanx style="verb"
xml:space="preserve">http</spanx> resources.  A client is permitted to use an
alternative service without acquiring the "http-opportunistic" resource from
that service.</t>

<t>A client MUST NOT use any cached copies of an
"http-opportunistic" resource that was acquired (or
revalidated) over an unauthenticated connection.  To avoid potential errors, a client can
request or revalidate the "http-opportunistic" resource before using any connection to an
alternative service.</t>

<t>Clients that use cached "http-opportunistic" responses MUST ensure that their cache is cleared of
any responses that were acquired over an unauthenticated connection.  Revalidating an
unauthenticated response using an authenticated connection does not ensure the integrity of the
response.</t></section></section>


<section anchor="iana-considerations" toc="default" 
title="IANA Considerations">

<t>This
specification registers the following well-known URI <xref target="RFC5785"
format="default"/>:</t>

<t><list style="symbols">
<t>URI Suffix: http-opportunistic</t>

<t>Change Controller: IETF</t>

<t>Specification Document(s): <xref target="well-known" format="default"/> of RFC 8164
</t>

<t>Related Information:</t></list></t></section>

<section anchor="security" toc="default" 
title="Security Considerations">

<section anchor="security-indicators" toc="default" 
title="Security Indicators">

<t>User agents MUST NOT provide any special security indicators when an <spanx style="verb" xml:space="preserve">http</spanx> resource is acquired
using TLS. In particular, indicators that might suggest the same level of security as <spanx style="verb" xml:space="preserve">https</spanx> MUST
NOT be used (e.g., a "lock device").</t></section>

<section anchor="downgrade" toc="default" 
title="Downgrade Attacks">

<t>A downgrade attack against the negotiation for TLS is possible.</t>

<t>For example, because the <spanx style="verb" xml:space="preserve">Alt-Svc</spanx> header field <xref target="RFC7838" format="default"/> likely appears in an unauthenticated
and unencrypted channel, it is subject to downgrade by network attackers. In its simplest form, an
attacker that wants the connection to remain in the clear need only strip the <spanx style="verb" xml:space="preserve">Alt-Svc</spanx> header
field from responses.</t></section>

<section anchor="privacy" toc="default" 
title="Privacy Considerations">

<t>Cached alternative services can be used to track clients over time, e.g.,
using a user-specific hostname. Clearing the cache reduces the ability of
servers to track clients; therefore, clients MUST clear cached alternative
service information when clearing other origin-based state (i.e.,
cookies).</t></section>

<section anchor="confuse" toc="default" 
title="Confusion regarding Request Scheme">

<t>HTTP implementations and applications sometimes use ambient signals to
determine if a request is for an <spanx style="verb"
xml:space="preserve">https</spanx> resource; for example, they might look for
TLS on the stack or a server port number of 443.</t>

<t>This might be due to expected limitations in the protocol (the most common HTTP/1.1 request form
does not carry an explicit indication of the URI scheme, and the resource might have been developed
assuming HTTP/1.1), or it may be because of how the server and application are
implemented (often, they are two separate entities, with a variety of possible
interfaces between them).</t>

<t>Any security decisions based upon this information could be misled by the
deployment of this specification, because it violates the assumption that the
use of TLS (or port 443) means that the client is accessing an HTTPS URI and
operating in the security context implied by HTTPS.</t>

<t>Therefore, server implementers and administrators need to carefully examine
the use of such signals before deploying this specification.</t></section>


<section anchor="server-controls" toc="default" 
title="Server Controls">

<t>This specification requires that a server send both an alternative service
advertisement and host
content in a well-known location to send HTTP requests over TLS. Servers
SHOULD take suitable
measures to ensure that the content of the well-known resource remains under
their control.
Likewise, because the "Alt-Svc" header field is used to describe policies
across an entire origin,
servers SHOULD NOT permit user content to set or modify the value of this
header.

</t>

</section>
</section>

</middle>

<back>

<references title="Normative References">

<?rfc include="reference.RFC.2119"?>
<?rfc include="reference.RFC.2818"?>
<?rfc include="reference.RFC.5246"?>
<?rfc include="reference.RFC.5785"?>
<?rfc include="reference.RFC.6454"?>
<?rfc include="reference.RFC.7159"?>
<?rfc include="reference.RFC.7230"?>
<?rfc include="reference.RFC.7232"?>
<?rfc include="reference.RFC.7234"?>
<?rfc include="reference.RFC.7540"?>
<?rfc include="reference.RFC.7838"?>

</references>

<references title="Informative References">

<?rfc include="reference.RFC.7258"?>
<?rfc include="reference.RFC.7435"?>


<reference anchor="W3C.CR-mixed-content-20160802"
	   target="https://www.w3.org/TR/2016/CR-mixed-content-20160802">

<front>
<title>Mixed Content</title>
<author initials="M." surname="West" fullname="Mike
West"><organization/></author>

<date month="August" day="2" year="2016"/>
</front>
<seriesInfo name="World Wide Web Consortium CR" value="CR-mixed-content-20160802"/>
<format type="HTML"
	target="https://www.w3.org/TR/2016/CR-mixed-content-20160802"/>
</reference>

</references>

<section anchor="acknowledgements" toc="default" title="Acknowledgements" numbered="no">

<t>Mike Bishop contributed significant text to this document.</t>

<t>Thanks to Patrick McManus, Stefan Eissing, Eliot Lear, Stephen Farrell, Guy
Podjarny, Stephen Ludin, Erik Nygren, Paul Hoffman, Adam Langley, Eric
Rescorla, Julian Reschke, Kari Hurtta, and Richard Barnes for their feedback
and suggestions.</t></section>

</back>


</rfc>
