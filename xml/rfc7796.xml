<?xml version="1.0" encoding="US-ASCII"?>

<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [

<!ENTITY RFC2119 SYSTEM "reference.RFC.2119.xml">
<!ENTITY RFC4447 SYSTEM "reference.RFC.4447.xml">
<!ENTITY RFC4448 SYSTEM "reference.RFC.4448.xml">
<!ENTITY RFC4761 SYSTEM "reference.RFC.4761.xml">
<!ENTITY RFC4762 SYSTEM "reference.RFC.4762.xml">
<!ENTITY RFC5036 SYSTEM "reference.RFC.5036.xml">
<!ENTITY RFC3985 SYSTEM "reference.RFC.3985.xml">
<!ENTITY RFC4664 SYSTEM "reference.RFC.4664.xml">
<!ENTITY RFC6136 SYSTEM "reference.RFC.6136.xml">
<!ENTITY RFC6246 SYSTEM "reference.RFC.6246.xml">
<!ENTITY RFC7041 SYSTEM "reference.RFC.7041.xml">
<!ENTITY RFC7152 SYSTEM "reference.RFC.7152.xml">
<!ENTITY RFC7387 SYSTEM "reference.RFC.7387.xml">

]>
<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>

<?rfc strict="yes" ?>
<?rfc toc="yes"?>
<?rfc tocdepth="4"?>
<?rfc symrefs="yes"?>
<?rfc sortrefs="yes" ?>
<?rfc compact="yes" ?>
<?rfc subcompact="no" ?>

<rfc number="7796" category="std" consensus="yes" ipr="trust200902" submissionType="IETF">

  <front>

    <title abbrev="E-Tree Support in VPLS">Ethernet-Tree (E-Tree) Support in
    Virtual Private LAN Service (VPLS)</title>

    <author fullname="Yuanlong Jiang" initials="Y." role="editor"
            surname="Jiang">
      <organization>Huawei</organization>

      <address>
        <postal>
          <street>Bantian, Longgang district</street>

          <city>Shenzhen</city>

          <region/>

          <code>518129</code>

          <country>China</country>
        </postal>

        <email>jiangyuanlong@huawei.com</email>

      </address>
    </author>

    <author fullname="Lucy Yong" initials="L." surname="Yong">
      <organization>Huawei</organization>

      <address>
        <postal>
          <street>207 Estrella Xing</street>

          <city>Georgetown</city>

          <region>TX</region>

          <code>78628</code>

          <country>United States</country>
        </postal>

        <email>lucyyong@huawei.com</email>

      </address>
    </author>

    <author fullname="Manuel Paul" initials="M." surname="Paul">
      <organization>Deutsche Telekom</organization>

      <address>
        <postal>
          <street>Winterfeldtstrasse 21</street>

          <city>Berlin</city>

          <region/>

          <code>10781</code>

          <country>Germany</country>
        </postal>

        <email>manuel.paul@telekom.de</email>


      </address>
    </author>

    <date month="March" year="2016"/>

    <area>Routing Area</area>

    <workgroup>Network Working Group</workgroup>

    <keyword>Etree</keyword>

    <abstract>
      <t>This document specifies a generic Virtual Private LAN Service (VPLS)
      solution, which uses VLANs to indicate root or leaf traffic to support
      Ethernet-Tree (E-Tree) services. A VPLS Provider Edge (PE) model is
      illustrated as an example for the solution. In the solution, E-Tree VPLS
      PEs are interconnected by Pseudowires (PWs), which carry the VLAN
      indicating the E-Tree attribute. The MAC address-based Ethernet
      forwarding engine and the PW work in the same way as specified in RFC
      4762 and RFC 4448, respectively. A signaling mechanism is described to
      support E-Tree capability and VLAN mapping negotiation.</t>
    </abstract>
  </front>

  <middle>

    <section title="Introduction">
      <t/>

      <t>The Ethernet-Tree (E-Tree) service is defined in the Metro Ethernet Forum
      (MEF) Technical Specification MEF 6.2 <xref target="MEF6.2"/> as a Rooted-Multipoint
      Ethernet Virtual Connection (EVC) service. An MEF 6.2 E-Tree solution
      must meet the following design requirements: the Ethernet frames from a
      root may be received by any other root or leaf, and the frames from a
      leaf may be received by any root, but must not be received by a leaf.
      Further, an E-Tree service may include multiple roots and multiple
      leaves. Although Virtual Private Multicast Service (VPMS) <xref
      target="VPMS"/> and Point-to-Multipoint
      (P2MP) multicast are somewhat simplified versions of this service, in
      fact, they are both multicast services and are different from an E-Tree
      service that may include both unicast and multicast traffic.</t>

      <t><xref target="RFC7152"/> gives the requirements for providing E-Tree
      solutions in the VPLS and the need to filter leaf-to-leaf traffic. <xref
      target="RFC7387"/> further describes a Multiprotocol Label Switching
      (MPLS) framework for providing E-Tree. Though there were proposals for
      using the Pseudowire (PW) control word or PWs to indicate the root/leaf
      attribute of an E-Tree frame, both methods are limited in that they are
      only applicable to "VPLS only" networks.</t>

      <t>A VPLS PE usually consists of a bridge module itself (see <xref
      target="RFC4664"/> and <xref target="RFC6246"/>); and moreover, E-Tree
      services may cross both Ethernet and VPLS domains. Therefore, it is
      necessary to develop an E-Tree solution both for "VPLS only" scenarios
      and for interworking between Ethernet and VPLS.</t>

      <t>IEEE 802.1 has incorporated the generic E-Tree solution into 802.1Q
      <xref target="IEEE-802.1Q-2014" />, which is an improvement on the traditional asymmetric
      VLAN mechanism. In the asymmetric VLAN mechanism as described in Section
      B.1.3 of IEEE 802.1Q <xref target="IEEE-802.1Q-2003"/>, a VLAN ID is used to indicate
      the traffic from a server, and multiple VLAN IDs are used to indicate
      the traffic from the clients (one VLAN ID per client). In the new IEEE
      802.1Q solution, only two VLANs are used to indicate root/leaf
      attributes of a frame: one VLAN ID is used to indicate the frames
      originated from the roots and another VLAN ID is used to indicate the
      frames originated from the leaves. At a leaf port, the bridge can then
      filter out all the frames from other leaf ports based on the VLAN ID. It
      is better to reuse the same mechanism in VPLS than to develop a new
      mechanism. A new mechanism would introduce more complexity to interwork
      with the new IEEE 802.1Q solution.</t>

      <t>This document specifies how the Ethernet VLAN solution can be used to
      support generic E-Tree services in VPLS. The solution specified here is
      fully compatible with the IEEE bridge architecture and with IETF Pseudowire Emulation Edge-to-Edge (PWE3) technology, thus it will not change
      the FIB (such as installing E-Tree attributes in the FIB) or need any
      specially tailored implementation. Furthermore, VPLS scalability and
      simplicity are also maintained. With this mechanism, it is also
      convenient to deploy a converged E-Tree service across both Ethernet and
      MPLS networks.</t>

      <t>A typical VPLS PE model is introduced as an example; the model is
      then extended in which a Tree VSI is connected to a VLAN bridge with a
      dual-VLAN interface.</t>

      <t>This document then discusses the PW encapsulation and PW processing
      such as VLAN mapping options for transporting E-Tree services in
      VPLS.</t>

      <t>Finally, this document describes the signaling extensions and
      processing procedures for E-Tree support in VPLS.</t>
    </section>
    <section title="Conventions Used in This Document">
      <t>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
      "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
      document are to be interpreted as described in <xref
      target="RFC2119"/>.</t>
    </section>

    <section title="Terminology">
      <t><list style="hanging">
          <t hangText="AC:">Attachment Circuit</t>

          <t hangText="B-VLAN:">Backbone VLAN</t>

          <t hangText="C-VLAN:">Customer VLAN</t>

          <t hangText="E-Tree:">Ethernet Tree, a Rooted-Multipoint EVC service
          as defined in <xref target="MEF6.2" /></t>

          <t hangText="EVC:">Ethernet Virtual Connection, as defined in
          <xref target="MEF4"/></t>

          <t hangText="FIB:">Forwarding Information Base, also known as
          "forwarding table"</t>

          <t hangText="I-SID:">Backbone Service Instance Identifier, as
          defined in IEEE 802.1ah <xref target="IEEE-802.1Q-2014" /></t>

          <t hangText="Leaf AC:">An AC attached with a leaf</t>

          <t hangText="Leaf VLAN:">A VLAN Identifier (ID) used to indicate all
          the frames that are originated at a leaf AC. It may be a C-VLAN, an
          S-VLAN, or a B-VLAN</t>

          <t hangText="OAM:">Operations, Administration, and Maintenance</t>

          <t hangText="PBB:">Provider Backbone Bridge</t>

          <t hangText="PE:">Provider Edge</t>

          <t hangText="PW:">Pseudowire</t>

          <t hangText="Root AC:">An AC attached with a root</t>

          <t hangText="Root VLAN:">A VLAN ID used to indicate all the frames
          that are originated at a root AC. It may be a C-VLAN, an S-VLAN, or a
          B-VLAN</t>

          <t hangText="S-VLAN:">Service VLAN</t>

          <t hangText="T-VSI:">Tree VSI, a VSI with E-Tree support</t>

          <t hangText="VLAN:">Virtual Local Area Network</t>

          <t hangText="VPLS:">Virtual Private LAN Service</t>

          <t hangText="VSI:">Virtual Switching Instance as defined in <xref
          target="RFC4664"/>, also known as "VPLS Forwarder" in <xref
          target="RFC7041"/></t>
        </list></t>
    </section>

    <section title="PE Model with E-Tree Support">
      <t>The problem scenario of E-Tree as shown in Figure 1 of <xref
      target="RFC7152"/> is a simplification of the L2VPN architecture.
      Several common VPLS PE architectures are discussed in more detail in
      <xref target="RFC4664"/> and <xref target="RFC6246"/>.</t>

      <t>Below, an E-Tree solution in VPLS is demonstrated with the help of a
      typical VPLS PE model. Its use in other PE models is discussed in
      Appendix A.</t>

      <section title="Existing PE Models">
        <t>According to <xref target="RFC4664"/>, there are at least three
        models possible for a VPLS PE, including: <list style="symbols">
            <t>A single bridge module, a single VSI;</t>

            <t>A single bridge module, multiple VSIs;</t>

            <t>Multiple bridge modules, each attaches to a VSI.</t>
          </list></t>

        <t/>

       <t> The second PE model is commonly used. A typical example is further
        depicted in <xref target="bridge"/> and <xref target="vpls"/> (both figures are extracted from <xref
        target="RFC6246"/>), where an S-VLAN bridge module is connected to
        multiple VSIs each with a single VLAN virtual interface.</t>

<figure anchor="bridge" title="A Model of 802.1ad Bridge Module">

  <artwork name="A model of 802.1ad Bridge Module">
                   +-------------------------------+ 
                   |  802.1ad Bridge Module Model  |  
                   |                               | 
        +---+  AC  |  +------+      +-----------+  | 
        |CE |---------|C-VLAN|------|           |  | 
        +---+      |  |bridge|------|           |  | 
                   |  +------+      |           |  | 
                   |     o          |   S-VLAN  |  | 
                   |     o          |           |  | ---&gt; to VSI 
                   |     o          |   Bridge  |  | 
        +---+  AC  |  +------+      |           |  | 
        |CE |---------|C-VLAN|------|           |  | 
        +---+      |  |bridge|------|           |  | 
                   |  +------+      +-----------+  | 
                   +-------------------------------+ 
           </artwork>
        </figure>

        <t/>

        <t/>

        <figure anchor="vpls" title="A VPLS-Capable PE Model">
          <artwork name="A VPLS-capable PE Model">        +----------------------------------------+ 
        |           VPLS-Capable PE Model        | 
        |   +---------------+          +------+  |   
        |   |               |          |VSI-1 |------------ 
        |   |               |==========|      |------------ PWs 
        |   |     Bridge    ------------      |------------ 
        |   |               | S-VLAN-1 +------+  | 
        |   |     Module    |             o      | 
        |   |               |             o      | 
        |   |   (802.1ad    |             o      | 
        |   |    bridge)    |             o      | 
        |   |               |             o      | 
        |   |               | S-VLAN-n +------+  | 
        |   |               ------------VSI-n |------------- 
        |   |               |==========|      |------------- PWs 
        |   |               |     ^    |      |------------- 
        |   +---------------+     |    +------+  | 
        |                         |              | 
        +-------------------------|--------------+ 
                         LAN Emulation Interface
 
          </artwork>
        </figure>

        <t>In this PE model, Ethernet frames from Customer Edges (CEs) will
        cross multiple stages of bridge modules (i.e., C-VLAN and S-VLAN
        bridge), and a VSI in a PE before being sent on the PW to a remote PE.
        Therefore, the association between an AC port and a PW on a VSI is
        difficult.</t>

        <t>This model could be further enhanced: when Ethernet frames arrive
        at an ingress PE, a root VLAN or a leaf VLAN tag is added. At an
        egress PE, the frames with the root VLAN tag are transmitted both to
        the roots and the leaves, while the frames with the leaf VLAN tag are
        transmitted to the roots but dropped for the leaves (these VLAN tags
        are removed before the frames are transmitted over the ACs). It was
        demonstrated in <xref target="IEEE-802.1Q-2014"/> that the E-Tree service in Ethernet
        networks can be well supported with this mechanism.</t>

        <t>Assuming this mechanism is implemented in the bridge module, it is
        quite straightforward to infer a VPLS PE model with two VSIs to
        support the E-Tree (as shown in <xref target="vsis"/>). But this model will require
        two VSIs per PE and two sets of PWs per E-Tree service, which is
        poorly scalable in a large MPLS/VPLS network; in addition, both of these
        VSIs have to share their learned MAC addresses.</t>

        <figure anchor="vsis" title="A VPLS PE Model for E-Tree with 2VSIs">
          <artwork name="A VPLS PE Model for E-Tree with 2 VSIs">        +----------------------------------------+ 
        |           VPLS-Capable PE Model        | 
        |   +---------------+          +------+  |   
        |   |               |          |VSI-1 |------------ 
        |   |               |==========|      |------------ PWs 
        |   |     Bridge    ------------      |------------ 
        |   |               | Root     +------+  | 
        |   |     Module    | S-VLAN             | 
        |   |               |                    | 
        |   |   (802.1ad    |                    | 
        |   |    bridge)    |                    | 
        |   |               | Leaf               | 
        |   |               | S-VLAN   +------+  | 
        |   |               ------------VSI-2 |------------- 
        |   |               |==========|      |------------- PWs 
        |   |               |     ^    |      |------------- 
        |   +---------------+     |    +------+  | 
        |                         |              | 
        +-------------------------|--------------+ 
                         LAN Emulation Interface 

            </artwork>
        </figure>
      </section>

      <section title="A New PE Model with E-Tree Support">
        <t>In order to support the E-Tree in a more scalable way, a new VPLS
        PE model with a single Tree VSI (T-VSI, a VSI with E-Tree support) is
        specified. As depicted in <xref target="tvsi"/>, the bridge module is connected to
        the T-VSI with a dual-VLAN virtual interface, i.e., both the root VLAN
        and the leaf VLAN are connected to the same T-VSI, and they share the
        same FIB and work in shared VLAN learning. In this way, only one VPLS
        instance and one set of PWs is needed per E-Tree service, and the
        scalability of VPLS is improved.</t>

        <figure anchor="tvsi" title="A VPLS PE Model for E-Tree with a Single T-VSI">
          <artwork name="A VPLS PE Model for E-Tree with a Single T-VSI">         +----------------------------------------+ 
         |           VPLS-Capable PE Model        | 
         |   +---------------+          +------+  |   
         |   |               |==========|TVSI-1|------------ 
+---+ AC |   |               ------------      |------------ PWs 
|CE |--------|     Bridge    ------------      |------------ 
+---+    |   |               | Root &amp;   +------+  | 
         |   |     Module    | Leaf VLAN   o      | 
         |   |               |             o      | 
         |   |               |             o      | 
         |   |               |             o      | 
         |   |               |             o      | 
+---+ AC |   |               |   VLAN-n +------+  | 
|CE |--------|               ------------VSI-n |------------- 
+---+    |   |               |==========|      |------------- PWs 
         |   |               |     ^    |      |------------- 
         |   +---------------+     |    +------+  | 
         |                         |              | 
         +-------------------------|--------------+ 
                         LAN Emulation Interface 
</artwork>
        </figure>

        <t>For an untagged AC port (frames over this port are untagged) or
        a VLAN unaware port (VLAN tags in the frames are ignored), where the
        bridge module is a C-VLAN bridge, the Ethernet frames received from
        the root ACs MUST be tagged with a root C-VLAN. When the bridge module
        is an 802.1ad bridge <xref target="IEEE-802.1Q-2014" />, the Ethernet frames received from the root ACs
        MUST be tagged with a root S-VLAN. Note, this can be done by adding a
        root C-VLAN first in a C-VLAN bridge, but this is out of the scope of
        this document.</t>

        <t>For a C-VLAN tagged port, the Ethernet frames received from the
        root ACs MUST be tagged with a root S-VLAN.</t>

        <t>For an S-VLAN tagged port, the S-VLAN tag in the Ethernet frames
        received from the root ACs SHOULD be translated to the root S-VLAN in
        the VPLS network domain.</t>

        <t>Alternatively, for an S-VLAN tagged port, the PBB VPLS PE model
        (where an IEEE 802.1ah bridge module is embedded in the PE) as
        described in <xref target="RFC7041"/> MAY be used. A root B-VLAN or
        a leaf B-VLAN MAY be added. The E-Tree attribute may also be indicated
        with two I-SID tags in the bridge module, and the frames are then
        encapsulated and transported transparently over a single B-VLAN. Thus,
        the PBB VPLS works in the same way as described in <xref
        target="RFC7041"/> and will not be discussed further in this document.
        When many S-VLANs are multiplexed in a single AC, PBB VPLS has the
        advantages of both VLAN scalability and MAC address scalability.</t>

        <t>In a similar way, the traffic from the leaf ACs is tagged and
        transported on the leaf C-VLAN, S-VLAN, or B-VLAN.</t>

        <t>In all cases, the outermost VLAN in the resulting Ethernet header
        is used to indicate the E-Tree attribute of an Ethernet frame; this
        document uses VLAN to refer to this outermost VLAN for simplicity in
        the latter sections.</t>
      </section>
    </section>

    <section title="PW for E-Tree Support">
      <section title="PW Encapsulation">
        <t>To support an E-Tree service, T-VSIs in a VPLS MUST be
        interconnected with a bidirectional Ethernet PW. The Ethernet PW
        SHOULD work in the tagged mode (PW type 0x0004) as described in <xref
        target="RFC4448"/>, in which case a VLAN tag MUST be carried in each
        frame in the PW to indicate the frame originated from either root or
        leaf (the VLAN tag indicating the frame originated from either root or
        leaf can be translated by a bridge module in the PE or added by an
        outside Ethernet edge device, even by a customer device). In the
        tagged PW mode, two service-delimiting VLANs MUST be allocated in the
        VPLS domain for an E-Tree. PW processing for the tagged PW will be
        described in <xref target="pwprocess" /> of this document.</t>

        <t>A raw mode PW (PW type 0x0005 in <xref target="RFC4448"/>) MAY also
        be used to carry an E-Tree service for a PW in Compatible mode as shown
        in <xref target="pwcomp" />. As defined in <xref target="RFC4448"/>, for a raw
        mode PW, an Ethernet frame's 802.1Q VLAN tag is not meaningful
        to the PEs and it passes transparently through them.</t>

        <t/>
      </section>

      <section title="VLAN Mapping" anchor="VLAN">
        <t>There are two ways of manipulating VLANs for an E-Tree in
        VPLS:<list style="symbols">
            <t>Global VLAN based, that is, provisioning two global VLANs (Root
            VLAN and Leaf VLAN) across the VPLS network, thus no VLAN mapping is
            needed at all, or the VLAN mapping is done completely in the
            Ethernet domains.</t>

            <t>Local VLAN based, that is, provisioning two local VLANs for
            each PE (that participates in the E-Tree) in the VPLS network
            independently.</t>
          </list></t>

        <t>The first method requires no VLAN mapping in the PW, but two unique
        service-delimiting VLANs must be allocated across the VPLS domain.</t>

        <t>The second method is more scalable in the use of VLANs, but needs a
        VLAN mapping mechanism in the PW similar to what is already described
        in Section 4.3 of <xref target="RFC4448"/>.</t>

        <t>Global or local VLANs can be manually configured or provisioned by
        an Operational Support System. Alternatively, some automatic VLAN
        allocation algorithm may be provided in the management plane, but it
        is out of scope of this document.</t>

        <t>For both methods, VLAN mapping parameters from a remote PE can be
        provisioned or determined by a signaling protocol as described in
        <xref target="Signal"/> when a PW is being established.</t>
      </section>


      <?rfc needLines="8" ?>

      <section title="PW Processing" anchor="pwprocess">
        <section title="PW Processing in the VLAN Mapping Mode" anchor="pwvlan">
          <t>In the VLAN mapping mode, two VPLS PEs with E-Tree capability are
          inter-connected with a PW (for example, the scenario of <xref
	  target="normal"/> depicts the interconnection of two PEs attached with both root and
          leaf nodes).</t>

          <figure anchor="normal" title="T-VSI Interconnected in the Normal Mode">
            <artwork name="T-VSI Interconnected in the Normal Mode">               +----------------------------+           
               |  VPLS PE with T-VSI        |           
               |                            |           
     +----+    | +------+ Root VLAN +-----+ |    PW     
     |Root|------| VLAN |-----------|T-VSI|----------   
     +----+    | | BRG  | Leaf VLAN |     |----------   
     +----+    | |      |-----------|     |----------   
     |Leaf|------|      |           |     |-----+       
     +----+    | +------+           +-----+ |   |       
               |                            |   |       
               +----------------------------+   |       
                                                |       
               +----------------------------+   |       
               |  VPLS PE with T-VSI        |   |       
               |                            |   |       
     +----+    | +------+ Root VLAN +-----+ |   | PW    
     |Root|------| VLAN |-----------|T-VSI|-----+       
     +----+    | | BRG  | Leaf VLAN |     |----------   
     +----+    | |      |-----------|     |----------   
     |Leaf|------|      |           |     |----------   
     +----+    | +------+           +-----+ |           
               |                            |  BRG: Bridge Module  
               +----------------------------+           
             </artwork>
          </figure>

          <t>If a PE is in the VLAN mapping mode for a PW, then in the data
          plane, the PE MUST map the VLAN in each frame as follows:</t>

          <t><list style="symbols">
              <t>Upon transmitting frames on the PW, map from the local VLAN to
              the remote VLAN (i.e., the local leaf VLAN in a frame is translated
              to the remote leaf VLAN; the local root VLAN in a frame is
              translated to the remote root VLAN).</t>

              <t>Upon receiving frames on the PW, map from the remote VLAN to
              the local VLAN, and the frames are further forwarded or dropped in
              the egress bridge module using the filtering mechanism as
              described in <xref target="IEEE-802.1Q-2014" />.</t>
            </list></t>

          <t>The signaling for VLANs used by E-Tree is specified in <xref
	  target="Signal" />.</t>
        </section>

        <section title="PW Processing in the Compatible Mode" anchor="pwcomp">
          <t>The new VPLS PE model can work in a traditional VPLS network
          seamlessly in the compatibility mode. As shown in <xref target="tradition"/>, the VPLS
          PE with T-VSI can be attached with root and/or leaf nodes, while the
          VPLS PE with a traditional VSI can only be attached with root nodes.
          A raw PW SHOULD be used to connect them.</t>

          <figure anchor="tradition" title="T-VSI Interconnected with
	    Traditional VSI">
            <artwork name="T-VSI Interconnected with Traditional VSI">
               +------------------------+ 
               |  VPLS PE with T-VSI    |  
               |                        | 
     +----+    | +------+       +-----+ |  PW
     |Root|------| VLAN |-------|T-VSI|----------
     +----+    | | BRG  |       |     |----------
     +----+    | |      |-------|     |----------
     |Leaf|------|      |       |     |---------+
     +----+    | +------+       +-----+ |       |
               |                        |       |
               +------------------------+       |
                                                |
               +------------------------+       |
               |  VPLS PE with VSI      |       |
               |                        |       |
     +----+    | +------+       +-----+ |  PW   |
     |Root|------| VLAN |-------|VSI  |---------+
     +----+    | | BRG  |       |     |----------
     +----+    | |      |       |     |----------
     |Root|------|      |       |     |----------
     +----+    | +------+       +-----+ |
               |                        |
               +------------------------+
</artwork>
          </figure>

          <t>If a PE is in the Compatible mode for a PW, then in the data
          plane, the PE MUST process the frame as follows:</t>

          <t><list style="symbols">
              <t>Upon transmitting frames on the PW, remove the root or leaf
              VLAN in the frames.</t>

              <t>Upon receiving frames on the PW, add a VLAN tag with a value
              of the local root VLAN to the frames.</t>
            </list></t>
        </section>

        <section title="PW Processing in the Optimized Mode" anchor="pwoptimized">
          <t>When two PEs (both with E-Tree capability) are inter-connected
          with a PW and one of them (e.g., PE2) is attached with only leaf
          nodes, as shown in the scenario of <xref target="leaf"/>, its peer PE (e.g., PE1)
          should then work in the Optimized mode for this PW. In this case,
          PE1 should not send the frames originated from the local leaf VLAN
          to PE2, i.e., these frames are dropped rather than transported over
          the PW. The bandwidth efficiency of the VPLS can thus be improved.
          The signaling for the PE attached with only leaf nodes is specified
          in <xref target="Signal" />.</t>

          <figure anchor="leaf" title="T-VSI Interconnected with PE Attached
	    with Only Leaf Nodes">
            <artwork name="T-VSI interconnected with PE attached with only leaf nodes">               +------------------------+ 
               |VPLS PE with T-VSI (PE1)|  
               |                        | 
     +----+    | +------+       +-----+ |  PW
     |Root|------| VLAN |-------|T-VSI|----------
     +----+    | | BRG  |       |     |----------
     +----+    | |      |-------|     |----------
     |Leaf|------|      |       |     |---------+
     +----+    | +------+       +-----+ |       |
               |                        |       |
               +------------------------+       |
                                                |
               +------------------------+       |
               |VPLS PE with T-VSI (PE2)|       |
               |                        |       |
     +----+    | +------+       +-----+ |  PW   |
     |Leaf|------| VLAN |-------|T-VSI|---------+
     +----+    | | BRG  |       |     |----------
     +----+    | |      |-------|     |----------
     |Leaf|------|      |       |     |----------
     +----+    | +------+       +-----+ |
               |                        |
               +------------------------+
</artwork>
          </figure>

          <t>If a PE is in the Optimized Mode for a PW, upon transmit, the PE
	  SHOULD drop a frame if its VLAN ID matches the local leaf VLAN ID.</t>
        </section>
      </section>
    </section>

    <section title="Signaling for E-Tree Support" anchor="Signal">
      <section title="LDP Extensions for E-Tree Support" anchor="LDP">
        <t>In addition to the signaling procedures as specified in Section
        5.3.3 of <xref target="RFC4447"/>, this document specifies a new
        interface parameter sub-TLV to provision an E-Tree service and
        negotiate the VLAN mapping function, as follows:</t>

        <figure anchor="subtlv" title="E-Tree Sub-TLV">
          <artwork name="E-Tree Sub-TLV">  0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |  E-Tree(0x1A) |   Length=8    |           Reserved        |P|V|
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |  MBZ  |   Root VLAN ID        |  MBZ  |   Leaf VLAN ID        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</artwork>
        </figure>

        <t>Where:</t>

        <t><list style="symbols">
            <t>E-Tree is the sub-TLV identifier (0x1A) as assigned by
            IANA.</t>

            <t>Length is the length of the sub-TLV in octets.</t>

            <t>Reserved, bits MUST be set to zero on transmit and be ignored
            on receive.</t>

            <t>P is a leaf-only bit, it is set to 1 to indicate that the PE is
            attached with only leaf nodes, and set to 0 otherwise.</t>

            <t>V is a bit indicating the sender's VLAN mapping
            capability. A PE capable of VLAN mapping MUST set this bit, and
            clear it otherwise.</t>

            <t>Must Be Zero (MBZ), 4 bits MUST be set to zero on transmit and
            be ignored on receive.</t>

            <t>Root VLAN ID is the value of the local root VLAN.</t>

            <t>Leaf VLAN ID is the value of the local leaf VLAN.</t>
          </list></t>

        <t>When setting up a PW for the E-Tree based VPLS, two peer PEs
        negotiate the E-Tree support using the above E-Tree sub-TLV. Note that
	the PW type of 0x0004 SHOULD be used during the PW negotiation.</t>

        <t>A PE that wishes to support an E-Tree service MUST include an E-Tree
        sub-TLV in its PW Label Mapping message and include its local root
        VLAN ID and leaf VLAN ID in the TLV. A PE that has the VLAN mapping
        capability MUST set the V bit to 1, and a PE attached with only leaf
        nodes SHOULD set the P bit to 1.</t>

        <t>A PE that receives a PW Label Mapping message with an E-Tree
        sub-TLV from its peer PE, after saving the VLAN information for the
        PW, MUST process it as follows:</t>

        <figure>
       <artwork> 
   1) For this PW, set VLAN-Mapping-Mode, Compatible-Mode, and
      Optimized-Mode to FALSE.

   2) If either the root VLAN ID in the message is not equal to the
      local root VLAN ID, or the leaf VLAN ID in the message is not 
      equal to the local leaf VLAN ID {

          If the bit V is cleared {

                If the PE is capable of VLAN mapping, it MUST set 
                VLAN-Mapping-Mode to TRUE;

                Else {

                     A Label Release message with the error code "E-
                     Tree VLAN mapping not supported" is sent to the
                     peer PE and exit the process;

                     }

          }

          If the bit V is set, and the PE is capable of VLAN mapping,
          the PE with the minimum IP address MUST set 
          VLAN-Mapping-Mode to TRUE;

      }

   3) If the P bit is set

      {

          If the PE is a leaf-only node itself, a Label Release 
          message with a status code "Leaf-to-Leaf PW released" is
          sent to the peer PE and exits the process;

          Else the PE SHOULD set the Optimized-Mode to TRUE.

      }
               
       </artwork>
        </figure>
      
        <t>A PE SHOULD send a Label Mapping message with an E-Tree sub-TLV as
        per Section 5.3.3 of <xref target="RFC4447"/>. A PE MUST send a Label Mapping message with an updated E-Tree sub-TLV to all other PEs over
        corresponding LDP sessions when its role changes from leaf-only to not
        leaf-only (i.e., when a root node is added to a PE attached with only
        leaf nodes).</t>

        <t>If a PE has sent a Label Mapping message with an E-Tree sub-TLV but
        does not receive any E-Tree sub-TLV in its peer's PW Label Mapping message, the PE SHOULD then establish a raw PW with this peer
        as in traditional VPLS and set Compatible-Mode to TRUE for this
        PW.</t>

        <t>Data plane processing for this PW is as follows:</t>
<t><list style="symbols">
        <t>If Optimized-Mode is TRUE, then data plane processing as described
        in <xref target="pwoptimized" /> applies.</t>

        <t>If VLAN-Mapping-Mode is TRUE, then data plane processing as
        described in <xref target="pwvlan" /> applies.</t>

        <t>If Compatible-Mode is TRUE, then data plane processing as
        described in <xref target="pwcomp" /> applies.</t>

        <t>PW processing as described in <xref target="RFC4448"/> proceeds as
        usual for all cases.</t>
</list></t>      
        <t>When VPLS is set up using the Pseudowire ID (PWid) Forwarding
        Equivalence Class (FEC) Element (see Appendix A of <xref
        target="RFC4762"/>), its E-Tree signaling is similar to the above
        process. Dynamic re&nbhy;configuration of E-Tree should be avoided for this
        case. However, when re-configuration of E-Tree is forced on a PE for
        some reason (e.g., a configuration error), the PE may close the LDP
        sessions with its peer PEs for this VPLS instance and re&nbhy;install its
        PW labels, so that its peer PEs can send out the LDP Label Mapping
        messages again.</t>

</section>

      <section title="BGP Extensions for E-Tree Support">
        <t>A new E-Tree extended community (0x800b) has been allocated by IANA for
        E-Tree signaling in BGP VPLS:</t>

        <figure anchor="comm" title="E-Tree Extended Community">
          <artwork name="E-Tree Extended Community">
               +------------------------------------+
               | Extended community type (2 octets) |
               +------------------------------------+
               |  MBZ  |   Root VLAN (12 bits)      |
               +------------------------------------+
               |  MBZ  |   Leaf VLAN (12 bits)      |
               +------------------------------------+
               |  Reserved                      |P|V|
               +------------------------------------+
</artwork>
        </figure>

        <t>Where:</t>

        <t><list style="symbols">
            <t>Must Be Zero (MBZ), 4 bits MUST be set to zero on transmit and
            be ignored on receive.</t>

            <t>Root VLAN ID is the value of the local root VLAN.</t>

            <t>Leaf VLAN ID is the value of the local leaf VLAN.</t>

            <t>Reserved, 14 bits MUST be set to zero on transmit and be
            ignored on receive.</t>

            <t>P is a leaf-only bit, it is set to 1 to indicate that the PE is
            attached with only leaf nodes, and set to 0 otherwise.</t>

            <t>V is a bit indicating the sender's VLAN mapping
            capability. A PE capable of VLAN mapping MUST set this bit, and
            clear it otherwise.</t>
          </list></t>

        <t>The PEs attached with both leaf and root nodes MUST support BGP
        E-Tree signaling as described in this document, and SHOULD support
        VLAN mapping in their data planes. The traditional PE attached with
        only root nodes may also participate in an E-Tree service. If some PEs
        don't support VLAN mapping, global VLANs as per <xref
	target="VLAN" /> 
	MUST be provisioned for an E-Tree service.
</t>

        <t>In BGP VPLS signaling, besides attaching a Layer2 Info Extended
        Community as detailed in <xref target="RFC4761"/>, an E-Tree Extended
        Community MUST be further attached if a PE wishes to participate in an
        E-Tree service. The PE MUST include its local root VLAN ID and leaf
        VLAN ID in the E-Tree Extended Community. A PE attached with only leaf
        nodes of an E-Tree SHOULD set the P bit in the E-Tree Extended
        Community to 1.</t>

        <t>A PE that receives a BGP UPDATE message with an E-Tree Extended
        Community from its peer PE, after saving the VLAN information for the
        PW, MUST process it as follows (after processing procedures as
        specified in Section 3.2 of <xref target="RFC4761"/>):</t>

        <figure>
          <artwork>
   1) For this PW, set VLAN-Mapping-Mode, Compatible-Mode, and
      Optimized-Mode to FALSE.

   2) If either the root VLAN ID in the E-Tree Extended Community is
      not equal to the local root VLAN ID, or the leaf VLAN ID in the
      E-Tree Extended Community is not equal to the local leaf VLAN ID {

          If the bit V is cleared {

                If the PE is capable of VLAN mapping, it MUST set VLAN-
                Mapping-Mode to TRUE;

                Else {

                     Log with a message "E-Tree VLAN mapping not
                     supported" and exit the process;

                     }

          }

          If the bit V is set, and the PE is capable of VLAN mapping,
          the PE with the minimum IP address MUST set VLAN-Mapping-Mode
          to TRUE;

      }

   3) If the P bit is set {

          If the PE is a leaf-only PE itself, forbids any traffic on the
          PW;

          Else the PE SHOULD set the Optimized-Mode to TRUE.

      }</artwork>
        </figure>

        <t>A PE that does not recognize this attribute SHALL ignore it
        silently. If a PE has sent an E-Tree Extended Community but does not
        receive any E-Tree Extended Community from its peer, the PE SHOULD
        then establish a raw PW with this peer as in traditional VPLS and set
        Compatible-Mode to TRUE for this PW.</t>

        <t>The data plane in the VPLS is the same as described in Section 4.2 of
        <xref target="RFC4761"/>, and data plane processing for a PW is the
        same as described at the end of <xref target="LDP" /> in this document.</t>
      </section>
    </section>
    <section title="OAM Considerations">
      <t>The VPLS OAM requirements and framework as specified in <xref
      target="RFC6136"/> are applicable to E-Tree, as both Ethernet OAM frames
      and data traffic are transported over the same PW.</t>

      <t>Ethernet OAM for E-Tree including both service OAM and segment OAM
      frames SHALL undergo the same VLAN mapping as the data traffic; and root
      VLAN SHOULD be applied to segment OAM frames so that they are not
      filtered.</t>
    </section>

    <section title="Applicability">
      <t>The solution specified in this document is applicable to both LDP
      VPLS <xref target="RFC4762"/> and BGP VPLS <xref target="RFC4761"/>.</t>

      <t>This solution is applicable to both "VPLS Only" networks and VPLS
      with Ethernet aggregation networks.</t>

      <t>This solution is also applicable to PBB VPLS networks.</t>
    </section>


    <?rfc needLines="8" ?>


    <!--    <section anchor="IANA" title="IANA Considerations">  -->

    <section title="IANA Considerations">
      <t>IANA allocated the following value for E-Tree in the "Pseudowire Interface
      Parameters Sub-TLV type Registry".</t>

      <figure>
        <artwork>Parameter ID   Length       Description
=======================================
0x1A            8            E-Tree
</artwork>
      </figure>

      <t>IANA allocated the two following new LDP status codes in the "Status Code Name
      Space" registry.</t>

      <figure>
        <artwork>Range/Value     E     Description                       
------------- -----   ----------------------           
0x20000003      1     E-Tree VLAN mapping not supported 
0x20000004      0     Leaf-to-Leaf PW released
</artwork>
      </figure>

      <t>IANA allocated the following value for E-tree in the "Generic
      Transitive Experimental Use Extended Community Sub-Types" registry
      within the BGP Extended Community registry.</t>

      <figure>
        <artwork>Type Value   Sub-Type Value   Name
==========   ==============   ============
0x80         0x0b             E-Tree Info
</artwork>
      </figure>
    </section>

    <!--    <section anchor="Security" title="Security Considerations"> -->

    <section title="Security Considerations">
      <t>This solution requires implementations to prevent leaf-to-leaf
      communication in the data plane of VPLS when its PEs are interconnected
      with PWs. If all PEs enforce that, then network attacks from one leaf to
      another leaf are avoided, and security can be enhanced for customers
      with this solution. However, if a PE is compromised or inappropriately
      configured, a leaf node may be taken as a root node and may receive
      traffic from other leaf nodes inappropriately. Authenticity and
      integrity measures for LDP need to be considered as in RFC 5036 <xref
      target="RFC5036"/>. Security considerations as described in <xref
      target="RFC4448"/>, <xref target="RFC4761"/>, and <xref
      target="RFC4762"/> also apply.</t>
    </section>
  </middle>

  <back>

    <references title="Normative References">

<reference anchor="IEEE-802.1Q-2014">
        <front>
          <title>Bridges and Bridged Networks</title>

          <author>
            <organization>IEEE</organization>
          </author>
          <date month="November" year="2014"/>
        </front>
<seriesInfo name="IEEE" value="802.1Q" />
<seriesInfo name="DOI" value="10.1109/ieeestd.2014.6991462" />  
    </reference>

      <reference anchor="MEF6.2">
        <front>
          <title>EVC Ethernet Services Definitions Phase 3</title>

          <author fullname="Metro Ethernet Forum">
            <organization abbrev="MEF">Metro Ethernet Forum 6.2</organization>
          </author>

          <date month="August" year="2014"/>
        </front>
      </reference>

      &RFC2119;

      &RFC4447;

      &RFC4448;

      &RFC4761;

      &RFC4762;

      &RFC5036;

       </references>

    <references title="Informative References">

      <reference anchor="IEEE-802.1Q-2003">
        <front>
          <title>Virtual Bridged Local Area Networks</title>

          <author>
            <organization>IEEE</organization>
          </author>

          <date month="May" year="2003"/>
        </front>
<seriesInfo name="IEEE" value="802.1" />
<seriesInfo name="DOI" value="10.1109/IEEESTD.2003.94280"/>
      </reference>

      <reference anchor="MEF4">
        <front>
          <title>Metro Ethernet Network Architecture Framework &ndash; Part 1:
          Generic Framework</title>

          <author fullname="Metro Ethernet Forum">
            <organization abbrev="MEF">Metro Ethernet Forum 4</organization>
          </author>

          <date month="May" year="2004"/>
        </front>
      </reference>

      &RFC3985;

      &RFC4664;

      &RFC6136;

      &RFC6246;

      &RFC7041;

      &RFC7152;

      &RFC7387;


<!-- draft-ietf-l2vpn-vpms-frmwk-requirements-05: Expired -->

<reference anchor='VPMS'>
<front>
<title>Framework and Requirements for Virtual Private Multicast Service (VPMS)</title>

<author initials='Y' surname='Kamite' fullname='Yuji Kamite'>
    <organization />
</author>

<author initials='F' surname='JOUNAY' fullname='Frederic JOUNAY'>
    <organization />
</author>

<author initials='B' surname='Niven-Jenkins' fullname='Ben Niven-Jenkins'>
    <organization />
</author>

<author initials='D' surname='Brungard' fullname='Deborah Brungard'>
    <organization />
</author>

<author initials='L' surname='Jin' fullname='Lizhong Jin'>
    <organization />
</author>

<date month='October' day='22' year='2012' />

</front>

<seriesInfo name='Work in Progress,' value='draft-ietf-l2vpn-vpms-frmwk-requirements-05' />
<format type='TXT'
        target='http://www.ietf.org/internet-drafts/draft-ietf-l2vpn-vpms-frmwk-requirements-05.txt' />
</reference>

    </references>

    <section title="Other PE Models for E-Tree">
      <section title="A PE Model with a VSI and No Bridge">
        <t>If there is no bridge module in a PE, the PE may consist of Native
        Service Processors (NSPs) as shown in <xref target="pemodel"/> (adapted from Figure 5
        of <xref target="RFC3985"/>) where any transformation operation for
        VLANs (e.g., VLAN insertion/removal or VLAN mapping) may be applied.
        Thus, a root VLAN or leaf VLAN can be added by the NSP depending on the
        User Network Interface (UNI) type (root/leaf) associated with the AC
        over which the packet arrives.</t>

        <t>Further, when a packet with a leaf VLAN exits a forwarder and
        arrives at the NSP, the NSP must drop the packet if the egress AC is
        associated with a leaf UNI.</t>

        <t>Tagged PW and VLAN mapping work in the same way as in the typical
        PE model.</t>
        <figure anchor="pemodel" title="A PE Model with a VSI and No Bridge Module">
          <artwork name="A PE Model with a VSI and No Bridge Module">
           +----------------------------------------+
           |                PE Device               |
   Multiple+----------------------------------------+
   AC      |      |          |        Single        | PW Instance
   &lt;------&gt;o  NSP #          +      PW Instance     X&lt;----------&gt;
           |      |          |                      |
           |------|  VSI     |----------------------|
           |      |          |        Single        | PW Instance
   &lt;------&gt;o  NSP #Forwarder +      PW Instance     X&lt;----------&gt;
           |      |          |                      |
           |------|          |----------------------|
           |      |          |        Single        | PW Instance
   &lt;------&gt;o  NSP #          +      PW Instance     X&lt;----------&gt;
           |      |          |                      |
           +----------------------------------------+
</artwork>
        </figure>
        <t>This PE model may be used by a Multi-Tenant Unit switch (MTU-s) in
        a Hierarchical VPLS (H-VPLS) network or a Network-facing PE (N-PE) in
        an H-VPLS network with non-bridging edge devices, wherein a spoke PW
        can be treated as an AC in this model.</t>
      </section>

      <section title="A PE Model with External E-Tree Interface">
        <figure anchor="external" title="A PE Model with External E-Tree
	  Interface">
          <artwork name="A PE Model with External E-Tree Interface"> 
          +----------------------------------------+
           |                PE Device               |
   Root    +----------------------------------------+
   VLAN    |                 |        Single        | PW Instance
   &lt;------&gt;o                 +      PW Instance     X&lt;----------&gt;
           |                 |                      |
           |       VSI       |----------------------|
           |                 |        Single        | PW Instance
           |    Forwarder    +      PW Instance     X&lt;----------&gt;
           |                 |                      |
   Leaf    |                 |----------------------|
   VLAN    |                 |        Single        | PW Instance
   &lt;------&gt;o                 +      PW Instance     X&lt;----------&gt;
           |                 |                      |
           +----------------------------------------+
</artwork>
        </figure>
        <t>A more simplified PE model is depicted in A.2, where Root/Leaf
        VLANs are directly or indirectly connected over a single PW to the same
        VSI forwarder in a PE, any transformation of E-Tree VLANs, e.g., VLAN
        insertion/removal or VLAN mapping, can be performed by some outer
        equipment, and the PE may further translate these VLANs into its own
        local VLANs. This PE model may be used by an N-PE in an H-VPLS network
        with bridging-capable devices, or scenarios such as providing E-Tree
        Network-to-Network interfaces.</t>
      </section>
    </section>

    <section title="Acknowledgements" numbered="no">
      <t>The authors would like to thank Stewart Bryant, Lizhong Jin, Deborah
      Brungard, Russ Housley, Stephen Farrell, Sheng Jiang, Alvaro Retana, and
      Ben Campbell for their detailed reviews and suggestions, and Adrian
      Farrel, Susan Hares, Shane Amante, and Andrew Malis for their valuable
      advice. In addition, the authors would like to thank Ben Mack-crane,
      Edwin Mallette, Donald Fedyk, Dave Allan,
      Giles Heron, Raymond Key, Josh Rogers, Sam Cao, and Daniel Cohn for their
      valuable comments and discussions.</t>
    </section>

    <section title="Contributors" numbered="no">
      <t>The following people made significant contributions to this
      document:</t>

<figure>
 <artwork>
Frederic Jounay
Salt Mobile SA
Rue du Caudray 4
1020 Renens
Switzerland

Email: frederic.jounay@salt.ch

Florin Balus
Alcatel-Lucent
701 East Middlefield Road
Mountain View, CA 94043
United States

Email: florin.balus@alcatel-lucent.com

Wim Henderickx
Alcatel-Lucent
Copernicuslaan 50
2018 Antwerp
Belgium

Email: wim.henderickx@alcatel-lucent.com

Ali Sajassi
Cisco
170 West Tasman Drive
San Jose, CA 95134
United States

Email: sajassi@cisco.com
 </artwork>
</figure>    
</section>
  
  </back>
</rfc>
