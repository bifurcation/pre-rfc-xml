<?xml version="1.0" encoding="US-ASCII"?>

<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [

        <!ENTITY rfc2119 PUBLIC ""
          "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml">

        <!ENTITY rfc2327 PUBLIC ""
          "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2327.xml">

        <!ENTITY rfc3550 PUBLIC ""
          "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3550.xml">

        <!ENTITY rfc3435 PUBLIC ""
          "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3435.xml">

        <!ENTITY rfc2198 PUBLIC ""
          "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2198.xml">

        <!ENTITY rfc4566 PUBLIC ""
          "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4566.xml">

        <!ENTITY rfc4733 PUBLIC ""
          "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4733.xml">

        <!ENTITY rfc4734 PUBLIC ""
          "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4734.xml">

        <!ENTITY rfc3261 PUBLIC ""
          "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3261.xml">

        <!ENTITY rfc5234 PUBLIC ""
          "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5234.xml">

        <!ENTITY rfc5109 PUBLIC ""
          "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5109.xml">

        <!ENTITY rfc3407 PUBLIC ""
          "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3407.xml">

        <!ENTITY rfc3660 PUBLIC ""
          "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3660.xml">

        <!ENTITY rfc5347 PUBLIC ""
          "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5347.xml">

        <!ENTITY rfc5406 PUBLIC ""
          "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5406.xml">

        <!ENTITY rfc3711 PUBLIC ""
          "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3711.xml">

]>

<rfc category="info" ipr="pre5378Trust200902" number="6498"
submissionType="IETF" consensus="yes">

<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>

<?rfc toc="yes" ?>
<?rfc symrefs="yes" ?>
<?rfc sortrefs="yes"?>
<?rfc compact="yes"?>
<?rfc subcompact="no"?>
<?rfc rfcedstyle="yes"?>

<front>
        <title abbrev="MGCP VBD Package">
            Media Gateway Control Protocol (MGCP) Voiceband Data (VBD) Package and General-Purpose Media Descriptor Parameter Package
        </title>

        <author initials='J.S.' surname="Stone" fullname='Joe Stone'>
                <organization>Cisco Systems</organization>
                <address>
                    <postal>
                       <street>2200 East President George Bush Highway</street>
                       <city>Richardson</city> <region>TX</region> 
                       <code>75082</code>
                       <country>USA</country>
                    </postal>
                  <email>joestone@cisco.com</email>
                  <uri>http://www.cisco.com/</uri>
                </address>
        </author>

        <author initials='R.K.' surname="Kumar" fullname='Rajesh Kumar'>
                <organization>Cisco Systems</organization>
                <address>
                    <postal>
                       <street>Mail Stop SJCE/1/1</street>
                       <street>190 West Tasman Drive</street>
                       <city>San Jose</city> <region>CA</region> 
                       <code>95134</code>
                       <country>USA</country>
                    </postal>
                    <email>rkumar@cisco.com</email>
                    <uri>http://www.cisco.com/</uri>
                </address>
        </author>

       <author initials='F.S.A' surname="Andreasen" fullname='Flemming Andreasen'>
                <organization>Cisco Systems</organization>
                <address>
                    <postal>
                       <street></street>
                       <city>Iselin</city> <region>NJ</region> 
                       <code>08830</code>
                       <country>USA</country>
                    </postal>
                    <email>fandreas@cisco.com</email>
                    <uri>http://www.cisco.com/</uri>
                </address>
        </author>

        <date month="February" year="2012"/>

        <workgroup>Network</workgroup>

        <keyword>MGCP</keyword>
        <keyword>VBD</keyword>

        <abstract>
                <t>
This document defines Media Gateway Control Protocol (MGCP) packages that
enable a Call Agent to authorize and monitor the transition of a connection to
and from Voiceband Data (VBD) with or without redundancy and FEC (forward error
correction). Although the focus is on VBD, the General-Purpose Media Descriptor
Parameter package can be used to authorize other modes of operation, not
relevant to VBD, for a particular codec. In addition to defining these
new packages, this document describes the use of the Media Format Parameter
package and Fax package with VBD, redundancy, and FEC.
                </t>
        </abstract>

</front>

<middle>


        <section anchor="applic" title="Applicability Statement">
<t>
This document defines a mechanism that requires media stream integrity
protection. The document specifies different alternative mechanisms but
does not choose one of them as mandatory-to-implement. Consequently, the use
of this specification is only suitable in environments that specify and use
at least one of these alternative mechanisms. Please see the Security
Considerations section for further details.
</t>
        </section>

        <section anchor="intro" title="Introduction">
                <t>
   The term Voiceband Data (or simply VBD) refers to the use of a suitable 
   voiceband codec (commonly G.711u or G.711a) for the transport of data 
   payloads using RTP as defined in RFC 3550 <xref target="RFC3550"/>. This 
   document defines Media Gateway Control Protocol (MGCP) <xref target="RFC3435"/> packages 
   that enable a Call Agent to authorize and monitor the transition of a 
   connection to and from VBD with or without redundancy <xref target="RFC2198"/> and FEC 
   (forward error correction) <xref target="RFC5109"/>.</t>

   <t>There are a number of different VBD procedures. These procedures vary in 
   terms of how the transition to and from VBD is coordinated end to end. Some 
   coordination techniques are mutually negotiated by the two gateways using
   the Session Description Protocol (SDP) <xref target="RFC4566"/>.
   These coordination techniques include</t>

<list style="symbols">
<t>ITU-T Recommendation V.150.1 State Signaling Event (SSE) <xref target="V1501"/></t>

<t>ITU-T Recommendation V.152 Payload Type Switching <xref target="V152"/></t>
</list>

   <t>Other coordination techniques are not negotiated. For example, the detection 
   of fax, modem, and text tones in the direction from the IP to the General Switched Telephone Network (GSTN) 
   may result in a switch to VBD or a change (e.g., disable echo cancellation) to 
   the gateway controlled VBD procedure already in place. The IP-side detected 
   tone serves as both a VBD stimulus and a coordination technique.</t>

   <t>RFC 4733 <xref target="RFC4733"/> and RFC 4734 <xref target="RFC4734"/> can be used to convey fax and modem events and tones. 
   As with IP-side tone detection, the telephone event may serve as both a VBD 
   stimulus and a coordination technique. Note that while the use of RFC 4733 and RFC 4734 to 
   convey fax and modem events and tones is negotiated, the use of RFC 4733 and RFC 4734 as a 
   gateway VBD coordination technique (at present) is not.</t>

   <t>The Voiceband Data (VBD) package is defined to support all VBD procedures. 
   This document does not address the relative merits of different procedures 
   nor does it advocate one procedure over another.</t>

   <t>We will use the term VBD to refer to Voiceband Data in general. In referring 
   to VBD in the context of the package, we will use the term VBD package. We use the term "audio" 
   (with double quotes) to refer to the IANA media type. We use the term audio 
   (without double quotes) to refer to the use of the "audio" media type for 
   (most commonly) voice.</t>

   <t>A package is defined for the General-Purpose Media Descriptor Parameter 
   <xref target="V152"/>. In the context of VBD, the General-Purpose Media Descriptor Parameter 
   (GPMD) package is used to authorize the negotiation of a particular codec for 
   use with VBD. The General-Purpose Media Descriptor Parameter is "general" in 
   nature and may be used in applications other than VBD.</t>

   <t>The Media Format Parameter (FM) package <xref target="RFC3660"/> describes the use of the 
   standard audio MIME subtype "RED" in conjunction with the "fmtp" 
   LocalConnectionOption in order to authorize the negotiation of redundancy 
   <xref target="RFC2198"/>, to identify the levels of redundancy and the media format 
   associated with each redundancy level. This document will further explore the 
   use of the FM package with VBD and redundancy.</t>

   <t>The VBD package is intended to complement the MGCP Fax (FXR) package 
   <xref target="RFC5347"/>. This document will explore the use of the FXR package with VBD.</t>

   <t>The VBD package definition is provided in <xref target="vbd-pkg-def"/>.
   The GPMD package 
   definition is provided in <xref target="gpmd-pkg-def"/>. 
   In <xref target="fm-vbd-red"/>, we discuss the use of the 
   FM package with VBD and redundancy. In <xref target="fm-vbd-fec"/>,
   we discuss the use of the 
   FM package with VBD and FEC. In <xref target="fxr-vbd"/>, we discuss
   the use of the FXR package with VBD.
   In <xref target="call-flow-examples"/>, we provide two call flow
   examples showing how 
   to use the VBD and GPMD packages.  Security considerations are found in
   <xref target="sec-cons"/>, followed by the IANA considerations
   (<xref target="iana-cons"/>) and references.</t>

        </section>

        <section anchor="Terminology" title="Terminology">
                <t>
                  The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL
NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
document are to be interpreted as described in RFC 2119 <xref target="RFC2119"/>.      
                  </t>
        </section>

        <section anchor="vbd-pkg-def" title="Voiceband Data Package Definition">
                <t>
   This package is defined for Voiceband Data (VBD).  The package defines new 
   events as detailed below.</t>

<figure><artwork>
   Package Name:        VBD  

   Package Version:     0 
</artwork></figure>
                        
               <section anchor="events-and-signals" title="Events and Signals">
                        <t>
 The following events are defined in support of the above:</t>

                           <figure title="">
                                <artwork><![CDATA[
 -------------------------------------------------------------------
| Symbol |   Definition                    |  R  |  S  |  Duration  |
|--------|---------------------------------|-----|-----|------------| 
| gwvbd  | Gateway Controlled VBD          |  x  |     |            | 
| nopvbd | No Negotiated Procedure for VBD |  x  |     |            | 
 -------------------------------------------------------------------
]]></artwork>
                        </figure> 

<t>This is standard MGCP package format as defined in Section 6.6 of
RFC&nbsp;3435 <xref target="RFC3435"/>. The definitions of the individual events
are provided in the following subsections.</t>

            <section anchor="gw-ctrld-vbd" title="Gateway Controlled Voiceband Data">
                                <t>
   The gwvbd procedure can be used by the gateway to control and decide how to handle 
   VBD calls without Call Agent involvement. The "Gateway Controlled Voiceband Data" 
   (or simply "gwvbd") event occurs when a gwvbd procedure has been negotiated 
   and VBD stimulus is detected. The "gwvbd" event may occur when the 
   gwvbd procedure is updated (e.g., upon detecting new stimulus) and 
   when the procedure fails. The "gwvbd" event occurs when the gwvbd 
   procedure ends. The gwvbd procedure MUST be negotiated with the other 
   side by passing and recognizing relevant parameters via the 
   LocalConnectionDescriptor and RemoteConnectionDescriptor.</t>
  
   <t>The following recommendations from MGCP <xref target="RFC3435"/>
   apply.</t>

<t>
   In this section, we provide a formal description of the protocol
   syntax, using ABNF as defined in "Augmented BNF for Syntax
   Specifications: ABNF" <xref target="RFC5234"/>.  The syntax makes
   use of the core rules defined in Appendix B.1 of <xref target="RFC5234"/>,
   which are not included here.  
   Furthermore, the syntax follows the case-sensitivity rules of 
   <xref target="RFC5234"/>, i.e., MGCP is case-insensitive (but SDP is not).
   It should be noted that ABNF does not provide for implicit specification of 
   linear white space, and MGCP messages MUST thus follow the explicit 
   linear white space rules provided in the grammar below.  However, in 
   line with general robustness principles, implementers are strongly 
   encouraged to tolerate additional linear white space in messages 
   received.</t>

<t>   The RequestedEvent parameter is encoded as</t>

<figure><artwork>
     GwVbdReqEvent = "gwvbd"
</artwork></figure>

<t>The ObservedEvent parameter is encoded as</t>

                           <figure title="">
                                <artwork><![CDATA[
GwVbdObsEvent = GwVbdObsEventStart / GwVbdObsEventUpdate /
                GwVbdObsEventStop / GwVbdObsEventFailure

GwVbdObsEventStart   = "gwvbd(start" Rc [Codec] [Coord] [Dir] ")"
GwVbdObsEventUpdate  = "gwvbd(update" Rc [Codec] [Dir] ")"
GwVbdObsEventStop    = "gwvbd(stop" [Rc] [Codec] ")"
GwVbdObsEventFailure = "gwvbd(failure" [Rc] [Codec] ")"  

Codec = "," *WSP "codec=" CodecString
CodecString = (ALPHA / DIGIT) *(ALPHA / DIGIT / "-" / "_" /
               "." / "/")
Coord = "," *WSP "coord=" CoordinationTechnique
CoordinationTechnique = "v152ptsw" / "v150fw"
Rc = "," *WSP "rc=" ReasonCode
ReasonCode = 1*(ALPHA / DIGIT / "-" / "_" / "." / "/") 
             ; Refer to the values listed in the tables below.
Dir = "," *WSP "dir=" Direction  
Direction = "GstnToIp" / "IpToGstn"
]]></artwork>
                        </figure> 

<t>ABNF does not provide for position-independent parameters. The "rc",
"codec", "coord", and "dir" parameters, if present, MUST appear in the relative
order shown.</t>

<t>The "start", "update", "stop", and "failure" ObservedEvent parameters are 
   defined as follows:</t>
    
<t>1) VBD Start (start)</t>

<list><t>The gwvbd procedure was initiated.  The Call Agent SHOULD refrain from
   issuing media handling instructions to the gateway until either a 
   "gwvbd(stop)" or "gwvbd(failure)" event is generated. One and only one 
   "gwvbd(stop)" or "gwvbd(failure)" event is generated corresponding to each
   "gwvbd(start)" event.</t></list>

<t>2) VBD Update (update)</t>

<list><t>The gwvbd procedure was updated. The "gwvbd(update)" event MUST only
be generated after a "gwvbd(start)" event and before a "gwvbd(stop)" or 
   "gwvbd(failure)" event.</t></list>

<t>3) VBD Stop (stop)</t>

<list><t>The gwvbd procedure ended, and the gateway did not detect any errors.
   Note that this does not necessarily imply a successful fax, modem, or text 
   transmission. It merely indicates that the gwvbd procedure has ended and 
   the procedure itself did not encounter any errors. The "stop" parameter may 
   correspond to a change from VBD to a non-VBD "audio" codec or from VBD to 
   another media type such as "image" or "text". This change may be under Call 
   Agent or gateway control. For example, the gateway may coordinate the 
   switch from VBD to "image/t38" through the exchange of SSEs 
   <xref target="T38"/> <xref target="V152"/>.
   For an example involving Call Agent control, refer to the "MC" Reason Code. 
   In both examples, the gwvbd procedure ends with the media change.</t></list>

<t>4) VBD Failure (failure)</t>

<list><t>The gwvbd procedure ended abnormally. Some kind of problem was
encountered in the gwvbd procedure, and the procedure ended.</t></list>

<t>When the "gwvbd" event is reported, exactly one of the "start", "update",
   "stop", or "failure" parameters MUST be present and MUST be the first
   parameter supplied.</t>

<t>The "rc", "codec", "coord", and "dir" ObservedEvent parameters are defined
as follows:</t>

<t>1) Reason Code (rc=&lt;ReasonCode&gt;)</t>

   <list><t>With the "start" and "update" parameters, the reason for
   triggering the 
   switch/change to VBD. With the "stop" and "failure" parameters, the reason 
   for triggering the switch from VBD. The Reason Codes in the following 
   table, which are based on the ITU-T Fax/Textphone/Modem Tones Detection 
   package <xref target="H2482"/>, ITU-T V.150.1 Amendment 1 <xref
   target="V1501A1"/>, and ITU-T V.152 

   <xref target="V152"/>, may be used with the "start" and "update"
   parameters:</t></list>

                           <figure title="">
                                <artwork><![CDATA[
    ---------------------------------------------------------------
   | ReasonCode | Description                                      |
   |------------|--------------------------------------------------|
   | CNG        | T.30 fax calling                                 |
   | V21flag    | V.21 tone and flags for fax answering            |
   | CIV18      | V.8 CI with V.18 call function                   |
   | XCI        | V.18 XCI                                         |
   | V18txp     | V.18 txp                                         |
   | Belltone   | Bell 103 carrier, high- or low-frequency channel |
   |            |   (ITU-T Recommendation V.18)                    |
   | Baudot     | Baudot initial tone and character (ITU-T         |
   |            |   Recommendation V.18)                           |
   | Edt        | EDT initial tone and character (ITU-T            |
   |            |   Recommendation V.18)                           |
   | CIdata     | V.8 CI with any data call function               |
   | CT         | V.25 calling tone                                |
   | CIfax      | V.8 CI with fax call function                    |
   | V21tone    | V.21 carrier, high- or low-frequency channel     |
   | V23tone    | V.23 carrier, high- or low-frequency channel     |
   | V8bis      | V.8 bis modem handshaking signal                 |
   | ANS        | V.25 ANS, equivalent to T.30 CED from answering  |
   |            |   terminal                                       |
   | /ANS       | V.25 ANS with periodic phase reversals           |
   | ANSam      | V.8 ANSam                                        |
   | /ANSam     | V.8 ANSam with periodic phase reversals          |
   | CMFax      | V.8 CM sequence indicating fax call function     |
   | JMFax      | V.8 JM sequence indicating fax call function     |
   | CMData     | V.8 CM sequence indicating unspecified data      |
   |            |   call function                                  |
   | JMData     | V.8 JM sequence indicating unspecified data      |
   |            |   call function                                  |
   | CMText     | V.8 CM sequence indicating text call function    |
   | JMText     | V.8 JM sequence indicating text call function    |
   | PTSW       | Payload type switch as defined in V.152          |
    ---------------------------------------------------------------]]>
                        </artwork></figure> 

     <list><t>For solutions involving textphones using a modulation with
     interspersed 
     text and speech on the same "channel", such as Baudot and EDT, the Call 
     Agent SHOULD interpret the ReasonCode parameter as part of the 
     "vbd/gwvbd(start)" event in order to differentiate between fax, modem, and 
     text. In the case of interspersed text and speech, the Call Agent SHOULD 
     remove the notification request for "vbd/gwvbd" upon receiving the 
     "vbd/gwvbd(start)" event in order to avoid large numbers of notifications.
     </t>

     <t>For example,</t>

     <figure><artwork>
      vbd/gwvbd(start, rc=Baudot)
     </artwork></figure>

     <t>With a ReasonCode of "PTSW", the Call Agent cannot differentiate text from
     fax/modem. In this case, the Call Agent SHOULD adopt a policy that guards
     against large numbers of notifications. We consider several such policies.</t>

     <t>The Call Agent MAY remove the notification request for "vbd/gwvbd" upon
     receiving the "vbd/gwvbd(start, rc=PTSW)" event. With this policy, 
     "update", "stop", and "failure" notifications will not be generated with 
     text AND fax/modem.</t>

     <t>The Call Agent MAY wait for a subsequent "vbd/gwvbd(update)" event that
     differentiates text from fax/modem. If the ReasonCode indicates 
     interspersed text and speech, the Call Agent SHOULD remove the notification 
     request for "vbd/gwvbd". For example,</t>

    <figure><artwork>
      vbd/gwvbd(update, rc=Edt)
    </artwork></figure>

     <t>The Call Agent MAY remove the notification request for "vbd/gwvbd" upon
     receiving a "vbd/gwvbd(stop)" event without having differentiated between
     text and fax/modem.</t>

     <t>The Call Agent MAY remove the notification request for "vbd/gwvbd" after
     having received a number of "vbd/gwvbd(start)" events without having
     differentiated between text and fax/modem. The specific number of events 
     after which the notification request is removed is considered an 
     implementation detail outside the scope of this specification.</t>

     <t>Reason Codes applicable with the "stop" parameter are listed below:</t>

                           <figure title="">
                                <artwork><![CDATA[
          ------------------------------------------------------
         | ReasonCode | Description                             |
         |------------|-----------------------------------------|
         | SIL        | Bidirectional silence                   |
         | Voice      | Voice signals                           |
         | PTSW       | Payload type switch as defined in V.152 |
         | MC         | Media change                            |
          ------------------------------------------------------
]]></artwork>
                        </figure> 

     <t>The "MC" Reason Code indicates that the media type has changed from
     "audio" (to "image", "text", ...) or the "audio" media format has
     changed from a VBD codec (for a reason other than "PTSW"). For example,
     the gwvbd procedure may be initiated upon detecting called terminal
     identification (CED). Subsequently,
     the Call Agent controlled T.38 procedure of the MGCP Fax (FXR)
     package <xref target="RFC5347"/> may be 
     initiated upon detecting V.21 flags. Upon receipt of a "t38(start)" event, 
     the Call Agent will instruct the gateway to switch from VBD to T.38 through 
     the use of a ModifyConnection command involving a LocalConnectionOption 
     encoding method of "L:a:image/t38" and/or a RemoteConnectionDescriptor with 
     an "image/t38" media description. This stops the gwvbd procedure. There is 
     no specific interdependency between the VBD package and the FXR package (or 
     any other package). The gwvbd procedure is stopped as a consequence of the 
     media change, not as a direct consequence of the T.38 procedure being 
     initiated. Note that in this situation the "t38(start)" event will be sent 
     before the "gwvbd(stop)" event. The Call Agent MAY choose to infer that the 
     gwvbd procedure has ended upon receiving the "t38(start)" event and disable 
     the notification of the "gwvbd" event. Refer to the example call flow in 
     <xref target="fax-call-flow"/>.</t>

     <t>Reason Codes applicable with the "failure" parameter:</t>

                           <figure>
                                <artwork><![CDATA[
          ----------------------------------------------------
         | ReasonCode | Description                           |
         |------------|---------------------------------------|
         | TO         | Indicates that a timeout has occurred |
          ----------------------------------------------------
]]></artwork>
                        </figure> 

     <t>The list of Reason Codes may be extended to include values with meaning 
     mutually understood between the gateway and the Call Agent. Obviously, 
     the use of extended values MUST be a provisionable option on the gateway in 
     order to ensure interoperability with the Call Agent.</t></list>

   <t>2) Codec String (codec=&lt;CodecString&gt;)</t>

   <list><t>
     With the "start" and "update" parameters, the codec parameter describes
     the MIME type associated with the 
     switch/change to VBD (e.g., "audio/RED", "audio/PCMU", "audio/PCMA", 
     "audio/G726-32", "audio/clearmode", ...). With the "stop" and "failure" 
     parameters, the codec parameter describes the MIME type associated with
     the switch from VBD (e.g., 
     "audio/G729", "image/t38", "text/t140", "audio/v150mr", ...). These
     strings should be full MIME types as listed in
     http://www.iana.org/assignments/media-types.</t></list>

<t>3) Coordination Technique (coord=&lt;CoordinationTechnique&gt;)</t>

   <list><t>The technique used to coordinate the transition to and from VBD
   with the remote endpoint. The coordination techniques are summarized in the 
   following table:</t>

                           <figure title="">
                                <artwork><![CDATA[
        ------------------------------------------------------
       | CoordinationTechnique | Description                  |
       |-----------------------|------------------------------|
       | v152ptsw              | V.152 Payload Type Switching |
       | v150fw                | V.150.1 SSE                  |
        ------------------------------------------------------ ]]>
    </artwork></figure>

    <t>With the "v152ptsw" coordination technique, payload type
    switching <xref target="V152"/> 
    is used to coordinate the transition to and from VBD.</t>

    <t>With the "v150fw" coordination technique, state signaling
    events <xref target="V1501"/> are used to coordinate the transition to
    and from VBD.</t>

    <t>The list of coordination techniques may be extended to include values
    with meaning mutually understood between the gateway and the Call
    Agent. Obviously, 
    the use of extended values MUST be a provisionable option on the gateway in
    order to ensure interoperability with the Call Agent.</t></list>

<t>4) Direction of Stimulus (dir=&lt;Direction&gt;)</t>

   <list><t> With the "start" and "update" parameters, the "dir" parameter
   describes the direction of the stimulus that resulted in the switch/change
   to VBD.</t></list>

                           <figure><artwork><![CDATA[
         ---------------------------------------------------
        | Direction | Description                            |
        |-----------|------------------------------------    |
        | GstnToIp  | Stimulus detected in the direction     |
        |           | from the GSTN to IP network,           |
        |           | including fax, modem, and text tones.  |
        | IpToGstn  | Stimulus detected in the direction     |
        |           | from the IP to GSTN network,           |
        |           | including fax, modem, and text tones   |
        |           | (e.g., IP-side tone detection);        |
        |           | RTP packet with VBD payload type       |
        |           | (e.g., V.152 or V.150.1).              |
         ----------------------------------------------------
]]></artwork></figure> 

   <t>Call Agents and gateways MUST implement the "start" and "stop" parameters and 
   MAY implement the "update" and "failure" parameters. Call Agents and gateways
   MAY implement the "coord", "codec", and "dir" parameters. Call Agents MAY,
   and
   gateways MUST, implement the "rc" parameter in conjunction with the "start" 
   and "update" parameters. Call Agents and gateways MAY implement the "rc"
   parameter in conjunction with the "stop" and "failure" parameters. A Call
   Agent MUST ignore all unknown ObservedEvent parameters, including parameters
   that are defined as part of this specification and not implemented.
                                </t>
                                
           <section anchor="gw-ctrld-vbd-examples" title="Gateway Controlled Voiceband Data Examples">
                                        <t>
   The following examples illustrate the encoding of the "gwvbd(start)" event:
   </t>
    
                        <figure title="">
                                <artwork><![CDATA[
        O: vbd/gwvbd(start, rc=ANS)
        O: vbd/gwvbd(start, rc=ANS, codec=audio/PCMU, coord=v152ptsw) 
        O: vbd/gwvbd(start, rc=PTSW, codec=audio/RED)
]]></artwork>
                        </figure> 

   <t>The following example illustrates the encoding of the "gwvbd(update)"
   event:</t>
   
                        <figure title="">
                                <artwork><![CDATA[
        O: vbd/gwvbd(update, rc=/ANSam, dir=IpToGstn)
]]></artwork>
                        </figure> 

   <t>The following examples illustrate the encoding of the "gwvbd(stop)"
   event:</t>
   
                        <figure title="">
                                <artwork><![CDATA[
        O: vbd/gwvbd(stop)
        O: vbd/gwvbd(stop, rc=SIL, codec=audio/G729)
        O: vbd/gwvbd(stop, rc=MC, codec=image/t38)
]]></artwork>
                        </figure> 

<t>The following examples illustrate the encoding of the "gwvbd(failure)"
  event:</t>
    
                        <figure title="">
                                <artwork><![CDATA[
        O: vbd/gwvbd(failure, codec=audio/G729)
        O: vbd/gwvbd(failure, rc=TO, codec=audio/G729)
]]></artwork>
                        </figure> 

                                </section>

                        </section>

        <section anchor="nopvbd" title="No Negotiated Procedure for Voiceband Data">
                                <t>
   The "No Negotiated Procedure for Voiceband Data" (or simply "nopvbd") event 
   occurs when a VBD procedure has not been negotiated and VBD stimulus is 
   detected. The "nopvbd" event may occur when the procedure is updated (e.g., 
   upon detecting new stimulus), when the procedure ends, and when the
   procedure 
   fails. Even though a procedure was not negotiated, a VBD handling procedure 
   MAY still be in place locally on the endpoint, as described further below.
   </t>

   <t>
   The nopvbd procedure MAY involve VBD handling including, but not limited to,
   adjusting gain and jitter, disabling voice activity detection, and DC
   offset 
   filters. The nopvbd procedure MAY involve switching to another codec. The 
   Call Agent MAY have to issue further commands in response to the "nopvbd" 
   event in order to ensure a successful VBD call.</t>

   <t>As with the "gwvbd" event, the same recommendations from
   MGCP <xref target="RFC3435"/> 
   regarding ABNF, general robustness principles, and white space apply.</t>

<figure title="">
        <artwork><![CDATA[
   The RequestedEvent parameter is encoded as

     NopVbdReqEvent = "nopvbd"

   The ObservedEvent parameter is encoded as

     NopVbdObsEvent = NopVbdObsEventStart / NopVbdObsEventUpdate / 
                      NopVbdObsEventStop / NopVbdObsEventFailure

     NopVbdObsEventStart   = "nopvbd(start" Rc [Codec] [Dir] ")"
     NopVbdObsEventUpdate  = "nopvbd(update" Rc [Codec] [Dir] ")"
     NopVbdObsEventStop    = "nopvbd(stop" [Rc] [Codec] ")"
     NopVbdObsEventFailure = "nopvbd(failure" [Rc] [Codec] ")"
]]></artwork>
                        </figure> 

  <t>The following ABNF notation is common with the "gwvbd" ObservedEvent
     parameter:</t>

                        <figure title="">
                                <artwork><![CDATA[
  Codec = "," *WSP "codec=" CodecString
  CodecString = (ALPHA / DIGIT) *(ALPHA / DIGIT / "-" / "_" /
                 "." / "/")
  Rc = "," *WSP "rc=" ReasonCode
  ReasonCode = 1*(ALPHA / DIGIT / "-" / "_" / "." / "/") 
               ; Refer to the values listed in the tables above.
  Dir = "," *WSP "dir=" Direction  
  Direction = "GstnToIp" / "IpToGstn"
]]></artwork>
                        </figure> 

   <t>
   ABNF does not provide for position-independent parameters. The "rc", "codec",
   and "dir" parameters, if present, MUST appear in the relative order shown.</t>

   <t>The "start", "update", "stop", and "failure" ObservedEvent parameters
   are defined as follows:</t>

   <t>1) VBD Start(start)</t>

   <list><t>
   The nopvbd procedure was initiated. The Call Agent may have to issue 
   further commands in order to ensure a successful VBD call (e.g., switch to 
   another codec). At most one "nopvbd(stop)" or "nopvbd(failure)" event MAY 
   be generated corresponding to each "nopvbd(start)" event. The Call Agent 
   MAY need to infer that the nopvbd procedure has ended.</t></list>

   <t>2) VBD Update (update)</t>

   <list><t>
   The nopvbd procedure was updated. The "nopvbd(update)" event MUST only be 
   generated after a "nopvbd(start)" event and before a "nopvbd(stop)" or 
   "nopvbd(failure)" event.</t></list>

   <t>3) VBD Stop (stop)</t>

   <list><t>
   The nopvbd procedure ended, and the gateway did not detect any errors. Note 
   that this does not necessarily imply a successful fax, modem, or text 
   transmission. It merely indicates that the nopvbd procedure has ended and 
   the procedure itself did not encounter any errors. Refer to the definition 
   of the "stop" parameter from the "gwvbd" event in
   <xref target="gw-ctrld-vbd"/> for additional information.</t></list>

   <t>4) VBD Failure (failure)</t>

   <list><t>
   The nopvbd procedure ended abnormally. Some kind of problem was encountered 
   in the nopvbd procedure, and the procedure ended.</t></list>
    
   <t>
   Call Agents and gateways MUST implement the "start" parameter and MAY 
   implement the "update", "stop", and "failure" parameters. Call Agents MAY,
   and gateways MUST, implement the "rc" parameter in conjunction with the
   "start" and "update" parameters. Call Agents and gateways MAY implement
   the "rc" parameter in conjunction with the "stop" and "failure" parameters.
   A Call Agent MUST ignore all unknown ObservedEvent parameters including
   parameters that are defined as part of this specification and not
   implemented.</t>

   <t>
   The definitions of the "rc", "codec", and "dir" ObservedEvent parameters are
   taken from the "gwvbd" event.</t>

   <t>
   As with the "gwvbd" event, the same recommendations regarding interspersed 
   text and speech apply.</t>

         <section anchor="nopvbd-examples" title="No Negotiated Procedure for Voiceband Data Examples">
                                        <t>
  The following examples illustrate the encoding of the "nopvbd(start)" event:
  </t>

                        <figure title="">
                                <artwork><![CDATA[
        O: vbd/nopvbd(start, rc=ANS) 
        O: vbd/nopvbd(start, rc=ANS, codec=audio/PCMU)
]]></artwork>
                        </figure> 

   <t>
   The following example illustrates the encoding of the "nopvbd(update)"
   event:</t>
   
                        <figure title="">
                                <artwork><![CDATA[
        O: vbd/nopvbd(update, rc=/ANSam, dir=IpToGstn)
]]></artwork>
                        </figure> 

   <t>
   The following examples illustrate the encoding of the "nopvbd(stop)" event:
   </t>
   
                        <figure title="">
                                <artwork><![CDATA[
        O: vbd/nopvbd(stop) 
        O: vbd/nopvbd(stop, rc=SIL, codec=audio/G729)
        O: vbd/nopvbd(stop, rc=MC, codec=image/t38)
]]></artwork>
                        </figure> 

   <t>The following examples illustrate the encoding of the "nopvbd(failure)" 
   event:</t>
    
                        <figure title="">
                                <artwork><![CDATA[
        O: vbd/nopvbd(failure, codec=audio/G729) 
        O: vbd/nopvbd(failure, rc=TO, codec=audio/G729)
]]></artwork>
                        </figure> 

                                </section>

                        </section>

                </section>

        </section>

        <section anchor="gpmd-pkg-def" title="General-Purpose Media Descriptor Parameter Package Definition">
                <t>
   This package is defined for the General-Purpose Media Descriptor Parameter 
   <xref target="V152"/>.  The package defines a new LocalConnectionOption as detailed below.</t>
    
                        <figure title="">
                                <artwork><![CDATA[
   Package Name:        GPMD  
   Package Version:     0 
]]></artwork>
                        </figure> 

           <section anchor="loc-con-opt" title="LocalConnectionOptions">

                        <t>
   The following new LocalConnectionOptions field is defined in support of
   the above: 
   </t>
    
                        <figure title="">
                                <artwork><![CDATA[
    ------------------------------------------------------ 
   | Symbol |   Definition                                | 
   |--------|---------------------------------------------| 
   | gpmd   | General-Purpose Media Descriptor Parameter  | 
    ------------------------------------------------------ 
]]></artwork>
                        </figure> 

   <t>The definition of the LocalConnectionOption is provided in the following 
   subsection.</t>

        <section anchor="gpmd-param" title="General-Purpose Media Descriptor Parameter">
                                <t>
    The General-Purpose Media Descriptor Parameter LocalConnectionOption is 
    similar to the "gpmd" SDP <xref target="RFC4566"/> attribute defined in ITU-T 
    Recommendation V.152 <xref target="V152"/> and is applicable to all of the same media 
    formats that the corresponding SDP "gpmd" attribute could be used with.</t>

    <t>The General-Purpose Media Descriptor Parameter is encoded as the keyword
    "gpmd" or "o-gpmd", followed by a colon and a quoted string beginning with 
    the media format name (MIME subtype only) followed by a space, followed by 
    the media format parameters associated with that media format:</t>

                        <figure title="">
                                <artwork><![CDATA[
      gpmd/gpmd:"<format> <parameter list>"
]]></artwork>
                        </figure> 

    <t>For simplicity, we will use the terms "codec" and "media format" 
    interchangeably in the following. Multiple media formats may be indicated by
    either repeating the "gpmd" LocalConnectionOption multiple times, such as
    </t>

                        <figure title="">
                                <artwork><![CDATA[
      L: a:codec1;codec2, gpmd/gpmd:"codec1 parameterX",
                          gpmd/gpmd:"codec2 parameterY"
]]></artwork>
                        </figure> 

    <t>
    or alternatively by having a single "gpmd" keyword followed by a colon, and
    a semicolon-separated list of quoted strings for each General-Purpose Media
    Descriptor Parameter, as in</t>

                        <figure title="">
                                <artwork><![CDATA[
      L: a:codec1;codec2, gpmd/gpmd:"codec1 parameterX";
                                    "codec2 parameterY"
]]></artwork>
                        </figure> 

    <t>The two formats may be mixed:</t>

                        <figure title="">
                                <artwork><![CDATA[
      L: a:codec1;codec2;codec3, gpmd/gpmd:"codec1 parameterX",
                                 gpmd/gpmd:"codec2 parameterY";
                                           "codec3 parameterZ"
]]></artwork>
                        </figure> 

    <t>
    The carriage returns above are included for formatting reasons only and are
    not permissible in a real implementation. This holds true for all of the 
    examples in this document.</t>

    <t>
    If it is possible for the same codec to be requested with and without the
    "gpmd" parameter, the following could result:</t>

                        <figure title="">
                                <artwork><![CDATA[
      L: a:codec1;codec1, gpmd/gpmd:"codec1 parameterX"
]]></artwork>
                        </figure> 

    <t>However, it would not be clear whether the "gpmd" parameter was
    to be applied to 
    the first or the second occurrence of the codec.  The problem is 
    that codec ordering is important (i.e., codecs are listed in preferred
    order), and the above syntax does not provide a way to indicate whether
    "parameterX" is preferred (i.e., associated with the first "codec1") or not
    (i.e., associated with the second "codec1").  In order to resolve this 
    dilemma, the codec in the "gpmd" media format is followed by a colon and an
    &lt;order&gt;, where &lt;order&gt; is a number from one to N for
    occurrences of the same codec in the codec list.  For example,</t>

                        <figure title="">
                                <artwork><![CDATA[
      L:a:codec1;codec1, gpmd/gpmd:"codec1:2 parameterX"
]]></artwork>
                        </figure> 

    <t>
    indicates that "parameterX" is associated with the second instance of 
    "codec1" in the "a:codec1;codec1" list.  If an invalid instance number is 
    supplied (e.g., instance 3 where there are only two instances), then error 
    code 524 -- inconsistency in local connection options -- will be returned.
    In the absence of an &lt;order&gt;, the first instance is assumed.</t>

    <t>
    Prepending "gpmd" with the string "o-" (i.e., "o-gpmd") indicates that the 
    parameter is optional.  In that case, the gateway may decide not to use the
    "gpmd" parameter specified, or only use it in part.</t>

    <t>
    If the "gpmd" LocalConnectionOption parameter is not optional (i.e., does 
    not have "o-" in front of it), and the LocalConnectionOption parameter value 
    is either not recognized or not supported, then the associated codec is 
    considered "not supported".</t>

    <t>
    When auditing capabilities, the "gpmd" LocalConnectionOption parameter MUST
    be returned with a semicolon-separated list of supported formats and/or 
    multiple independent "gpmd" parameters, as&nbsp;in</t>

                        <figure title="">
                                <artwork><![CDATA[
      A: a:codec1;codec2, gpmd/gpmd:"codec1 parameterX";
                                    "codec2 parameterY"

    or

      A: a:codec1;codec1, gpmd/gpmd:"codec1 parameterX"
]]></artwork>
                        </figure> 

    <t>One example uses the General-Purpose Media Descriptor Parameter 
    LocalConnectionOption in conjunction with gateway controlled Voiceband Data 
    (or simply VBD) using payload type switching <xref target="V152"/>. In the context of VBD, 
    the &lt;format&gt; must be an RTP/AVP payload type.
    The &lt;parameter list&gt; is a  
    semicolon-separated list of "parameter=value" pairs:</t>

                        <figure title="">
                                <artwork><![CDATA[
  L: a:codec1, gpmd/gpmd:"codec1 parameterX=ValueA;parameterY=ValueB"
]]></artwork>
                        </figure> 

    <t>In the example below, G.729 is an audio codec and G.711u is a VBD codec:
    </t>

                        <figure title="">
                                <artwork><![CDATA[
      L: a:G729;PCMU, gpmd/gpmd:"PCMU vbd=yes"
]]></artwork>
                        </figure> 

    <t>
    The corresponding media description in the SDP as part of the connection 
    request acknowledgment might look like</t>

                        <figure title="">
                                <artwork><![CDATA[
      m=audio 12345 RTP/AVP 18 96
      a=rtpmap:96 PCMU/8000
      a=gpmd:96 vbd=yes
]]>                                </artwork>
                        </figure> 

    <t>If a request is made to audit the capabilities of an endpoint, and the 
    endpoint supports G.711u as both an audio and VBD codec, then the "gpmd" 
    LocalConnectionOption parameter might look like</t>

                        <figure title="">
                                <artwork><![CDATA[
      A: a:PCMU, p:10-40, e:on, s:on,
         m:sendonly;recvonly;sendrecv;inactive
      A: a:PCMU, p:10-40, e:on, s:off, 
         m:sendonly;recvonly;sendrecv;inactive,
         gpmd/gpmd:"PCMU vbd=yes"
]]>                                </artwork>
                        </figure> 

    <t>Given that some parameters, e.g., silence suppression, are only 
    compatible with G.711u as an audio codec, then the gateway MUST return 
    different capability sets corresponding to audio and VBD.</t>

    <t>If we combine V.152 and redundancy <xref target="RFC2198"/>, an example 
    LocalConnectionOption might look like the example below. In this example,
    G.729 is an audio codec and G.711u is a VBD codec with a redundancy
    level of one:</t>

                        <figure title="">
                                <artwork><![CDATA[
  L: a:G729;RED;PCMU, gpmd/gpmd:"PCMU vbd=yes", fmtp:"RED PCMU/PCMU"
]]>                                </artwork>
                        </figure> 

    <t>
    The corresponding media description in the SDP as part of the connection 
    request acknowledgment might look like</t>

                        <figure title="">
                                <artwork><![CDATA[
      m=audio 12345 RTP/AVP 18 96 97
      a=rtpmap:96 RED/8000
      a=fmtp:96 97/97
      a=rtpmap:97 PCMU/8000
      a=gpmd:97 vbd=yes
]]>                                </artwork>
                        </figure> 

    <t>Refer to <xref target="fm-vbd-red"/> for more examples involving
       V.152 and redundancy.</t>

                        </section>
                </section>

        </section>

        <section anchor="fm-vbd-red" title="Use of Media Format Parameter Package with VBD and Redundancy">
                <t>
   The MGCP Media Format Parameter (FM) package <xref target="RFC3660"/> in conjunction with the 
   standard audio MIME subtype "RED" may be used by the Call Agent to authorize 
   the negotiation of redundancy <xref target="RFC2198"/>, to identify the levels of redundancy 
   and the media format associated with each redundancy level. An example of
   this was demonstrated in <xref target="gpmd-pkg-def"/>.</t>

   <t>
   The FM package states that the "fmtp" LocalConnectionOption MUST be returned
   when auditing capabilities. Applying this to VBD and redundancy might
   result in</t>

                        <figure title="">
                                <artwork><![CDATA[
      A: a:PCMU, p:10-40, e:on, s:on,
         m:sendonly;recvonly;sendrecv;inactive
      A: a:RED;PCMU, p:10-40, e:on, s:off, 
         m:sendonly;recvonly;sendrecv;inactive,
         gpmd/gpmd:"PCMU vbd=yes",
         fmtp:"RED PCMU/PCMU"

   The FM package defines "instance syntax", in which

     L:a:codec1;codec1, fmtp:"codec1:2 formatX"
]]>                                </artwork>
                        </figure> 

   <t>
   indicates that "formatX" is associated with the second instance of "codec1" 
   in the "a:codec1;codec1" list. The examples in the FM package are limited to
   the use of the instance syntax in conjunction with the media format. We 
   propose the use of the instance syntax in conjunction with the media format 
   parameters</t>

                        <figure title="">
                                <artwork><![CDATA[
     L:a:codec1;codec2;codec3;codec2, fmtp:"codec3 codec2:2/codec2:2"
]]>                                </artwork>
                        </figure> 

   <t>
   Let's build on the example of <xref target="gpmd-pkg-def"/>. In the
   example below, G.729 is an 
   audio codec, and G.711u is both an audio codec and a VBD codec with a
   redundancy level of one:</t>

                        <figure title="">
                                <artwork><![CDATA[
     L: a:G729;PCMU;RED;PCMU, gpmd/gpmd:"PCMU:2 vbd=yes",
                              fmtp:"RED PCMU:2/PCMU:2"
]]>                                </artwork>
                        </figure> 

   <t>The corresponding media description in the SDP as part of the connection 
   request acknowledgment might look like</t>

                        <figure title="">
                                <artwork><![CDATA[
     m=audio 12345 RTP/AVP 18 0 96 97
     a=rtpmap:96 RED/8000
     a=fmtp:96 97/97
     a=rtpmap:97 PCMU/8000
     a=gpmd:97 vbd=yes
]]>                                </artwork>
                        </figure> 

   <t>Note that the relative preference of the LocalConnectionOption encoding 
   methods is preserved in the "audio" media formats (i.e., payload types) as 
   part of the media description. In this example, this reflects a preference 
   for V.152 with redundancy versus without. No preference is inferred from the
   relative order of the different LocalConnectionOptions, namely "a",
   "gpmd/gpmd", and "fmtp".</t>

   <t>
   A Call Agent can authorize the negotiation of audio codecs and VBD codecs 
   involving different levels of redundancy. In the example below, G.711u is a 
   VBD codec with a redundancy level of two (preferred) or one:</t>

                        <figure title="">
                                <artwork><![CDATA[
     L: a:G729;RED;RED;PCMU, fmtp:"RED PCMU/PCMU/PCMU", 
                             fmtp:"RED:2 PCMU/PCMU", 
                             gpmd/gpmd:"PCMU vbd=yes"
]]>                                </artwork>
                        </figure> 

   <t>The corresponding media description in the SDP as part of the connection 
   request acknowledgment might look like</t>
 
                        <figure title="">
                                <artwork><![CDATA[
     m=audio 12345 RTP/AVP 18 96 97 98
     a=rtpmap:96 RED/8000
     a=fmtp:96 98/98/98
     a=rtpmap:97 RED/8000
     a=fmtp:97 98/98
     a=rtpmap:98 PCMU/8000
     a=gpmd:98 vbd=yes
]]>                                </artwork>
                        </figure> 

   <t>
   Redundancy can be applied to both audio codecs and VBD codecs. In the example
   below, G.729 is an audio codec with a redundancy level of two and G.711u is a
   VBD codec with a redundancy level of one:</t>

                        <figure title="">
                                <artwork><![CDATA[
     L: a:RED;G729;RED;PCMU, fmtp:"RED G729/G729/G729",
                             fmtp:"RED:2 PCMU/PCMU",
                             gpmd/gpmd:"PCMU vbd=yes"
]]>                                </artwork>
                        </figure> 

   <t>The corresponding media description in the SDP as part of the connection 
   request acknowledgment might look like</t>
 
                        <figure title="">
                                <artwork><![CDATA[
     m=audio 12345 RTP/AVP 96 18 97 98
     a=rtpmap:96 RED/8000
     a=fmtp:96 18/18/18
     a=rtpmap:97 RED/8000
     a=fmtp:97 98/98
     a=rtpmap:98 PCMU/8000
     a=gpmd:98 vbd=yes
]]>                                </artwork>
                        </figure> 

        </section>

        <section anchor="fm-vbd-fec" title="Use of Media Format Parameter Package with VBD and FEC">
                <t>
  A Call Agent may authorize the negotiation of forward error correction (FEC) 
   <xref target="RFC5109"/> with the standard audio MIME subtype "parityfec":
                        <figure title="">
                                <artwork><![CDATA[
     L: a:PCMU;parityfec
]]>
                                </artwork>
                        </figure> 


   By default, we assume that FEC packets are to be sent as a separate stream.   
   The corresponding media description in the SDP as part of the connection 
   request acknowledgment might look like

                        <figure title="">
                                <artwork><![CDATA[
      v=0
      c=IN IP4 192.0.2.0
      m=audio 49170 RTP/AVP 0 96
      a=rtpmap:96 parityfec/8000
      a=fmtp:96 49172 IN IP4 192.0.2.0
]]>
                                </artwork>
                        </figure> 

   If FEC is to be sent as a secondary codec in the redundant codec payload 
   format <xref target="RFC2198"/>, we again leverage the MGCP Media Format
   Parameter (FM) package <xref target="RFC3660"/> in conjunction with the
   standard audio MIME subtype "RED":

                        <figure title="">
                                <artwork><![CDATA[
      L: a:G729;RED;PCMU;parityfec, gpmd/gpmd:"PCMU vbd=yes",
                                    fmtp:"RED PCMU/parityfec"

   The corresponding media description might look like

      v=0
      c=IN IP4 192.0.2.0
      m=audio 49170 RTP/AVP 18 96 97 98
      a=rtpmap:96 RED/8000
      a=fmtp:96 97/98
      a=rtpmap:97 PCMU/8000
      a=gpmd:97 vbd=yes
      a=rtpmap:98 parityfec/8000
]]>                                </artwork>
                        </figure> 

   The FM package states that the "fmtp" LocalConnectionOption MUST be returned
   when auditing capabilities. Applying this to VBD, redundancy and FEC might 
   result in
                        <figure title="">
                                <artwork><![CDATA[
      A: a:PCMU, p:10-40, e:on, s:on,
         m:sendonly;recvonly;sendrecv;inactive
      A: a:RED;PCMU;parityfec, p:10-40, e:on, s:off, 
         m:sendonly;recvonly;sendrecv;inactive,
         gpmd/gpmd:"PCMU vbd=yes",
         fmtp:"RED PCMU/parityfec"
]]>                                </artwork>
                        </figure> 


                </t>
        </section>

        <section anchor="fxr-vbd" title="Use of Fax Package with VBD">

                <t>The MGCP Fax (FXR) package <xref target="RFC5347"/> is
   used by a Call Agent to authorize fax 
   handling, including Call Agent controlled T.38 and gateway procedures such as
   V.152. With the FXR package, VBD falls into one of two categories: "special 
   fax handling" as part of the gateway procedure (resulting in the "gwfax" 
   event), or "no special fax handling" as part of the gateway and Off 
   procedures (resulting in the "nopfax" event). In order for a VBD procedure to
   fall into the "special fax handling" category, support for it MUST be
   negotiated with the other side by passing and recognizing relevant parameters
   via the LocalConnectionDescriptor and RemoteConnectionDescriptor.</t>

   <t>A gateway controlled VBD procedure such as V.152 MUST fall into the category 
   of gateway controlled mode involving "special fax handling". The resulting 
   "gwfax" event is what informs the Call Agent to refrain from issuing media 
   handling instructions that could otherwise have a negative impact on the 
   gateway procedure.</t>

   <t>Consider the following example (with shorthand SDP notation):</t>

                        <figure title="">
                                <artwork><![CDATA[
        CRCX 2000 ds/ds1-1/2@gw-t.whatever.net MGCP 1.0
        C: 1 
        M: sendrecv 
        L: a:G729;PCMU, gpmd/gpmd:"PCMU vbd=yes", fxr/fx:t38;gw
        X: 1
        R: fxr/t38, fxr/gwfax, fxr/nopfax 
         
        v=0  
        c=IN IP4 192.0.2.1  
        m=audio 3456 RTP/AVP 18 96
        a=rtpmap:96 PCMU/8000
        a=gpmd:96 vbd=yes

        200 2000 OK
        I: 1

        v=0
        c=IN IP4 192.0.2.2
        m=audio 1296 RTP/AVP 18 96
        a=rtpmap:96 PCMU/8000
        a=gpmd:96 vbd=yes
]]>                                </artwork>
                        </figure> 

   <t>The RemoteConnectionDescriptor does not indicate support for "image/t38" as a 
   latent capability <xref target="RFC3407"/>. Consequently, the gateway will not initiate the 
   T.38 strict fax procedure, "t38", upon detecting fax stimulus (i.e., CNG, 
   V.21 flags, etc.). However, the two endpoints did successfully negotiate a 
   gateway controlled VBD procedure (e.g., V.152); therefore, a 
   gateway controlled 
   mode involving "special fax handling" is used. The "gwfax(start)" event will 
   be generated upon detecting VBD (including fax) stimulus.</t>

   <t>A Call Agent can express a preference for a gateway procedure involving 
   "special fax handling" over a T.38 procedure (strict or loose). For example,</t>

   <figure><artwork>
      L: fxr/fx:gw;t38
   </artwork></figure>

   <t>and</t>

   <figure><artwork>
      L: fxr/fx:gw;t38-loose
   </artwork></figure>

   <t>However, with the existing syntax of the FXR package, a Call Agent cannot 
   express a preference for one gateway procedure over another, each with 
   possibly different preferences relative to a T.38 procedure.</t>

   <t>The FXR package allows a gateway to implement additional fax handling
   parameters. We define just such a parameter by qualifying the existing "gw" 
   parameter with a list of one or more MIME types:</t>

                        <figure title="">
                                <artwork><![CDATA[
     Gateway  = "gw[" mimeType 0*("|" mimeType) "]"
     mimeType = mimeMediaType "/" mimeSubType
     ; mimeMediaType and mimeSubType from
     ;   http://www.iana.org/assignments/media-types/
]]>
                                </artwork>
                        </figure> 

   <t>By qualifying the "gw" parameter with a list of MIME types, we narrow the 
   scope of the gateway procedure. Consider the following examples in which the
   Call Agent authorizes the use of a gateway controlled fax handling
   procedure:</t>

                        <figure title="">
                                <artwork><![CDATA[
    - involving "image/t38" (e.g., T.38oUDPTL, T.38oTCP):

      L: a:G729, fxr/fx:gw[image/t38]

    - involving VBD (e.g., PCMU and V.152):

      L: a:G729;PCMU, gpmd/gpmd:"PCMU vbd=yes", fxr/fx:gw[audio/PCMU]

    - involving VBD with redundancy (e.g., PCMU, V.152,
      and RFC 2198):

      L: a:G729;RED;PCMU, fmtp:"RED PCMU/PCMU",
         gpmd/gpmd:"PCMU vbd=yes", fxr/fx:gw[audio/RED|audio/PCMU]
]]>
                                </artwork>
                        </figure> 

   <t>Only "special fax handling" involving one of the specified MIME types is 
   authorized. Support for "special fax handling" involving one of the specified 
   MIME types MUST be negotiated, or this "instance" of the gateway procedure is
   not initiated. Consider the following example in which the Call Agent 
   authorizes the use of a gateway controlled fax handling procedure:</t>

                        <figure title="">
                                <artwork><![CDATA[
    - involving "audio/t38" (e.g., T.38oRTP):

      L: a:G729;t38, fxr/fx:gw[audio/t38]
]]>                                </artwork>
                        </figure> 

   <t>In this example, the call will fail if the gateway fails to negotiate 
   "audio/t38".</t>

   <t>The "fx" LocalConnectionOption MAY now involve multiple instances of the
   "gw" parameter, each with a different list of MIME types. In order to
   authorize 
   "no special fax handling", the Call Agent MUST include the "gw" parameter 
   without a MIME type, or the "off" parameter. The instance of the "gw"
   parameter without a MIME type should appear as the last instance of the "gw"
   parameter. In the following example,</t>

   <figure><artwork>
   L: a:G729;PCMU, fxr/fx:gw[image/t38];gw
   </artwork></figure>

   <t>the Call Agent authorizes the use of, and expresses a preference for,</t>

   <list style="numbers">
   <t>Gateway controlled image/t38 (e.g., T.38oUDPTL)</t>

   <t>Any other gateway procedure with "special fax handling"</t>

   <t>No special fax handling (this is a function of the
      "fxr/fx:gw" parameter as defined in Section 2.1 of the MGCP Fax
      (FXR) package <xref target="RFC5347"/>)</t></list>

   <t>If present, the "off" parameter should appear as the last parameter. In
    the following example,</t>

   <figure><artwork>
   L: a:G729;PCMU;t38, fxr/fx:gw[audio/t38];off
   </artwork></figure>

   <t>the Call Agent authorizes the use of, and expresses a preference for,</t>

   <list style="numbers">
   <t>Gateway controlled audio/t38 (e.g., T.38oRTP)</t>

   <t>No special fax handling</t></list>

   <t>We can express relative preferences for different gateway controlled fax 
   handling procedures, not only with respect to one another, but with respect 
   to T.38 procedures. Consider the following preferential list of fax handling
   procedures:</t>

   <list style="numbers">
   <t>Gateway controlled audio/t38 (e.g., T.38oRTP)</t>

   <t>Gateway controlled image/t38 (e.g., T.38oUDPTL)</t>

   <t>Call Agent controlled image/t38</t>

   <t>Gateway controlled VBD with redundancy (e.g., PCMU, V.152, and RFC 2198)</t>

   <t>Gateway controlled VBD without redundancy (e.g., PCMU and V.152)</t>

   <t>Any other gateway procedure with "special fax handling"</t>

   <t>No special fax handling (this is a function of the "fxr/fx:gw" parameter
      as defined in Section 2.1 of the MGCP Fax (FXR) package <xref target="RFC5347"/>)</t></list>

   <t>This would be expressed as</t>
  
                        <figure title="">
                                <artwork><![CDATA[
  L: a:G729;PCMU;t38;RED;PCMU, 
     gpmd/gpmd:"PCMU:2 vbd=yes",
     fmtp:"RED PCMU:2/PCMU:2",
     fxr/fx:gw[audio/t38|image/t38];t38;gw[audio/RED|audio/PCMU:2];gw
]]>
                                </artwork>
                        </figure> 

   <t>Note that the bracketed form of the "gw" parameter is NOT defined as part of 
   the VBD package. The bracketed form of the "gw" parameter is defined as an 
   extension to the FXR package. Gateways that implement the bracketed form of 
   the "gw" parameter MUST return this form of the parameter when capabilities 
   are audited as illustrated by the following example:</t>

                        <figure title="">
                                <artwork><![CDATA[
     A: fxr/fx:t38;t38-loose;gw[audio/t38|image/t38];gw;off
]]>
                                </artwork>
                        </figure> 

   <t>Support for the bracketed "gw" parameter MAY be spread across multiple 
   capability lines:</t>

                        <figure title="">
                                <artwork><![CDATA[
     A: a:RED;PCMU, p:10-40, e:on, s:off,
        m:sendonly;recvonly;sendrecv;inactive,
        gpmd/gpmd:"PCMU vbd=yes",
          fmtp:"RED PCMU/PCMU",
          fxr/fx:gw[audio/RED|audio/PCMU]
     A: a:t38, fxr/fx:gw[audio/t38]
     A: a:image/t38, fxr/fx:t38;t38-loose;gw[image/t38]
]]>                                </artwork>
                        </figure> 

   <t>A Call Agent SHOULD only attempt to leverage the bracketed form of the "gw" 
   parameter in conjunction with an endpoint that indicates support for the 
   bracketed syntax as part of its capabilities.</t>

   <t>Call Agents and gateways that do not support this form of the "gw" parameter 
   MUST ignore the bracketed MIME type information consistent with the MGCP 
   grammar <xref target="RFC3435"/>.</t>

        </section>

        <section anchor="call-flow-examples" title="Call Flow Examples">
                <t>
   In this section, we provide two call flow examples. The first one illustrates 
   a modem call under gateway control using V.152.  The second one illustrates a 
   fax call under gateway control using V.152 and Call Agent controlled T.38.
                </t>

           <section anchor="modem-call-flow" title="Modem Call with Gateway Controlled VBD">
                        <t>
   In this example, both sides support gateway controlled VBD using V.152 with 
   redundancy. We assume that the originating and terminating Call Agents
   communicate via the Session Initiation Protocol (SIP)
   <xref target="RFC3261"/>:</t>

                        <figure title="">
                                <artwork><![CDATA[
 ------------------------------------------------------------------
| #|     GW-o      |     CA-o      |      CA-t     |      GW-t     |
|==|===============|===============|===============|===============|
| 1|             <-|CRCX           |               |               |
| 2|     200(sdp-o)|->             |               |               |
| 3|               |  INVITE(sdp-o)|->             |               |
| 4|               |               |    CRCX(sdp-o)|->             |
| 5|               |               |             <-|200 (sdp-t)    |
| 6|               |             <-|200(sdp-t)     |               |
| 7|             <-|MDCX(sdp-t)    |               |               |
| 8|            200|->             |               |               |
|--|---------------|---------------|---------------|---------------|
| 9|               |               |               |<- ANS/T.30 CED|
|10|               |               |           <- NTFY(gwvbd start)|
|11|               |               |            200|->             |
|12|NTFY(gwvbd start) ->           |               |               |
|13|             <-|200            |               |               |
|--|---------------|---------------|---------------|---------------|
|14|               |               |               | (modem ends)  |
|15|               |               |           <- NTFY(gwvbd stop) |
|16|               |               |            200|->             |
|17|NTFY(gwvbd stop) ->            |               |               |
|18|             <-|200            |               |               |
 ------------------------------------------------------------------
]]>
                                </artwork>
                        </figure> 

   <t>Step 1:</t>

   <list><t>
   The Call Agent issues a CreateConnection command to the gateway,
   instructing it to use G.729 media encoding and to notify it of the
   "gwvbd" and "nopvbd" events. The Call Agent authorizes the negotiation of
   G.711u as a VBD codec with a redundancy level of one:</t></list>
    
                        <figure title="">
                                <artwork><![CDATA[
   CRCX 1000 ds/ds1-1/1@gw-o.whatever.net MGCP 1.0
   C: 1 
   L: a:G729;RED;PCMU, gpmd/gpmd:"PCMU vbd=yes", fmtp:"RED PCMU/PCMU"
   M: recvonly 
   R: vbd/gwvbd, vbd/nopvbd 
   X: 1 
   Q: process, loop
]]>
                                </artwork>
                        </figure> 

   <t>Step 2:</t>
    
   <list><t>
   The gateway acknowledges the command and includes SDP with codec 
   information as well as V.152 and redundancy information:</t></list>
    
                        <figure title="">
                                <artwork><![CDATA[
        200 1000 OK
        I:1 
         
        v=0  
        o=- 25678 753849 IN IP4 192.0.2.1  
        s=-  
        c=IN IP4 192.0.2.1  
        t=0 0  
        m=audio 3456 RTP/AVP 18 96 97
        a=rtpmap:96 RED/8000
        a=fmtp:96 97/97
        a=rtpmap:97 PCMU/8000
        a=gpmd:97 vbd=yes
]]>
                                </artwork>
                        </figure> 

   <t>Step 3:</t>
    
   <list><t>
   The originating Call Agent sends a SIP INVITE message with the SDP to the 
   terminating Call Agent.</t></list>
    
   <t>Step 4:</t>
    
   <list><t>
   The terminating Call Agent issues a CreateConnection command to the 
   terminating gateway, instructing it to use G.729 media encoding and to
   notify it of the "gwvbd" and "nopvbd" events. Again, the Call Agent
   authorizes the negotiation of G.711u as a VBD codec with a redundancy
   level of one:
   </t></list>
    
                        <figure title="">
                                <artwork><![CDATA[
   CRCX 2000 ds/ds1-1/2@gw-t.whatever.net MGCP 1.0
   C: 2 
   L: a:G729;RED;PCMU, gpmd/gpmd:"PCMU vbd=yes", fmtp:"RED PCMU/PCMU"
   M: sendrecv 
   R: vbd/gwvbd, vbd/nopvbd 
   X: 20 
   Q: process, loop
         
   v=0  
   o=- 25678 753849 IN IP4 192.0.2.1  
   s=-  
   c=IN IP4 192.0.2.1  
   t=0 0  
   m=audio 3456 RTP/AVP 18 96 97
   a=rtpmap:96 RED/8000
   a=fmtp:96 97/97
   a=rtpmap:97 PCMU/8000
   a=gpmd:97 vbd=yes
]]>
                                </artwork>
                        </figure> 

   <t>Step 5:</t>

   <list><t>
   The terminating gateway supports V.152 and redundancy, and the 
   RemoteConnectionDescriptor included indicates that the other side supports 
   V.152 and redundancy.  The terminating gateway sends back a success response
   with its SDP, which also includes V.152 and redundancy information:
   </t></list>
   
                        <figure title="">
                                <artwork><![CDATA[
        200 2000 OK
        I:2 
         
        v=0  
        o=- 25678 753849 IN IP4 192.0.2.2 
        s=-  
        c=IN IP4 192.0.2.2 
        t=0 0  
        m=audio 1296 RTP/AVP 18 96 97  
        a=rtpmap:96 RED/8000
        a=fmtp:96 97/97
        a=rtpmap:97 PCMU/8000
        a=gpmd:97 vbd=yes
]]>
                                </artwork>
                        </figure> 

   <t>Step 6:</t>
    
   <list><t>
   The terminating Call Agent sends back a SIP 200 OK response to the 
   originating Call Agent, which in turn sends a SIP ACK (not shown).
   </t></list>

   <t>Step 7:</t>
    
   <list><t>
   The originating Call Agent in turn sends a ModifyConnection command to the 
   originating gateway:</t></list>
    
                        <figure title="">
                                <artwork><![CDATA[
        MDCX 1001 ds/ds1-1/1@gw-o.whatever.net MGCP 1.0
        C: 1 
        I: 1 
        M: sendrecv 
         
        v=0  
        o=- 25678 753849 IN IP4 192.0.2.2 
        s=-  
        c=IN IP4 192.0.2.2 
        t=0 0  
        m=audio 1296 RTP/AVP 18 96 97  
        a=rtpmap:96 RED/8000
        a=fmtp:96 97/97
        a=rtpmap:97 PCMU/8000
        a=gpmd:97 vbd=yes
]]>
                                </artwork>
                        </figure> 

   <list><t>
   Since the RemoteConnectionDescriptor indicates that the other side
   supports V.152
   and redundancy, the gateway will in fact be able to use the gateway 
   controlled VBD procedure with redundancy. Had there not been any support for
   V.152 in the RemoteConnectionDescriptor, then this command would still have 
   succeeded; however, there would be no negotiated procedure for VBD handling.
   </t></list>

   <t>Step 8:</t>

   <list><t>
   The gateway acknowledges the command.  At this point, a call is established 
   using G.729 encoding, and if a VBD call is detected, the gateway controlled 
   VBD procedure will be initiated.</t></list>

   <t>Steps 9-10:</t>

   <list><t>
   A modem call now occurs.  The terminating gateway detects a T.30 CED tone 
   (a.k.a.&nbsp;V.25 ANS) in the GSTN-to-IP direction and begins transmitting
   RTP packets with the negotiated redundant VBD payload type (96).</t>
    
   <t>The "gwvbd(start)" event occurs, and a Notify command is sent to
   the Call Agent:
   </t></list>

                        <figure title="">
                                <artwork><![CDATA[
        NTFY 2500 ds/ds1-1/2@gw-t.whatever.net MGCP 1.0
        O: vbd/gwvbd(start, rc=ANS, codec=audio/RED, coord=v152ptsw)
        X: 20
]]>
                                </artwork>
                        </figure> 

   <t>Step 11:</t>

   <list><t>
   The Call Agent acknowledges the Notify command:</t></list>

   <figure><artwork><![CDATA[
        200 2500 OK
   ]]>
   </artwork></figure>

   <t>Step 12:</t>

   <list><t>
   Upon receiving an RTP packet with the redundant VBD payload type (96), the 
   originating gateway begins transmitting RTP packets with the redundant VBD 
   payload type.</t>

   <t>The "gwvbd(start)" event occurs, and a Notify command is sent to
   the Call Agent:
   </t></list>

                        <figure title="">
                                <artwork><![CDATA[
        NTFY 1500 ds/ds1-1/1@gw-o.whatever.net MGCP 1.0
        O: vbd/gwvbd(start, rc=PTSW, codec=audio/RED)
        X: 1
]]>
                                </artwork>
                        </figure> 
    
   <t>Step 13:</t>

   <list><t>
   The Call Agent acknowledges the Notify command:</t></list>

   <figure><artwork>    
<![CDATA[
        200 1500 OK
   ]]>
   </artwork></figure>

   <t>Steps 14-15:</t>

   <list><t>
   The modem call ends. The terminating gateway detects bidirectional silence 
   and begins transmitting RTP packets with the negotiated audio payload type
   (18).</t>

   <t>The "gwvbd(stop)" event occurs, and a Notify command is sent to
   the Call Agent:
   </t></list>

                        <figure title="">
                                <artwork><![CDATA[
        NTFY 2501 ds/ds1-1/2@gw-t.whatever.net MGCP 1.0
        O: vbd/gwvbd(stop, rc=SIL, codec=audio/G729) 
        X: 20
]]>
                                </artwork>
                        </figure> 

   <t>Step 16:</t>

   <list><t>
   The Call Agent acknowledges the Notify command:</t></list>

   <figure><artwork>    
<![CDATA[
        200 2501 OK
   ]]>
   </artwork></figure>

   <t>Step 17:</t>

   <list><t>
   Upon receiving an RTP packet with the audio payload type (18), the originating
   gateway begins transmitting RTP packets with the audio payload type.
   </t>

   <t>The "gwvbd(stop)" event occurs, and a Notify command is sent to
   the Call Agent:
   </t></list>
    
                        <figure title="">
                                <artwork><![CDATA[
        NTFY 1501 ds/ds1-1/1@gw-o.whatever.net MGCP 1.0
        O: vbd/gwvbd(stop, rc=PTSW, codec=audio/G729)
        X: 1
]]>
                                </artwork>
                        </figure> 

   <t>Step 18:</t>

   <list><t>
   The Call Agent acknowledges the Notify command:</t></list>
    
                        <figure title="">
                                <artwork><![CDATA[
        200 1501 OK
   ]]>
                                </artwork>
                        </figure> 

   <t>The modem call is now over.</t>
                        
            </section>

            <section anchor="fax-call-flow" title="Fax Call with Gateway Controlled VBD and Call Agent Controlled T.38">
                        <t>
   In this example, both sides support gateway controlled VBD using V.152 with 
   redundancy and Call Agent controlled T.38. We assume that the originating and 
   terminating Call Agent communicate via the Session Initiation Protocol (SIP) 
   <xref target="RFC3261"/>:</t>

                        <figure title="">
                                <artwork><![CDATA[
 ------------------------------------------------------------------
| #|     GW-o      |     CA-o      |      CA-t     |      GW-t     |
|==|===============|===============|===============|===============|
| 1|             <-|CRCX           |               |               |
| 2|     200(sdp-o)|->             |               |               |
| 3|               |  INVITE(sdp-o)|->             |               |
| 4|               |               |    CRCX(sdp-o)|->             |
| 5|               |               |             <-|200 (sdp-t)    |
| 6|               |             <-|200(sdp-t)     |               |
| 7|             <-|MDCX(sdp-t)    |               |               |
| 8|            200|->             |               |               |
|--|---------------|---------------|---------------|---------------|
| 9|               |               |               |<- ANS/T.30 CED|
|10|               |               |           <- NTFY(gwvbd start)|
|11|               |               |            200|->             |
|12|NTFY(gwvbd start) ->           |               |               |
|13|             <-|200            |               |               |
|14|               |               |               <- V.21 Preamble|
|15|               |               |             <- NTFY(t38 start)|
|16|               |               |            200|->             |
|17|               |               |      MDCX(t38)|->             |
|18|               |               |             <-|200(sdp-t2)    |
|19|               |             <-|INVITE(sdp-t2) |               |
|20|             <-|MDCX(sdp-t2)   |               |               |
|21|    200(sdp-o2)|->             |               |               |
|22|               |    200(sdp-o2)|->             |               |
|23|               |               |   MDCX(sdp-o2)|->             |
|24|               |               |             <-|200            |
|25| V.21 Preamble |->             |               |               |
|26|NTFY(t38 start)|->             |               |               |
|27|             <-|200            |               |               |
|--|---------------|---------------|---------------|---------------|
|28|               |               |               |   (fax ends)  |
|29|               |               |             <-|NTFY(t38 stop) |
|30|               |               |            200|->             |
|31|NTFY(t38 stop) |->             |               |               |
|32|             <-|200            |               |               |
 ------------------------------------------------------------------
]]>
                                </artwork>
                        </figure> 

   <t>Step 1:</t>

   <list><t>
   The Call Agent issues a CreateConnection command to the gateway,
   instructing it to use G.729 media encoding and to use either the strict
   T.38 procedure or the gateway procedure. Consequently, the Call Agent
   requests notification of the "t38", "gwfax", "gwvbd", and "nopvbd" events.
   The Call Agent authorizes the negotiation of G.711u as a VBD codec with a
   redundancy level of one:</t></list>
    
                        <figure title="">
                                <artwork><![CDATA[
  CRCX 1000 ds/ds1-1/1@gw-o.whatever.net MGCP 1.0  
  C: 1 
  L: a:G729;RED;PCMU, gpmd/gpmd:"PCMU vbd=yes", fmtp:"RED PCMU/PCMU",
     fxr/fx:t38;gw 
  M: recvonly 
  R: fxr/t38, fxr/gwfax, vbd/gwvbd, vbd/nopvbd
  X: 1 
  Q: process, loop
]]>
                                </artwork>
                        </figure> 

   <t>Step 2:</t>

   <list><t>
   The gateway acknowledges the command and includes SDP with codec 
   information as well as capability, V.152, and redundancy information:
   </t></list>

                        <figure title="">
                                <artwork><![CDATA[
        200 1000 OK 
        I:1 
         
        v=0  
        o=- 25678 753849 IN IP4 192.0.2.1  
        s=-  
        c=IN IP4 192.0.2.1  
        t=0 0  
        a=pmft: T38
        m=audio 3456 RTP/AVP 18 96 97
        a=rtpmap:96 RED/8000
        a=fmtp:96 97/97
        a=rtpmap:97 PCMU/8000
        a=gpmd:97 vbd=yes
        a=sqn: 0  
        a=cdsc: 1 audio RTP/AVP 18 96 97
        a=cdsc: 4 image udptl t38
]]>
                                </artwork>
                        </figure> 

   <list><t>
   Note that V.152 requires the use of the session-level "a=pmft" SDP attribute
   in order to express a preference for T.38 over V.152 for fax handling.
   </t></list>

   <t>Step 3:</t>

  <list><t>
   The originating Call Agent sends a SIP INVITE message with the SDP to the 
   terminating Call Agent.</t></list>

   <t>Step 4:</t>

   <list><t>
   The terminating Call Agent issues a CreateConnection command to the
   terminating gateway, instructing it to use G.729 media encoding and to use 
   either the strict T.38 procedure or the gateway procedure.  Consequently, 
   the Call Agent requests notification of the "t38", "gwfax", "gwvbd", and 
   "nopvbd" events. Again, the Call Agent authorizes the negotiation of G.711u 
   as a VBD codec with a redundancy level of one:</t></list>
    
                        <figure title="">
                                <artwork><![CDATA[
  CRCX 2000 ds/ds1-1/2@gw-t.whatever.net MGCP 1.0
  C: 2 
  L: a:G729;RED;PCMU, gpmd/gpmd:"PCMU vbd=yes", fmtp:"RED PCMU/PCMU",
     fxr/fx:t38;gw
  M: sendrecv 
  R: fxr/t38, fxr/gwfax, vbd/gwvbd, vbd/nopvbd 
  X: 20  
  Q: process, loop  
         
  v=0  
  o=- 25678 753849 IN IP4 192.0.2.1  
  s=-  
  c=IN IP4 192.0.2.1  
  t=0 0  
  a=pmft: T38
  m=audio 3456 RTP/AVP 18 96 97
  a=rtpmap:96 RED/8000
  a=fmtp:96 97/97
  a=rtpmap:97 PCMU/8000
  a=gpmd:97 vbd=yes
  a=sqn: 0  
  a=cdsc: 1 audio RTP/AVP 18 96 97
  a=cdsc: 4 image udptl t38
]]>
                                </artwork>
                        </figure> 

   <t>Step 5:</t>

   <list><t>
   The terminating gateway supports T.38, and the RemoteConnectionDescriptor 
   included indicates that the other side supports T.38 as well, so the strict 
   T.38 Call Agent controlled procedure requested can be used.  The terminating
   gateway supports V.152 and redundancy, and the RemoteConnectionDescriptor 
   included indicates that the other side supports V.152 and redundancy, so 
   gateway controlled VBD using V.152 and redundancy can be used for modem and 
   text transmissions.  The terminating gateway sends back a success response 
   with its SDP, which also includes capability, V.152, and redundancy 
   information:</t></list>
    
                        <figure title="">
                                <artwork><![CDATA[
        200 2000 OK 
        I:2 
         
        v=0  
        o=- 25678 753849 IN IP4 192.0.2.2 
        s=-  
        c=IN IP4 192.0.2.2 
        t=0 0  
        a=pmft: T38
        m=audio 1296 RTP/AVP 18 96 97
        a=rtpmap:96 RED/8000
        a=fmtp:96 97/97
        a=rtpmap:97 PCMU/8000
        a=gpmd:97 vbd=yes
        a=sqn: 0  
        a=cdsc: 1 audio RTP/AVP 18 96 97
        a=cdsc: 4 image udptl t38
]]>
                                </artwork>
                        </figure> 

   <t>Step 6:</t>

   <list><t>
   The terminating Call Agent sends back a SIP 200 OK response to the 
   originating Call Agent, which in turn sends a SIP ACK (not shown).
   </t></list>

   <t>Step 7:</t>

   <list><t>
   The originating Call Agent in turn sends a ModifyConnection command 
   to the originating gateway:</t></list>

                        <figure title="">
                                <artwork><![CDATA[
        MDCX 1001 ds/ds1-1/1@gw-o.whatever.net MGCP 1.0  
        C: 1 
        I: 1 
        M: sendrecv 
         
        v=0  
        o=- 25678 753849 IN IP4 192.0.2.2 
        s=-  
        c=IN IP4 192.0.2.2 
        t=0 0  
        a=pmft: T38
        m=audio 1296 RTP/AVP 18 96 97
        a=rtpmap:96 RED/8000
        a=fmtp:96 97/97
        a=rtpmap:97 PCMU/8000
        a=gpmd:97 vbd=yes
        a=sqn: 0  
        a=cdsc: 1 audio RTP/AVP 18 96 97
        a=cdsc: 4 image udptl t38
]]>
                                </artwork>
                        </figure> 

   <list><t>
   The ModifyConnection command does not repeat the LocalConnectionOptions sent
   previously.  As far as fax handling is concerned, the gateway therefore 
   attempts to continue using the current fax handling procedure, i.e., strict 
   Call Agent controlled T.38.  Since the capability information indicates that
   the other side supports T.38, the gateway will in fact be able to use the
   strict Call Agent controlled T.38 procedure.  Since the
   RemoteConnectionDescriptor indicates that the other side supports V.152
   and redundancy, the gateway will in fact be able to use the V.152 VBD
   procedure with redundancy.</t></list>

   <t>Step 8:</t>

   <list><t>
   The gateway acknowledges the command.  At this point, a call is established 
   using G.729 encoding, and if a fax call is detected, the Call Agent 
   controlled T.38 procedure will be initiated. If a modem or text call is 
   detected, the V.152 VBD procedure will be initiated.</t></list>
    
   <t>Steps 9-10:</t>

   <list><t>
   The terminating gateway detects the T.30 CED tone (a.k.a.&nbsp;V.25
   ANS). Since 
   both fax and modem calls can start with this sequence, it is not possible to
   determine that this is a fax call until step 14, where the V.21 fax preamble
   is detected. The terminating gateway begins transmitting RTP packets with
   the negotiated redundant VBD payload type (96).</t>

   <t>The "gwvbd(start)" event occurs, and a Notify command is sent to
   the Call Agent:
   </t></list>

                        <figure title="">
                                <artwork><![CDATA[
        NTFY 2500 ds/ds1-1/2@gw-t.whatever.net MGCP 1.0  
        O: vbd/gwvbd(start, rc=ANS, codec=audio/RED, coord=v152ptsw) 
        X: 20
]]>
                                </artwork>
                        </figure> 

   <t>Step 11:</t>

   <list><t>
   The Call Agent acknowledges the Notify command:</t></list>
    
                        <figure title="">
                                <artwork><![CDATA[
        200 2500 OK
]]>
                                </artwork>
                        </figure> 

   <t>Step 12:</t>

   <list><t>
   Upon receiving an RTP packet with the redundant VBD payload type (96), the 
   originating gateway begins transmitting RTP packets with the redundant VBD 
   payload type.</t>

   <t>The "gwvbd(start)" event occurs, and a Notify command is sent to
   the Call Agent:
   </t></list>

                        <figure title="">
                                <artwork><![CDATA[
        NTFY 1500 ds/ds1-1/1@gw-o.whatever.net MGCP 1.0
        O: vbd/gwvbd(start, rc=PTSW, codec=audio/RED)
        X: 1
]]>
                                </artwork>
                        </figure> 

   <t>Step 13:</t>

   <list><t>
   The Call Agent acknowledges the Notify command:</t></list>

                        <figure title="">
                                <artwork><![CDATA[
        200 1500 OK
]]>
                                </artwork>
                        </figure> 

   <t>Steps 14-15:</t>

   <list><t>
   The terminating gateway detects the V.21 fax preamble.</t>

   <t>The terminating gateway is using the Call Agent controlled T.38 strict
   procedure for fax calls, so the "t38(start)" event occurs, and a
   Notify command is sent to the Call Agent:</t></list>

                        <figure title="">
                                <artwork><![CDATA[
        NTFY 2500 ds/ds1-1/2@gw-t.whatever.net MGCP 1.0
        O: fxr/t38(start)
        X: 20
]]>
                                </artwork>
                        </figure> 

   <t>Step 16:</t>
    
   <list><t>
   The Call Agent acknowledges the Notify command:</t></list>

                        <figure title="">
                                <artwork><![CDATA[
        200 2500 OK
]]>
                                </artwork>
                        </figure> 

   <t>Step 17:</t>

   <list><t>
   The Call Agent then instructs the terminating gateway to change to using the
   "image/t38" MIME type instead:</t></list>

                        <figure title="">
                                <artwork><![CDATA[
        MDCX 2002 ds/ds1-1/2@gw-t.whatever.net MGCP 1.0
        C: 2 
        I: 2 
        L: a:image/t38 
        R: fxr/t38 
        X: 21
]]>
                                </artwork>
                        </figure> 
    
   <list><t>
   Note that the Call Agent is no longer requesting notification of the "gwvbd"
   event.</t></list>

   <t>Step 18:</t>

   <list><t>
   The terminating gateway sends back a success response with its SDP, which
   also includes the "image/t38" media description:</t></list>

                        <figure title="">
                                <artwork><![CDATA[
        200 2002 OK 
    
        v=0  
        o=- 25678 753850 IN IP4 192.0.2.2 
        s=-  
        c=IN IP4 192.0.2.2 
        t=0 0  
        m=image 1296 udptl t38  
        a=sqn: 0  
        a=cdsc: 1 audio RTP/AVP 18 96 97
        a=cpar: a=rtpmap:96 RED/8000
        a=cpar: a=fmtp:96 97/97
        a=cpar: a=rtpmap:97 PCMU/8000
        a=cpar: a=gpmd:97 vbd=yes
        a=cdsc: 4 image udptl t38
]]>
                                </artwork>
                        </figure> 

   <list><t>
   The gwvbd procedure ends due to the media type change. The "gwvbd(stop)" 
   event notification would normally be sent at this point; however, the
   Call Agent is
   no longer requesting notification of the "gwvbd" event. The Call Agent would
   have inferred from the "t38(start)" event that the gwvbd procedure ended.
   </t></list>

   <t>Step 19:</t>

   <list><t>
   The terminating Call Agent sends a re-INVITE to the originating Call Agent 
   with the updated SDP.</t></list>

   <t>Step 20:</t>

   <list><t>
   The originating Call Agent then sends a ModifyConnection command to the 
   originating gateway:</t></list>

                        <figure title="">
                                <artwork><![CDATA[
        MDCX 1003 ds/ds1-1/1@gw-o.whatever.net MGCP 1.0
        C: 1 
        I: 1 
        R: fxr/t38
        X: 2
    
        v=0  
        o=- 25678 753850 IN IP4 192.0.2.2 
        s=-  
        c=IN IP4 192.0.2.2 
        t=0 0  
        m=image 1296 udptl t38  
        a=sqn: 0  
        a=cdsc: 1 audio RTP/AVP 18 96 97
        a=cpar: a=rtpmap:96 RED/8000
        a=cpar: a=fmtp:96 97/97
        a=cpar: a=rtpmap:97 PCMU/8000
        a=cpar: a=gpmd:97 vbd=yes
        a=cdsc: 4 image udptl t38
]]>
                                </artwork>
                        </figure> 

   <t>Step 21:</t>

   <list><t>
   The originating gateway changes to T.38 and sends back a success response 
   with the updated SDP:</t></list>

                        <figure title="">
                                <artwork><![CDATA[
        200 1003 OK
    
        v=0  
        o=- 25678 753850 IN IP4 192.0.2.1  
        s=-  
        c=IN IP4 192.0.2.1  
        t=0 0  
        m=image 3456 udptl t38  
        a=sqn: 0  
        a=cdsc: 1 audio RTP/AVP 18 96 97
        a=cpar: a=rtpmap:96 RED/8000
        a=cpar: a=fmtp:96 97/97
        a=cpar: a=rtpmap:97 PCMU/8000
        a=cpar: a=gpmd:97 vbd=yes
        a=cdsc: 4 image udptl t38
]]>
                                </artwork>
                        </figure> 

   <list><t>
   Again, the gwvbd procedure ends due to the media type change. The
   "gwvbd(stop)" event notification would normally be sent at this point;
   however, the Call Agent is no longer requesting notification of the
   "gwvbd" event.
   </t></list>

   <t>Step 22:</t>

   <list><t>
   The originating Call Agent sends a SIP 200 OK response with the updated SDP 
   to the terminating Call Agent, which in turn sends a SIP ACK (not shown).
   </t></list>

   <t>Step 23:</t>

   <list><t>
   The terminating Call Agent sends a ModifyConnection with the updated SDP to 
   the terminating gateway:</t></list>

                        <figure title="">
                                <artwork><![CDATA[
        MDCX 2002 ds/ds1-1/2@gw-t.whatever.net MGCP 1.0
        C: 2 
        I: 2 

        v=0  
        o=- 25678 753850 IN IP4 192.0.2.1  
        s=-  
        c=IN IP4 192.0.2.1  
        t=0 0  
        m=image 3456 udptl t38  
        a=sqn: 0  
        a=cdsc: 1 audio RTP/AVP 18 96 97
        a=cpar: a=rtpmap:96 RED/8000
        a=cpar: a=fmtp:96 97/97
        a=cpar: a=rtpmap:97 PCMU/8000
        a=cpar: a=gpmd:97 vbd=yes
        a=cdsc: 4 image udptl t38
]]>
                                </artwork>
                        </figure> 

   <t>Steps 24-32:</t>

   <list><t>
   These steps correspond to the Call Agent controlled T.38 strict procedure as
   defined in the MGCP Fax (FXR) package <xref target="RFC5347"/>.
   </t></list>

                </section>

        </section>

        <section anchor="sec-cons" title="Security Considerations">

<t> This document defines two new packages, both of which have security
considerations in two areas:

<list style="numbers">
<t> MGCP signaling message security </t>
<t> Media stream security </t>
</list>
</t>

<t>
From an MGCP signaling security point of view, the MGCP VBD and GPMD packages
define extensions to the basic MGCP signaling specification in accordance with
the procedures specified in MGCP <xref target="RFC3435"/>, and hence the MGCP
signaling security considerations and recommendations provided in Section 5
of <xref target="RFC3435"/> (namely the use of IPsec) apply here as well. Lack
of MGCP signaling integrity protection can in general be detrimental to any
use of MGCP, and the two packages defined here do not change that. From a
confidentiality point of view, the VBD package is not believed to convey any
vulnerable or privacy-sensitive information. The GPMD package is slightly
different inasmuch as it does not define any specific parameters that are
believed to require confidentiality; however, it is a generic parameter that
can carry any codec parameter information, and hence it is possible that
confidential information is conveyed through this parameter. If confidentiality
of any such potential information is a concern, confidentiality protection of
the MGCP signaling MUST be provided as well. It should be noted that Section 8
of <xref target="RFC5406"/> provides considerations for specifying the use of
IPsec that are above and beyond those provided in <xref target="RFC3435"/>;
however, given that the use of IPsec for MGCP applies to all of MGCP,
and not just the MGCP VBD and GPMD packages, we do not specify such additional
detail here.
</t>

<t>
From a media stream security point of view, the MGCP VBD and GPMD packages
again define extensions that rely on the general use of media streams defined
in MGCP <xref target="RFC3435"/>, and hence the MGCP media stream security
considerations and recommendations provided in Section 5.1
of <xref target="RFC3435"/>
apply here as well. Lack of media stream security can in general be
detrimental to any media stream established via MGCP, and the two packages
defined here do not change that. Confidentiality concerns apply as for any
other media stream. Integrity concerns are further compounded by the GPMD
package's use of payload type switching, state signaling events, and media
stream in-band triggers to drive overall Voiceband Data operation: Integrity
protection with replay protection MUST be used to counter these threats.
</t>

<t>
Ideally, there would be a single mandatory-to-implement media stream security
mechanism to provide this integrity protection, and in theory there is, since
MGCP <xref target="RFC3435"/> defines a media stream security
mechanism. However, the standard MGCP media stream security mechanism defined
in <xref target="RFC3435"/> relies on the encryption key ("k=") field
defined in the original SDP specification <xref target="RFC2327"/>, the use of
which is no longer recommended in the current SDP specification <xref
target="RFC4566"/>. In practice, this mechanism has also seen very limited
implementation, and hence there is not much value in relying on it. Still, the
integrity protection requirement remains, and there are several different ways
this can be achieved:</t>

<t>
<list style="hanging">

<t hangText="Secure RTP:  ">For RTP-based media streams, the use of Secure RTP
<xref target="RFC3711"/> with an associated key management mechanism is
generally preferred at the time of this writing; however, such a mechanism has
currently not been defined for MGCP.</t>

<t hangText="PacketCable Security:  "> The PacketCable Network-Based Call
Signaling Protocol <xref target="NCS"/> defines another media stream security
mechanism that is generally supported by PacketCable-compliant
implementations. Implementations targeted for those environments SHOULD
implement this security mechanism.  </t>

<t hangText="Lower-Level Security:  "> In the absence of a common media stream
security mechanism supported by both endpoints, a lower-level security
mechanism, e.g., IPsec, MUST be used. Note that since there is no inherent MGCP
signaling support for such a lower-level security mechanism, it MUST be
configured by other means.</t>

</list>
</t>

        </section>

        <section anchor="iana-cons" title="IANA Considerations">
                <t>
   The IANA has registered the following MGCP packages:

                        <figure title="">
                                <artwork><![CDATA[
   Package Title                               Name     Version
   -------------                               ----     -------
   Voiceband Data                              VBD      0
   General-Purpose Media Descriptor Parameter  GPMD     0
]]>                                </artwork>
                        </figure> 
                </t>
        </section>

<section title="Acknowledgements">
<t>
   Several people have contributed to the development of the MGCP VBD and GPMD 
   packages and the use of the MIME subtypes "RED" and "parityfec" with the FM 
   package for VBD with redundancy and FEC. In particular, the authors would 
   like to thank Flemming Andreasen, John Atkinson, Bill Foster, and the
   CableLabs PacketCable TGCP/NCS focus team for their contributions. Many
   thanks to Billy Hare for doing a thorough review of this document. 

</t>
<t>
Joe Stone and Rajesh Kumar are the main authors of this document; security
considerations and final editor role were provided by Flemming
Andreasen. Sandeep Sharma was editor on earlier versions of the document. 
</t>

</section>

</middle>

<back>
        <references title="Normative References">
                &rfc2119;
                &rfc3550;
                &rfc3435;
                &rfc2198;
                &rfc4566;
                &rfc4733;
                &rfc4734;

<reference anchor='RFC5234'>
<front>
<title>Augmented BNF for Syntax Specifications: ABNF</title>
<author initials='D.' surname='Crocker' fullname='D. Crocker' role="editor">
<organization /></author>
<author initials='P.' surname='Overell' fullname='P. Overell'>
<organization /></author>
<date year='2008' month='January' />
</front>
<seriesInfo name='STD' value='68' />
<seriesInfo name='RFC' value='5234' />
</reference>

<reference anchor='RFC5109'>
<front>
<title>RTP Payload Format for Generic Forward Error Correction</title>
<author initials='A.' surname='Li' fullname='A. Li' role="editor">
<organization /></author>
<date year='2007' month='December' />
</front>
<seriesInfo name='RFC' value='5109' />
</reference>

                &rfc3407;
                &rfc3660;
                &rfc5347;

              <reference anchor='V1501'>
                <front>
                   <title>
                     Modem-over-IP networks: Procedures for the end-to-end connection of V-series DCEs
                   </title>
                   <author>
                     <organization>
                     International Telecommunication Union - Telecommunication Standardization Sector 
                     </organization>
                   </author>
                   <date month='January' year='2003' />
                 </front>
                <seriesInfo name="ITU-T" value="Recommendation V.150.1" />
               </reference>

               <reference anchor='V152'>
                 <front>
                   <title>
                   Procedures for supporting Voice-Band Data over IP Networks
                   </title>
                   <author>
                     <organization>
                     International Telecommunication Union - Telecommunication Standardization Sector 
                     </organization>
                   </author>
                   <date month='January' year='2005' />
                 </front>
                <seriesInfo name="ITU-T" value="Recommendation V.152" />
               </reference>

               <reference anchor='H2482'>
                  <front>
                    <title>
                    Gateway control protocol: Facsimile, text conversation and call discrimination packages
                    </title>
                    <author>
                      <organization>International Telecommunication Union -
Telecommunication Standardization Sector
                      </organization>
                    </author>
                    <date month='November' year='2000' />
                  </front>
                <seriesInfo name="ITU-T" value="Recommendation H.248.2" />
               </reference>


        <reference anchor='V1501A1'>
            <front>
               <title>
Modem-over-IP networks: Procedures for the end-to-end connection of V-series
DCEs, Amendment 1: Modification to SSE reason identifier codes to support voice
band data and text relay
               </title>
               <author>
                 <organization>International Telecommunication Union -
                 Telecommunication Standardization Sector
                 </organization>
               </author>
               <date month='January' year='2005' />
            </front>
           <seriesInfo name="ITU&nbhy;T" value="Recommendation V.150.1 Amendment 1" />
         </reference>
        
         <reference anchor='NCS'>
           <front>
             <title>
             PacketCable(TM) 1.5 Specifications: Network-Based Call Signaling Protocol, PKT-SP-NCS1.5-I03-070412
             </title>
             <author>
                 <organization abbrev='PacketCable'>
                 CableLabs(R)
                 </organization>
             </author>
             <date month='April' year='2007' />
           </front>
         </reference>

        </references>


        <references title="Informative References">
                &rfc2327;
                &rfc3261;
                &rfc3711;
                &rfc5406;


                <reference anchor='T38'>
                  <front>
                    <title>
                    Procedures for real-time Group 3 facsimile communication over IP networks
                    </title>
                    <author>
                      <organization>
                      International Telecommunication Union - Telecommunication Standardization Sector 
                      </organization>
                    </author>
                    <date month='April' year='2004' />
                  </front>
                 <seriesInfo name="ITU&nbhy;T" value="Recommendation T.38" />
                </reference>

        </references>
</back>

</rfc>
