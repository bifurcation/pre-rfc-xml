<?xml version="1.0" encoding="US-ASCII"?>

<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!ENTITY RFC2119 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml">
<!ENTITY RFC5944 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5944.xml">
<!ENTITY RFC3519 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3519.xml">
<!ENTITY RFC2003 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2003.xml">
<!ENTITY RFC2004 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2004.xml">
<!ENTITY RFC2784 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2784.xml">
<!ENTITY RFC5177 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5177.xml">
<!ENTITY RFC6275 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6275.xml">
<!ENTITY RFC3543 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3543.xml">
<!ENTITY RFC1035 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.1035.xml">
<!ENTITY RFC4282 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4282.xml">
<!ENTITY RFC4086 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4086.xml">
<!ENTITY RFC5226 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5226.xml">
]>

<?rfc toc="yes"?>
<?rfc tocompact="yes"?>
<?rfc tocdepth="3"?>
<?rfc tocindent="yes"?>
<?rfc symrefs="yes"?>
<?rfc sortrefs="yes"?>
<?rfc comments="yes"?>
<?rfc inline="yes"?>
<?rfc compact="yes"?>
<?rfc subcompact="no"?>
<?rfc rfcedstyle="yes"?>

<rfc category="exp" number="6521" ipr="trust200902" submissionType="IETF" consensus="yes">

  <front>
    <title abbrev="HAaRO">Home Agent-Assisted Route Optimization between
    Mobile IPv4 Networks</title>

    <author fullname="Antti Makela" initials="A." surname="Makela">
      <organization abbrev="Aalto University/Comnet">Aalto University</organization>
      <address>
        <postal>
          <street>Department of Communications and Networking (Comnet)</street>
          <street>P.O. Box 13000</street>
          <code>FIN-00076 Aalto</code>
          <country>FINLAND</country>
        </postal>
        <email>antti.t.makela@iki.fi</email>
      </address>
    </author>

    <author fullname="Jouni Korhonen" initials="J." surname="Korhonen">
      <organization abbrev="Nokia Siemens Networks">Nokia Siemens
      Networks</organization>
      <address>
        <postal>
          <street>Linnoitustie 6</street>
          <code>FI-02600 Espoo</code>
          <country>FINLAND</country>
        </postal>
        <email>jouni.nospam@gmail.com</email>
      </address>
    </author>

    <date month="February" year="2012" />

    <abstract>
      <t>This document describes a home agent-assisted route optimization
      functionality for the IPv4 Network Mobility Protocol. The function is
      designed to facilitate optimal routing in cases where all nodes are
      connected to a single home agent; thus, the use case is route
      optimization within a single organization or similar entity. The
      functionality enables the discovery of eligible peer
      nodes (based on information received from the home agent) and their
      network prefixes, and the establishment of a direct tunnel between
      such nodes.</t>

    </abstract>
  </front>

  <middle>
    <section anchor="Background" title="Introduction and Motivations">
      <t>Traditionally, there has been no method for route optimization in
      <xref target="RFC5944">Mobile IPv4</xref> apart from an early attempt
      <xref target="MIP-RO"></xref>. Unlike <xref
      target="RFC6275">Mobile IPv6</xref>, where route optimization has been
      included from the start, with Mobile IPv4, route optimization hasn't been
      addressed in a generalized scope.</t>

      <t>Even though general route optimization may not be of interest in the
      scope of IPv4, there are still specific applications for route
      optimization in Mobile IPv4. This document proposes a method to optimize
      routes between networks behind Mobile Routers (MRs), as defined by <xref
      target="RFC5177">Network Mobility (NEMO)</xref>. Although NAT and
      the pending shortage of
      IPv4 addresses make widespread deployment of end-to-end route
      optimization infeasible, using route optimization from MR
      to MR is still a practical scenario. Note that the method
      specified in this document is only for route optimization between MRs;
      any network prefix not advertised by an MR would
      still be routed via the home agent, although an MR could advertise very
      large address spaces, e.g., by acting as an Internet gateway.</t>

      <t>A particular use case concerns setting up redundant yet economical
      enterprise networks. Recently, a trend has emerged where customers
      prefer to maintain connectivity via multiple service providers. Reasons
      include redundancy, reliability, and availability issues. These kinds of
      multihoming scenarios have traditionally been solved by using such
      technologies as multihoming BGP. However, a more lightweight and
      economical solution is desirable.</t>

      <t>From a service provider perspective, a common topology for an
      enterprise customer network consists of one to several sites (typically
      headquarters and various branch offices). These sites are typically
      connected via various Layer 2 technologies (ATM or Frame Relay
      Permanent Virtual Circuits (PVCs)),
      MPLS VPNs, or Layer 3 site-to-site VPNs. With a Service Level Agreement
      (SLA), a customer can obtain very reliable and well-supported intranet
      connectivity. However, compared to the cost of "consumer-grade"
      broadband Internet access, the SLA-guaranteed version can be considered
      very expensive. These consumer-grade options, however, are not a reliable
      approach for mission-critical applications.</t>

      <t>Mobile IP, especially MRs, can be used to improve
      reliability of connectivity even when implemented over consumer-grade
      Internet access. The customer becomes a client for a virtual service
      provider, which does not take part in the actual access technology. The
      service provider has a backend system and an IP address pool that it
      distributes to customers. Access is provided by multiple, independent,
      possibly consumer-grade ISPs, with Mobile IP providing seamless
      handovers if service from a specific ISP fails. The drawback of this
      solution is that it creates a star topology; all Mobile IP tunnels end
      up at the service provider-hosted home agent, causing a heavy load at the
      backend. Route optimization between mobile networks addresses this
      issue, by taking the network load off of the home agent and the
      backend.</t>

      <t>An example network is pictured below:</t>

      <figure title="Virtual Service Provider Architecture Using NEMOv4">
        <preamble></preamble>

        <artwork><![CDATA[                    +----------------------------+
                    |  Virtual Operator Backend  |
                    +------------+         +-----+
                    | Home Agent |         | AAA |
                    +------------+---------+-----+
                                 |
                               .--. 
                             _(.   `)
                           _(   ISP `)_
                          (   Peering  `)
                         ( `  . Point )  )
                          `--(_______)--'
                    ____ /     |         \
                   /           |          \
                .--.         .--.         .--.
              _(    `.     _(    `.     _(    `.
             (  ISP A )   (  ISP B )   (  ISP C )
            ( `  .  )  ) ( `  .  )  ) ( `  .  )  )
             `--(___.-'   `--(___.-'   `--(___.-'   
                 |     ______/    \       /
                 |    /            \     /
                 |   /              \   /
               +----+               +----+
               |MR A|               |MR B|
               +----+               +----+
                 |                    |
                .--.                 .--.
              _(    `.             _(    `.
             ( Site A )           ( Site B )
            ( `  .  )  )         ( `  .  )  )
             `--(___.-'           `--(___.-'   
]]></artwork>

        <postamble></postamble>
      </figure>

      <t>In this example case, the organization network consists of two sites
      that are connected via two ISPs for redundancy reasons. Mobile IP allows
      fast handovers without the problems of multihoming and BGP peering
      between each individual ISP and the organization. The traffic,
      however, takes a non-optimal route through the virtual operator
      backend.</t>

      <t>Route optimization addresses this issue, allowing traffic between
      Sites A and B to flow directly through ISP B's network, or in case of a
      link failure, via the ISP peering point (such as the Metropolitan Area
      Ethernet (MAE), e.g., MAE-West). The backend will not suffer from
      heavy loads.</t>

      <t>The specification in this document is meant to be Experimental, with
      the primary design goal of keeping the load on the backend to a minimum.
      Additional design goals include extensibility to a more generalized
      scope, such as not requiring all MRs to be homed on the same home agent.
      Experiences are mostly sought regarding applicability to real-world
      operations,
      and protocol-specific issues such as signaling scalability, interworking
      with other Mobile IP extensions not specifically addressed in this
      document, and behavior of end-user applications over route-optimized
      paths.</t>

      <t>The aforementioned use case is the original application. Moving this
      specification to Standards Track should be considered
      after enough deployment experience
      has been gathered. Besides the aforementioned issues, additional
      elements that might require refinement based on real-world experiences
      are delivery of information on networks managed by peer MRs;
      conducting MR &lt;-&gt; MR authentication; reaction to, and recovery
      methods for, connectivity breakdowns and other break-before-make topology
      changes; keepalive timer intervals; formats of signaling extensions;
      behavior in NAT/firewalled environments; and the prefix and realm
      compression algorithms.</t>
    </section>

    <section title="Terms and Definitions">
      <t>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
      "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
      document are to be interpreted as described in <xref
      target="RFC2119">RFC 2119</xref>.</t>

      <t><list hangIndent="5" style="hanging">
          <t hangText="Care-of Address (CoA)"><vspace blankLines="1" />
          <xref target="RFC5944">RFC 5944</xref> defines a care-of address
          as the
          termination point of a tunnel toward a mobile node, for datagrams
          forwarded to the mobile node while it is away from home. The
          protocol can use two different types of CoA: a "foreign
          agent care-of address", which is an address of a foreign agent with
          which the mobile node is registered, and a "co-located care-of
          address", which is an externally obtained local address that the
          mobile node has associated with one of its own network interfaces.
          However, in the case of Network Mobility, foreign agents are not
          used, so no foreign CoAs are used either.</t>

          <t hangText="Correspondent Router (CR)"><vspace blankLines="1" />
          <xref target="RFC5944">RFC 5944</xref> defines a
          correspondent node as a peer with which a mobile node is
          communicating. A CR is a peer MR that
          MAY also represent one or more entire networks.</t>

          <t hangText="Home Address (HoA)"><vspace blankLines="1" />
          <xref target="RFC5944">RFC 5944</xref> defines a home address
          as an IP
          address that is assigned for an extended period of time to a mobile
          node. It remains unchanged regardless of where the node is attached
          to the Internet.</t>

          <t hangText="Home Agent (HA)"><vspace blankLines="1" />
          <xref target="RFC5944">RFC 5944</xref> defines a home agent as a
          router on a
          mobile node's home network that tunnels datagrams for delivery to
          the mobile node when it is away from home and maintains current
          location information for the mobile node. For this application, the
          "home network" sees limited usage.</t>

          <t hangText="Host Network Prefix"><vspace blankLines="1" />A
          host network prefix is a network
          prefix with a mask of /32, e.g., 192.0.2.254/32, consisting of a
          single host.</t>

          <t hangText="Mobility Binding"><vspace blankLines="1" />
          <xref target="RFC5944">RFC 5944</xref> defines Mobility Binding
          as the
          association of an HoA with a CoA, along with the
          lifetime remaining for that association.</t>

          <t hangText="Mobile Network Prefix"><vspace blankLines="1" />
          <xref target="RFC5177">RFC 5177</xref> defines a mobile network
          prefix as the network prefix of
          the subnet delegated to an MR as the mobile network.</t>

          <t hangText="Mobile Router (MR)"><vspace blankLines="1" />
          <xref target="RFC5177">RFC 5177</xref> and
          <xref target="RFC5944">RFC 5944 </xref> define a mobile router
          as a mobile node that can be a router that is responsible for the
          mobility of one or more entire networks moving together, perhaps on
          an airplane, a ship, a train, an automobile, a bicycle, or a
          kayak.</t>

          <t hangText="Route Optimization Cache"><vspace blankLines="1" />A
          Route Optimization Cache is defined as a data
          structure, maintained by MRs, containing possible destinations for
          route optimization. The cache contains information
          (HoAs) on potential CRs and their associated mobile networks.</t>

          <t hangText="Return Routability (RR)"><vspace blankLines="1" />
          Return routability is defined as a procedure to bind an MR's
          HoA to a CoA on a CR with a degree of trust.</t>

          <t hangText="| (Concatenation)"><vspace blankLines="1" />Some
          formulas in this specification use the symbol "|" to indicate
          bytewise concatenation, as in A | B.&nbsp; This concatenation
          requires
          that all of the octets of the datum A appear first in the result,
          followed by all of the octets of the datum B.</t>

          <t hangText="First (size, input)"><vspace blankLines="1" />Some
          formulas in this specification use a functional form "First (size,
          input)" to indicate truncation of the "input" data so that only the
          first "size" bits remain to be used.</t>
        </list></t>
    </section>

    <section anchor="MIP4RO"
             title="Mobile IPv4 Route Optimization between Mobile Networks">
      <t>This section describes the changed functionality of the HA and
      the MR compared to the base NEMOv4 operation defined in <xref
      target="RFC5177"></xref>. The basic premise is still the same; MRs,
      when registering with the HA, may inform the HA
      of the mobile network prefixes they are managing (explicit mode), or the
      HA already knows the prefix assignments. However, instead of
      prefix &lt;-&gt; MR mapping information only remaining on the
      HA and the single MR, this information will now be
      distributed to the other MRs as well.</t>

      <t>Home agent-assisted route optimization is primarily intended for
      helping to optimize traffic patterns between multiple sites in a single
      organization or administrative domain; however, extranets can also be
      reached with optimized routes, as long as all MRs connect to
      the same HA. The procedure aims to maintain backward
      compatibility; with legacy nodes or routers, full connectivity is always
      preserved, even though optimal routing cannot be guaranteed.</t>

      <t>The scheme requires an MR to be able to receive messages
      from other MRs unsolicited -- that is, without first
      initiating a request. This behavior -- accepting unsolicited messages --
      is similar to the <xref target="RFC3543">registration revocation
      procedure</xref>. Many of the mechanisms are the same, including the
      fact that advertising route optimization support upon registration
      implies the capability to receive Registration Requests and Return
      Routability messages from other MRs.</t>

      <t>Compared to IPv6, where mobile node &lt;-&gt; correspondent node
      bindings are maintained via Mobility Routing header and home address
      options, Mobile IPv4 always requires the use of tunnels. Therefore,
      inter-mobile-router tunnel establishment has to be conducted.</t>

      <section anchor="ROUTING"
               title="Maintaining Route Optimization Information">
        <t>During registration, a registering MR MAY request
        information on route-optimizable network prefixes. The MR
        MAY also allow redistribution of information on its managed network
        prefixes regardless of whether they are explicitly registered or
        already configured. These are indicated with a Mobile Router Route
        Optimization Capability Extension; see <xref target="MRROCAP"></xref>.
        If the HA accepts the request for route optimization, this is
        indicated with a <xref target="ROR">Route Optimization Reply
        Extension</xref> in the Registration Reply.</t>

        <t>Note that the redistribution of network prefix information from the
        HA happens only during the registration signaling. There are
        no "routing updates" from the HA except during
        re-registrations triggered by handovers, registration timeouts, and
        specific solicitation. The solicitation re-registration MAY occur if a
        CR receives a Registration Request from an unknown
        MR (see <xref target="INTERMOBILEREG"></xref>).</t>

        <section anchor="PREFIX_INFO"
                 title="Advertising Route-Optimizable Prefixes">
          <t>As noted, an HA that supports NEMO already maintains
          information on which network prefixes are reachable behind specific
          MRs. The only change to this functionality is that this
          information can now be distributed to other MRs upon
          request. This request is implied by including a
          <xref target="MRROCAP">Route Optimization Capability Extension</xref>
          and setting the 'R' bit.</t>

          <t>When an HA receives a Registration Request, standard
          authentication and authorization procedures are conducted.</t>

          <t>If registration is successful and the Route Optimization
          Capability Extension was present in the Registration
          Request, the reply message MUST include the <xref target="ROR">Route
          Optimization Reply Extension</xref> to indicate that the Route
          Optimization Capability Extension was understood. Furthermore, the
          extension also informs the MR whether NAT was detected
          between the HA and the MR using the procedure in
          <xref target="RFC3519">RFC 3519</xref>, which is based on the
          discrepancy between the requester's indicated CoA and
          the packet's source address.</t>

          <t>The reply message MAY also include one Route Optimization Prefix
          Advertisement Extension, which informs the MR of existing
          mobile network prefixes and the MRs that manage them, if
          eligible for redistribution. The networks SHOULD be included in
          order of priority, with the prefixes determined, by policy, as most
          desirable targets for route optimization listed first. The extension
          is constructed as shown in <xref target="ROPREFIXAD"></xref>. The
          extension consists of a list where each MR, identified by
          its HoA, is listed with corresponding prefix(es) and their
          respective realm(s).</t>

          <t>Each network prefix can be associated with a realm <xref
          target="RFC4282"></xref>, usually in the form
          'organization.example.com'. Besides the routers in the customer's
          own organization, the prefix list may also include other MRs,
          e.g., a default prefix (0.0.0.0/0) pointing toward an
          Internet gateway for Internet connectivity or additional prefixes
          belonging to possible extranets. The realm information can be used
          to make policy decisions on the MR, such as preferring
          optimization within a specific realm only. Furthermore, the unique
          realm information can be used to differentiate between overlapping
          address spaces utilized by the same or different organizations
          concurrently and adjusting forwarding policies accordingly.</t>

          <t>In a typical scenario, where network prefixes are allocated to
          MRs connecting to a single HA, the prefixes are
          usually either continuous or at least very close to each other. Due
          to these characteristics, an optional prefix compression mechanism
          is provided. Another optional compression scheme is in use for
          realm information, where realms often share the same higher-level
          domains. These compression mechanisms are further explained in <xref
          target="compressionsformats"></xref>.</t>

          <t>Upon receiving a Registration Reply with a Route Optimization
          Prefix Advertisement Extension, the MR SHALL insert the
          MR HoAs included in the extension as
          host-prefixes to the local Route Optimization Cache if they do not
          already exist. If present, any additional prefix information SHALL
          also be inserted into the Route Optimization Cache.</t>

          <t>The MR MAY discard entries from a desired starting
          point onward, due to memory or other policy-related constraints.
          The intention of listing the prefixes in order of priority is to
          provide implicit guidance for this decision. If the capacity of the
          device allows, the MR SHOULD use information on all
          advertised prefixes.</t>
        </section>

        <section anchor="ROCACHE" title="Route Optimization Cache">
          <t>MRs supporting route optimization will maintain a
          Route Optimization Cache.</t>

          <t>The Route Optimization Cache contains mappings between potential
          CR HoAs, network(s) associated with each HoA,
          information on reachability related to NAT and other divisions, and
          information related to the RR procedure. The cache is
          populated based on information received from the HA in Route
          Optimization Prefix Advertisement Extensions and in
          registration messages from
          CRs. Portions of the cache may also be configured
          statically.</t>

          <t>The Route Optimization Cache contains the following information
          for all known CRs. Note that some fields may
          contain multiple entries. For example, during handovers, there may
          be both old and new CoAs listed.</t>

          <t><list hangIndent="10" style="hanging">
              <t hangText="CR-HoA"><vspace blankLines="1" />Correspondent
              router's home address.
              Primary key identifying each CR.</t>

              <t hangText="CR-CoA(s)"><vspace blankLines="1" />Correspondent
              router's care-of address(es). May be empty if none known.
              Potential tunnel's destination address(es).</t>

              <t hangText="MR-CoA"><vspace blankLines="1" />Mobile router's
              care-of address currently used with this CR.
              Tunnel's source address.</t>

              <t hangText="Tunnels"><vspace blankLines="1" />Tunnel
              interface(s) associated with this CR. The
              tunnel interface itself handles all the necessary operations to
              keep the tunnel operational, e.g., sending keepalive messages
              required by UDP encapsulation.</t>

              <t hangText="NAT states"><vspace blankLines="1" />A table of
              booleans. Contains entries for all pairs of potential
              MR-CoAs and CR-CoAs that are known to require NAT awareness.
              The table is populated either statically or based on
              information received during operation. A setting of
              true indicates that the MR can establish a UDP tunnel
              toward the CR, using this pair of CoAs. A received
              advertisement can indicate that the value should be
              set to false for all of the respective CR's CoAs. Settings in
              this table affect tunnel establishment direction;
              see <xref target="TUNNELS"></xref> and the registration
              procedure when deciding which CoAs to include in the
              Care-of Address Extension in the Registration Reply. 
              The existence of an entry mandates the use of UDP encapsulation.
              </t>

              <t hangText="RRSTATEs"><vspace blankLines="1" />Return
              routability state for each CR-HoA - MR-CoA pair. States are
              INACTIVE, IN PROGRESS, and ACTIVE. If state is INACTIVE, the RR
              procedure must be completed before forwarding
              route-optimized traffic. If state is IN PROGRESS or ACTIVE, the
              information concerning this CR MUST NOT be
              removed from the Route Optimization Cache as long as a tunnel
              to the CR is established.</t>

              <t hangText="KRms"><vspace blankLines="1" />Registration
              management key for each CR-HoA - MR-CoA pair. This field is only
              used if configured statically -- if the KRm was computed using
              the RR procedure, it is calculated in situ
              based on
              nonces and the router key. If configured statically, RRSTATE is
              permanently set to ACTIVE.</t>

              <t hangText="Care-of nonce indices"><vspace blankLines="1" />If
              the KRm was established with the RR procedure,
              contains the care-of nonce index for each MR-CoA - CR-HoA
              pair.</t>

              <t hangText="Care-of keygen token"><vspace blankLines="1" />If
              the KRm was established with the RR procedure,
              contains the care-of keygen token for each MR&nbhy;CoA - CR-HoA
              pair.</t>

              <t hangText="Home nonce indices"><vspace blankLines="1" />If the
              KRm was established with the RR procedure,
              contains the Home nonce index for each CR-HoA.</t>

              <t hangText="Home keygen token"><vspace blankLines="1" />If the
              KRm was established with the RR procedure,
              contains the home keygen token for each CR-HoA.</t>

              <t hangText="Network prefixes"><vspace blankLines="1" />A list
              of destination network prefixes reachable via this CR.
              Includes network and prefix length, e.g., 192.0.2.0/25.
              Always contains at least a single entry: the CR-HoA host network
              prefix in the form of 192.0.2.1/32.</t>

              <t hangText="Realms"><vspace blankLines="1" />Each prefix may be
              associated with a realm. May also be empty, if the realm is not
              provided by advertisement or configuration.</t>

              <t hangText="Prefix_Valid"><vspace blankLines="1" />Boolean
              field for each prefix - CR-HoA pair, which is set to true if
              this prefix's owner has been confirmed. The host network prefix
              consisting of the CR itself does not need
              validation beyond the RR procedure. For other
              prefixes, the confirmation is done by soliciting the information
              from the HA. Traffic for prefixes that have unconfirmed ownership
              should not be routed through the tunnel.</t>
            </list></t>

          <t>Information that is no longer valid due to expirations or
          topology changes MAY be removed from the Route Optimization Cache as
          desired by the MR.</t>
        </section>
      </section>

      <section anchor="RRP" title="Return Routability Procedure">
        <t>The purpose of the RR procedure is to establish
        CoA &lt;-&gt; HoA bindings in a trusted manner.
        The RR procedure for Mobile IPv6 is described in <xref
        target="RFC6275"></xref>. The same principles apply to the Mobile IPv4
        version: two messages are sent to the CR's HoA -- one via the
        HA using the MR's HoA, and
        the other directly from the MR's CoA, with two responses
        coming through the same routes. The registration management key is derived
        from token information carried on these messages. This registration
        management key (KRm) can then be used to authenticate Registration
        Requests (comparable to Binding Updates in Mobile IPv6).</t>

        <t>The RR procedure is a method provided by Mobile
        IP to establish the KRm in a relatively lightweight fashion.
        If desired, the KRms can be configured on MRs statically,
        or by using a desired external secure key provisioning mechanism. If
        KRms are known to the MRs via some other mechanism, the
         RR procedure can be skipped. Such provisioning
        mechanisms are out of scope for this document.</t>

        <t>The main assumption on traffic patterns is that the MR
        that initiates the RR procedure can always send outbound messages,
        even when behind a NAT or firewall. This basic assumption made for NAT
        Traversal in <xref target="RFC3519"></xref> is also applicable here.
        In the case where the CR is behind such obstacles, it
        receives these messages via the reverse tunnel to the CR's HoA;
        thus, any problem regarding the CR's connectivity is
        addressed during registration with the HA.</t>

        <t>The RR procedure consists of four Mobile IP
        messages: Home Test Init (HoTI), Care-of Test Init (CoTI),
        Home Test (HoT), and Care-of Test (CoT). They are constructed as
        shown in Sections <xref target="HOTI" format="counter"></xref>
        through <xref target="CoT" format="counter"></xref>. If the
        MR has included
        the Mobile Router Route Optimization Capability Extension in its
        Registration Request, it MUST be able to accept Return Routability
        messages. The messages are delivered as Mobile IP signaling packets.
        The destination address of the HoTI and CoTI messages is set to the
        CR's HoA, with the sources being the MR's HoA and CoA,
        respectively.</t>

        <t>The RR procedure begins with the MR
        sending HoTI and CoTI messages, each containing a (different) 64-bit
        random value -- the cookie. The cookie is used to bind a specific
        signaling exchange together.</t>

        <t>Upon receiving the HoTI or CoTI message, the CR
        MUST have a secret correspondent router key (Kcr) and nonce.
        If it does not have this material
        yet, it MUST produce it before continuing with the RR
        procedure.</t>

        <t>The CR responds to HoTI and CoTI messages by
        constructing HoT and CoT messages, respectively, as replies. The HoT
        message contains a home init cookie, current home nonce index, and home
        keygen token. The CoT message contains a care-of init cookie, current
        care-of nonce index, and care-of keygen token.</t>

        <t>The home keygen token is constructed as follows:</t>

        <t>Home keygen token = First (64, HMAC_SHA1 (Kcr, (home address |
        nonce | 0)))</t>

        <t>The care-of keygen token is constructed as follows:</t>

        <t>Care-of keygen token = First (64, HMAC_SHA1 (Kcr, (care-of address
        | nonce | 1)))</t>

        <t>Note that the CoA in this case is the source address of
        the received CoTI message packet. The address may have changed
        in transit due to network address translation. This does not affect the
        registration process; subsequent Registration Requests are expected to
        arrive from the same translated address.</t>

        <t>The RR procedure SHOULD be initiated when the Route
        Optimization Cache's RRSTATE field for the desired CoA
        with the target CR is INACTIVE. If the state was
        INACTIVE, the state MUST be set to IN PROGRESS when the RR
        procedure is initiated. In the case of a handover occurring, the MR
        SHOULD only send a CoTI message to obtain a new care-of keygen
        token; the home keygen token may still be valid. If the reply to a
        registration indicates that one or both of the tokens have expired, the
        RRSTATE MUST be set to INACTIVE. The RR procedure may
        then be restarted as needed.</t>

        <t>Upon completion of the RR procedure, the Route
        Optimization Cache's RRSTATE field is set to ACTIVE, allowing for
        Registration Requests to be sent. The MR will establish a
        KRm. By default, this will be done using the SHA1 hash algorithm,
        as follows:</t>

        <t>KRm = SHA1 (home keygen token | care-of keygen token)</t>

        <t>When de-registering (by setting the Registration Request's lifetime
        to zero), the care-of keygen token
        is not used. Instead, the KRm is generated as follows:</t>

        <t>KRm = SHA1 (home keygen token)</t>

        <t>As in Mobile IPv6, the CR does not maintain any
        state for the MR until after receiving a Registration
        Request.</t>

        <section title="Router Keys">
          <t>Each MR maintains a Kcr,
          which MUST NOT be shared with any other entity. The Kcr is used for
          authenticating peer MRs in the situation where an MR
          is acting as a CR. This is analogous to the node key (Kcn) in
          Mobile IPv6. A CR uses its router key to verify
          that the keygen tokens sent by a peer MR in a
          Registration Request are the CR's own. The router key MUST be a
          random number, 16 octets in length, generated with a good random
          number generator <xref target="RFC4086"></xref>.</t>

          <t>The MR MAY generate a new key at any time to avoid
          persistent key storage. If desired, it is RECOMMENDED that the
          keys be expired in conjunction with nonces; see <xref target="Updating"></xref>.
          </t>
        </section>

        <section anchor="NONCES" title="Nonces">
          <t>Each MR also maintains one or more indexed nonces.
          Nonces SHOULD be generated periodically with a good random number
          generator <xref target="RFC4086"></xref>. The MR may use
          the same nonces with all MRs. Nonces MAY be of any
          length, with the RECOMMENDED length being 64 bits.</t>
        </section>

        <section anchor="Updating" title="Updating Router Keys and Nonces">
          <t>The router keys and nonce updating guidelines are similar to those
          for Mobile IPv6. MRs keep both the current nonce and the small
          set of valid previous nonces whose lifetimes have not expired yet.
          A nonce should remain valid for at least MAX_TOKEN_LIFETIME seconds
          (see <xref
          target="PROTOCOLCONSTANTS"></xref>) after it has first been
          used in constructing an RR response. However, the
          CR MUST NOT accept nonces beyond
          MAX_NONCE_LIFETIME seconds (see <xref
          target="PROTOCOLCONSTANTS"></xref>) after the first use. As the
          difference between these two constants is 30 seconds, a convenient
          way to enforce the above lifetimes is to generate a new nonce every
          30 seconds. The node can then continue to accept keygen tokens that
          have been based on the last 8 (MAX_NONCE_LIFETIME / 30) nonces. This
          results in keygen tokens being acceptable MAX_TOKEN_LIFETIME to
          MAX_NONCE_LIFETIME seconds after they have been sent to the mobile
          node, depending on whether the token was sent at the beginning or
          end of the first 30&nbhy;second period. Note that the correspondent node
          may also attempt to generate new nonces on demand, or only if the
          old nonces have been used. This is possible as long as the
          correspondent node keeps track of how long ago the nonces
          were used for the first time and does not generate new nonces on
          every return routability request.</t>

          <t>If the Kcr is being updated, the update SHOULD be done at the same
          time as the nonce is updated. This way, nonce indexes can be used to
          refer to both Kcrs and nonces.</t>
        </section>
      </section>

      <section title="Mobile-Correspondent Router Operations">
        <t>This section deals with the operation of mobile and correspondent
        routers performing route optimization. Note that in the context of
        this document, all routers work as both MR and CR.
        The term "mobile router" applies to the router initiating the
        route optimization procedure, and "correspondent router" indicates the
        peer router.</t>

        <t>There are two issues regarding IPv4 that are different when compared
        to Mobile IPv6 route optimization. First of all, since Mobile
        IPv4 always uses tunnels, there must be a tunnel established between
        the MR's and the CR's CoAs. The CR learns of
        the MR's CoA, because it is included in the Registration Request.
        The MR learns the CR's CoA via a new extension,
        "Care-of Address", in the Registration
        Reply. The second issue is a security consideration: In a Registration
        Request, the MR claims to represent an arbitrary IPv4
        network. If the CR has not yet received this information (HoA
        &lt;-&gt; network prefix), it SHOULD perform a re-registration with the
        HA to verify the claim.</t>

        <t>An additional aspect is that the MR MAY use a different
        CoA for different CRs (and the HA).
        This is useful in situations where the network provides only
        partial-mesh connectivity and specific interfaces must be used to
        reach specific destinations. In addition, this allows for load
        balancing.</t>

        <section title="Triggering Route Optimization">
          <t>Since each MR knows the eligible route-optimizable
          networks, the route optimization between all CRs
          can be established at any time; however, a better general practice is
          to conduct route optimization only on demand. It is RECOMMENDED that
          route optimization be started only when sending a packet that
          originates
          from a local managed network (and if the network is registered as
          route
          optimizable) and whose destination address falls within the network
          prefixes of the Route Optimization Cache. With a small number of
          MRs, such on-demand behavior may not be necessary, and
          full-mesh route optimization may be in place constantly.</t>
        </section>

        <section title="Mobile Router Routing Tables">
          <t>Each MR maintains a routing table. In a typical
          situation, the MR has one or more interface(s) to the
          local networks, one or more interface(s) to wide-area networks (such
          as those provided by ISPs), and a tunnel interface to the HA.
          Additional tunnel interfaces become activated as route optimization
          is being performed.</t>

          <t>The routing table SHOULD typically contain network prefixes
          managed by CRs associated with established
          route-optimized tunnel interfaces. A default route MAY point to the
          reverse tunnel to the HA if not overridden by prefix
          information. The routing table MAY also include additional routes if
          required by the tunneling implementation.</t>

          <t>The routes for the HoAs of any CRs SHOULD also be pointing toward
          their respective tunnels that are using the optimized path.</t>

          <t>If two prefixes overlap each other, e.g., 192.0.2.128/25 and
          192.0.2.128/29, the standard longest-match rule for routing is in
          effect. However, overlapping private addresses SHOULD be
          considered an
          error situation. Any aggregation for routes in private address space
          SHOULD be conducted only at the HA.</t>
        </section>

        <section anchor="INTERMOBILEREG"
                 title="Inter-Mobile Router Registration">
          <t>If route optimization between an MR and a CR
          is desired, either the RR procedure must have
          been performed (see <xref target="RRP"></xref>), or the KRm must be
          pre-shared between the MR and the CR.
          If either
          condition applies, an MR MAY send a Registration Request
          to the CR's HoA from the desired interface.</t>

          <t>The Registration Request's Source Address and Care-of Address
          fields are set to the address of the desired outgoing interface on
          the MR. The address MAY be the same as the CoA
          used with the HA. The Home Agent field is set to the HA of the MR.
          The Registration Request MUST be sent to
          (have a destination address of) the HoA of the CR.
          The Registration Request MUST include a
          Mobile-Correspondent Authentication Extension (defined in <xref
          target="AUTHENTICATIONEXT"></xref>) and SHOULD include a Mobile
          Network Request Extension (defined in <xref
          target="RFC5177"></xref>).
          If present, the Mobile Network Request Extension MUST contain the
          network prefixes, as if registering in explicit mode. If timestamps
          are used, the CR MUST check the Identification
          field for validity. The Authenticator field is hashed with the
          KRm.</t>

          <t>The CR replies to the request with a
          Registration Reply. The Registration Reply MUST include a
          Mobile-Correspondent Authentication Extension (defined in <xref
          target="AUTHENTICATIONEXT"></xref>) and, if a Mobile Network Request
          Extension was present in the request, a Mobile Network
          Acknowledgement Extension.</t>

          <t>The encapsulation can be set as desired, except in the case where
          the Route Optimization Cache Entry has NAT entries for the
          CR, or the MR itself is known to be
          behind a NAT or firewall. If either condition applies, the
          Registration Request MUST specify UDP encapsulation. It is
          RECOMMENDED that UDP encapsulation always be used to facilitate
          detection of path failures via a keepalive mechanism.</t>

          <t>The CR first checks the Registration Request's
          authentication against Kcr and nonce indexes negotiated during the
           RR procedure. This ensures that the Registration
          Request is coming from a valid MR. If the check fails,
          an appropriate Registration Reply code is sent (see <xref
          target="IANA"></xref>). If the failure is due to the nonce index
          expiring, the MR sets RRSTATE for the CR to INACTIVE.
          The RR procedure MAY then be initiated again.</t>

          <t>If the check passes, the CR MUST then check
          its Route Optimization Cache to determine whether the MR
          exists and is associated with the prefixes included in the request
          (i.e., whether prefixes are present and the 'HA' flag is true
          for each prefix). Note that the
          viewpoint is always local; the CR compares CR-HoA
          entries against the MR's HoA -- from the CR's perspective,
          the MR is also a "correspondent router".</t>

          <t>If the check against the cache fails, the CR
          SHOULD send a re-Registration Request to the HA with the 'S'
          (solicitation) bit set, thus obtaining the latest information on
          network prefixes managed by the incoming MR. If, even
          after this update, the prefixes still don't match, the reply's
          Mobile Network Acknowledgement code MUST be set to
          "MOBNET_UNAUTHORIZED". The registration MAY also be rejected
          completely. This verification is done to protect against MRs
          claiming to represent arbitrary networks; however, since the
          HA is assumed to provide trusted information, it can
          authorize the MR's claim. If the environment itself is
          considered trusted, the CR can, as a policy,
          accept registrations without this check; however, this is NOT
          RECOMMENDED as a general practice.</t>

          <t>If the prefixes match, the CR MAY accept the
          registration. If the CR chooses to accept, the CR MUST check
          to determine if a
          tunnel to the MR already exists. If the tunnel does NOT
          exist or has wrong endpoints (CoAs), a new tunnel MUST be
          established and the Route Optimization Cache updated. The reply MUST
          include a list of eligible CoAs (see <xref
          target="CoAExtension"></xref>) with which the MR may
          establish a tunnel. The reply MUST also include the
          Mobile-Correspondent Authentication Extension (see <xref
          target="AUTHENTICATIONEXT"></xref>).</t>

          <t>Upon receiving the Registration Reply, the MR MUST
          check to determine if a tunnel to the CR already exists. If the
          tunnel does NOT exist or has wrong endpoints (CoAs), a new tunnel
          MUST be established and the Route Optimization Cache updated. This is
          covered in detail in <xref target="TUNNELS"></xref>.</t>

          <t>The CR's routing table MUST be updated to
          indicate that the MR's networks are reachable via the
          direct tunnel to the MR.</t>

          <t>After the tunnel is established, the MR MAY update
          its routing tables to reach all of the CR's
          Prefixes via
          the tunnel, although it is RECOMMENDED that time be given for the
          CR to perform its own, explicit registration. This is primarily
          a policy decision, depending on the network environment. See <xref
          target="MUTUALNESS"></xref>.</t>

          <t>Due to the fact that the route optimization procedures may occur
          concurrently at both MRs, each working as each other's
          CR, there may be a situation where two routers are
          attempting to establish separate tunnels between them at the same
          time. If a router with a smaller HoA (meaning a normal
          32&nbhy;bit integer comparison treating IPv4 addresses as 32-bit
          unsigned integers) receives a Registration Request (in the CR role)
          while its own
          Registration Request (sent in the MR role) is pending, the attempt
          should be accepted with reply code "concurrent registration" (Value
          2). If receiving such an indication, the recipient SHOULD
          consider the registration a success but only act on it once the
          peer has completed its own registration.</t>
        </section>

        <section anchor="TUNNELS" title="Inter-Mobile Router Tunnels">
          <t>Inter-MR tunnel establishment follows establishing
          standard reverse tunnels to the HA. The Registration Request
          to the CR includes information on the desired
          encapsulation. It is RECOMMENDED that UDP encapsulation be used.
          In the cases of Generic Router Encapsulation (GRE) <xref
          target="RFC2784"> </xref>, IP over IP <xref
          target="RFC2003"> </xref>, or minimal encapsulation <xref
          target="RFC2004"> </xref>, no special considerations regarding
          reachability are necessary. The tunnel has no stateful information;
          the packets are simply encapsulated within the GRE, IP, or minimal
          header.</t>

          <t>The tunnel origination point for the CR is its
          CoA, not the HoA where the Registration
          Requests were sent. This is different from the creation of the
          reverse tunnel to the HA, which reuses the channel from
          registration signaling.</t>

          <t>Special considerations rise from using UDP encapsulation,
          especially in cases where one of the MRs is located
          behind a NAT or firewall. A deviation from <xref target="RFC3519">RFC
          3519</xref> is that keepalives should be sent from both ends of the
          tunnel to detect path failures after the initial keepalive has been
          sent -- this allows both the MR and CR to detect path failures.</t>

          <t>The initial UDP keepalive SHOULD be sent by the MR. Only after the
          first keepalive is successfully completed SHOULD the tunnel be
          considered eligible for traffic. If a reply to the initial keepalive
          is not received, the MR may opt to attempt sending the keepalive
          to other CoAs provided by the Registration Reply to
          check whether they provide better connectivity; or, if all of these
          fail, the MR may perform a re-registration via an 
          alternative interface, or
          deregister completely. See <xref target="NATCONSIDERATIONS"></xref>.
          Once the initial keepalive packet has reached the CR and a reply has
          been sent, the CR MAY start sending its own keepalives.</t>

          <t>The original specification for UDP encapsulation suggests a
          keepalive interval default of 110 seconds. However, to provide fast
          response time and switching to alternate paths, it is RECOMMENDED,
          if power and other constraints allow, that considerably shorter
          periods be used, adapting to the perceived latency as needed.
          However, the maximum amount of keepalives SHOULD at no point exceed
          MAX_UPDATE_RATE times per second. The purpose of the keepalive is
          not to keep NAT or firewall mappings in place but to serve as a
          mechanism to provide fast response in case of path failures.</t>

          <t>If both the MR and the CR are behind
          separate NATs, route optimization cannot be performed between them.
          Possible ways to set up mutual tunneling when both routers are
          behind NATs are outside the scope of this document. However, some of
          these issues are addressed in <xref
          target="NATCONSIDERATIONS"></xref>.</t>

          <t>The designations "MR" and "CR" only apply to the initial
          tunnel establishment phase. Once a tunnel is established between two
          routers, either of them can opt to either tear down the tunnel or
          perform a handover. Signaling messages have to be authenticated with
          a valid KRm.</t>
        </section>

        <section title="Constructing Route-Optimized Packets">
          <t>All packets received by the MR are forwarded using
          normal routing rules according to the routing table. There are no
          special considerations when constructing the packets; the tunnel
          interface's own processes will encapsulate any packet
          automatically.</t>
        </section>

        <section title="Handovers and Mobile Routers Leaving Network">
          <t>Handovers and connection breakdowns can be categorized as either
          ungraceful or graceful, also known as "break-before-make" (bbm) and
          "make-before-break" (mbb) situations.</t>

          <t>As with establishment, the "mobile router" discussed here is the
          router wishing to change connectivity state, with the
          "correspondent router" being the peer.</t>

          <t>When an MR wishes to join its home link, it SHOULD, in
          addition to sending the Registration Request to the HA with
          lifetime set to zero, also send such a request to all known
          CRs, to their HoAs. The CR(s), upon accepting this request
          and sending the reply, will
          check whether the Route Optimization Cache contains any prefixes
          associated with the requesting MR. These entries should
          be removed and the routing table updated accordingly (traffic for the
          prefixes will be forwarded via the HA again). The tunnel
          MUST then be destroyed. A short grace period SHOULD be used to allow
          possible in-transit packets to be received correctly.</t>

          <t>In the case of a handover, the CR simply needs
          to update the tunnel's destination to the MR's new
          CoA. The MR SHOULD keep accepting packets from
          both old and new CoAs for a short grace period,
          typically on the order of ten seconds. In the case of UDP
          encapsulation, it is RECOMMENDED that the same port numbers be used
          for both
          registration signaling and tunneled traffic, if possible. The initial
          keepalive message sent by the MR will verify that direct
          connectivity exists between the MR and CR -- if the keepalive fails,
          the MR SHOULD attempt alternate paths.</t>

          <t>If the MR was unable to send the re-Registration
          Request before handover, it MUST send it immediately after handover
          has been completed and a tunnel with the HA is established.
          Since the changing of CoA(s) invalidates the KRm, it is
          RECOMMENDED that partial return routability be conducted by
          sending a CoTI
          message via the new CoA and obtaining a new
          care-of keygen
          token. In all cases, necessary tokens also have to be acquired if
          the existing tokens have expired.</t>

          <t>If a reply is not received for a Registration Request to a
          CR, any routes to the network prefixes managed by
          the CR MUST be removed from the routing table,
          thus causing the user traffic to be forwarded via the HA.</t>
        </section>
      </section>

      <section title="Convergence and Synchronization Issues">
        <t>The information the HA maintains on mobile network prefixes
        and the MRs' Route Optimization Caches does not need to be
        explicitly synchronized. This is based on the assumption that at least
        some of the traffic between nodes inside mobile networks is always
        bidirectional. If using on-demand route optimization, this also
        implies that when a node in a mobile network talks to a node in
        another mobile network, if the initial packet does not trigger route
        optimization, the reply packet will.</t>

        <t>Consider a situation with three mobile networks, A, B, and C,
        handled by
        three mobile routers, MR A, MR B, and MR C, respectively. If they
        register with an HA in this order, the situation goes as
        follows:</t>

        <t>MR A registers and receives no information on other networks from
        the HA, as no other MR has registered yet.</t>

        <t>MR B registers and receives information on mobile network A being
        reachable via MR A.</t>

        <t>MR C registers and receives information on both of the other mobile
        networks.</t>

        <t>If a node in mobile network C is about to send traffic to mobile
        network A, the route optimization is straightforward; MR C already has
        network A in its Route Optimization Cache. Thus, packet transmission
        triggers route optimization toward MR A.&nbsp; When MR C registers
        with MR A (after the
         RR procedure is completed), MR A does not have
        information on mobile network C; thus, it will perform a
        re-registration with the HA on demand. This allows MR A to
        verify that MR C is indeed managing network C.</t>

        <t>If a node in mobile network B sends traffic to mobile network C, MR
        B has no information on network C.&nbsp; No route optimization is triggered.
        However, when the node in network C replies and the reply reaches MR
        C, route optimization happens as above. Further examples of signaling
        are in <xref target="examplesignals"></xref>.</t>

        <t>Even in the very rare case of completely unidirectional traffic
        from an entire network, re-registrations with the HA caused
        by timeouts will eventually cause convergence. However, this should be
        treated as a special case.</t>

        <t>Note that all MRs are connected to the same HA.
        For possibilities concerning multiple HAs, see <xref
        target="MULTIHOMEAGENTS"></xref>.</t>
      </section>
    </section>

    <section anchor="compressionsformats" title="Data Compression Schemes">
      <t>This section defines the two compression formats used in Route
      Optimization Prefix Advertisement Extensions.</t>

      <section anchor="prefixcomp" title="Prefix Compression">
        <t>Prefix compression is based on the idea that prefixes usually
        share common properties. The scheme is simple delta compression. In
        the prefix information advertisement (<xref
        target="ROPREFIXAD"></xref>), the 'D' bit indicates whether receiving a
        "master" or a "delta" prefix. This, combined with the Prefix Length
        information, allows for compression and decompression of prefix
        information.</t>

        <t>If D = 0, what follows in the "Prefix" field are bits 1..n of the new
        master prefix, where n is PLen. This is rounded up to the nearest full
        octet. Thus, prefix lengths of /4 and /8 take 1 octet, /12 and /16
        take 2 octets, /20 and /24 take 3 octets, and longer prefix lengths
        take a full 4 octets.</t>

        <t>If D = 1, what follows in the "Prefix" field are bits m..PLen of the
        prefix, where m is the first changed bit of the previous master prefix,
        with padding from the master prefix filling the field to a full octet.
        The maximum value of PLen - m is 8 (that is, the delta MUST fit
        into one octet).
        If this is not possible, a new master prefix has to be declared. If
        the prefixes are equal -- for example, in the case where the same
        prefix appears in multiple realms -- then one octet is still encoded,
        consisting completely of padding from the master prefix.</t>

        <t>Determining the order of prefix transmission should be based on
        saving maximum space during transmission.</t>

        <t>An example of compression and transmitted data, where network prefixes
        192.0.2.0/28, 192.0.2.64/26, and 192.0.2.128/25 are transmitted, is
        illustrated in <xref target="PREFIXCOMPEXAMPLE"></xref>. Because of
        the padding to full octets, redundant information is also sent. The
        bit patterns being transmitted are as follows:</t>

        <figure anchor="PREFIXCOMPEXAMPLE" title="Prefix Compression Example">
          <artwork><![CDATA[ =+= shows the prefix mask
 --- shows the master prefix for delta coded prefixes
 192.0.2.0/28, D = 0

 0                   1                     2                     3
 1 2 3 4 5 6 7 8   9 0 1 2 3 4 5 6   7 8 9 0 1 2 3 4   5 6 7 8 9 0 1 2
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|1|1|0|0|0|0|0|0|.|0|0|0|0|0|0|0|0|.|0|0|0|0|0|0|1|0|.|0|0|0|0|0|0|0|0|
+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+-+-+-+-+
 ^                                                                   ^
 +---------------------------- encoded ------------------------------+
                                                               ^     ^
                                                               +-pad-+
 192.0.2.64/26, D = 1

 0                   1                     2                     3
 1 2 3 4 5 6 7 8   9 0 1 2 3 4 5 6   7 8 9 0 1 2 3 4   5 6 7 8 9 0 1 2
+-------------------------------------------------------------+-+-+-+-+
|1|1|0|0|0|0|0|0|.|0|0|0|0|0|0|0|0|.|0|0|0|0|0|0|1|0|.|0|1|0|0|0|0|0|0|
+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+-+-+-+-+-+-+
                                         ^               ^
                                         +--- encoded ---+
                                         ^             ^
                                         +-- padding --+
 192.0.2.128/25, D = 1

 0                   1                     2                     3
 1 2 3 4 5 6 7 8   9 0 1 2 3 4 5 6   7 8 9 0 1 2 3 4   5 6 7 8 9 0 1 2
+-------------------------------------------------------------+-+-+-+-+
|1|1|0|0|0|0|0|0|.|0|0|0|0|0|0|0|0|.|0|0|0|0|0|0|1|0|.|1|0|0|0|0|0|0|0|
+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+-+-+-+-+-+-+-+
                                       ^               ^
                                       +--- encoded ---+
                                       ^           ^
                                       +- padding -+
]]></artwork>
        </figure>

        <t>The first prefix, 192.0.2.0/28, is considered a master prefix and is
        transmitted in full. The PLen of 28 bits determines that all four
        octets must be transmitted. If the prefix would have been, e.g.,
        192.0.2.0/24, three octets would have sufficed, since 24 bits fit into
        3 octets.</t>

        <t>For the following prefixes, D = 1. Thus, they are deltas of the
        previous prefix, where D was zero.</t>

        <t>192.0.2.64/26 includes bits 19-26 (full octet). Bits 19-25 are
        copied from the master prefix, but bit 26 is changed to 1. The final
        notation in binary is "1001", or 0x09.</t>

        <t>192.0.2.128/25 includes bits 18-25 (full octet). Bits 18-24 are
        copied from the master prefix, but bit 25 is changed to 1. The final
        notation in binary is "101", or 0x05.</t>

        <t>The final encoding thus becomes</t>

        <figure>
          <artwork><![CDATA[
+----------------+--------+-+---------------------+
|     Prefix     |  PLen  |D| Transmitted Prefix  |
+----------------+--------+-+---------------------+
| 192.0.2.0/28   |  28    |0| 0xc0 0x00 0x02 0x00 |
| 192.0.2.64/26  |  26    |1| 0x09                |
| 192.0.2.128/25 |  25    |1| 0x05                |
+----------------+--------+-+---------------------+
]]></artwork>
        </figure>

        <t>It should be noted that in this case the order of prefix
        transmission would not affect compression efficiency. If prefix
        192.0.2.128/25 would have been considered the master prefix and the
        others as deltas instead, the resulting encoding still fits into one
        octet for the subsequent prefixes. There would be no need to declare a
        new master prefix.</t>
      </section>

      <section anchor="realmcomp" title="Realm Compression">
        <section title="Encoding of Compressed Realms">
          <t>In order to reduce the size of messages, the system introduces a
          realm compression scheme, which reduces the size of realms in a
          message. The compression scheme is a simple dynamically updated
          dictionary-based algorithm, which is designed to compress text
          strings of arbitrary length. In this scheme, an entire realm,
          a single label,
          or a list of labels may be replaced with an index to a previous
          occurrence of the same string stored in the dictionary. The realm
          compression defined in this specification was inspired by the <xref
          target="RFC1035">RFC 1035</xref> DNS domain name label compression
          scheme.
          Our algorithm is, however, improved to gain more compression.</t>

          <t>When compressing realms, the dictionary is first reset and does
          not contain a single string. The realms are processed one by one, so
          the algorithm does not expect to see them all or the whole message
          at once. The state of the compressor is the current content of the
          dictionary. The realms are compressed label by label or as a list of
          labels. The dictionary can hold a maximum of 128 strings; after
          that, a rollover MUST occur, and existing contents will be
          overwritten. Thus, when adding the 129th string into the dictionary,
          the first entry of the dictionary MUST be overwritten, and the index
          of the new string will become 0.</t>

          <t>The encoding of an index to the dictionary or an uncompressed run
          of octets representing a single label has purposely been made simple,
          and the whole encoding works on an octet granularity. The encoding
          of an uncompressed label takes the form of one octet as follows:

</t>

          <figure>
            <artwork><![CDATA[
 0
 0 1 2 3 4 5 6 7
+-+-+-+-+-+-+-+-+-+-+-+-=================-+-+-+-+
|0|   LENGTH    | 'length' octets long string.. |
+-+-+-+-+-+-+-+-+-+-+-+-=================-+-+-+-+
]]></artwork>
          </figure>

          <t>This encoding allows label lengths from 1 to 127 octets. A label
          length of zero (0) is not allowed. The "label length" tag octet is
          then followed by up to 127 octets of the actual encoded label
          string.</t>

          <t>The index to the dictionary (the "label index" tag octet) takes
          the form of one octet as follows:</t>

          <figure>
            <artwork><![CDATA[
 0
 0 1 2 3 4 5 6 7
+-+-+-+-+-+-+-+-+
|1|   INDEX     |
+-+-+-+-+-+-+-+-+
]]></artwork>
          </figure>

          <t>The above encodings do not allow generating an output octet value
          of zero (0). The encapsulating Mobile IPv4 extension makes use of
          this property and uses the value of zero (0) to mark the end of the
          compressed realm or to indicate an empty realm. It is also possible
          to encode the complete realm using only "label length" tags. In this
          case, no compression takes place. This allows the sender to skip
          compression -- for example, to reduce computation requirements when
          generating messages. However, the receiver MUST always be prepared
          to receive compressed realms.</t>
        </section>

        <section title="Searching Algorithm">
          <t>When compressing the input realm, the dictionary is searched for
          a matching string. If no match could be found, the last label is
          removed from the right-hand side of the used input realm. The search
          is repeated until the whole input realm has been processed. If no
          match was found at all, then the first label of the original input
          realm is encoded using the "label length" tag, and the label is
          inserted into the dictionary. The previously described search is
          repeated with the remaining part of the input realm, if any. If
          nothing remains, the realm encoding is complete.</t>

          <t>When a matching string is found in the dictionary, the matching
          part of the input realm is encoded using the "label index" tag. The
          matching part of the input realm is removed, and the search is
          repeated with the remaining part of the input realm, if any. If
          nothing remains, the octet value of zero (0) is inserted to mark the
          end of the encoded realm.</t>

          <t>The search algorithm also maintains the "longest non-matching
          string" for each input realm. Each time the search in the dictionary
          fails and a new label gets encoded using the "label length" tag and
          inserted into the dictionary, the "longest non-matching string" is
          concatenated by this label, including the separating "." (dot, i.e.,
          hexadecimal 0x2e). When a match is found in the dictionary, the
          "longest non-matching string" is reset (i.e., emptied). Once the
          whole input realm has been processed and encoded, all possible
          suffixes longer than one label are taken from the string and
          inserted into the dictionary.</t>
        </section>

        <section title="Encoding Example">
          <t>This section shows an example of how to encode a set of realms using
          the specified realm compression algorithm. For example, a message
          might need to compress the realms "foo.example.com",
          "bar.foo.example.com", "buz.foo.example.org", "example.com", and
          "bar.example.com.org". The following example shows the processing of
          input realms on the left-hand side and the contents of the dictionary on
          the right-hand side. The example uses hexadecimal representation of
          numbers.</t>

          <figure>
            <artwork><![CDATA[
COMPRESSOR:                                 DICTIONARY:

1) Input "foo.example.com"
Search("foo.example.com")                     
Search("foo.example")
Search("foo")
Encode(0x03,'f','o','o')                    0x00 "foo"
  +-> "longest non-matching string" = "foo"
Search("example.com")
Search("example")
Encode(0x07,'e','x','a','m','p','l','e')    0x01 "example"
  +-> "longest non-matching string" = "foo.example"
Search("com")
Encode(0x03,'c','o','m')                    0x02 "com"
  +-> "longest non-matching string" = "foo.example.com"
                                            0x03 "foo.example.com"
                                            0x04 "example.com"
Encode(0x00)

2) Input "bar.foo.example.com"
Search("bar.foo.example.com")
Search("bar.foo.example")
Search("bar.foo")
Search("bar")
Encode(0x03,'b','a','r')                    0x05 "bar"
  +-> "longest non-matching string" = "bar"
Search("foo.example.com") -> match to 0x03
Encode(0x83)
  +-> "longest non-matching string" = NUL
Encode(0x00)

3) Input "buz.foo.example.org"
Search("buz.foo.example.org")
Search("buz.foo.example")
Search("buz.foo")
Search("buz")
Encode(0x03,'b','u','z')                    0x06 "buz"
  +-> "longest non-matching string" = "buz"
Search("foo.example.org")
Search("foo.example")
Search("foo") -> match to 0x00
Encode(0x80)
  +-> "longest non-matching string" = NUL
Search("example.org")
Search("example") -> match to 0x01
Encode(0x81)
  +-> "longest non-matching string" = NUL
Search("org")
Encode(0x03,'o','r','g')                    0x07 "org"
  +-> "longest non-matching string" = "org"
Encode(0x00)

4) Input "example.com"
Search("example.com") -> match to 0x04
Encode(0x84)
Encode(0x00)

5) Input "bar.example.com.org"
Search("bar.example.com.org")
Search("bar.example.com")
Search("bar.example")
Search("bar") -> match to 0x05
Encode(0x85)
Search("example.com.org")
Search("example.com") -> match to 0x04
Encode(0x84)
Search("org") -> match to 0x07
Encode(0x87)
Encode(0x00)
]]></artwork>
          </figure>

          <t>As can be seen from the example, due to the greedy approach of
          encoding matches, the search algorithm and the dictionary update
          function are not the most optimal. However, we do not claim that
          the algorithm would be the most efficient. It functions efficiently
          enough for most inputs. In this example, the original input realm
          data was 79 octets, and the compressed output, excluding the end
          mark, is 35 octets.</t>
        </section>
      </section>
    </section>

    <section anchor="MESSAGESANDEXTENSIONS"
             title="New Mobile IPv4 Messages and Extensions">
      <t>This section describes the construction of all new information
      elements.</t>

      <section anchor="MRROCAP"
               title="Mobile Router Route Optimization Capability Extension">
        <t>This skippable extension MAY be sent by an MR to an HA in the
        Registration Request message.</t>

        <figure>
          <artwork><![CDATA[
  0               1               2               3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |     Type      |    Length     |    Subtype    |A|R|S|O| Rsvd  |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 ~                 Optional Mobile Router HoA                    ~
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
        </figure>

        <t><list hangIndent="10" style="hanging">
            <t hangText="Type">153 (skippable); if the HA does not
            support route optimization advertisements, it can ignore this
            request and simply not include any information in the reply.
            "short" extension format.</t>

            <t hangText="Subtype">1</t>

            <t hangText="Reserved">Set to zero; MUST be ignored on
            reception.</t>

            <t hangText="A">Advertise my networks. If the 'A' bit is set,
            the HA
            is allowed to advertise the networks managed by this MR to
            other MRs. This also indicates that the
            MR is capable of receiving route optimization
            Registration Requests. In effect, this allows the MR to
            work in the CR role.</t>

            <t hangText="R">Request mobile network information. If the 'R' bit is
            set, the HA MAY respond with information about mobile
            networks in the same domain.</t>

            <t hangText="S">Solicit prefixes managed by a specific MR.
            The MR is specified in the Optional Mobile
            Router HoA field.</t>

            <t hangText="O">Explicitly specify that the requesting router is
            only able to initiate outgoing connections and not accept any
            incoming connections, due to a NAT device, stateful firewall,
            or similar
            issue on any interface. This is reflected by the HA in the
            reply and distributed in Prefix Advertisements to other MRs.</t>

            <t hangText="Optional Mobile Router HoA"><vspace
            blankLines="1" />Solicited mobile router's home address. This
            field is only included if the 'S' flag is set.</t>
          </list></t>
      </section>

      <section anchor="ROR" title="Route Optimization Reply">
        <t>This non-skippable extension MUST be sent by an HA to an
        MR in the Registration Reply message, if the MR
        indicated support for route optimization in the registration message
        and the HA supports route optimization.</t>

        <figure>
          <preamble></preamble>

          <artwork><![CDATA[  0               1               2               3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |     Type      |    Length     |    Subtype    |O|N|S|   Code  |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>

          <postamble></postamble>
        </figure>

        <t><list hangIndent="10" style="hanging">
            <t hangText="Type">49 (non-skippable); "short" extension
            format.</t>

            <t hangText="Subtype">1</t>

            <t hangText="O">The 'O' flag in the Mobile Router Route Optimization
            Capability Extension was set during registration.</t>

            <t hangText="N">NAT was detected by the HA. This
            informs the MR that it is located behind a NAT. The
            detection procedure is specified in <xref target="RFC3519">RFC
            3519</xref> and is based on the discrepancy between the registration
            packet's source address and indicated CoA. The MR
            can use this information to make decisions about route
            optimization strategy.</t>

            <t hangText="S">Responding to a solicitation. If the 'S' bit was
            present in the <xref target="MRROCAP">MR's Route Optimization
            Capability Extension</xref>, this bit is set; otherwise,
            it is unset.</t>
          </list></t>

        <t>The Reply code indicates whether route optimization has been
        accepted. Values of 0..15 indicate assent, and values 16..63 indicate
        that route optimization is not done.</t>

        <list hangIndent="10" style="hanging">
            <t hangText="0">Will do route optimization.</t>

            <t hangText="16">Route optimization declined; reason
            unspecified.</t>
          </list>
      </section>

      <section anchor="AUTHENTICATIONEXT"
               title="Mobile-Correspondent Authentication Extension">

        <t>The Mobile-Correspondent Authentication Extension is included in
        Registration Requests sent from the MR to the CR.
        The existence of this extension indicates that the message is not
        destined to an HA, but another MR. The format is
        similar to the other authentication extensions defined in <xref
        target="RFC5944"></xref>, with Security Parameter Indexes (SPIs)
        replaced by nonce indexes.</t>

        <figure>
          <artwork><![CDATA[
  0               1               2               3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |     Type      |    Length     |    Subtype    |    Reserved   |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |      Home Nonce Index         |     Care-of Nonce Index       |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                      Authenticator...                         ~
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
        </figure>

        <t>The Home Nonce Index field tells the CR which
        nonce value to use when producing the home keygen token. The Care-of
        Nonce Index field is ignored in requests to remove a binding.
        Otherwise, it tells the CR which nonce value to use
        when producing the care-of keygen token. If using a pre-shared
        key (KRm), the indexes may be set to zero and are ignored on
        reception.</t>

        <t><list hangIndent="10" style="hanging">
            <t hangText="Type">49 (non-skippable); "short" extension
            format.</t>

            <t hangText="Subtype">2</t>

            <t hangText="Reserved">Set to zero; MUST be ignored on
            reception.</t>

            <t hangText="Home Nonce Index"><vspace blankLines="1" />Home Nonce
            Index in use. If using a pre-shared KRm, set to zero
            and ignored on reception.</t>

            <t hangText="Care-of Nonce Index"><vspace blankLines="1" />Care-of
            Nonce Index in use. If using a pre-shared KRm, set to zero
            and ignored on reception.</t>

            <t hangText="Authenticator"><vspace blankLines="1" />Authenticator
            field, by default constructed with First&nbsp;(128, HMAC_SHA1 (KRm,
            Protected Data)).</t>
          </list></t>

        <t>The protected data, just like in other cases where the
        Authenticator field is used, consists of</t>

        <t><list style="hanging">
            <t hangText="o">the UDP payload (i.e., the Registration Request or
            Registration Reply data),</t>

            <t hangText="o">all prior extensions in their entirety, and</t>

            <t hangText="o">the Type, Length, Home Nonce Index, and
            Care-of Nonce Index of this extension.</t>
          </list></t>
      </section>

      <section anchor="CoAExtension" title="Care-of Address Extension">
        <t>The Care-of Address Extension is added to a Registration Reply sent
        by the CR to inform the MR of the
        upcoming tunnel endpoint.</t>

        <figure>
          <artwork><![CDATA[
  0               1               2               3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |     Type      |    Length     |    Subtype    |   Reserved    |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    1..n times the following information structure
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        Care-of Address                        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
        </figure>

        <t></t>

        <t><list hangIndent="10" style="hanging">
            <t hangText="Type">49 (non-skippable); "short" extension
            format.</t>

            <t hangText="Length">Total length of the packet. When processing
            the information structures, if Length octets have been reached,
            this is an indication that the final information structure was
            reached as well.</t>

            <t hangText="Subtype">3</t>

            <t hangText="Care-of Address"><vspace blankLines="1" />Care-of
            address(es) that may be used for a tunnel with the MR,
            in order of priority. Multiple CoAs MAY be listed to facilitate
            faster NAT traversal processing.</t>
          </list></t>
      </section>

      <section anchor="ROPREFIXAD"
               title="Route Optimization Prefix Advertisement Extension">
        <t>This non-skippable extension MAY be sent by an HA to an
        MR in the Registration Reply message. This extension is only
        included when explicitly requested by the MR in the
        Registration Request message, setting the 'R' flag of the Mobile Router
        Route Optimization Capability Extension. Implicit prioritization of
        prefixes is caused by the order of extensions.</t>

        <t>The extension contains a sequence of information structures. An
        information structure may consist of either an MR HoA or a network
        prefix. Any network prefixes following an MR HoA are owned by that MR.
        An MR HoA MUST be first in the sequence, since one cannot have prefixes
        without an MR.</t>

        <figure>
          <preamble></preamble>

          <artwork><![CDATA[  0               1               2               3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |     Type      |    Subtype    |             Length            |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  1..n times the following information structure
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |D|M| PLen/Info |  Optional Mobile Router HoA (4 octets)        ~ 
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 ~               |  Optional Prefix (1, 2, 3, or 4 octets)       ~
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 ~                   Realm (1..n characters)                     ~
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>

          <postamble></postamble>
        </figure>

        <t><list hangIndent="10" style="hanging">
            <t hangText="Type">50 (non-skippable); "long" extension
            format.</t>

            <t hangText="Subtype">1</t>

            <t hangText="Length">Total length of the packet. When processing
            the information structures, if Length octets have been reached,
            this is an indication that the final information structure was
            reached as well.</t>

            <t hangText="D">Delta. If D = 1, the prefix is a delta from the
            last Prefix, where D = 0. MUST be zero on the first
            information structure containing a Prefix; MAY
            be zero or one on subsequent information structures. If D = 1, the
            Prefix field is one octet in length. See <xref
            target="prefixcomp"></xref> for details.</t>

            <t hangText="M">Mobile Router HoA bit. If M = 1, the next field is
            Mobile Router HoA, and Prefix and Realm are omitted. If M = 0, the
            next field is Prefix followed by Realm, and Mobile Router HoA is
            omitted. For the first information structure, M MUST be set to 1.
            If M = 1, the 'D' bit is set to zero and ignored upon reception.</t>

            <t hangText="PLen/Info">This field is interpreted differently,
            depending on whether the 'M' bit is set or not.
            If M = 0, the field is considered to be the PLen field, and the
            contents indicate the length of the advertised prefix.
            The 6 bits allow for values from 0 to 63, of which 33-63 are
            illegal. If M = 1, the field is considered to be the Info field.
            Permissible values are 0 to indicate no specific information, or
            1 to indicate "outbound connections only". This indicates that the
            target MR can only initiate, not receive, connections
            on any of its interfaces (apart from the reverse tunnel to the HA).
            This is set if the MR has explicitly requested it via
            the 'O' flag in <xref target="MRROCAP">the Mobile Router Route
            Optimization Capability Extension</xref>.</t>

            <t hangText="Mobile Router HoA"><vspace blankLines="1" />The mobile
            router's home address. All prefixes in the following information
            structures where M = 0 are maintained by this MR. This
            field is present only when M&nbsp;=&nbsp;1.</t>

            <t hangText="Prefix">The IPv4 prefix advertised. If D = 0, the field
            length is PLen bits, rounded up to the nearest full octet.
            Least-significant bits starting off PLen (and that are zeros) are
            omitted. If D = 1, the field length is one octet. This field is present
            only when M = 0.</t>

            <t hangText="Realm">The Realm that is associated with the
            advertised Mobile Router HoA and prefix. If empty, MUST be set to
            '\0'. For realm encoding and an optional compression scheme, refer to
            <xref target="realmcomp"></xref>. This field is present only when
            M = 0.</t>
          </list></t>
      </section>

      <section anchor="HOTI" title="Home Test Init Message">
        <t>This message is sent from the MR to the CR
        when performing the RR procedure. The source and
        destination IP addresses are set to the MR's HoA and the CR's HoA,
        respectively. The UDP source port MAY be randomly chosen. The
        UDP destination port is 434.</t>

        <figure>
          <artwork><![CDATA[
  0               1               2               3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |     Type      |   Reserved    |                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               +
 |                          Home Init Cookie                     |
 +                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
        </figure>

        <t><list hangIndent="10" style="hanging">
            <t hangText="Type">24</t>

            <t hangText="Reserved">Set to zero; MUST be ignored on
            reception.</t>

            <t hangText="Home Init Cookie"><vspace blankLines="1" />64-bit
            field that contains a random value, the Home Init Cookie.</t>
          </list></t>
      </section>

      <section anchor="CoTI" title="Care-of Test Init Message">
        <t>This message is sent from the MR to the CR
        when performing the RR procedure. The source and
        destination IP addresses are set to the MR's CoA and 
        the CR's HoA,
        respectively. The UDP source port MAY be randomly chosen. The
        UDP destination port is 434.</t>

        <figure>
          <artwork><![CDATA[
  0               1               2               3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |     Type      |   Reserved    |                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               +
 |                       Care-of Init Cookie                     |
 +                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
        </figure>

        <t><list hangIndent="10" style="hanging">
            <t hangText="Type">25</t>

            <t hangText="Reserved">Set to zero; MUST be ignored on
            reception.</t>

            <t hangText="Care-of Init Cookie"><vspace blankLines="1" />64-bit
            field that contains a random value, the Care-of Init Cookie.</t>
          </list></t>
      </section>

      <section anchor="HoT" title="Home Test Message">
        <t>This message is sent from the CR to the MR
        when performing the RR procedure as a reply to the
        Home Test
        Init message. The source and destination IP addresses, as well as UDP
        ports, are the reverse of those in the Home Test Init message for which
        this message is
        constructed. As such, the UDP source port is always 434.</t>

        <figure>
          <artwork><![CDATA[
  0               1               2               3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |     Type      |   Reserved    |         Nonce Index           |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                                                               |
 +                    Home Init Cookie                           +
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                                                               |
 +                    Home Keygen Token                          +
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
        </figure>

        <t><list hangIndent="10" style="hanging">
            <t hangText="Type">26</t>

            <t hangText="Reserved">Set to zero; MUST be ignored on
            reception.</t>

            <t hangText="Nonce Index"><vspace blankLines="1" />This field will
            be echoed back by the MR to the CR in
            a subsequent Registration Request's authentication extension.</t>

            <t hangText="Home Init Cookie"><vspace blankLines="1" />64-bit
            field that contains a random value, the Home Init Cookie.</t>

            <t hangText="Home Keygen Token"><vspace blankLines="1" />This
            field contains the 64-bit home keygen token used in the RR
            procedure. Generated from cookie + nonce.</t>
          </list></t>
      </section>

      <section anchor="CoT" title="Care-of Test Message">
        <t>This message is sent from the CR to the MR
        when performing the RR procedure as a reply to the
        Care-of Test Init message. The source and destination IP addresses, as
        well as UDP ports, are the reverse of those in the Care-of Test Init
        message for which this
        message is constructed. As such, the UDP source port is always
        434.</t>

        <figure>
          <artwork><![CDATA[
  0               1               2               3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |     Type      |   Reserved    |         Nonce Index           |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                                                               |
 +                    Care-of Init Cookie                        +
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                                                               |
 +                    Care-of Keygen Token                       +
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
        </figure>

        <t><list hangIndent="10" style="hanging">
            <t hangText="Type">27</t>

            <t hangText="Reserved">Set to zero; MUST be ignored on
            reception.</t>

            <t hangText="Care-of Nonce Index"><vspace blankLines="1" />This
            field will be echoed back by the MR to the
            CR in a subsequent Registration Request's
            authentication extension.</t>

            <t hangText="Care-of Init Cookie"><vspace blankLines="1" />64-bit
            field that contains a random value, the Care-of Init Cookie.</t>

            <t hangText="Care-of Keygen Token"><vspace blankLines="1" />This
            field contains the 64-bit care-of keygen token used in the RR
            procedure. Generated from cookie + nonce.</t>
          </list></t>

      </section>
    </section>

    <section title="Special Considerations">
      <t></t>

      <section anchor="NATCONSIDERATIONS" title="NATs and Stateful Firewalls ">
        <t>Mechanisms described in <xref target="RFC3519">Mobile IP NAT
        traversal</xref> allow the HA to work with MRs
        situated behind a NAT device or a stateful firewall. Furthermore, the
        HA may also detect whether a NAT device is located between the
        mobile node and the HA. The MR may also explicitly state
        that it is
        behind a NAT or firewall on all interfaces, and this information is
        passed on to the other MRs with the Info field in
        the <xref target="ROPREFIXAD">Route Optimization Prefix Advertisement
        Extension</xref>. The HA may also detect NAT and
        inform the registering MR via the 'N' flag in the <xref
        target="ROR">Route Optimization Reply Extension</xref>. In the case
        where one or both of the routers is known to be behind a NAT or
        is similarly
        impaired (not able to accept incoming connections), the tunnel
        establishment procedure needs to take this into account.</t>

        <t>In the case where the MR is behind a NAT (or firewall)
        and the
        CR is not, the MR will, when the tunnel has
        been established, send keepalive messages (ICMP echo requests) through
        the tunnel. Until a reply has been received, the tunnel SHOULD NOT be
        considered active. Once a reply has been received, NAT mapping is in
        place, and traffic can be sent.</t>

        <t>The source address may change due to NAT in CoTI and Registration
        Request messages. This does not affect the process -- the hash values
        are calculated by the translated address, and the Registration Request
        will also appear from the same translated address.</t>

        <t>Unlike communication with the HA, in the case of route
        optimization, the path used for signaling is not used for tunneled
        packets, as signaling always uses HoAs, and the
        MR &lt;-&gt; CR
        tunnel is from CoA to CoA. It is assumed that even though port numbers
        may change, NAT processing rarely allocates more than one external IP
        address to a single internal address; thus, the IP address seen in the
        Registration Request and tunnel packets remains the same. However, the
        UDP source port number may be different in the Registration Request and
        incoming tunnel packets, due to port translation. This must not cause
        an error situation -- the CR MUST be able to accept
        tunneling packets from a different UDP source port than what was used
        in the Registration Request.</t>

        <t>Since MRs may have multiple interfaces connecting to
        several different networks, it might be possible that specific MRs
        may only be able to perform route optimization using specific
        CoA pairs, obtained from specific networks --
        for example, in
        a case where two MRs have an interface behind the same NAT.
        A similar case may be applicable to nested NATs. In such cases, 
        the MR MAY attempt to detect eligible CoA pairs by
        performing a registration and attempting to establish a tunnel
        (sending keepalives) with each CoA listed in the
        Registration Reply's Care-of Address Extension. The eligible pairs
        should be recorded in the Route Optimization Cache. If a tunnel
        cannot be
        established with any CoAs, the MR MAY attempt to repeat
        the procedure with alternative interfaces. The above information on
        network topology can also be configured on the MRs either
        statically or via some external feedback mechanism.</t>

        <t>If both the MR and the CR are behind
        two separate NATs, some sort of proxy or hole-punching technique may
        be applicable. This is out of scope for this document.</t>
      </section>

      <section title="Handling of Concurrent Handovers">
        <t>If both the MR and the CR move at the same
        time, this causes no issues from the signaling perspective, as all
        requests are always sent from a CoA to HoAs.
        Thus, the recipient will always receive the request and can send the
        reply. This applies even in break-before-make situations where both 
        the MR and the CR get disconnected at the same time -- once the
        connectivity is
        restored, one endpoint of the signaling messages is always the HoA
        of the respective router, and it is up to the HA to
        provide reachability.</t>
      </section>

      <section title="Foreign Agents">
        <t>Since foreign agents have been dropped from work related to
        Network Mobility for Mobile IPv4, they are not considered here.</t>
      </section>

      <section anchor="MULTIHOMEAGENTS" title="Multiple Home Agents">
        <t>MRs can negotiate and perform route optimization without
        the assistance of an HA -- if they can discover each other's
        existence and thus know where to send registration messages. This
        document only addresses a logically single HA that distributes
        network prefix information to the MRs. Problems arise from
        possible trust relationships; in this document, the HA serves
        as a way to provide verification that a specific network is managed by
        a specific router.</t>

        <t>If route optimization is desired between nodes attached to separate
        HAs, there are several possibilities. Note that standard
        high-availability redundancy protocols, such as the Virtual
        Router Redundancy Protocol (VRRP), can be utilized;
        however, in such a case, the HA is still a single logical
        entity, even if it consists of more than a single node.</t>

        <t>Several possibilities exist for achieving route optimization
        between MRs attached to separate HAs, such as a new
        discovery/probing protocol or routing protocol between HAs or
        DNS SRV records, or a common Authentication, Authorization, and
        Accounting (AAA) architecture. There is already a
        framework for HA to retrieve information from AAA, so it
        can be considered the most viable possibility. See <xref
        target="EXTENSIBILITY"></xref> for information on a possible way to
        generalize the method.</t>

        <t>Any discovery/probing protocols are out of scope for this
        document.</t>
      </section>

      <section anchor="MUTUALNESS" title="Mutualness of Route Optimization">
        <t>The procedure as specified is asymmetric; that is, if bidirectional
        route optimization is desired while maintaining consistency, the route
        optimization (RR check and registration) has to be performed in both
        directions, but this is not strictly necessary. This is primarily a
        policy decision, depending on how often the mobile prefixes are
        reconfigured.</t>

        <t>Consider the case where two networks, A and B, are handled by
        MRs A and B, respectively. If the routers are set up in such
        a fashion that route optimization is triggered when the router is
        forwarding a packet destined to a network prefix in the
        Route Optimization Cache, the
        following occurs if a node in network A starts sending ICMP echo
        requests (ping packets) to a node in network B.</t>

        <t>MR A sees the incoming ICMP echo request packet from the
        local network destined to network B. Since network B exists in
        MR A's Route Optimization Cache, the route optimization process
        is triggered. The original packet is forwarded via the reverse
        tunnel toward the HA as normal.</t>

        <t>MR A completes the RR procedure and registration with MR B,
        which thus becomes a CR for MR A.&nbsp; A tunnel is created
        between the routers. MR B updates its routing tables so that
        network A is reachable via the MR A &lt;-&gt; MR B tunnel.</t>

        <t>The traffic pattern is now such that packets from network B
        to network A
        are sent over the direct tunnel, but the packets from A to B are
        transmitted via the HA and reverse tunnels. The echo reply that
        the node in network B sends toward network A triggers the route
        optimization at MR B in similar fashion. As such, MR B now performs
        its own registration toward MR A.&nbsp; Upon completion, MR B
        notices that a tunnel to MR A already exists, and updates its
        routing table so that network A is now reachable via the
        (existing) MR A &lt;-&gt; MR B tunnel. From this point onward,
        traffic is bidirectional.</t>

        <t>In this scenario, if MR A does NOT wait for a separate route
        optimization process (RR check and registration) from MR B,
        but instead simply updates its routing table to reach
        network B via the tunnel, problems may
        arise if MR B has started to manage another network, B', before the
        information has been propagated to MR A.&nbsp; The end result is that
        MR B starts to receive packets from network A to network B'
        via the HA and to network B via the direct tunnel.
        If reverse path checking or a similar mechanism is in
        use on MR B, some of the packets from network A could be
        black-holed.</t>

        <t>Whether to perform this mutual registration or not thus depends on
        the situation, and whether MRs are going to start managing
        additional network prefixes during operation.</t>
      </section>

      <section anchor="EXTENSIBILITY" title="Extensibility">
        <t>The design considerations include several mechanisms that might
        not be strictly necessary if route optimization were only desired
        between individual customer sites in a managed network. The
        registration procedure (with the optional return routability part),
        which allows CRs to learn an MR's
        CoAs, is not strictly necessary; the CoAs could have been
        provided by the HA directly.</t>

        <t>However, this approach allows the method to be extended to a more
        generic route optimization. The primary driver for having an HA
        to work as a centralized information distributer is to provide MRs
        with not only the knowledge of the other routers, but with
        information on which networks are managed by which routers.</t>

        <t>The HA provides the information on all feasible nodes with
        which it is possible to establish route optimization. If representing
        a whole mobile network is not necessary -- in effect,
        the typical mobile node &lt;-&gt; correspondent node situation --
        the mechanisms in this
        document work just as well; the only problem is discovering whether
        the target
        correspondent node can provide route optimization capability. This can
        be performed by not including any prefixes in the information
        extension -- just the HoA of the MR.</t>

        <t>In addition, with route optimization for a single node, checks for
        whether an MR is allowed to represent specific networks are
        unnecessary, since there are none.</t>

        <t>Correspondent node/router discovery protocols (whether they are
        based on probing or a centralized directory beyond the single HA)
        are outside the scope of this document.</t>
      </section>

      <section title="Load Balancing">
        <t>This design simply provides the possibility of creating
        optimal paths
        between MRs; it doesn't dictate what the user
        traffic using these paths should be.
        One possible approach in helping facilitate
        load balancing and utilizing all available paths is presented in <xref
        target="MIPv4FLOW"></xref>, which
        effectively allows for multiple CoAs for a single HoA.
        In addition, per-tunnel load balancing is possible by using
        separate CoAs for separate tunnels.</t>
      </section>
    </section>

    <section title="Scalability">
      <t>Home agent-assisted route optimization scalability issues stem from
      the general Mobile IPv4 architecture, which is based on tunnels.
      Creating, maintaining, and destroying tunnel interfaces can cause load on
      the MRs. However, the MRs can always fall back to normal,
      reverse-tunneled routing if resource constraints are apparent.</t>

      <t>If there are a large number of optimization-capable prefixes,
      maintaining state for all of these may be an issue also, due to limits
      on routing table sizes.</t>

      <t>Registration responses from the HA to the MR
      may provide
      information on a large number of network prefixes. If thousands of
      networks are involved, the Registration Reply messages are bound to grow
      very large. The prefix and realm compression mechanisms defined in
      <xref target="compressionsformats"></xref> mitigate this problem to an
      extent. There will, however, be some practical upper limit, after which
      some other delivery mechanism for the prefix information will be
      needed.</t>
    </section>

    <section anchor="examplesignals" title="Example Signaling Scenarios">
      <t></t>

      <section anchor="regreqexample" title="Registration Request">
        <t>The following example assumes that there are three mobile
        routers -- MR A, MR B, and MR C -- each managing network prefixes A, B,
        and C.&nbsp; At
        the beginning, no networks are registered with the HA. Any AAA
        processing at the HA is omitted from the diagram.</t>

        <figure>
          <artwork><![CDATA[+--------+ +--------+ +--------+ +--------------+  
| [MR A] | | [MR B] | | [MR C] | | [Home Agent] |  
+--------+ +--------+ +--------+ +--------------+  
   |          |          |          |
   x------------------------------->|  Registration Request
   |          |          |          |  includes Mobile Router
   |          |          |          |  Route Optimization 
   |          |          |          |  Capability Extension
   |          |          |          |
   |<-------------------------------x  Registration response;
   |          |          |          |  no known networks from HA
   |          |          |          |  in response
   |          |          |          |
   |          x-------------------->|  Registration Request similar
   |          |          |          |  to the one sent by MR A
   |          |          |          |
   |          |<--------------------x  Registration Reply includes
   |          |          |          |  network A in Route Optimization
   |          |          |          |  Prefix Advertisement Extension
   |          |          |          |
   |          |          x--------->|  Registration Request similar
   |          |          |          |  to the one sent by MR A
   |          |          |          |
   |          |          |<---------x  Registration Reply includes
   |          |          |          |  networks A and B in Route 
   |          |          |          |  Optimization Prefix 
   |          |          |          |  Advertisement Extension. 
   |          |          |          |  Network B is sent in 
   |          |          |          |  compressed form.
   |          |          |          |
]]></artwork>
        </figure>
      </section>

      <section title="Route Optimization with Return Routability">
        <t>The following example has the same network setup as that in <xref
        target="regreqexample"></xref> -- three MRs, each
        corresponding to their respective network. Node A is in network A, and
        Node C is in network&nbsp;C.</t>

        <t>At the beginning, none of the MRs know each other's
        KRms. If
        the KRms were pre-shared or provisioned with some other method,
        the Return Routability messages could be omitted. Signaling
        as described in <xref
        target="regreqexample"></xref> has occurred; thus, MR A is not aware of
        the other networks, and MR C is aware of networks A and B.</t>

        <figure>
          <artwork><![CDATA[
  ======= Traffic inside Mobile IP tunnel to/from HA
  =-=-=-= Traffic inside Mobile IP tunnel between MRs
  ------- Traffic outside Mobile IP tunnel

+----------+ +--------+ +------+ +--------+ +----------+
| [Node A] | | [MR A] | | [HA] | | [MR C] | | [Node C] |
+----------+ +--------+ +------+ +--------+ +----------+
   |            |          |         |       |
   x------------O==========O=========O------>| Mobile Router A is 
   |            |          |         |       | unaware of network C;
   |            |          |         |       | thus, nothing happens
   |            |          |         |       |
   |<-----------O==========O=========O-------x Mobile Router C
   |            |          |         |       | notices packet to
   |            |          |         |       | network A - begins
   |            |          |         |       | route optimization
   |            |          |         |       |
   |            |          |         |       | Return Routability (if
   |            |          |         |       | no pre-shared KRms)
   |            |          |         |       |
   |            |<=========O---------x       | CoTI
   |            |<=========O=========x       | HoTI
   |            |          |         |       |
   |            x==========O-------->|       | CoT
   |            x==========O========>|       | HoT
   |            |          |         |       |
   |            |          |         |       | KRm between MR A <-> C
   |            |          |         |       | established
   |            |          |         |       |
   |            |<=========O---------x       | Registration Request
   |            |          |         |       |
   |            x--------->|         |       | Registration Request 
   |            |          |         |       | to HA due to MR A 
   |            |          |         |       | being unaware of 
   |            |          |         |       | network C. 
   |            |          |         |       | Solicit bit set.
   |            |          |         |       |
   |            |<---------x         |       | Registration Reply
   |            |          |         |       | contains info on
   |            |          |         |       | network A
   |            |          |         |       |
   |            x==========O-------->|       | Registration Reply
   |            |          |         |       | includes MR A's CoA in
   |            |          |         |       | Care-of Address
   |            |          |         |       | Extension
   |            |          |         |       |
   |            |<= = = = =O= = = ==>|       | Optional mutual registra-
   |            |          |         |       | tion from MR A to MR C
   |            |          |         |       | (same procedure as above,
   |            |          |         |       | multiple packets);
   |            |          |         |       | possible keepalive checks
   |            |          |         |       |
   |<-----------O=-=-=-==-=-=-=-==-=-O-------x Packet from Node C -> A
   |            |          |         |       | routed to direct tunnel
   |            |          |         |       | at MR C, based on 
   |            |          |         |       | MR C now knowing MR A's
   |            |          |         |       | CoA and tunnel being up
   |            |          |         |       |
   x------------O=-=-=-==-=-=-=-==-=-O------>| Packet from Node A -> C 
   |            |          |         |       | routed to direct tunnel
   |            |          |         |       | at MR A, based on MR A
   |            |          |         |       | now knowing MR C's CoA
   |            |          |         |       | and tunnel being up
]]></artwork>
        </figure>
      </section>

      <section title="Handovers">
        <t>In this signaling example, MR C changes its CoA while route
        optimization between MR A and MR C is operating and data is
        being transferred.
        Cases where the handover is graceful ("make before break") and
        ungraceful ("break before make") both occur in similar fashion,
        except that in
        the graceful version no packets are lost. This diagram considers the
        case where MR C gets immediate notification of lost connectivity,
        e.g., due to a link status indication. MR A would eventually notice the
        breakdown, due to keepalive messages failing.</t>

        <figure>
          <artwork><![CDATA[
  ======= Traffic inside Mobile IP tunnel to/from HA
  =-=-=-= Traffic inside Mobile IP tunnel between MRs
  ------- Traffic outside Mobile IP tunnel

+----------+ +--------+ +------+ +--------+ +----------+
| [Node A] | | [MR A] | | [HA] | | [MR C] | | [Node C] |
+----------+ +--------+ +------+ +--------+ +----------+
   |            |          |         |       |
   x------------O=-=-=-==-=-=-=-==-=-O------>| Nodes A and C are
   |<-----------O=-=-=-==-=-=-=-==-=-O-------x exchanging traffic
   |            |          |         |       |
   |            |          xxxxxxxxxxx       | Break occurs: MR C
   |            |          |         |       | loses connectivity to
   |            |          |         |       | current attachment point
   |            |          |         |       |
   x------------O=-=-=-==-=-=-=->x   |       | Traffic from A -> C
   |            |          |         |       | lost, and 
   |            |          |   x<=-=-O-------x vice versa
   |            |          |         |       |
   |            |          |<--------x       | MR C finds a new
   |            |          |         |       | point of attachment,
   |            |          |         |       | registers with the HA,
   |            |          |         |       | clears routing tables
   |            |          |         |       |
   |            |          x-------->|       | Registration Reply
   |            |          |         |       |
   x------------O=-=-=-==-=-=-=->x   |       | Traffic from A -> C lost
   |            |          |         |       | (reverts to routing via
   |            |          |         |       | HA if enough keepalives
   |            |          |         |       | fail)
   |            |          |         |       | 
   |<-----------O==========O=========O-------| Traffic from C -> A
   |            |          |         |       | sent via HA
   |            |          |         |       |
   |            O<=========O---------x       | CoTI message 
   |            |          |         |       | (partial RR check)
   |            |          |         |       |
   |            x==========O-------->|       | CoT message
   |            |          |         |       |
   |            |<=========O---------x       | Registration Request
   |            |          |         |       | reusing newly calculated
   |            |          |         |       | KRm
   |            |          |         |       |
   |            x==========O-------->|       | Registration Reply
   |            |          |         |       |
   |            O<=-=-=-=-=-=-=-=-=-=x       | First keepalive check if
   |            |          |         |       | using UDP encapsulation;
   |            |          |         |       | also creates holes in
   |            x=-=-=-=-=-=-=-=-=-=>|       | firewalls
   |            |          |         |       |
   |            |          |         |       |
   x------------O=-=-=-==-=-=-=-==-=-O------>| Traffic from A -> C
   |            |          |         |       | forwarded directly again
   |            |          |         |       |
   |<-----------O=-=-=-==-=-=-=-==-=-O-------x Traffic from C -> A
   |            |          |         |       | switches back to direct
   |            |          |         |       | tunnel
   |            |          |         |       |
]]></artwork>
        </figure>
      </section>
    </section>

    <section anchor="PROTOCOLCONSTANTS" title="Protocol Constants">
      <figure>
        <artwork><![CDATA[
   MAX_NONCE_LIFETIME              240 seconds
   MAX_TOKEN_LIFETIME              210 seconds
   MAX_UPDATE_RATE                 5 times
]]></artwork>
      </figure>
    </section>

    <section anchor="IANA" title="IANA Considerations">
      <t>IANA has assigned rules for the existing registries "Mobile IP
      Message Types" and "Extensions to Mobile IP Registration Messages",
      specified in <xref target="RFC5944">RFC 5944</xref>. New Mobile IP
      message types and extension code allocations have been made for the messages
      and extensions listed in <xref target="MESSAGESANDEXTENSIONS"/>.</t>

      <t>The route optimization authentication processing requires four new
      message type numbers. The new Mobile IP Message types are listed below,
      in <xref target="MIPMSG"/>.</t>

      <texttable anchor="MIPMSG" title="New Values and Names for Mobile IP Message Types">
        <ttcol>Value</ttcol>

        <ttcol>Name</ttcol>

        <c>24</c>

        <c>Home Test Init message</c>

        <c>25</c>

        <c>Care-of Test Init message</c>

        <c>26</c>

        <c>Home Test message</c>

        <c>27</c>

        <c>Care-of Test message</c>
      </texttable>

      <t>Three new registration message extension types are required and
      listed in <xref target="MIPREGEXT"/>. The first type, 153,
      is skippable and has been
      allocated from range 128-255. The other two, 49 and 50, are
      non-skippable and have been allocated from range 0-127, with
      49 being of
      the "short" format and 50 being of the "long" format. None of the
      messages are permitted for notification messages.</t>

      <texttable anchor="MIPREGEXT" title="New Values and Names for Extensions in Mobile IP Registration Messages">
        <ttcol>Value</ttcol>

        <ttcol>Name</ttcol>

        <c>153, 128-255</c>

        <c>Mobile Router Route Optimization Indication</c>

        <c>49, 0-127</c>

        <c>Route Optimization Extensions</c>

        <c>50, 0-127</c>

        <c>Route Optimization Data</c>
      </texttable>

      <t>In addition, the registry "Code Values for Mobile IP Registration
      Reply Messages" has been modified. A new success code, 2, should
      be allocated as follows:</t>

      <t><list hangIndent="10" style="hanging">
          <t hangText="2">Concurrent registration (pre-accept)</t>
        </list>In addition, a new allocation range has been created as
      "Error Codes from the Correspondent Node", subject to the 
      policy of Expert
      Review <xref target="RFC5226"></xref>. The range is 201-210.
      Three
      new Registration Reply codes have been allocated from this range. They
      are specified in <xref target="MIPREPLYCODES"/>, below:</t>

      <texttable anchor="MIPREPLYCODES" title="New Code Values and Names for Mobile IP Registration Reply Messages">
        <ttcol>Value</ttcol>

        <ttcol>Name</ttcol>

        <c>201</c>

        <c>Expired Home nonce Index</c>

        <c>202</c>

        <c>Expired Care-of nonce Index</c>

        <c>203</c>

        <c>Expired nonces</c>
      </texttable>

      <t>Three new number spaces were required for the subtypes of the
      extensions in <xref target="MIPREGEXT"/>.
      A new registry, named "Route Optimization Types
      and Subtypes", has been created with an allocation policy of RFC Required <xref
      target="RFC5226"></xref>. The registration entries include Type, Subtype,
      and Name. Type and Subtype have a range of 0-255. Types are references to
      registration message extension types. Subtypes are allocated initially
      as in <xref target="ROTYPESANDSUBTYPES"/>, below:</t>

      <texttable anchor="ROTYPESANDSUBTYPES" title="Initial Values and Names for Registry Route Optimization Types and Subtypes">
        <ttcol>Type</ttcol>

        <ttcol>Subtype</ttcol>

        <ttcol>Name</ttcol>

        <c>153</c>

        <c>0</c>

        <c>Reserved</c>

        <c>153</c>

        <c>1</c>

        <c>Mobile Router Route Optimization Capability Extension</c>

        <c>49</c>

        <c>0</c>

        <c>Reserved</c>

        <c>49</c>

        <c>1</c>

        <c>Route Optimization Reply</c>

        <c>49</c>

        <c>2</c>

        <c>Mobile-Correspondent Authentication Extension</c>

        <c>49</c>

        <c>3</c>

        <c>Care-of Address Extension</c>

        <c>50</c>

        <c>0</c>

        <c>Reserved</c>

        <c>50</c>

        <c>1</c>

        <c>Route Optimization Prefix Advertisement Extension</c>
      </texttable>

      <t></t>
    </section>

    <section anchor="Security" title="Security Considerations">
      <t>There are two primary security issues: One issue relates to the
      RR check, which establishes that a specific CoA is,
      indeed, managed by a specific HoA. The other issue is trust
      relationships and an arbitrary router claiming to represent an
      arbitrary network.</t>

      <t>The end-user traffic can be protected using normal IPsec
      mechanisms.</t>

      <section title="Return Routability">
        <t>The RR check's security has been vetted with Mobile
        IPv6. There are no major differences, apart from two issues:
        connectivity check and replay attack protection.  The connectivity
        check is conducted with a separate ICMP message exchange.
        Replay attack protection is achieved with Mobile IPv4 timestamps in
        the Registration Request's Identification field, in contrast to
        the sequence numbers used in Mobile IPv6.</t>

        <t>The RR procedure does not establish any kind of
        state information on the CR; this mitigates
        denial-of-service attacks. State information is only maintained
        after a Registration Request has been accepted.</t>
      </section>

      <section title="Trust Relationships">
        <t>The network of trust relationships in home agent-assisted route
        optimization solves possible trust issues: An arbitrary
        CR can
        trust an arbitrary MR that it is indeed the proper route to
        reach an arbitrary mobile network.</t>

        <t>It is assumed that all MRs have a trust relationship
        with the HA. Thus, they trust information provided by the
        HA.</t>

        <t>The HA provides information matching HoAs and
        network prefixes. Each MR trusts this information.</t>

        <t>MRs may perform the RR procedure between
        each other. This creates a trusted association between the
        MR's
        HoA and CoA. The MR also claims to
        represent a specific network. This information is not trustworthy as
        such.</t>

        <t>The claim can be verified by checking the HoA &lt;-&gt;
        network prefix information received, either earlier, or due to an
        on-demand request, from the HA. If they match, the MR's
        claim is authentic. If the network is considered trusted, a
        policy decision can be made to skip this check. Exact definitions on
        situations where such decisions can be made are out of scope for this
        document. The RECOMMENDED general practice is to perform the
        check.</t>
      </section>
    </section>

    <section anchor="Acknowledgements" title="Acknowledgements">
      <t>Thanks to Alexandru Petrescu for constructive comments and support.
      Thanks to Jyrki Soini and Kari Laihonen for initial reviews. This work
      was supported by TEKES as part of the Future Internet program of TIVIT
      (Finnish Strategic Centre for Science, Technology and Innovation in the
      field of ICT).</t>
    </section>
  </middle>

  <back>
    <references title="Normative References">
      &RFC2119;

<reference anchor='RFC5944'>
<front>
<title>IP Mobility Support for IPv4, Revised</title>
<author initials='C.' surname='Perkins' fullname='C. Perkins' role="editor">
<organization /></author>
<date year='2010' month='November' />
</front>
<seriesInfo name='RFC' value='5944' />
</reference>

      &RFC3519;

      &RFC5177;

      &RFC2003;

      &RFC2004;

      &RFC2784;

      &RFC5226;
    </references>

    <references title="Informative References">

<reference anchor='RFC6275'>
<front>
<title>Mobility Support in IPv6</title>
<author initials='C.' surname='Perkins' fullname='C. Perkins' role="editor">
<organization /></author>
<author initials='D.' surname='Johnson' fullname='D. Johnson'>
<organization /></author>
<author initials='J.' surname='Arkko' fullname='J. Arkko'>
<organization /></author>
<date year='2011' month='July' />
</front>
<seriesInfo name='RFC' value='6275' />
</reference>

      &RFC3543;

      &RFC1035;

      &RFC4282;

<reference anchor='RFC4086'>
<front>
<title>Randomness Requirements for Security</title>
<author initials='D.' surname='Eastlake 3rd' fullname='D. Eastlake'>
<organization /></author>
<author initials='J.' surname='Schiller' fullname='J. Schiller'>
<organization /></author>
<author initials='S.' surname='Crocker' fullname='S. Crocker'>
<organization /></author>
<date year='2005' month='June' />
</front>
<seriesInfo name='BCP' value='106' />
<seriesInfo name='RFC' value='4086' />
</reference>

<!-- draft-ietf-mip4-multiple-tunnel-support ("I-D Exists") -->
<reference anchor='MIPv4FLOW'>
<front>
<title>Flow Binding Support for Mobile IPv4</title>
<author initials='S' surname='Gundavelli' fullname='Sri Gundavelli' role="editor">
    <organization />
</author>
<author initials='K' surname='Leung' fullname='Kent Leung'>
    <organization />
</author>
<author initials='G' surname='Tsirtsis' fullname='George Tsirtsis'>
    <organization />
</author>
<author initials='H' surname='Soliman' fullname='Hesham Soliman'>
    <organization />
</author>
<author initials='A' surname='Petrescu' fullname='Alexandru Petrescu'>
    <organization />
</author>
<date month='February' year='2012' />
</front>
<seriesInfo name='Work in' value='Progress' />
</reference>

<!-- draft-ietf-mobileip-optim (Expired) -->
      <reference anchor="MIP-RO">
        <front>
          <title>Route Optimization in Mobile IP</title>
          <author fullname="Charles Perkins" initials="C" surname="Perkins">
            <organization>Nokia Research Center</organization>
          </author>
          <author fullname="David B. Johnson" initials="D" surname="Johnson">
            <organization>Carnegie Mellon University</organization>
          </author>
          <date month="September" year="2001" />
        </front>
       <seriesInfo name='Work in' value='Progress' />
      </reference>
    </references>
  </back>
</rfc>
